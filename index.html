<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Vendor Mobilization Dashboard</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8f9fa;
        padding: 10px;
        min-height: 100vh;
        font-size: 14px;
        color: #2c3e50;
    }

    .dashboard-container {
        max-width: 100%;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .header {
        background: #34495e;
        color: white;
        padding: 20px;
        text-align: center;
    }

    .header h1 {
        font-size: 28px;
        margin-bottom: 5px;
        font-weight: 600;
    }

    .header .subtitle {
        font-size: 16px;
        opacity: 0.9;
    }

    .stats-overview {
        background: #ecf0f1;
        padding: 20px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-top: 4px solid;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }
.stat-card:active {
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.stat-breakdown div:hover {
    background: rgba(52, 152, 219, 0.1);
    padding: 2px 4px;
    border-radius: 3px;
    margin: -2px -4px;
}
    .stat-card.total { border-top-color: #3498db; }
    .stat-card.belum-onsite { border-top-color: #e74c3c; }
    .stat-card.sudah-onsite { border-top-color: #27ae60; }

    .stat-number {
        font-size: 42px;
        font-weight: 700;
        margin-bottom: 8px;
        line-height: 1;
    }

    .stat-label {
        color: #7f8c8d;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .stat-breakdown {
        font-size: 13px;
        color: #95a5a6;
        line-height: 1.6;
    }

    .filter-controls {
        margin-top: 15px;
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 8px 14px;
        border: 1px solid #bdc3c7;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .filter-btn.active {
        background: #34495e;
        color: white;
        border-color: #34495e;
    }

    .filter-btn:hover {
        border-color: #34495e;
    }

    .content-area {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 20px;
        padding: 20px;
        max-width: 1800px;
        margin: 0 auto;
    }

    .main-table-section {
        background: white;
        min-width: 0;
        overflow: hidden;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
        flex-wrap: wrap;
        gap: 10px;
    }

    .table-title {
        font-size: 20px;
        font-weight: 600;
        color: #2c3e50;
    }

    .search-box {
        padding: 10px 14px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        width: 280px;
        font-size: 14px;
    }

    .search-box:focus {
        outline: none;
        border-color: #3498db;
    }

    .add-item-container {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn-add, .btn-export {
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .btn-add {
        background: #27ae60;
    }

    .btn-add:hover {
        background: #229954;
        transform: translateY(-1px);
    }

    .btn-export {
        background: #3498db;
    }

    .btn-export:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    .btn-delete {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-left: 5px;
    }

    .btn-delete:hover {
        background: #c0392b;
        transform: translateY(-1px);
    }

    .data-table-container {
    overflow-x: auto;
    overflow-y: visible;
    border: 1px solid #ecf0f1;
    border-radius: 4px;
}

    .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    table-layout: auto;  /* ‚≠ê GANTI dari fixed ke auto */
}

    .data-table th {
        background: #34495e;
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        font-size: 11px;
        white-space: nowrap;
    }

    /* ‚úÖ SESUDAH */
.data-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #ecf0f1;
    vertical-align: middle;
    font-size: 12px;
    white-space: nowrap;        /* Tetap nowrap untuk kolom lain */
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ‚≠ê TAMBAHKAN INI MULAI DARI SINI (Baris 274 baru) */
/* KOLOM TASK - Bisa multi-line */
/* ‚úÖ GANTI DENGAN INI */
.data-table td:nth-child(6),
.data-table th:nth-child(6) {
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;  /* ‚Üê Lebih baik dari word-break */
    line-height: 1.4;
    vertical-align: top;
    min-width: 150px;  /* ‚Üê Lebar minimum agar tidak terlalu sempit */
}

/* Equipment juga bisa wrap jika terlalu panjang */
/* ‚úÖ GANTI */
.data-table td:nth-child(3) {
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    min-width: 120px;
}

/* MOB Status bisa wrap */
.data-table td:nth-child(12) {
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
    min-width: 80px;
}
/* ‚≠ê SAMPAI SINI */

/* Kolom yang boleh wrap */
.data-table td.wrap-text {
    white-space: normal !important;
    word-wrap: break-word !important;
    word-break: break-word !important;
    overflow: visible !important;
    text-overflow: clip !important;
    max-width: none !important;
}

/* Fix kolom Actions agar dropdown tidak terpotong */
.data-table td:last-child {
    overflow: visible !important;
    position: relative;
    padding: 12px 8px !important;
}

/* Tambah z-index untuk row yang memiliki dropdown active */
.data-table tr:has(.action-dropdown[style*="display: block"]) {
    position: relative;
    z-index: 1000;
}

/* Dropdown backdrop untuk close saat klik di luar */
.dropdown-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9998;
    background: transparent;
    pointer-events: none !important; /* ‚≠ê DON'T BLOCK CLICKS! */
}

/* Dropdown container - FIXED position agar lepas dari table flow */
.action-dropdown {
    position: fixed !important;
    z-index: 9999 !important;
    background: white !important;
    border: 2px solid #d0d0d0 !important;
    border-radius: 10px !important;
    box-shadow: 0 10px 40px rgba(0,0,0,0.25), 
                0 4px 12px rgba(0,0,0,0.15) !important;
    min-width: 200px !important;
    overflow: hidden !important;
    animation: dropdownSlideIn 0.2s ease-out;
    transform-origin: top;
}

/* Dropdown animation */
@keyframes dropdownSlideIn {
    from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Dropdown items */
.dropdown-item {
    width: 100%;
    padding: 14px 18px;
    border: none;
    background: white;
    text-align: left;
    cursor: pointer !important; /* ‚≠ê UBAH: tambahkan !important */
    pointer-events: auto !important; /* ‚≠ê TAMBAH: baris baru ini */
    font-size: 13px;
    font-weight: 500;
    color: #2c3e50;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s ease;
    position: relative;
}

.dropdown-item:hover {
    background: linear-gradient(90deg, #f0f7ff 0%, #e3f2fd 100%) !important;
    color: #2196F3 !important;
    padding-left: 24px;
}

.dropdown-item:active {
    background: #bbdefb !important;
    transform: scale(0.98);
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item span:first-child {
    font-size: 18px;
    transition: transform 0.2s;
    flex-shrink: 0;
}

.dropdown-item:hover span:first-child {
    transform: scale(1.15) rotate(5deg);
}

.dropdown-item span:last-child {
    flex: 1;
}

.dropdown-item span {
    pointer-events: none; /* ‚≠ê Prevent span from intercepting clicks */
}

/* Tombol More styling */
.action-btn.dropdown-trigger {
    position: relative;
    transition: all 0.2s ease;
}

.action-btn.dropdown-trigger:hover {
    background: #8e44ad !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(155, 89, 182, 0.4);
}

.action-btn.dropdown-trigger:active {
    transform: translateY(0);
}

.action-btn.dropdown-trigger.active {
    background: #8e44ad !important;
    box-shadow: 0 2px 8px rgba(155, 89, 182, 0.4);
}

    .data-table tr.priority-1st { background: #fdf2f2; }
    .data-table tr.priority-2nd { background: #fefbf3; }
    .data-table tr.priority-3rd { background: #f0f9f0; }
    .data-table tr.priority-OSBL { background: #f0f4ff; }

    .status-badge {
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
        min-width: 60px;
        text-align: center;
        white-space: nowrap;
    }

    .status-done { background: #d5f4e6; color: #1e6937; }
    .status-ongoing { background: #fff3cd; color: #8a6d3b; }
    .status-issue { background: #f8d7da; color: #721c24; }
    .status-waiting { background: #d1ecf1; color: #0c5460; }
    .status-onsite { background: #d4edda; color: #155724; }
    .status-ontime { background: #d4edda; color: #155724; }
    .status-delayed { background: #f8d7da; color: #721c24; }

    .priority-badge {
    padding: 5px 12px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    color: white;
    display: inline-block;
    min-width: 55px;
    text-align: center;
}

    .priority-1st { background: #dc3545; }
    .priority-2nd { background: #fd7e14; }
    .priority-3rd { background: #198754; }
    .priority-OSBL { background: #0d6efd; }

.data-table tr.highlighted {
    background: linear-gradient(90deg, #ffe5e5 0%, #fff8f8 100%) !important;
    border-left: 5px solid #dc3545 !important;
    position: relative;
    box-shadow: inset 0 0 0 1px rgba(220, 53, 69, 0.1);
}


@keyframes warningPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.warning-badge {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    padding: 3px 7px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    display: inline-block;
    margin-right: 5px;
    box-shadow: 0 2px 6px rgba(231, 76, 60, 0.5);
    text-transform: uppercase;
    vertical-align: middle;
    white-space: nowrap;
}

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .sidebar-section {
        background: white;
        border-radius: 6px;
        padding: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .sidebar-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #2c3e50;
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 8px;
    }

    .timeline-item {
        padding: 10px 0;
        border-bottom: 1px solid #ecf0f1;
        font-size: 13px;
    }

    .timeline-item:last-child {
        border-bottom: none;
    }

    .action-btn {
        padding: 8px 14px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .action-btn.primary {
        background: #3498db;
        color: white;
    }

    .action-btn:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow-y: auto;
    }

    .modal-content {
        background-color: white;
        margin: 3% auto;
        padding: 30px;
        border-radius: 8px;
        width: 700px;
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        position: relative;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #2c3e50;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 20px;
        top: 20px;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .close:hover {
        color: #000;
        background-color: #f0f0f0;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
        color: #2c3e50;
    }

    .form-control {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 18px 24px;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        font-size: 14px;
        z-index: 1001;
        opacity: 0;
        transform: translateX(300px);
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    .notification.success { background: #27ae60; }
    .notification.error { background: #e74c3c; }

    .connection-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 18px;
        border-radius: 25px;
        font-size: 13px;
        font-weight: 600;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .connection-status.connected {
        background: #27ae60;
        color: white;
    }

    .connection-status.disconnected {
        background: #e74c3c;
        color: white;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: white;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    @media (max-width: 1400px) {
        .content-area {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        body { padding: 5px; }
        .header h1 { font-size: 22px; }
        .stat-number { font-size: 32px; }
        .table-title { font-size: 18px; }
        .search-box { width: 100%; }
    }

/* Gantt Chart Styles */
/* ========================================
   GANTT CHART PRINT/PDF OPTIMIZATION
   ======================================== */

/* Force white background for Gantt */
.gantt-container,
.gantt,
.gantt svg,
#gantt-chart,
#gantt-chart svg {
    background: white !important;
    background-color: white !important;
}

/* Ensure SVG background is white */
.gantt svg rect:first-child {
    fill: white !important;
}

/* Print-specific styles */
/* ========================================
   TASK TRACKER MODAL STYLES
   ======================================== */

.task-group {
    margin-bottom: 20px;
}

.task-group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: #f8f9fa;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 10px;
    transition: all 0.2s;
}

.task-group-header:hover {
    background: #e9ecef;
}

.task-group-header.completed {
    background: #d4edda;
    border-left: 4px solid #28a745;
}

.task-group-header.inprogress {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
}

.task-group-header.pending {
    background: #e7f3ff;
    border-left: 4px solid #6c757d;
}

.task-group-title {
    font-size: 14px;
    font-weight: 600;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
}

.task-group-count {
    font-size: 11px;
    background: white;
    padding: 2px 8px;
    border-radius: 10px;
    color: #7f8c8d;
}

.task-group-toggle {
    font-size: 12px;
    color: #7f8c8d;
}

.task-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.2s;
}

.task-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.task-item.completed {
    border-left: 4px solid #28a745;
    background: #f8fff9;
}

.task-item.inprogress {
    border-left: 4px solid #ffc107;
    background: #fffef8;
}

.task-item.pending {
    border-left: 4px solid #6c757d;
    background: #f8f9fa;
}

.task-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 10px;
}

.task-title {
    font-size: 13px;
    font-weight: 600;
    color: #2c3e50;
    flex: 1;
}

.task-status-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.task-status-badge.completed {
    background: #28a745;
    color: white;
}

.task-status-badge.inprogress {
    background: #ffc107;
    color: #000;
}

.task-status-badge.pending {
    background: #6c757d;
    color: white;
}

.task-meta {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    font-size: 11px;
    color: #6c757d;
    margin-bottom: 10px;
}

.task-meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.task-progress-bar {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0;
}

.task-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    transition: width 0.3s ease;
}

.task-notes {
    font-size: 11px;
    color: #495057;
    background: #f8f9fa;
    padding: 8px 10px;
    border-radius: 4px;
    margin: 10px 0;
    line-height: 1.5;
}

.task-actions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.task-btn {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.task-btn-complete {
    background: #28a745;
    color: white;
}

.task-btn-update {
    background: #17a2b8;
    color: white;
}

.task-btn-edit {
    background: #ffc107;
    color: #000;
}

.task-btn-delete {
    background: #dc3545;
    color: white;
}

.task-btn-start {
    background: #007bff;
    color: white;
}

.task-btn:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}

.task-analytics {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}

.task-analytics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 15px;
}

.task-analytics-item {
    background: rgba(255,255,255,0.1);
    padding: 12px;
    border-radius: 6px;
}

.task-analytics-value {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 5px;
}

.task-analytics-label {
    font-size: 11px;
    opacity: 0.9;
}

.task-prognosis {
    background: white;
    color: #2c3e50;
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
}

.task-prognosis-header {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.task-risk-badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
}

.task-risk-high {
    background: #dc3545;
    color: white;
}

.task-risk-medium {
    background: #ffc107;
    color: #000;
}

.task-risk-low {
    background: #28a745;
    color: white;
}

.task-recommendations {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    border-radius: 6px;
    margin-top: 15px;
}

.task-recommendations-title {
    font-size: 13px;
    font-weight: 600;
    color: #856404;
    margin-bottom: 10px;
}

.task-recommendations-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.task-recommendations-list li {
    font-size: 12px;
    color: #856404;
    padding: 5px 0;
    padding-left: 20px;
    position: relative;
}

.task-recommendations-list li:before {
    content: "‚Ä¢";
    position: absolute;
    left: 5px;
    font-weight: bold;
}

.task-overall-progress {
    background: white;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 2px solid #e9ecef;
}

.task-overall-bar {
    width: 100%;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.task-overall-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 700;
}

/* End of Task Tracker Styles */
/* Dropdown Menu Styles */
.dropdown-menu {
    animation: fadeIn 0.15s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media print {
    body {
        background: white !important;
    }
    
    .gantt-container {
        background: white !important;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
        page-break-inside: avoid !important;
    }
    
    .gantt,
    .gantt svg {
        background: white !important;
    }
    
    /* Force all backgrounds to white */
    .gantt .grid-background,
    .gantt .grid-header,
    .gantt .grid-row {
        fill: white !important;
        background: white !important;
    }
    
    /* Ensure text is visible */
    .gantt text {
        fill: #2c3e50 !important;
        color: #2c3e50 !important;
    }
    
    /* Grid lines visible */
    .gantt .grid-line {
        stroke: #e0e0e0 !important;
    }
    
    /* Header styling for print */
    .gantt .grid-header .grid-cell {
        fill: #f8f9fa !important;
        stroke: #34495e !important;
    }
    
    /* Hide unnecessary elements in print */
    .modal-header,
    .gantt-controls,
    button {
        display: none !important;
    }
}
.gantt-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: relative;
    max-height: 70vh;
    overflow: auto;
}

/* Sticky Gantt Header - TAMBAHKAN INI */
.gantt .grid-header,
.gantt .gantt_table_header {
    position: sticky !important;
    top: 0 !important;
    z-index: 100 !important;
    background: white !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
}

.gantt .upper-text,
.gantt .lower-text {
    background: white !important;
    font-weight: 700 !important;
    color: #2c3e50 !important;
}

/* Freeze task list column */
.gantt .grid-row {
    position: relative;
}

.gantt .grid-row .grid-cell:first-child {
    position: sticky !important;
    left: 0 !important;
    z-index: 50 !important;
    background: white !important;
    box-shadow: 2px 0 4px rgba(0,0,0,0.05) !important;
}

/* Enhance header visibility */
.gantt-container::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

.gantt-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.gantt-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.gantt-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Today line enhancement */
.gantt .today-highlight {
    background: rgba(52, 152, 219, 0.1) !important;
    border-left: 2px solid #3498db !important;
}

.gantt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ecf0f1;
}

.gantt-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.gantt-view-btn {
    padding: 8px 16px;
    border: 1px solid #bdc3c7;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
}

.gantt-view-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.gantt-view-btn:hover {
    border-color: #3498db;
}

#gantt-chart {
    min-height: 400px;
}

.gantt-legend {
    display: flex;
    gap: 20px;
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 11px;
}

.gantt-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.gantt-legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
}

/* Custom Gantt Bar Colors */
/* Custom Gantt Bar Colors - More Specific Selectors */
/* Custom Gantt Bar Colors - More Specific Selectors */

/* Custom Gantt Bar Colors - More Specific Selectors */
.gantt .bar-wrapper .bar-notstarted {
    fill: #95a5a6 !important; /* Abu-abu */
}

.gantt .bar-wrapper .bar-inprogress {
    fill: #27ae60 !important; /* Hijau */
}

.gantt .bar-wrapper .bar-completed {
    fill: #3498db !important; /* Biru */
}

.gantt .bar-wrapper .bar-delayedmob {
    fill: #f39c12 !important; /* Kuning - Delayed Mobilization */
}

.gantt .bar-wrapper .bar-workdelayed {
    fill: #e74c3c !important; /* Merah - Work Delayed */
}

/* Force override default Gantt colors */
/* Force override default Gantt colors */
.gantt .bar-wrapper.bar-notstarted .bar {
    fill: #95a5a6 !important; /* Abu-abu */
}

.gantt .bar-wrapper.bar-inprogress .bar {
    fill: #27ae60 !important; /* Hijau */
}

.gantt .bar-wrapper.bar-completed .bar {
    fill: #3498db !important; /* Biru */
}

.gantt .bar-wrapper.bar-delayedmob .bar {
    fill: #f39c12 !important; /* Kuning */
}

.gantt .bar-wrapper.bar-workdelayed .bar {
    fill: #e74c3c !important; /* Merah */
}

.gantt .bar-wrapper.bar-critical .bar {
    fill: #9b59b6 !important; /* Ungu */
}

.gantt .bar-progress {
    fill: rgba(255, 255, 255, 0.3) !important;
}

/* Additional override for bar group */
/* Additional override for bar group */
.gantt g.bar-group .bar-notstarted {
    fill: #95a5a6 !important; /* Abu-abu */
}

.gantt g.bar-group .bar-inprogress {
    fill: #27ae60 !important; /* Hijau */
}

.gantt g.bar-group .bar-completed {
    fill: #3498db !important; /* Biru */
}

.gantt g.bar-group .bar-delayedmob {
    fill: #f39c12 !important; /* Kuning */
}

.gantt g.bar-group .bar-workdelayed {
    fill: #e74c3c !important; /* Merah */
}

.gantt g.bar-group .bar-critical {
    fill: #9b59b6 !important; /* Ungu */
}

/* Gantt Tooltip for Mitigation Plan */
.gantt-tooltip {
    position: absolute;
    background: #fff3cd;
    border: 2px solid #f39c12;
    border-radius: 8px;
    padding: 12px 15px;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 9999;
    font-size: 12px;
    line-height: 1.6;
    pointer-events: none;
    display: none;
}

.gantt-tooltip.active {
    display: block;
}

.gantt-tooltip-header {
    font-weight: 700;
    color: #f39c12;
    margin-bottom: 8px;
    font-size: 13px;
    border-bottom: 2px solid #f39c12;
    padding-bottom: 5px;
}

.gantt-tooltip-content {
    color: #856404;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.gantt-tooltip-footer {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #f39c12;
    font-size: 10px;
    color: #999;
}


/* Force SVG white background */
.gantt svg {
    background-color: white !important;
}

.gantt .grid-background {
    fill: white !important;
}

.gantt .grid-header .grid-cell {
    fill: #f8f9fa !important;
}

.gantt .grid-row {
    fill: white !important;
}

/* ‚≠ê TAMBAH CSS BARU MULAI DARI SINI */
.equipment-group-row {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white !important;
    font-weight: 700;
    cursor: pointer;
    border-left: 5px solid #ffd700;
}

.equipment-group-row:hover {
    transform: translateX(3px);
}

.equipment-group-row td {
    padding: 15px 10px !important;
    color: white !important;
}

.collapse-icon {
    transition: transform 0.3s;
    margin-right: 8px;
}

.collapsed .collapse-icon {
    transform: rotate(-90deg);
}

.child-task-row {
    background: #f8f9fa;
    border-left: 4px solid #e0e0e0;
}

.child-task-row.hidden {
    display: none;
}

.child-task-row td:first-child {
    padding-left: 40px !important;
}

.phase-badge {
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 9px;
    margin-right: 5px;
    background: rgba(255,255,255,0.2);
}

.phase-badge.complete { background: #22c55e; }
.phase-badge.ongoing { background: #3b82f6; }
.phase-badge.pending { background: rgba(255,255,255,0.2); }

.overall-progress-bar {
    width: 100px;
    height: 8px;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    overflow: hidden;
    display: inline-block;
    vertical-align: middle;
}

.overall-progress-fill {
    height: 100%;
    background: #22c55e;
    transition: width 0.5s;
}

 /* Style untuk kolom nomor di group mode */
    .equipment-group-row td:first-child {
        background: rgba(52, 152, 219, 0.1);
        border-right: 2px solid rgba(52, 152, 219, 0.2);
        font-size: 14px;
        color: #2c3e50;
    }
    
    /* Ensure progress bar container is flexible */
    .overall-progress-bar {
        min-width: 80px;
        max-width: 200px;
    }

/* Force hide pagination in group mode */
body.grouped-view-active #pagination,
body.grouped-view-active .pagination-controls,
body.grouped-view-active .pagination-info,
body.grouped-view-active #tablePagination {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

/* Force hide pagination in group mode */
.hide-in-group-mode {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    opacity: 0 !important;
}

/* PDF Generation Optimization */
@media print {
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    .section {
        page-break-inside: avoid !important;
        page-break-after: auto !important;
    }
    
    .group-card {
        page-break-inside: avoid !important;
    }
    
    table {
        page-break-inside: auto !important;
    }
    
    tr {
        page-break-inside: avoid !important;
        page-break-after: auto !important;
    }
    
    .print-btn {
        display: none !important;
    }
}

/* Optimize for PDF generation */
.container {
    max-width: 100% !important;
}

.section {
    page-break-inside: avoid;
    margin-bottom: 20px;
}

table {
    page-break-inside: auto;
}

tr {
    page-break-inside: avoid;
    page-break-after: auto;
}

/* ========== VISUAL MANAGEMENT STYLES ========== */

/* Card Grid Layout */
.vm-cards-grid-3 { grid-template-columns: repeat(3, 1fr); }
.vm-cards-grid-4 { grid-template-columns: repeat(4, 1fr); }
.vm-cards-grid-5 { grid-template-columns: repeat(5, 1fr); }
.vm-cards-grid-6 { grid-template-columns: repeat(6, 1fr); }

/* Equipment Card */
.vm-equipment-card {
    background: white;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    padding: 15px;
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
}

.vm-equipment-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

/* Card Header */
.vm-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ecf0f1;
}

.vm-card-status {
    font-size: 18px;
    margin-right: 5px;
}

.vm-card-title {
    font-weight: bold;
    font-size: 14px;
    color: #2c3e50;
    line-height: 1.3;
    flex: 1;
}

.vm-card-close {
    background: none;
    border: none;
    font-size: 18px;
    color: #95a5a6;
    cursor: pointer;
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
}

.vm-card-close:hover {
    background: #e74c3c;
    color: white;
}

/* Card Meta Info */
.vm-card-meta {
    font-size: 11px;
    color: #7f8c8d;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
}

/* Progress Bars */
.vm-progress-section {
    margin-bottom: 12px;
}

.vm-progress-label {
    font-size: 11px;
    color: #7f8c8d;
    margin-bottom: 3px;
    display: flex;
    justify-content: space-between;
}

.vm-progress-bar {
    width: 100%;
    height: 8px;
    background: #ecf0f1;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 8px;
}

.vm-progress-fill {
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

.vm-progress-fill.green { background: #27ae60; }
.vm-progress-fill.blue { background: #3498db; }
.vm-progress-fill.orange { background: #f39c12; }
.vm-progress-fill.red { background: #e74c3c; }

/* SPI Badge */
.vm-spi-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 5px;
}

.vm-spi-badge.critical { background: #e74c3c; color: white; }
.vm-spi-badge.warning { background: #f39c12; color: white; }
.vm-spi-badge.good { background: #27ae60; color: white; }

/* Timeline Info */
.vm-timeline-info {
    font-size: 12px;
    color: #2c3e50;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
}

/* Task Status Counts */
.vm-task-counts {
    display: flex;
    justify-content: space-around;
    margin-bottom: 10px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
}

.vm-task-count {
    text-align: center;
    font-size: 11px;
}

.vm-task-count-number {
    display: block;
    font-size: 18px;
    font-weight: bold;
    color: #2c3e50;
}

/* Milestone Section */
.vm-milestone {
    margin-bottom: 10px;
    padding: 8px;
    background: #fff3cd;
    border-left: 3px solid #f39c12;
    border-radius: 4px;
    font-size: 11px;
}

.vm-milestone-title {
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 3px;
}

.vm-milestone-due {
    color: #7f8c8d;
}

/* Highlight Section */
.vm-highlight {
    margin-bottom: 12px;
    padding: 8px;
    background: #e8f5e9;
    border-left: 3px solid #27ae60;
    border-radius: 4px;
    font-size: 11px;
    color: #2c3e50;
    line-height: 1.4;
    max-height: 60px;
    overflow: hidden;
    position: relative;
}

.vm-highlight-label {
    font-weight: bold;
    margin-bottom: 3px;
    display: block;
}

.vm-highlight-text {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.vm-highlight-more {
    color: #3498db;
    cursor: pointer;
    font-size: 10px;
    margin-top: 3px;
    display: inline-block;
}

.vm-highlight-more:hover {
    text-decoration: underline;
}

/* Card Actions */
.vm-card-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.vm-action-btn {
    flex: 1;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
}

.vm-action-btn.primary {
    background: #3498db;
    color: white;
}

.vm-action-btn.primary:hover {
    background: #2980b9;
}

.vm-action-btn.secondary {
    background: #95a5a6;
    color: white;
}

.vm-action-btn.secondary:hover {
    background: #7f8c8d;
}

/* Equipment List in Dialog */
.vm-equipment-item {
    padding: 12px;
    border-bottom: 1px solid #ecf0f1;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.vm-equipment-item:hover {
    background: #f8f9fa;
}

.vm-equipment-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.vm-equipment-item-info {
    flex: 1;
}

.vm-equipment-item-name {
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 3px;
}

.vm-equipment-item-meta {
    font-size: 11px;
    color: #7f8c8d;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .vm-cards-grid-6 { grid-template-columns: repeat(4, 1fr); }
    .vm-cards-grid-5 { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 992px) {
    .vm-cards-grid-6,
    .vm-cards-grid-5,
    .vm-cards-grid-4 { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 768px) {
    .vm-cards-grid-6,
    .vm-cards-grid-5,
    .vm-cards-grid-4,
    .vm-cards-grid-3 { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 480px) {
    .vm-cards-grid-6,
    .vm-cards-grid-5,
    .vm-cards-grid-4,
    .vm-cards-grid-3 { grid-template-columns: 1fr; }
    
    #visualManagementSection {
        padding: 15px 10px !important;
    }
}

/* ‚úÖ ADD - Split Button & Dropdown Styles */
.vm-card-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}

.split-button {
    display: inline-flex;
    position: relative;
    flex: 1;
    z-index: 1; /* ‚úÖ ADD THIS */
}

/* ‚úÖ ADD - When dropdown is open, raise z-index */
.split-button.dropdown-open {
    z-index: 10000;
}

.split-button-main {
    flex: 1;
    padding: 10px 16px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px 0 0 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background 0.2s;
}

.split-button-main:hover {
    background: #2980b9;
}

.split-button-dropdown {
    padding: 10px 12px;
    background: #3498db;
    color: white;
    border: none;
    border-left: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    font-size: 12px;
    transition: background 0.2s;
}

.split-button-dropdown:hover {
    background: #2980b9;
}

.task-dropdown-menu {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #dfe6e9;
    border-radius: 4px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25); /* ‚úÖ Stronger shadow */
    z-index: 9999; /* ‚úÖ Higher z-index */
    display: none;
    overflow: visible; /* ‚úÖ Changed from hidden */
    min-width: 200px; /* ‚úÖ Ensure minimum width */
}

.task-dropdown-menu.show {
    display: block;
    animation: dropdownFadeIn 0.2s ease-out;
}

@keyframes dropdownFadeIn {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.dropdown-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.15s;
    font-size: 14px;
    color: #2c3e50;
}

.dropdown-item:hover {
    background: #ecf0f1;
}

.dropdown-item.all-tasks {
    font-weight: 600;
    color: #3498db;
}

.dropdown-divider {
    height: 1px;
    background: #dfe6e9;
    margin: 4px 0;
}

.dropdown-item-count {
    float: right;
    color: #95a5a6;
    font-size: 13px;
}

.vm-report-button {
    flex: 1;
    padding: 10px 16px;
    background: #2ecc71;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background 0.2s;
}

.vm-report-button:hover {
    background: #27ae60;
}

/* ‚úÖ ADD - Card z-index management */
.vm-equipment-card {
    position: relative; /* ‚úÖ Need this for z-index to work */
    z-index: 1; /* ‚úÖ Default z-index */
}

/* ‚úÖ ADD - Raise card z-index when dropdown is open */
.vm-equipment-card:has(.split-button.dropdown-open) {
    z-index: 10000 !important;
}

/* Fallback for browsers without :has() support */
.vm-equipment-card.dropdown-active {
    z-index: 10000 !important;
}
/* ‚úÖ ADD - Disabled main button style */
.split-button-main[style*="cursor: default"] {
    opacity: 0.8;
}

.split-button-main[style*="cursor: default"]:hover {
    background: #3498db; /* No color change on hover */
}

/* ===== VM CARD CHANGE INDICATORS ===== */

/* Colored left border for recent changes */
.vm-equipment-card.recent-activity {
    border-left: 4px solid #3498db; /* Blue - high activity */
    transition: all 0.3s ease;
}

.vm-equipment-card.recent-milestone {
    border-left: 4px solid #f39c12; /* Gold - milestone */
}

.vm-equipment-card.recent-progress {
    border-left: 4px solid #27ae60; /* Green - progress increase */
}

/* Pulse badge (top-right) */
.change-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    z-index: 10;
}

/* Pulse animation */
.change-badge.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 currentColor;
        opacity: 1;
    }
    50% {
        box-shadow: 0 0 0 8px transparent;
        opacity: 0.7;
    }
    100% {
        box-shadow: 0 0 0 0 transparent;
        opacity: 1;
    }
}

/* Badge colors */
.change-badge.activity {
    background: #3498db;
    color: #3498db;
}

.change-badge.milestone {
    background: #f39c12;
    color: #f39c12;
}

.change-badge.progress {
    background: #27ae60;
    color: #27ae60;
}

/* Tooltip for badge */
.change-badge-tooltip {
    display: none;
    position: absolute;
    top: 30px;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 200px;
    z-index: 100;
    font-size: 12px;
    line-height: 1.6;
}

.change-badge:hover + .change-badge-tooltip,
.change-badge-tooltip:hover {
    display: block;
}

/* Progress delta indicator */
.progress-delta {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-left: 8px;
    font-size: 13px;
    font-weight: 600;
    animation: slideIn 0.5s ease;
}

.progress-delta.increase {
    color: #27ae60;
}

.progress-delta.decrease {
    color: #e74c3c;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.progress-delta .arrow {
    font-size: 14px;
}

.progress-delta .from-value {
    font-size: 11px;
    color: #95a5a6;
    font-weight: normal;
}

/* Progress bar pulse effect for recent increase */
.vm-progress-fill.recent-increase {
    animation: progressPulse 2s ease-out;
}

@keyframes progressPulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(39, 174, 96, 0);
    }
}

/* ‚≠ê AKHIR CSS BARU */

</style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        <span class="status-dot"></span>
        <span id="statusText">Connecting...</span>
    </div>

    <div class="dashboard-container">
      <div class="header">
            <h1>RFCC VENDOR MOBILIZATION & PROGRESS TRACKING</h1>
            <div style="display: flex; justify-content: center; align-items: center; gap: 25px;">
                <div class="subtitle" style="font-size: 13px; opacity: 0.85;">
                    üìÖ Updated: <span id="currentDate"></span>
                </div>
                <!-- Auto-Sort Toggle - Sejajar dengan tanggal -->
                <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; background: rgba(255,255,255,0.15); padding: 5px 12px; border-radius: 8px; transition: all 0.3s; backdrop-filter: blur(5px);">
                    <input type="checkbox" id="sortToggle" checked onchange="toggleAutoSort(this.checked)" style="width: 14px; height: 14px; cursor: pointer; accent-color: #27ae60;">
                    <span style="color: #fff; font-weight: 500; letter-spacing: 0.3px;">‚úì Auto-sort</span>
                </label>
            </div>
            
            <div style="position: absolute; right: 20px;
                <div style="position: absolute; right: 20px; font-size: 11px; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px;">
                    üë• <span id="onlineCount" style="font-weight: bold;">0</span> online
                </div>
            </div>
        </div>

        <div class="stats-overview">
            <div class="stats-grid">
                <div class="stat-card total" onclick="filterByStatus('all')" style="cursor: pointer;">
    <div class="stat-number">
    <span id="totalCount">0</span>
    <span id="totalCountLabel" style="font-size: 14px; font-weight: 400; margin-left: 5px;"></span>
</div>
<div class="stat-label">Total Items</div>
                    <div class="filter-controls">
    <button class="filter-btn active" data-filter="all" onclick="filterByPriority('all')">All</button>
    <button class="filter-btn" data-filter="1st" onclick="filterByPriority('1st')">1st</button>
    <button class="filter-btn" data-filter="2nd" onclick="filterByPriority('2nd')">2nd</button>
    <button class="filter-btn" data-filter="3rd" onclick="filterByPriority('3rd')">3rd</button>
    <button class="filter-btn" data-filter="OSBL" onclick="filterByPriority('OSBL')">OSBL</button>
    <button class="filter-btn" data-filter="highlighted" onclick="filterByPriority('highlighted')" style="background: #e74c3c; color: white; border-color: #e74c3c;">‚ö†Ô∏è Critical</button>
</div>
                </div>

                <div class="stat-card belum-onsite" onclick="filterByStatus('notonsite')" style="cursor: pointer;">
    <div class="stat-number" id="belumOnsiteCount">0</div>
    <div class="stat-label">Not Yet Onsite</div>
    <div class="stat-breakdown">
        <div style="cursor: pointer;" onclick="event.stopPropagation(); filterByIssueType('contract')">
            Contract Issues: <span id="contractIssueCount">0</span>
        </div>
        <div style="cursor: pointer;" onclick="event.stopPropagation(); filterByIssueType('payment')">
            Payment Issues: <span id="paymentIssueCount">0</span>
        </div>
        <div style="cursor: pointer;" onclick="event.stopPropagation(); filterByIssueType('visa')">
            VISA Processing: <span id="visaProcessingCount">0</span>
        </div>
    </div>
</div>

                <div class="stat-card sudah-onsite" style="cursor: pointer;">
    <div class="stat-number" id="sudahOnsiteCount" onclick="filterByStatus('onsite')">0</div>
    <div class="stat-label" onclick="filterByStatus('onsite')">Already Onsite</div>
    <div class="stat-breakdown">
        <div style="cursor: pointer;" onclick="filterByStatus('inprogress')">In Progress: <span id="inProgressCount">0</span></div>
        <div style="cursor: pointer;" onclick="filterByStatus('completed')">Completed: <span id="completedCount">0</span></div>
        <div style="color: #27ae60; cursor: pointer;" onclick="filterByStatus('ontime')">On Time: <span id="onTimeCount">0</span></div>
        <div style="color: #e74c3c; cursor: pointer;" onclick="filterByStatus('delayed')">Delayed: <span id="delayedCount">0</span></div>
    </div>
</div>
            </div>
        </div>

<!-- ========== VISUAL MANAGEMENT SECTION ========== -->
<div id="visualManagementSection" style="display: none; margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
        <div>
            <h3 style="margin: 0; color: #2c3e50;">üìä Visual Management - Equipment Progress Summary</h3>
            <p id="vmSubtitle" style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 13px;">No equipment selected</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="clearAllVMEquipment()" style="padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                üóëÔ∏è Clear All
            </button>
            <button onclick="openAddEquipmentDialog()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                ‚ûï Add Equipment
            </button>
            <button onclick="openVMSettings()" style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                ‚öôÔ∏è Settings
            </button>
            <span id="vmAutoSaveIndicator" style="padding: 8px 12px; color: #27ae60; font-size: 12px; align-self: center;"></span>
        </div>
    </div>

    <div id="vmCardsContainer" style="display: grid; gap: 15px; margin-bottom: 15px;"></div>

<!-- ‚úÖ ADD THIS - Loading State (NEW) -->
<div id="vmLoadingState" style="display: none; text-align: center; padding: 60px 20px; color: #7f8c8d;">
    <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #34495e;">Loading Equipment Data...</div>
    <div style="font-size: 14px; opacity: 0.8;">Please wait while we fetch your equipment progress</div>
</div>

    <div id="vmEmptyState" style="text-align: center; padding: 60px 20px; color: #95a5a6;">
        <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
        <h4 style="color: #7f8c8d; margin-bottom: 10px;">No Equipment Added</h4>
        <p style="margin-bottom: 20px;">Add equipment to monitor their progress here</p>
        <button onclick="openAddEquipmentDialog()" style="padding: 10px 24px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
            ‚ûï Add Your First Equipment
        </button>
    </div>

</div>

<div id="addEquipmentDialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
        <div style="padding: 20px; border-bottom: 1px solid #ecf0f1; background: #3498db; color: white;">
            <h3 style="margin: 0;">üìå Add Equipment to Visual Board</h3>
        </div>
        <div style="padding: 20px; overflow-y: auto; flex: 1;">
            <div style="margin-bottom: 20px;">
                <input type="text" id="vmEquipmentSearch" placeholder="üîç Search equipment..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" oninput="filterVMEquipmentList()">
            </div>
            <div id="vmEquipmentList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ecf0f1; border-radius: 4px; padding: 10px;"></div>
        </div>
        <div style="padding: 15px 20px; border-top: 1px solid #ecf0f1; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa;">
            
            <button onclick="document.getElementById('addEquipmentDialog').style.display='none'" style="padding: 8px 20px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">Cancel</button>
<button onclick="addSelectedEquipmentBatch()" style="padding: 8px 20px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">Add Selected</button>
        </div>
    </div>
</div>

<div id="vmSettingsDialog" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 8px; width: 90%; max-width: 500px; overflow: hidden;">
        <div style="padding: 20px; border-bottom: 1px solid #ecf0f1; background: #34495e; color: white;">
            <h3 style="margin: 0;">‚öôÔ∏è Visual Management Settings</h3>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">Layout:</label>
                <select id="vmLayoutSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="updateVMLayout()">
                    <option value="3">3 cards per row</option>
                    <option value="4">4 cards per row</option>
                    <option value="5">5 cards per row</option>
                    <option value="6">6 cards per row</option>
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">Maximum Rows to Display:</label>
                <select id="vmMaxRowsSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="updateVMLayout()">
                    <option value="1">1 row</option>
                    <option value="2">2 rows</option>
                    <option value="3">3 rows</option>
                    <option value="4">4 rows</option>
                    <option value="999">Show all</option>
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">Card Display Options:</label>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="vmShowVendor" checked onchange="updateVMLayout()" style="margin-right: 8px;"><span>Show vendor name</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="vmShowMilestone" checked onchange="updateVMLayout()" style="margin-right: 8px;"><span>Show milestone</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="vmShowHighlight" checked onchange="updateVMLayout()" style="margin-right: 8px;"><span>Show highlights</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="vmShowSPI" checked onchange="updateVMLayout()" style="margin-right: 8px;"><span>Show SPI</span>
                    </label>
                </div>
            </div>
        </div>
        <div style="padding: 15px 20px; border-top: 1px solid #ecf0f1; display: flex; justify-content: flex-end; gap: 10px; background: #f8f9fa;">
            <button onclick="closeVMSettings()" style="padding: 8px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </div>
</div>

<!-- Visual Management Quick Access Button -->
<div id="vmQuickAccessButton" style="display: none; text-align: center; margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
    <h3 style="color: #2c3e50; margin: 0 0 8px 0; font-size: 18px;">üìä Visual Management Dashboard</h3>
    <p style="color: #7f8c8d; margin: 0 0 15px 0; font-size: 13px;">Monitor equipment progress at a glance</p>
    <button onclick="openAddEquipmentDialog()" style="padding: 10px 24px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3); transition: all 0.3s;">
        ‚ûï Add Equipment to Dashboard
    </button>
</div>

        <div class="content-area">
            <div class="main-table-section">
                <div class="table-header">
                    <h2 class="table-title">Detailed Task List</h2>
                    <div class="add-item-container">
    <button class="btn-add" id="addItemBtn">+ Add New Item</button>
    <button class="btn-export" id="exportBtn">üìÑ Export PDF</button>
    <button class="btn-export" id="viewTimelineBtn" style="background: #9b59b6;">üìä View Timeline</button>
<!-- ‚≠ê TAMBAH BUTTON BARU DI BAWAH INI -->
    <button class="btn-export" id="groupViewBtn" onclick="toggleGroupedView()" style="background: #e67e22;">
        üîß Group Equipment
</button>
    <input type="text" class="search-box" placeholder="Search equipment, vendor, or task..." id="searchBox">
</div>
                </div>

                <div class="data-table-container">
                    <table class="data-table" id="mainDataTable">
                        <thead>
                            <tr>
                                <!-- ‚úÖ SESUDAH (Total 100% - BENAR & PROPORSIONAL) -->
<th style="width: 2%;">No</th>
<th style="width: 3%;">Priority</th>
<th style="width: 17%;">Equipment</th>       
<th style="width: 5%;">Vendor</th>           <!-- ‚¨áÔ∏è 8%‚Üí6% (nama singkat) -->
<th style="width: 3%;">Disc</th>             <!-- ‚¨áÔ∏è 4%‚Üí3% (CI, COM, ME) -->
<th style="width: 21%;">Task</th>            <!-- ‚¨ÜÔ∏è 12%‚Üí18% DIPERBESAR! -->
<th style="width: 5%;">Status</th>           <!-- ‚¨áÔ∏è 8%‚Üí7% -->
<th style="width: 6%;">Contract</th>
<th style="width: 5%;">VISA</th>
<th style="width: 6%;">Target MOB<br>Date</th>
<th style="width: 5%;">MOB Date</th>
<th style="width: 6%;">MOB Status</th>
<th style="width: 5%;">Target Comp.<br>Date</th>
<th style="width: 6%;">Prognosa Comp.<br>Date</th>
<th style="width: 4%;">Progress</th>
<th style="width: 11%;">Actions</th>         <!-- ‚¨áÔ∏è 12%‚Üí11% -->
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>

            <!-- Pagination Controls -->
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <div style="font-size: 12px; color: #7f8c8d;">
                        Showing <span id="tablePageInfo">0</span> items
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="changeTablePage(-1)" id="prevTablePageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Previous</button>
                        <span id="tablePageNumbers" style="display: flex; gap: 5px;"></span>
                        <button onclick="changeTablePage(1)" id="nextTablePageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Next</button>
                    </div>
                </div>
            </div>


            <div class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Recent Updates</h3>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Filter by Equipment:</label>
<input type="text" id="equipmentSearch" placeholder="Search equipment..." style="width: 100%; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 11px; margin-bottom: 5px;" oninput="searchEquipment()">
<select id="equipmentHistoryFilter" size="5" style="width: 100%; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 11px; max-height: 150px; overflow-y: auto;" onchange="filterEquipmentHistory()">
    <option value="all">All Equipment</option>
</select>
                        <button id="viewProgressReportBtn" onclick="showProgressReport()" style="width: 100%; margin-top: 8px; padding: 8px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; display: none;">
                            View Progress Report
                        </button>
                    </div>

                    <div id="historyContainer" style="max-height: 400px; overflow-y: auto;">
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="action-btn primary" id="showAllHistoryBtn" style="flex: 1; font-size: 10px;">Show All History</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 class="sidebar-title" style="margin-bottom: 0;">Upcoming Mobilizations</h3>
                        <span id="upcomingCount" style="background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">0</span>
                    </div>
                    <div id="upcomingContainer" style="max-height: 400px; overflow-y: auto;">
                        <div style="padding: 20px; text-align: center; color: #95a5a6; font-size: 11px;">
                            Loading upcoming mobilizations...
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
    <h3 class="sidebar-title">Critical Issues</h3>
    <div style="background: #fdf2f2; padding: 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;" onclick="filterByIssueType('contract')">
        <strong>Contract Delays</strong><br>
        <span id="criticalContract">0</span> items waiting quotation or contract review
    </div>
    <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;" onclick="filterByIssueType('visa')">
        <strong>VISA Bottleneck</strong><br>
        <span id="criticalVisa">0</span> items in VISA processing queue
    </div>
    <div style="background: #f8d7da; padding: 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;" onclick="filterByIssueType('payment')">
        <strong>Payment Issues</strong><br>
        <span id="criticalPayment">0</span> vendors awaiting AP invoice processing
    </div>
    <div style="background: #ffe5e5; padding: 8px; border-radius: 4px; border: 2px solid #e74c3c; cursor: pointer;" onclick="filterByIssueType('workdelayed')">
        <strong style="color: #c0392b;">‚ö†Ô∏è Work Delayed</strong><br>
        <span id="criticalWorkDelayed" style="font-weight: 700; color: #c0392b;">0</span> items with prognosa ‚â• target completion
    </div>
</div>
            </div>
        </div>
    </div>

    <div id="updateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Task</h3>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Equipment:</label>
                    <input type="text" id="modalEquipment" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Vendor:</label>
                    <input type="text" id="modalVendor" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority:</label>
                    <select id="modalPriority" class="form-control">
                        <option value="1st">1st Start-up</option>
                        <option value="2nd">2nd Start-up</option>
                        <option value="3rd">3rd Start-up</option>
                        <option value="OSBL">OSBL</option>
                    </select>
                </div>
                <div class="form-group">
    <label class="form-label">Discipline:</label>
    <select id="modalDisc" class="form-control">
        <option value="CI">CI</option>
        <option value="CI/COM">CI/COM</option>
        <option value="COM">COM</option>
        <option value="COM-EL">COM-EL</option>
        <option value="COM-I">COM-I</option>
        <option value="COM-ME">COM-ME</option>
        <option value="COM-ME-CI">COM-ME-CI</option>
        <option value="EL">EL</option>
        <option value="HV">HV</option>
        <option value="ME">ME</option>
        <option value="MR">MR</option>
        <option value="custom">‚ûï Custom (Type Your Own)</option>
    </select>
</div>

<!-- ‚úÖ ADD THIS NEW FIELD -->
<div class="form-group">
    <label class="form-label">Display Sequence (for reports):</label>
    <input type="number" id="modalDisplaySequence" class="form-control" 
           placeholder="1, 2, 3..." min="1" step="1" value="999">
    <small style="color: #7f8c8d; font-size: 11px; display: block; margin-top: 3px;">
        üìä Controls order in reports: 1=first, 2=second, etc. Same equipment can have different sequences for different disciplines.
    </small>
</div>

<!-- Custom Discipline Input (Hidden by default) -->
<div class="form-group" id="customDiscGroup" style="display: none;">
    <label class="form-label">Custom Discipline:</label>
    <input type="text" id="customDiscInput" class="form-control" placeholder="Type your custom discipline..." maxlength="20">
    <small style="color: #7f8c8d; font-size: 11px;">Max 20 characters. Example: CI/ME, COM-CI-EL, etc.</small>
</div>
<div class="form-group">
    <label class="form-label">Task Name:</label>
    <input type="text" id="modalTask" class="form-control" placeholder="e.g., FAT Inspection, SAT Testing, Installation, etc.">
</div>
                <div class="form-group">
                    <label class="form-label">Status:</label>
                    <select id="modalStatus" class="form-control">
                        <option value="Contract Issue">Contract Issue</option>
                        <option value="Payment Issue">Payment Issue</option>
                        <option value="VISA Processing">VISA Processing</option>
                        <option value="Contract Review">Contract Review</option>
                        <option value="Ready">Ready for Mobilization</option>
                        <option value="Onsite Working">Onsite Working</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Contract Status:</label>
                    <select id="modalContract" class="form-control">
                        <option value="Quotation">Waiting Quotation</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Reviewing">Reviewing</option>
                        <option value="Ongoing">Ongoing</option>
                        <option value="Waiting AP">Waiting AP Invoice</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">VISA Status:</label>
                    <select id="modalVisa" class="form-control">
                        <option value="Not Applied">Not Applied</option>
                        <option value="Processing">Processing</option>
                        <option value="Ongoing">Ongoing</option>
                        <option value="Local">Local</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Target MOB Date:</label>
                    <input type="date" id="modalTargetDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Mobilization Date:</label>
                    <input type="date" id="modalMobDate" class="form-control">
                </div>

<div class="form-group">
    <label class="form-label">Target Completion Date:</label>
    <input type="date" id="modalTargetCompDate" class="form-control">
</div>
<div class="form-group">
    <label class="form-label">Prognosa Completion Date:</label>
    <input type="date" id="modalPrognosaCompDate" class="form-control">
</div>
                <div class="form-group">
                    <label class="form-label">Progress (%):</label>
                    <input type="number" id="modalProgress" class="form-control" min="0" max="100">
                </div>
<div class="form-group">
    <label class="form-label">
        <input type="checkbox" id="modalHighlight" style="margin-right: 8px; width: auto; cursor: pointer;">
        <span style="color: #e74c3c; font-weight: 700;">‚ö†Ô∏è Mark as Critical/Priority Item</span>
    </label>
    <small style="display: block; margin-top: 5px; color: #7f8c8d; font-size: 12px;">
        This item will be highlighted with a warning indicator
    </small>
</div>
<div class="form-group">
    <label class="form-label">‚ö†Ô∏è Work Mitigation Plan:</label>
    <textarea id="modalMitigationPlan" class="form-control" rows="5" placeholder="Enter work mitigation plan for potential delays or issues...&#10;Example:&#10;‚Ä¢ Expedite quotation process with vendor&#10;‚Ä¢ Prepare alternative vendor as backup&#10;‚Ä¢ Fast track VISA application if contract approved"></textarea>
    <small style="display: block; margin-top: 5px; color: #7f8c8d; font-size: 12px;">
        Detail action plan to mitigate risks and delays
    </small>
</div>
                <div class="form-group">
                    <label class="form-label">Notes:</label>
                    <textarea id="modalNotes" class="form-control" rows="3" placeholder="Add notes about this task..."></textarea>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="saveButton">Save Changes</button>
            </div>
        </div>
    </div>

<div id="historyModal" class="modal">
        <div class="modal-content" style="width: 900px; max-width: 95%;">
            <div class="modal-header">
                <h3 class="modal-title">Complete Activity History</h3>
                <span class="close" onclick="closeHistoryModal()">&times;</span>
            </div>
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="historySearch" placeholder="Search history..." style="flex: 1; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 12px;">
                <button onclick="selectAllHistory()" style="padding: 8px 12px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Select All</button>
                <button onclick="deleteSelectedHistory()" style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Delete Selected</button>
                <button onclick="exportHistoryPDF()" style="padding: 8px 12px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Export PDF</button>
            </div>
            <div id="fullHistoryContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #ecf0f1; border-radius: 4px; padding: 10px;">
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <div style="font-size: 12px; color: #7f8c8d;">
                    Showing <span id="historyPageInfo">0</span> items
                </div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="changeHistoryPage(-1)" id="prevPageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Previous</button>
                    <span id="pageNumbers" style="display: flex; gap: 5px; align-items: center; font-size: 12px; color: #2c3e50;"></span>
                    <button onclick="changeHistoryPage(1)" id="nextPageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Next</button>
                </div>
            </div>
        </div>
    </div>


   <!-- Progress Report Modal -->
<div id="progressReportModal" class="modal">
    <div class="modal-content" style="width: 900px; max-width: 95%;">
        <div class="modal-header">
            <h3 class="modal-title">üìä Equipment Progress Report</h3>
            <span class="close" onclick="closeProgressReport()">&times;</span>
        </div>
        
        <!-- TAMBAHKAN FILTER SECTION INI -->
        <div style="background: #f8f9fa; padding: 15px; border-bottom: 2px solid #e9ecef; margin-bottom: 15px;">
            <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #2c3e50; display: flex; align-items: center; gap: 8px;">
                üîç Filter Timeline
            </h4>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div>
                    <label style="display: block; font-size: 11px; font-weight: 600; color: #495057; margin-bottom: 4px;">üìÖ Dari Tanggal:</label>
                    <input type="date" id="reportDateFrom" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 11px;" onchange="applyReportFilter()">
                </div>
                <div>
                    <label style="display: block; font-size: 11px; font-weight: 600; color: #495057; margin-bottom: 4px;">üìÖ Sampai Tanggal:</label>
                    <input type="date" id="reportDateTo" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 11px;" onchange="applyReportFilter()">
                </div>
                <div>
                    <label style="display: block; font-size: 11px; font-weight: 600; color: #495057; margin-bottom: 4px;">üìÇ Tipe Update:</label>
                    <select id="reportFilterType" style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 11px;" onchange="applyReportFilter()">
                        <option value="all">Semua Tipe</option>
                        <option value="ADD">Task Added</option>
                        <option value="UPDATE">Progress Update</option>
                        <option value="TASK START">Task Started</option>
                        <option value="TASK COMPLETE">Task Completed</option>
                        <option value="PROGRESS UPDATE">Progress Update</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 11px; color: #6c757d;">
                    <span id="reportTotalCount">0</span> updates ditemukan
                </div>
                <button onclick="clearReportFilter()" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">
                    üîÑ Reset Filter
                </button>
            </div>
        </div>
        
        <div id="progressReportContent" style="max-height: 50vh; overflow-y: auto;">
            <!-- Content will be populated by JavaScript -->
        </div>
        
        <!-- TAMBAHKAN PAGINATION CONTROLS INI -->
        <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-top: 2px solid #e9ecef;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-size: 11px; color: #6c757d;">
                    Menampilkan <span id="reportPageInfo">0</span> updates
                </div>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <button onclick="changeReportPage(-1)" id="prevReportPageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">‚óÑ Prev</button>
                    <span id="reportPageNumbers" style="display: flex; gap: 5px;"></span>
                    <button onclick="changeReportPage(1)" id="nextReportPageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Next ‚ñ∫</button>
                </div>
            </div>
        </div>
        <div style="margin-top: 20px; text-align: center; padding-top: 15px; border-top: 1px solid #ecf0f1;">
            <button onclick="exportProgressReportPDF()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; margin-right: 10px;">üìÑ Export as PDF</button>
            <button onclick="closeProgressReport()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">Close</button>
        </div>
    </div>
</div>

<!-- ========================================
     ONSITE TASK TRACKER MODAL
     ======================================== -->
<div id="taskTrackerModal" class="modal">
    <div class="modal-content" style="width: 900px; max-width: 95%; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 class="modal-title" id="taskTrackerTitle">üìã Onsite Task Tracker</h3>
            <span class="close" onclick="closeTaskTracker()">&times;</span>
        </div>
        
        <div id="taskTrackerContent">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div style="margin-top: 20px; text-align: center; padding-top: 15px; border-top: 1px solid #ecf0f1;">
    <button onclick="closeTaskTracker()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">Close</button>
</div>
    </div>
</div>

<!-- ========================================
     ADD/EDIT TASK MODAL
     ======================================== -->
<div id="taskEditModal" class="modal">
    <div class="modal-content" style="width: 600px; max-width: 90%;">
        <div class="modal-header">
            <h3 class="modal-title" id="taskEditTitle">Add New Task</h3>
            <span class="close" onclick="closeTaskEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Task Name:</label>
                <input type="text" id="taskNameInput" class="form-control" placeholder="e.g., Mechanical Installation & Alignment">
            </div>
            <div class="form-group">
                <label class="form-label">Description:</label>
                <textarea id="taskDescInput" class="form-control" rows="2" placeholder="Brief description of the task..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Target Start Date:</label>
                <input type="date" id="taskStartInput" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Target End Date:</label>
                <input type="date" id="taskEndInput" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">Duration (auto-calculated):</label>                <input type="number" id="taskDurationInput" class="form-control" min="1" placeholder="Auto-calculated" readonly style="background: #f8f9fa; cursor: not-allowed;">
            </div>
           
            <div class="form-group">
                <label class="form-label">Status:</label>
                <select id="taskStatusInput" class="form-control">
                    <option value="pending">Pending</option>
                    <option value="inprogress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
<!-- Actual Dates (shown when status is inprogress or completed) -->
<div class="form-group" id="taskActualDatesGroup" style="display: none;">
    <label class="form-label">Actual Start Date:</label>
    <input type="date" id="taskActualStartInput" class="form-control">
    <small style="color: #7f8c8d; font-size: 11px;">Auto-filled when task started, can be adjusted manually</small>
</div>

<div class="form-group" id="taskActualEndGroup" style="display: none;">
    <label class="form-label">Actual Completion Date:</label>
    <input type="date" id="taskActualEndInput" class="form-control">
    <small style="color: #7f8c8d; font-size: 11px;">Auto-filled when task completed, can be adjusted manually</small>
</div>
            <div class="form-group" id="taskProgressGroup" style="display: none;">
                <label class="form-label">Progress (%):</label>
                <input type="number" id="taskProgressInput" class="form-control" min="0" max="100" value="0">
            </div>
            <div class="form-group">
    <label class="form-label">Notes:</label>
    <textarea id="taskNotesInput" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
</div>
<!-- ‚úÖ USER NAME FIELD (MANDATORY) -->
<div class="form-group">
    <label class="form-label">Updated By: <span style="color: #e74c3c; font-weight: 600;">*Required</span></label>
    <input type="text" id="taskUpdatedByInput" class="form-control" placeholder="Enter your name (e.g., John Doe)" required>
    <small style="color: #7f8c8d; font-size: 11px;">Your name will be recorded for this update</small>
</div>
<!-- ‚úÖ TAMBAHKAN MULAI DARI SINI -->

<!-- Sequence Number -->
<div class="form-group">
    <label class="form-label">Sequence Number:</label>
    <input type="number" id="taskSequenceInput" class="form-control" min="1" placeholder="1, 2, 3..." value="1">
    <small style="color: #7f8c8d; font-size: 11px;">Order of execution (1 = first, 2 = second, etc.)</small>
</div>

<!-- Execution Mode -->
<div class="form-group">
    <label class="form-label">Execution Mode:</label>
    <select id="taskExecutionModeInput" class="form-control">
        <option value="sequential">Sequential (wait for dependencies)</option>
        <option value="independent">Independent (can start anytime)</option>
        <option value="parallel">Parallel (can run with others)</option>
    </select>
    <small style="color: #7f8c8d; font-size: 11px;">How this task relates to other tasks</small>
</div>

<!-- Dependencies (shown only for sequential mode) -->
<div class="form-group" id="taskDependenciesGroup" style="display: none;">
    <label class="form-label" id="taskDependenciesLabel">Dependencies (must complete first):</label>
    <div id="taskDependenciesList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f8f9fa;">
        <div style="color: #95a5a6; font-size: 12px;">Select sequential mode to set dependencies</div>
    </div>
    <small style="color: #7f8c8d; font-size: 11px;">This task will be blocked until selected tasks are completed</small>
</div>

<!-- Parallel Tasks (shown only for parallel mode) -->
<div class="form-group" id="taskParallelGroup" style="display: none;">
    <label class="form-label" id="taskParallelLabel">Can run parallel with:</label>
    <div id="taskParallelTasksList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f8f9fa;">
        <div style="color: #95a5a6; font-size: 12px;">Select parallel mode to choose tasks</div>
    </div>
    <small style="color: #7f8c8d; font-size: 11px;">These tasks can be executed at the same time</small>
</div>

<!-- ‚úÖ AKHIR TAMBAHAN -->
        </div>
        <div class="btn-group">
            <button class="btn btn-secondary" onclick="closeTaskEditModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
        </div>
    </div>
</div>

<!-- Report Generation Modal -->
<div id="reportModal" class="modal" style="display: none;">
    <div class="modal-content" style="width: 600px; max-width: 90%;">
        <div class="modal-header">
            <h3 class="modal-title">üìä Generate Progress Report</h3>
            <span class="close" onclick="closeProgressReportModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Equipment Base:</label>
                <input type="text" id="reportEquipmentBase" class="form-control" readonly style="background: #f8f9fa;">
                <small style="color: #7f8c8d; font-size: 11px;">System will find all related groups automatically</small>
            </div>
            
            <div class="form-group">
    <label class="form-label">Related Groups Found:</label>
    <div id="reportGroupsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px; background: #f8f9fa;">
        <!-- Will be populated dynamically -->
    </div>
    <small style="color: #7f8c8d; font-size: 11px;">Check/uncheck groups to include in report</small>
</div>

<div class="form-group">
    <label class="form-label">Report Date:</label>
    <input type="date" id="reportDate" class="form-control" style="background: #ffffff;">
</div>

<!-- ‚úÖ ADD THIS - Highlights & Action Plan -->
<div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #ddd;">
    <div class="form-group">
        <label class="form-label" style="font-weight: 600; color: #2c3e50;">
            ‚ú® Key Highlights (Optional):
        </label>
        <textarea id="reportHighlights" 
                  class="form-control"
                  rows="4"
                  style="resize: vertical; font-size: 12px;"
                  placeholder="Enter key highlights, achievements, or issues...&#10;Example:&#10;- All MR tasks completed ahead of schedule&#10;- CI phase started on time&#10;- Material delivery delayed by 2 days"></textarea>
        <small style="color: #7f8c8d; font-size: 11px; display: block; margin-top: 5px;">
            Use bullet points (-) or numbered list for better formatting
        </small>
    </div>
    
    <div class="form-group">
        <label class="form-label" style="font-weight: 600; color: #2c3e50;">
            üìã Action Plan (Optional):
        </label>
        <textarea id="reportActionPlan" 
                  class="form-control"
                  rows="4"
                  style="resize: vertical; font-size: 12px;"
                  placeholder="Enter action items, next steps, or recommendations...&#10;Example:&#10;1. Start CI commissioning testing by Nov 20&#10;2. Order replacement bearings from vendor&#10;3. Schedule alignment check for turbine"></textarea>
        <small style="color: #7f8c8d; font-size: 11px; display: block; margin-top: 5px;">
            Use numbered list (1, 2, 3) for sequential actions
        </small>
    </div>

<!-- ‚úÖ‚úÖ‚úÖ TAMBAHKAN DI SINI - Milestones Section ‚úÖ‚úÖ‚úÖ -->
<div style="margin-top: 25px; padding-top: 20px; border-top: 2px solid #ddd;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <label class="form-label" style="font-weight: 600; color: #2c3e50; margin: 0;">
            üéØ Project Milestones (Optional):
        </label>
        <button onclick="addMilestone()" type="button"
                style="padding: 5px 12px; font-size: 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
            + Add Milestone
        </button>
    </div>
    <small style="color: #7f8c8d; font-size: 11px; display: block; margin-bottom: 15px;">
        Track key project milestones (e.g., Equipment MOB, Installation Complete, Commissioning, etc.)
    </small>
    
    <div id="milestonesList" style="max-height: 200px; overflow-y: auto;">
        <!-- Milestones will be added dynamically -->
    </div>
</div>
<!-- ‚úÖ‚úÖ‚úÖ AKHIR TAMBAHAN ‚úÖ‚úÖ‚úÖ -->

</div>

</div>
<div class="btn-group">
    <button class="btn btn-secondary" onclick="closeProgressReportModal()">Cancel</button>
    <button class="btn btn-primary" onclick="previewReport()" style="background: #2ecc71;">
        üëÅÔ∏è Preview Report
    </button>
    <button class="btn btn-primary" onclick="generateReport()" style="background: #3498db;">
        üì• Download PDF
    </button>
</div>
</div>
</div>

<!-- Gantt Chart Modal -->
<div id="ganttModal" class="modal">

    <div class="modal-content" style="width: 95%; max-width: 1400px;">
        <div class="modal-header">
            <h3 class="modal-title">üìä Project Timeline - Gantt Chart</h3>
            <span class="close" onclick="closeGanttModal()">&times;</span>
        </div>
        
        <div class="gantt-container">
            <div class="gantt-header">
                <div>
                    <h4 style="margin: 0; font-size: 16px; color: #2c3e50;">Vendor Mobilization Timeline</h4>
                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #7f8c8d;">Visual representation of all tasks and their schedules</p>
                </div>
                <div class="gantt-controls">
    <!-- Search Equipment/Vendor -->
    <div style="display: flex; align-items: center; margin-right: 20px;">
        <label style="font-size: 12px; color: #2c3e50; font-weight: 600; margin-right: 8px;">üîç Search:</label>
        <input type="text" id="ganttSearchBox" placeholder="Equipment or vendor..." style="padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 12px; width: 200px;" oninput="searchGanttChart()">
        <button onclick="clearGanttSearch()" style="margin-left: 5px; padding: 8px 12px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Clear</button>
    </div>
    
    <!-- Date Range Filter -->
    <div style="display: flex; align-items: center; margin-right: 20px; border-left: 2px solid #bdc3c7; padding-left: 20px;">
        <label style="font-size: 12px; color: #2c3e50; font-weight: 600; margin-right: 8px;">üìÖ Date Range:</label>
        <input type="date" id="ganttDateFrom" placeholder="From" style="padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 12px; width: 140px;" onchange="filterGanttByDateRange()">
        <span style="margin: 0 8px; color: #7f8c8d;">to</span>
        <input type="date" id="ganttDateTo" placeholder="To" style="padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 12px; width: 140px;" onchange="filterGanttByDateRange()">
    </div>
    
    <!-- Priority Filter -->
    <div style="display: flex; align-items: center; margin-right: 20px; border-left: 2px solid #bdc3c7; padding-left: 20px;">
        <label style="font-size: 12px; color: #2c3e50; font-weight: 600; margin-right: 5px;">Filter:</label>
        <select id="ganttFilterPriority" style="padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 12px;" onchange="filterGanttChart()">
            <option value="all">All Items</option>
            <option value="1st">1st Priority</option>
            <option value="2nd">2nd Priority</option>
            <option value="3rd">3rd Priority</option>
            <option value="OSBL">OSBL</option>
            <option value="critical">‚ö†Ô∏è Critical Only</option>
        </select>
    </div>

    <!-- View Mode -->
    <div style="display: flex; align-items: center; border-left: 2px solid #bdc3c7; padding-left: 20px;">
        <label style="font-size: 12px; color: #2c3e50; font-weight: 600; margin-right: 8px;">View:</label>
        <button class="gantt-view-btn active" onclick="changeGanttView('Day')">Day</button>
        <button class="gantt-view-btn" onclick="changeGanttView('Week')">Week</button>
        <button class="gantt-view-btn" onclick="changeGanttView('Month')">Month</button>
    </div>
</div>
            </div>
            
            <div id="gantt-chart"></div>
            
            <div class="gantt-legend">
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #95a5a6;"></div>
        <span>Not Started</span>
    </div>
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #27ae60;"></div>
        <span>In Progress / On Track</span>
    </div>
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #3498db;"></div>
        <span>Completed</span>
    </div>
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #f39c12;"></div>
        <span>Delayed Mobilization</span>
    </div>
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #e74c3c;"></div>
        <span>Work Delayed (Prognosa √¢‚Ä∞¬• Target)</span>
    </div>
</div>
        </div>
        
        <div style="margin-top: 20px; text-align: center; padding-top: 15px; border-top: 1px solid #ecf0f1;">
            <button onclick="exportGanttPDFSafe()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; margin-right: 10px;">üìÑ Export as PDF</button>
<small id="exportStatus" style="display: block; margin-top: 8px; color: #7f8c8d; font-size: 10px;"></small>
<button onclick="closeGanttModal()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">Close</button>
        </div>
    </div>
</div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<!-- Frappe Gantt Library -->
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">

<!-- ‚úÖ TAMBAHKAN INI - jsPDF Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<!-- ‚úÖ TAMBAHKAN INI - html2pdf for converting HTML to PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>

// Update current date automatically
        function updateCurrentDate() {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            };
            const currentDate = new Date().toLocaleDateString('en-US', options);
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = currentDate;
            }
        }
        
        // Run on page load
        updateCurrentDate();
        // ===== FIREBASE CONFIGURATION =====
        // IMPORTANT: Replace with your own Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD8JTPzLD2Dp6yWM2Bepjh81mwIp9f0MRM",
  authDomain: "rfcc-dashboard.firebaseapp.com",
  databaseURL: "https://rfcc-dashboard-default-rtdb.firebaseio.com",
  projectId: "rfcc-dashboard",
  storageBucket: "rfcc-dashboard.firebasestorage.app",
  messagingSenderId: "951098160331",
  appId: "1:951098160331:web:6f14f05cb05c9d2ef7574e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Database references
        const projectDataRef = database.ref('projectData');
        const activityHistoryRef = database.ref('activityHistory');

// ===== SIMPLE ONLINE USER COUNTER =====
const myConnectionsRef = database.ref('onlineUsers').push();

const connectedRefCounter = database.ref('.info/connected');
connectedRefCounter.on('value', (snap) => {
    if (snap.val() === true) {
        myConnectionsRef.set(true);
        myConnectionsRef.onDisconnect().remove();
    }
});

database.ref('onlineUsers').on('value', (snapshot) => {
    const count = snapshot.numChildren();
    const counterElement = document.getElementById('onlineCount');
    if (counterElement) {
        counterElement.textContent = count;
    }
});


        // Local state
        let projectData = [];
        let activityHistory = [];
        let currentEditId = null;
        let currentFilter = 'all';
let currentUser = null;  // ‚Üê ADD THIS if not exists
let searchResults = []; // Menyimpan hasil pencarian
let isSearching = false; // Status sedang search atau tidak
window.isGroupedView = false; // ‚úÖ TAMBAHKAN INI
 // ===== AUTO-SORT SETTINGS =====
        let autoSortEnabled = true; // Set false untuk disable auto-sort

// ========== VISUAL MANAGEMENT VARIABLES ========== 
        let vmSettings = {
            layout: 3,
            maxRows: 2,
            selectedEquipment: [],
            displayOptions: {
                showVendor: true,
                showMilestone: true,
                showHighlight: true,
                showSPI: true
            }
        };
        let vmEquipmentData = {};
        let vmSaveTimeout = null;

// Task Tracker Variables
let currentEquipmentTasks = null;
let currentTaskEditId = null;
let onsiteTasks = {}; // Store tasks per equipment

	// Pagination
        let currentTablePage = 1;
	const itemsPerTablePage = 20;

// ===== üÜï TAMBAHKAN FUNCTION updatePaginationInfo() DI SINI =====
function updatePaginationInfo(displayedCount, totalCount) {
    // If parameters not provided, calculate from current state
    if (displayedCount === undefined || totalCount === undefined) {
        const tableRows = document.querySelectorAll('#tableBody tr:not([style*="display: none"])');
        displayedCount = tableRows.length;
        
        // Get total based on current filter
        if (isSearching) {
            totalCount = searchResults.length;
        } else if (currentFilter === 'highlighted') {
            totalCount = projectData.filter(item => item.highlighted).length;
        } else if (currentFilter === 'all') {
            totalCount = projectData.length;
        } else {
            totalCount = projectData.filter(item => item.priority === currentFilter).length;
        }
    }
    
    // Find or create pagination info element
    let paginationInfo = document.getElementById('paginationInfo');
    
    if (!paginationInfo) {
        // Create pagination info container if doesn't exist
        const tableContainer = document.querySelector('.data-table-container');
        if (tableContainer) {
            paginationInfo = document.createElement('div');
            paginationInfo.id = 'paginationInfo';
            paginationInfo.style.cssText = `
                padding: 10px 15px;
                text-align: center;
                font-size: 12px;
                color: #7f8c8d;
                background: #f8f9fa;
                border-top: 1px solid #ecf0f1;
                border-radius: 0 0 4px 4px;
            `;
            tableContainer.parentNode.insertBefore(paginationInfo, tableContainer.nextSibling);
        } else {
            console.warn('Table container not found for pagination info');
            return;
        }
    }
    
    // Update text
    if (totalCount === 0) {
        paginationInfo.textContent = 'No items to display';
        paginationInfo.style.color = '#95a5a6';
    } else if (displayedCount === totalCount) {
        paginationInfo.innerHTML = `Showing <strong>${totalCount}</strong> item${totalCount !== 1 ? 's' : ''}`;
        paginationInfo.style.color = '#27ae60';
    } else {
        const startNum = (currentTablePage - 1) * itemsPerTablePage + 1;
        const endNum = Math.min(currentTablePage * itemsPerTablePage, totalCount);
        paginationInfo.innerHTML = `Showing <strong>${startNum}-${endNum}</strong> of <strong>${totalCount}</strong> items`;
        paginationInfo.style.color = '#3498db';
    }
}
// ===== AKHIR PENAMBAHAN =====

        // Connection monitoring
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (snap.val() === true) {
                statusElement.className = 'connection-status connected';
                statusText.textContent = 'Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusText.textContent = 'Disconnected';
            }
        });

    // ===== FIREBASE REAL-TIME LISTENERS =====
    
    // Listen for project data changes
projectDataRef.on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
        // ‚≠ê Preserve originalOrder jika sudah ada
        const newData = Object.keys(data).map((key, index) => {
            const existingItem = projectData.find(p => p.firebaseKey === key);
            return {
                firebaseKey: key,
                originalOrder: existingItem ? existingItem.originalOrder : index, // ‚Üê PRESERVE!
                ...data[key]
            };
        });
        
        projectData = newData;
        
        // Debug log untuk item yang baru diupdate
        const recentUpdates = projectData.filter(item => {
            if (!item.lastUpdated) return false;
            const timeSince = Date.now() - new Date(item.lastUpdated).getTime();
            return timeSince < 5 * 60 * 1000; // < 5 menit
        });
        
        if (recentUpdates.length > 0) {
            console.log(`üîî ${recentUpdates.length} items recently updated:`);
            recentUpdates.forEach(item => {
                const timeSince = Date.now() - new Date(item.lastUpdated).getTime();
                console.log(`  - ${item.equipment}: ${Math.floor(timeSince/1000)}s ago`);
            });
        }
    } else {
        projectData = [];
    }
    
    console.log('üîÑ Firebase sync complete, re-rendering table...');
    populateTable();
    updateStats();
});

    // Listen for activity history changes
    activityHistoryRef.orderByChild('timestamp').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            activityHistory = Object.keys(data).map(key => ({
                firebaseKey: key,
                ...data[key]
            })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } else {
            activityHistory = [];
        }
        populateEquipmentHistoryFilter();
        filterEquipmentHistory();
    });


// Listen for onsite tasks changes
const onsiteTasksRef = database.ref('onsiteTasks');
onsiteTasksRef.on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
        onsiteTasks = data;
    } else {
        onsiteTasks = {};
    }
});

    // ===== INITIALIZATION =====
   document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();

// Initialize dropdowns
    initDropdowns();  // ‚Üê TAMBAHKAN BARIS INI    

    projectDataRef.once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            if (confirm('Database is empty. Would you like to initialize with sample data?')) {
                initializeSampleData();
            }
        }
    });
});

    function initializeSampleData() {
        const sampleData = [
    { id: 1, no: 1, priority: "2nd", equipment: "Air Blower Expander (K-052-02)", vendor: "MAN-RMS", disc: "CI", task: "CI", taskName: "FAT Inspection", status: "Contract Issue", contract: "Quotation", visa: "Not Applied", targetDate: "2025-10-25", mobDate: "End Oct", targetCompDate: "2025-11-15", prognosaCompDate: "2025-11-20", progress: 0, mitigationPlan: "Expedite quotation process with vendor" },
    { id: 2, no: 2, priority: "2nd", equipment: "Air Blower Anti-surge (K-052-01)", vendor: "MAN-Honeywell", disc: "CI", task: "CI", taskName: "SAT Testing", status: "Contract Issue", contract: "Quotation", visa: "Not Applied", targetDate: "2025-11-01", mobDate: "Early Nov", targetCompDate: "2025-11-20", prognosaCompDate: "2025-11-25", progress: 0, mitigationPlan: "" },
    { id: 3, no: 3, priority: "2nd", equipment: "WGC Compressor I-SAT (K-052-03)", vendor: "EETC", disc: "CI", task: "CI", taskName: "Installation SAT", status: "Payment Issue", contract: "Ongoing", visa: "Not Applied", targetDate: "2025-10-10", mobDate: "Oct 15", targetCompDate: "2025-10-25", prognosaCompDate: "2025-10-28", progress: 0, mitigationPlan: "" },
    { id: 4, no: 4, priority: "2nd", equipment: "WGC Compressor Control (K-052-03)", vendor: "EETC", disc: "COM", task: "COM", taskName: "Commissioning", status: "Payment Issue", contract: "Waiting AP", visa: "Not Applied", targetDate: "2025-10-10", mobDate: "Oct 15", targetCompDate: "2025-10-25", prognosaCompDate: "2025-10-30", progress: 0, mitigationPlan: "" },
    { id: 5, no: 5, priority: "2nd", equipment: "Flue Gas Scrubber", vendor: "BELCO", disc: "CI", task: "CI", taskName: "Performance Test", status: "VISA Processing", contract: "Done", visa: "Processing", targetDate: "2025-10-05", mobDate: "Oct 7", targetCompDate: "2025-10-20", prognosaCompDate: "2025-10-22", progress: 0, mitigationPlan: "" }
];

        sampleData.forEach(item => {
            projectDataRef.push(item);
        });

        activityHistoryRef.push({
            id: 1,
            timestamp: new Date().toISOString(),
            type: 'system',
            category: 'SYSTEM',
            title: 'Database Initialized',
            equipmentId: null,
            equipment: 'System',
            vendor: 'System',
            description: 'Sample data loaded successfully',
            notes: 'Database initialized with sample project data',
            user: 'System',
            icon: 'üéâ',
            color: '#3498db'
        });

        showNotification('Sample data initialized successfully!', 'success');
    }

    // ===== EVENT LISTENERS =====
   function setupEventListeners() {
    // DISABLED: Conflict dengan onclick di HTML
    // document.querySelectorAll('.filter-btn').forEach(btn => {
    //     btn.addEventListener('click', function() {
    //         filterByPriority(this.getAttribute('data-filter'));
    //     });
    // });
    
    const searchBox = document.getElementById('searchBox');

    if (searchBox) {
        searchBox.addEventListener('input', searchTable);
        searchBox.addEventListener('keyup', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                searchTable();
            }
        });
    }

    // ‚≠ê TAMBAHKAN CODE BARU INI DI SINI ‚≠ê
    // ===== HANDLE CUSTOM DISCIPLINE INPUT =====
    const modalDiscSelect = document.getElementById('modalDisc');
    const customDiscGroup = document.getElementById('customDiscGroup');
    const customDiscInput = document.getElementById('customDiscInput');
    
    if (modalDiscSelect) {
        modalDiscSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                if (customDiscGroup) customDiscGroup.style.display = 'block';
                if (customDiscInput) customDiscInput.focus();
            } else {
                if (customDiscGroup) customDiscGroup.style.display = 'none';
                if (customDiscInput) customDiscInput.value = '';
            }
        });
    }

       const addItemBtn = document.getElementById('addItemBtn');
const exportBtn = document.getElementById('exportBtn');
const viewTimelineBtn = document.getElementById('viewTimelineBtn');
const showHistoryBtn = document.getElementById('showAllHistoryBtn');
const closeModalBtn = document.getElementById('closeModal');
const saveButton = document.getElementById('saveButton');

if (addItemBtn) addItemBtn.addEventListener('click', openAddModal);
if (exportBtn) exportBtn.addEventListener('click', exportToPDF);
if (viewTimelineBtn) viewTimelineBtn.addEventListener('click', openGanttModal);
if (showHistoryBtn) showHistoryBtn.addEventListener('click', showFullHistory);
if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
if (saveButton) saveButton.addEventListener('click', saveUpdate);

        window.addEventListener('click', function(event) {
    const updateModal = document.getElementById('updateModal');
    const historyModal = document.getElementById('historyModal');
    const taskTrackerModal = document.getElementById('taskTrackerModal');
    const taskEditModal = document.getElementById('taskEditModal');
    const ganttModal = document.getElementById('ganttModal');
    const progressReportModal = document.getElementById('progressReportModal');
    
    if (event.target === updateModal) {
        closeModal();
    }
    if (event.target === historyModal) {
        closeHistoryModal();
    }
    if (event.target === taskTrackerModal) {
        closeTaskTracker();
    }
    if (event.target === taskEditModal) {
        closeTaskEditModal();
    }
    if (event.target === ganttModal) {
        closeGanttModal();
    }
    if (event.target === progressReportModal) {
        closeProgressReport();
    }
});
    }

// ===== GANTT CHART FUNCTIONS =====
let ganttInstance = null;
let currentGanttView = 'Week';
let ganttSearchTerm = '';
let ganttDateFrom = null;
let ganttDateTo = null;

function openGanttModal() {
    document.getElementById('ganttModal').style.display = 'block';
    
    // Reset filters
    document.getElementById('ganttSearchBox').value = '';
    document.getElementById('ganttDateFrom').value = '';
    document.getElementById('ganttDateTo').value = '';
    ganttSearchTerm = '';
    ganttDateFrom = null;
    ganttDateTo = null;
    
    // Wait for modal to be visible before rendering
    setTimeout(() => {
        renderGanttChart();
    }, 100);
}

function closeGanttModal() {
    document.getElementById('ganttModal').style.display = 'none';
    if (ganttInstance) {
        ganttInstance = null;
    }
}

function prepareGanttData() {
    const ganttTasks = [];
    
    // Apply priority filter
    let filteredData = projectData;
    if (currentGanttFilter === 'critical') {
        filteredData = projectData.filter(item => item.highlighted);
    } else if (currentGanttFilter !== 'all') {
        filteredData = projectData.filter(item => item.priority === currentGanttFilter);
    }
    
    // Apply search filter
    if (ganttSearchTerm) {
        const searchLower = ganttSearchTerm.toLowerCase();
        filteredData = filteredData.filter(item => 
            item.equipment.toLowerCase().includes(searchLower) ||
            item.vendor.toLowerCase().includes(searchLower)
        );
    }
    
    // Apply date range filter
    if (ganttDateFrom || ganttDateTo) {
        filteredData = filteredData.filter(item => {
            const itemStartDate = item.targetDate ? new Date(item.targetDate) : null;
            const itemEndDate = item.targetCompDate || item.prognosaCompDate ? 
                                new Date(item.targetCompDate || item.prognosaCompDate) : null;
            
            if (!itemStartDate) return false;
            
            let passFilter = true;
            
            // Check if item start date is within range
            if (ganttDateFrom) {
                const fromDate = new Date(ganttDateFrom);
                passFilter = passFilter && itemStartDate >= fromDate;
            }
            
            if (ganttDateTo) {
                const toDate = new Date(ganttDateTo);
                // Check if either start or end date is within range
                passFilter = passFilter && (
                    itemStartDate <= toDate || 
                    (itemEndDate && itemEndDate <= toDate)
                );
            }
            
            return passFilter;
        });
    }
    
    filteredData.forEach((item, index) => {
        // Parse dates - use different dates if not set to avoid stacking
        let startDate = item.targetDate;
        
        // If no target date, create staggered dates based on index to avoid overlapping
        if (!startDate) {
            const today = new Date();
            today.setDate(today.getDate() + (index * 3)); // Spread tasks by 3 days each
            startDate = today.toISOString().split('T')[0];
        }
        
        let endDate = item.targetCompDate || item.prognosaCompDate;
        
        // If no end date, add 7 days to start date
        if (!endDate) {
            const start = new Date(startDate);
            start.setDate(start.getDate() + 7);
            endDate = start.toISOString().split('T')[0];
        }
        
        // Ensure end date is after start date
        if (new Date(endDate) <= new Date(startDate)) {
            const start = new Date(startDate);
            start.setDate(start.getDate() + 7);
            endDate = start.toISOString().split('T')[0];
        }
        
        // Determine task color based on status
        // Determine task color based on status

// Determine task color based on status
let customClass = '';

// Priority 1: Check completion status
if (item.status.includes('Completed')) {
    customClass = 'bar-completed';
}
// Priority 2: Check for work delay (target comp vs prognosa comp)
else if (item.targetCompDate && item.prognosaCompDate) {
    const targetComp = new Date(item.targetCompDate);
    const prognosaComp = new Date(item.prognosaCompDate);
    
    // Work Delayed: Prognosa >= Target (sama atau lebih lambat)
    if (prognosaComp >= targetComp) {
        customClass = 'bar-workdelayed'; // Merah - Work Delayed
    } 
    // On Track: Prognosa < Target (lebih cepat dari target)
    else {
        customClass = 'bar-inprogress'; // Hijau - On track
    }
}
// Priority 3: Check if onsite/in progress (no prognosa data yet)
else if (item.status.includes('Onsite')) {
    customClass = 'bar-inprogress';
}
// Priority 4: Check for mobilization delay (target mob vs actual mob)
else if (item.targetDate && item.mobDate) {
    const mobDateStatus = getDateStatus(item.targetDate, item.mobDate);
    if (mobDateStatus.status.includes('DELAYED')) {
        customClass = 'bar-delayedmob'; // Kuning - Delayed MOB
    } else {
        customClass = 'bar-notstarted'; // Abu-abu - Not started
    }
}
// Priority 5: Default - Not started
else {
    customClass = 'bar-notstarted'; // Abu-abu - Not started
}
        
        ganttTasks.push({
            id: item.firebaseKey || `task-${index}`,
            name: `${item.equipment} (${item.vendor})`,
            start: startDate,
            end: endDate,
            progress: item.progress || 0,
            custom_class: customClass,
            dependencies: ''
        });
    });
    
    return ganttTasks;
}

function renderGanttChart() {
    // Show loading
    document.getElementById('gantt-chart').innerHTML = '<div style="padding: 60px; text-align: center; color: #7f8c8d;"><div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>Loading timeline...</div>';
    
    setTimeout(function() {
        const tasks = prepareGanttData();
        
        if (tasks.length === 0) {
            document.getElementById('gantt-chart').innerHTML = '<div style="padding: 40px; text-align: center; color: #95a5a6;">No tasks available for timeline view</div>';
            return;
        }
        
        // Destroy existing instance
        if (ganttInstance) {
            document.getElementById('gantt-chart').innerHTML = '';
        }
        
        // Create new Gantt instance
      // Create new Gantt instance
ganttInstance = new Gantt("#gantt-chart", tasks, {
    view_mode: currentGanttView,
    bar_height: 30,
    header_height: 65,
    column_width: 60,
    step: 24,
    view_modes: ['Day', 'Week', 'Month'],
    bar_corner_radius: 3,
    arrow_curve: 5,
    padding: 20,
    date_format: 'DD MMM',
    language: 'en',
    on_click: function(task) {
        showMitigationTooltip(task);
    },
    on_view_change: function(mode) {
        currentGanttView = mode;
    },
    on_date_change: function(task, start, end) {
        console.log('Date changed:', task, start, end);
    }
});

// Force apply colors and white background after render
setTimeout(function() {
    applyGanttColors();
    attachGanttHoverEvents();
    enhanceGanttHeader(); // Keep existing function
    
    // Force white background on SVG for PDF export
    const svgElement = document.querySelector('#gantt-chart svg');
    if (svgElement) {
        svgElement.style.backgroundColor = 'white';
        svgElement.style.background = 'white';
        
        // Add white background rect if not exists
        const existingRect = svgElement.querySelector('rect[data-background="white"]');
        if (!existingRect) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', '100%');
            rect.setAttribute('height', '100%');
            rect.setAttribute('fill', 'white');
            rect.setAttribute('data-background', 'white');
            svgElement.insertBefore(rect, svgElement.firstChild);
        }
    }
}, 200);

// Force apply colors after render

    }, 100);
}

// NEW FUNCTION: Apply colors manually to Gantt bars
function applyGanttColors() {
    const tasks = prepareGanttData();
    
    tasks.forEach(function(task) {
        const barElement = document.querySelector('.gantt .bar-wrapper[data-id="' + task.id + '"] .bar');
        
        if (barElement) {
    let color = '#95a5a6'; // default gray - Not Started
    
    if (task.custom_class === 'bar-completed') {
        color = '#3498db'; // Biru - Completed
    } else if (task.custom_class === 'bar-inprogress') {
        color = '#27ae60'; // Hijau - In Progress
    } else if (task.custom_class === 'bar-delayedmob') {
        color = '#f39c12'; // Kuning - Delayed MOB
    } else if (task.custom_class === 'bar-workdelayed') {
        color = '#e74c3c'; // Merah - Work Delayed
    } else if (task.custom_class === 'bar-notstarted') {
        color = '#95a5a6'; // Abu-abu - Not Started
    }
    
    barElement.setAttribute('fill', color);
    barElement.style.fill = color;
}
    });
}

// Function to show mitigation plan tooltip
function showMitigationTooltip(task) {
    const item = projectData.find(p => p.firebaseKey === task.id);
    
    if (!item) return;
    
    // Only show for work delayed tasks
   // Only show for work delayed tasks with mitigation plan
if (task.custom_class !== 'bar-workdelayed' || !item.mitigationPlan || item.mitigationPlan.trim() === '') {
    return;
}
    
    if (item.mitigationPlan && item.mitigationPlan.trim() !== '') {
        alert('‚ö†Ô∏è WORK MITIGATION PLAN\n\n' + 
              'Equipment: ' + item.equipment + '\n' +
              'Vendor: ' + item.vendor + '\n\n' +
              'Mitigation Plan:\n' + item.mitigationPlan);
    } else {
        showNotification('No mitigation plan available for this task', 'error');
    }
}

// Function to attach hover events to Gantt bars
function attachGanttHoverEvents() {
    // Remove existing tooltip if any
    const existingTooltip = document.getElementById('ganttTooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }
    
    // Create tooltip element
    const tooltip = document.createElement('div');
    tooltip.id = 'ganttTooltip';
    tooltip.className = 'gantt-tooltip';
    document.body.appendChild(tooltip);
    
    // Get all gantt bars
    const bars = document.querySelectorAll('.gantt .bar-wrapper');
    
    bars.forEach(bar => {
        const taskId = bar.getAttribute('data-id');
        const task = prepareGanttData().find(t => t.id === taskId);
        const item = projectData.find(p => p.firebaseKey === taskId);
        
        if (!item) return;
        
        // Only add hover for work delayed tasks with mitigation plan
        if (task && task.custom_class === 'bar-workdelayed' && item.mitigationPlan) {
            bar.style.cursor = 'pointer';
            
            bar.addEventListener('mouseenter', function(e) {
                const targetComp = item.targetCompDate ? formatDateForDisplay(item.targetCompDate) : 'N/A';
                const prognosaComp = item.prognosaCompDate ? formatDateForDisplay(item.prognosaCompDate) : 'N/A';
                
                tooltip.innerHTML = `
                    <div class="gantt-tooltip-header">
                        ‚ö†Ô∏è Work Delayed - Mitigation Plan
                    </div>
                    <div style="font-size: 11px; margin-bottom: 8px;">
                        <strong>${item.equipment}</strong><br>
                        <span style="color: #666;">${item.vendor}</span>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 10px;">
                        <strong>Target Completion:</strong> ${targetComp}<br>
                        <strong>Prognosa Completion:</strong> ${prognosaComp}
                    </div>
                    <div class="gantt-tooltip-content">${item.mitigationPlan}</div>
                    <div class="gantt-tooltip-footer">Click for more details</div>
                `;
                tooltip.classList.add('active');
                
                // Position tooltip near cursor
                const rect = bar.getBoundingClientRect();
                tooltip.style.left = (rect.left + window.scrollX) + 'px';
                tooltip.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            });
            
            bar.addEventListener('mouseleave', function() {
                tooltip.classList.remove('active');
            });
        }
    });
}

// NEW FUNCTION: Enhance Gantt Header with Better Styling
function enhanceGanttHeader() {
    // Add today marker
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    // Style header cells
    const headerCells = document.querySelectorAll('.gantt .grid-header .grid-cell');
    headerCells.forEach(function(cell) {
        cell.style.fontWeight = '700';
        cell.style.fontSize = '11px';
        cell.style.borderBottom = '2px solid #3498db';
        cell.style.padding = '12px 8px';
    });
    
    // Add visual separator for months
    const upperTextCells = document.querySelectorAll('.gantt .upper-text');
    upperTextCells.forEach(function(cell) {
        cell.style.fontSize = '13px';
        cell.style.borderBottom = '2px solid #34495e';
        cell.style.padding = '10px';
        cell.style.letterSpacing = '0.5px';
    });
    
    // Highlight weekends if in day/week view
    if (currentGanttView === 'Day' || currentGanttView === 'Week') {
        const dateCells = document.querySelectorAll('.gantt .lower-text');
        dateCells.forEach(function(cell) {
            const dateText = cell.textContent;
            // Simple weekend detection (you can enhance this)
            if (dateText.includes('Sat') || dateText.includes('Sun')) {
                cell.style.background = '#f8f9fa';
                cell.style.color = '#95a5a6';
            }
        });
    }
    
    console.log('Gantt header enhanced');
}

function changeGanttView(viewMode) {
    currentGanttView = viewMode;
    
    // Update active button
    document.querySelectorAll('.gantt-view-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Re-render gantt
    if (ganttInstance) {
        ganttInstance.change_view_mode(viewMode);
        
        // Re-apply colors and events after view change
        setTimeout(function() {
            applyGanttColors();
            attachGanttHoverEvents(); // Re-attach hover events
        }, 200);
    }
}

function jumpToGanttDate() {
    const selectedDate = document.getElementById('ganttDatePicker').value;
    if (!selectedDate || !ganttInstance) return;
    
    const dateObj = new Date(selectedDate);
    const tasks = prepareGanttData();
    
    // Find task closest to this date
    const closestTask = tasks.reduce((prev, curr) => {
        const prevDiff = Math.abs(new Date(prev.start) - dateObj);
        const currDiff = Math.abs(new Date(curr.start) - dateObj);
        return currDiff < prevDiff ? curr : prev;
    });
    
    if (closestTask) {
        // Alternative: Scroll to task bar manually using DOM
        const taskBar = document.querySelector(`.gantt .bar-wrapper[data-id="${closestTask.id}"]`);
        if (taskBar) {
            taskBar.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'center'
            });
            
            // Highlight the bar briefly
            const bar = taskBar.querySelector('.bar');
            if (bar) {
                const originalFill = bar.style.fill;
                bar.style.fill = '#fff';
                bar.style.stroke = '#000';
                bar.style.strokeWidth = '3';
                
                setTimeout(() => {
                    bar.style.fill = originalFill;
                    bar.style.stroke = '';
                    bar.style.strokeWidth = '';
                }, 1000);
            }
            
            showNotification(`Jumped to ${formatDateForDisplay(selectedDate)} - ${closestTask.name}`, 'success');
        } else {
            showNotification('Task not found in current view', 'error');
        }
    }
}

let currentGanttFilter = 'all';

function filterGanttChart() {
    currentGanttFilter = document.getElementById('ganttFilterPriority').value;
    renderGanttChart();
}

// NEW FUNCTION: Search Gantt Chart by Equipment/Vendor
function searchGanttChart() {
    ganttSearchTerm = document.getElementById('ganttSearchBox').value.trim();
    renderGanttChart();
    
    if (ganttSearchTerm) {
        const matchCount = prepareGanttData().length;
        showNotification(`Found ${matchCount} item(s) matching "${ganttSearchTerm}"`, 'success');
    }
}

// NEW FUNCTION: Clear Gantt Search
function clearGanttSearch() {
    document.getElementById('ganttSearchBox').value = '';
    ganttSearchTerm = '';
    renderGanttChart();
    showNotification('Search cleared', 'success');
}

// NEW FUNCTION: Filter Gantt by Date Range
function filterGanttByDateRange() {
    ganttDateFrom = document.getElementById('ganttDateFrom').value;
    ganttDateTo = document.getElementById('ganttDateTo').value;
    
    // Validate date range
    if (ganttDateFrom && ganttDateTo && new Date(ganttDateFrom) > new Date(ganttDateTo)) {
        showNotification('‚ö†Ô∏è "From" date cannot be later than "To" date', 'error');
        document.getElementById('ganttDateTo').value = '';
        ganttDateTo = null;
        return;
    }
    
    renderGanttChart();
    
    const matchCount = prepareGanttData().length;
    if (ganttDateFrom || ganttDateTo) {
        const fromStr = ganttDateFrom ? formatDateForDisplay(ganttDateFrom) : 'Start';
        const toStr = ganttDateTo ? formatDateForDisplay(ganttDateTo) : 'End';
        showNotification(`Showing ${matchCount} task(s) from ${fromStr} to ${toStr}`, 'success');
    }
}

function exportGanttPDF() {
    showNotification('Preparing timeline report...', 'success');
    
    const printWindow = window.open('', '_blank');
    const currentDate = new Date().toLocaleString();
    const tasks = prepareGanttData();
    
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Project Timeline Report</title>
        <meta charset="UTF-8">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                font-size: 11px; 
                background: white;
                color: #333;
            }
            
            .header { 
                text-align: center; 
                margin-bottom: 30px; 
                border-bottom: 3px solid #34495e; 
                padding-bottom: 15px;
            }
            
            .header h1 { 
                margin: 0; 
                font-size: 24px; 
                color: #2c3e50;
                font-weight: 700;
            }
            
            .header p {
                margin: 5px 0;
                color: #7f8c8d;
                font-size: 12px;
            }
            
            .info-box {
                background: #ecf0f1;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 30px;
            }
            
            .info-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
                text-align: center;
            }
            
            .info-item {
                background: white;
                padding: 15px;
                border-radius: 6px;
                border-left: 4px solid #3498db;
            }
            
            .info-number {
                font-size: 32px;
                font-weight: 700;
                color: #2c3e50;
            }
            
            .info-label {
                font-size: 11px;
                color: #7f8c8d;
                margin-top: 5px;
            }
            
            .legend { 
                display: flex; 
                gap: 20px; 
                margin: 20px 0; 
                font-size: 12px; 
                justify-content: center;
                flex-wrap: wrap;
                background: #f8f9fa;
                padding: 20px;
                border: 1px solid #ecf0f1;
                border-radius: 8px;
            }
            
            .legend-item { 
                display: flex; 
                align-items: center; 
                gap: 10px;
            }
            
            .legend-color { 
                width: 24px; 
                height: 24px; 
                border-radius: 4px;
                border: 1px solid #ddd;
            }
            
            table { 
                width: 100%; 
                border-collapse: collapse; 
                margin-top: 30px; 
                background: white;
            }
            
            th, td { 
                border: 1px solid #34495e; 
                padding: 12px 10px; 
                text-align: left; 
                font-size: 10px;
            }
            
            th { 
                background: #34495e; 
                color: white;
                font-weight: 700;
            }
            
            tr:nth-child(even) { 
                background: #f8f9fa;
            }
            
            .priority-badge {
                padding: 4px 8px;
                border-radius: 3px;
                font-size: 9px;
                font-weight: 700;
                color: white;
                display: inline-block;
            }
            
            .priority-1st { background: #dc3545; }
            .priority-2nd { background: #fd7e14; }
            .priority-3rd { background: #198754; }
            .priority-OSBL { background: #0d6efd; }
            
            .status-indicator {
                width: 100%;
                height: 8px;
                background: #ecf0f1;
                border-radius: 4px;
                overflow: hidden;
                margin-top: 5px;
            }
            
            .status-fill {
                height: 100%;
                transition: width 0.3s;
            }
            
            .footer {
                margin-top: 50px;
                padding-top: 20px;
                border-top: 2px solid #34495e;
                text-align: center;
            }
            /* Action Dropdown Animation */
.action-dropdown {
    animation: dropdownFadeIn 0.2s ease-out;
}

@keyframes dropdownFadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* End of Dropdown Styles */

/* End of Dropdown Styles */

/* ===== RECENT UPDATE HIGHLIGHT STYLES ===== */
.data-table tr.recently-updated {
    position: relative;
    background: rgba(46, 204, 113, 0.03) !important;
    border-left: 3px solid #27ae60 !important;
    animation: pulseGlow 2s ease-in-out;
}

.data-table tr.recently-updated::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, #27ae60, #2ecc71);
    box-shadow: 0 0 8px rgba(39, 174, 96, 0.4);
}

.recent-update-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 9px;
    font-weight: 600;
    margin-left: 6px;
    box-shadow: 0 2px 4px rgba(39, 174, 96, 0.2);
    animation: slideIn 0.3s ease-out;
}

.recent-update-time {
    font-size: 9px;
    color: #27ae60;
    font-weight: 500;
    margin-left: 8px;
    opacity: 0.8;
}

@keyframes pulseGlow {
    0%, 100% {
        box-shadow: 0 0 0 rgba(39, 174, 96, 0);
    }
    50% {
        box-shadow: 0 0 15px rgba(39, 174, 96, 0.3);
    }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Fade out animation after 30 seconds */
.data-table tr.recently-updated.fading {
    animation: fadeOutHighlight 2s ease-out forwards;
}

@keyframes fadeOutHighlight {
    from {
        background: rgba(46, 204, 113, 0.03);
        border-left-color: #27ae60;
    }
    to {
        background: transparent;
        border-left-color: transparent;
    }
}

            @media print {
                body {
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>üìä PROJECT TIMELINE REPORT</h1>
            <p style="font-size: 14px; font-weight: 600; margin-top: 10px;">RFCC Vendor Mobilization Timeline</p>
            <p style="font-size: 11px; margin-top: 8px;">Generated on: ${currentDate}</p>
            <p style="font-size: 11px;">Filter: ${currentGanttFilter === 'all' ? 'All Items' : currentGanttFilter + ' Priority'} | Total Tasks: ${tasks.length}</p>
        </div>
        
        <div class="info-box">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-number">${tasks.length}</div>
                    <div class="info-label">Total Tasks</div>
                </div>
                <div class="info-item" style="border-left-color: #27ae60;">
                    <div class="info-number" style="color: #27ae60;">${tasks.filter(t => t.custom_class === 'bar-inprogress').length}</div>
                    <div class="info-label">In Progress</div>
                </div>
                <div class="info-item" style="border-left-color: #3498db;">
                    <div class="info-number" style="color: #3498db;">${tasks.filter(t => t.custom_class === 'bar-completed').length}</div>
                    <div class="info-label">Completed</div>
                </div>
                <div class="info-item" style="border-left-color: #e74c3c;">
                    <div class="info-number" style="color: #e74c3c;">${tasks.filter(t => t.custom_class === 'bar-workdelayed').length}</div>
                    <div class="info-label">Work Delayed</div>
                </div>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #95a5a6;"></div>
                <span><strong>Not Started</strong></span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #27ae60;"></div>
                <span><strong>In Progress / On Track</strong></span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span><strong>Completed</strong></span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12;"></div>
                <span><strong>Delayed Mobilization</strong></span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span><strong>Work Delayed</strong></span>
            </div>
        </div>
        
        <h2 style="margin-top: 40px; font-size: 16px; border-bottom: 3px solid #34495e; padding-bottom: 10px; color: #2c3e50;">üìã Task Timeline Details</h2>
        
        <table>
            <thead>
                <tr>
    <th style="width: 2%;">No</th>
    <th style="width: 3%;">Priority</th>
    <th style="width: 14%;">Equipment</th>
    <th style="width: 5%;">Vendor</th>
    <th style="width: 3%;">Disc</th>
    <th style="width: 18%;">Task</th>
    <th style="width: 7%;">Status</th>
    <th style="width: 6%;">Contract</th>
    <th style="width: 5%;">VISA</th>
    <th style="width: 7%;">Target MOB<br>Date</th>
    <th style="width: 6%;">MOB Date</th>
    <th style="width: 7%;">MOB Status</th>
    <th style="width: 6%;">Target Comp.<br>Date</th>
    <th style="width: 6%;">Prognosa Comp.<br>Date</th>
    <th style="width: 4%;">Progress</th>
    <th style="width: 11%;">Actions</th>
</tr>
            </thead>
            <tbody>
                ${tasks.map(function(task, index) {
                    const item = projectData.find(function(p) { return p.firebaseKey === task.id; });
                    if (!item) return '';
                    
                    const duration = Math.ceil((new Date(task.end) - new Date(task.start)) / (1000 * 60 * 60 * 24));
                    
                    let statusColor = '#95a5a6';
                    let statusText = 'Not Started';
                    
                    if (task.custom_class === 'bar-completed') {
                        statusColor = '#3498db';
                        statusText = 'Completed';
                    } else if (task.custom_class === 'bar-inprogress') {
                        statusColor = '#27ae60';
                        statusText = 'In Progress';
                    } else if (task.custom_class === 'bar-workdelayed') {
                        statusColor = '#e74c3c';
                        statusText = 'Work Delayed';
                    } else if (task.custom_class === 'bar-delayedmob') {
                        statusColor = '#f39c12';
                        statusText = 'Delayed MOB';
                    }
                    
                    return `
                    <tr>
                        <td style="text-align: center;">${index + 1}</td>
                        <td style="font-weight: 600;">${item.equipment}</td>
                        <td><strong>${item.vendor}</strong></td>
                        <td style="text-align: center;"><span class="priority-badge priority-${item.priority}">${item.priority}</span></td>
                        <td>${formatDateForDisplay(task.start)}</td>
                        <td>${formatDateForDisplay(task.end)}</td>
                        <td style="text-align: center;">${duration} days</td>
                        <td>
                            <strong style="font-size: 11px;">${task.progress}%</strong>
                            <div class="status-indicator">
                                <div class="status-fill" style="width: ${task.progress}%; background: ${statusColor};"></div>
                            </div>
                        </td>
                        <td style="color: ${statusColor}; font-weight: 600;">${statusText}</td>
                    </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
        
        <div style="margin-top: 40px; padding: 20px; background: #fff3cd; border-left: 4px solid #f39c12; border-radius: 6px;">
            <h3 style="margin: 0 0 10px 0; font-size: 13px; color: #856404;">‚ÑπÔ∏è Note on Timeline Visualization</h3>
            <p style="font-size: 11px; color: #856404; line-height: 1.6;">
                This report contains detailed task information in table format. For visual Gantt chart representation, 
                please view the timeline directly in the web application where interactive features are available.
            </p>
        </div>
        
        <div class="footer">
            <p style="font-size: 14px; font-weight: bold; color: #2c3e50;">Developed by TS-KPB</p>
            <p style="font-size: 11px; color: #7f8c8d; margin-top: 5px;">¬© 2025 All Rights Reserved</p>
            <p style="font-size: 10px; color: #95a5a6; margin-top: 10px;">RFCC Vendor Mobilization Tracking System</p>
        </div>
    </body>
    </html>
    `;
    
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    
    printWindow.onload = function() {
        setTimeout(function() {
            printWindow.print();
        }, 500);
    };
}

function refreshGanttBeforeExport() {
    showNotification('Refreshing timeline for export...', 'success');
    
    // Re-render Gantt
    renderGanttChart();
    
    // Wait for render to complete, then export
    setTimeout(function() {
        const ganttSVG = document.querySelector('#gantt-chart svg');
        
        if (ganttSVG) {
            showNotification('Timeline loaded. Starting export...', 'success');
            setTimeout(function() {
                exportGanttPDF();
            }, 1000);
        } else {
            showNotification('‚ùå Timeline failed to load. Please try again.', 'error');
        }
    }, 2000);
}


     
// Safe export function with loading check
function exportGanttPDFSafe() {
    const ganttSVG = document.querySelector('#gantt-chart svg');
    const statusEl = document.getElementById('exportStatus');
    
    if (!ganttSVG) {
        showNotification('‚ö†Ô∏è Timeline not loaded yet. Please wait...', 'error');
        if (statusEl) statusEl.textContent = '‚ö†Ô∏è Timeline not loaded. Please wait a moment...';
        return;
    }
    
    // Check if SVG has content
    const bbox = ganttSVG.getBoundingClientRect();
    if (bbox.width < 100 || bbox.height < 100) {
        showNotification('‚ö†Ô∏è Timeline still loading. Please wait...', 'error');
        if (statusEl) statusEl.textContent = '‚ö†Ô∏è Timeline still rendering. Please wait...';
        return;
    }
    
    // SVG is ready, proceed with export
    if (statusEl) statusEl.textContent = '‚úÖ Timeline ready. Preparing export...';
    showNotification('‚úÖ Timeline ready. Exporting...', 'success');
    
    setTimeout(function() {
        exportGanttPDF();
    }, 500);
}

    // ===== UTILITY FUNCTIONS =====
    function getDateStatus(targetDate, mobDate) {
        if (!targetDate || !mobDate) return { status: '-', class: '' };
        
        const target = new Date(targetDate);
        const mob = new Date(parseDateString(mobDate));
        
        if (mob <= target) {
            return { status: 'ON TIME', class: 'status-ontime' };
        } else {
            const diffDays = Math.ceil((mob - target) / (1000 * 60 * 60 * 24));
            return { status: `DELAYED ${diffDays}d`, class: 'status-delayed' };
        }
    }

    function parseDateString(dateStr) {
        if (!dateStr) return null;
        
        if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return dateStr;
        }
        
        const monthMap = {
            'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
            'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
            'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
        };
        
        const currentYear = new Date().getFullYear();
        const monthMatch = dateStr.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
        const dayMatch = dateStr.match(/\b(\d{1,2})\b/);
        
        if (monthMatch && dayMatch) {
            const month = monthMap[monthMatch[0]];
            const day = dayMatch[0].padStart(2, '0');
            return `${currentYear}-${month}-${day}`;
        }
        
        return null;
    }

    function formatDateForDisplay(dateValue) {
        if (!dateValue) return 'TBD';
        
        const date = new Date(dateValue);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        const month = monthNames[date.getMonth()];
        const day = date.getDate();
        
        return `${month} ${day}`;
    }

    function formatDateForInput(dateString) {
        if (!dateString) return '';
        if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) return dateString;
        
        const currentYear = new Date().getFullYear();
        const monthMap = {
            'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
            'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
            'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
        };
        
        const monthMatch = dateString.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
        const dayMatch = dateString.match(/\b(\d{1,2})\b/);
        
        if (monthMatch && dayMatch) {
            const month = monthMap[monthMatch[0]];
            const day = dayMatch[0].padStart(2, '0');
            return `${currentYear}-${month}-${day}`;
        }
        
        return '';
    }

    // ===== FILTER AND SEARCH =====
    function filterByPriority(priority) {
    console.log('üîµ filterByPriority called:', priority);
    console.log('üîµ window.isGroupedView:', window.isGroupedView);
    
    currentFilter = priority;
    currentTablePage = 1; // Reset to page 1
    
    // Reset search jika sedang searching
    if (isSearching) {
        document.getElementById('searchBox').value = '';
        isSearching = false;
        searchResults = [];
    }
    
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector ( `[data-filter="${priority}"]`).classList.add('active');
    
    // ‚úÖ CHECK VIEW MODE DULU
    if (window.isGroupedView) {
        console.log('‚úÖ Calling renderGroupedView()');
        renderGroupedView(); // Tetap di group view
    } else {
        console.log('‚úÖ Calling populateTable()');
        populateTable(); // Normal view
    }
    
    console.log('üîµ After filter, window.isGroupedView:', window.isGroupedView);
    updateStats();
}

    function searchTable() {
    const searchBox = document.getElementById('searchBox');
    const searchTerm = searchBox.value.trim().toLowerCase();
    
    // ‚úÖ CHECK VIEW MODE DULU
    if (window.isGroupedView) {
        // Kalau di group view, render ulang group view (akan auto-filter)
        renderGroupedView();
        return;
    }
    
    // Kalau di detail view, pakai logic existing
    if (searchTerm === '') {
        isSearching = false;
        searchResults = [];
        currentTablePage = 1;
        populateTable();
    } else {
        isSearching = true;
        searchResults = projectData.filter(item => {
            return (
                item.equipment.toLowerCase().includes(searchTerm) ||
                item.vendor.toLowerCase().includes(searchTerm) ||
                (item.taskName && item.taskName.toLowerCase().includes(searchTerm)) ||
                (item.disc && item.disc.toLowerCase().includes(searchTerm)) ||
                (item.status && item.status.toLowerCase().includes(searchTerm)) ||
                (item.priority && item.priority.toLowerCase().includes(searchTerm))
            );
        });
        currentTablePage = 1;
        populateTable();
    }
}

    function filterByIssueType(issueType) {
    // Reset search box
    document.getElementById('searchBox').value = '';
    
    // Reset to page 1
    currentTablePage = 1;
    
    // Set temporary filter
    window.tempIssueFilter = issueType;
    
// ‚úÖ CHECK VIEW MODE DULU
    if (window.isGroupedView) {
        renderGroupedView(); // Tetap di group view
    } else {
        populateTable(); // Normal view
    }
    
    // Update title based on issue type
    let titleText = '';
    if (issueType === 'contract') {
        titleText = 'Detailed Task List - Contract Issues Only';
    } else if (issueType === 'visa') {
        titleText = 'Detailed Task List - VISA Issues Only';
    } else if (issueType === 'payment') {
        titleText = 'Detailed Task List - Payment Issues Only';
    } else if (issueType === 'workdelayed') {
        titleText = 'Detailed Task List - Work Delayed Items (Prognosa ‚â• Target)';
    } else {
        const issueTypeText = issueType.charAt(0).toUpperCase() + issueType.slice(1);
        titleText = `Detailed Task List - ${issueTypeText} Issues Only`;
    }
    
    document.querySelector('.table-title').textContent = titleText;
    
    // Add clear filter button if not exists
    if (!document.getElementById('clearFilterBtn')) {
        const clearBtn = document.createElement('button');
        clearBtn.id = 'clearFilterBtn';
        clearBtn.className = 'btn-export';
        clearBtn.style.background = '#95a5a6';
        clearBtn.textContent = 'Clear Filter';
        clearBtn.onclick = clearIssueFilter;
        document.querySelector('.add-item-container').appendChild(clearBtn);
    }
}

function filterByStatus(statusType) {
    // Reset search box
    document.getElementById('searchBox').value = '';
    
    // Reset to page 1
    currentTablePage = 1;
    
    // Set temporary status filter
    window.tempStatusFilter = statusType;

// ‚úÖ CHECK VIEW MODE DULU
    if (window.isGroupedView) {
        renderGroupedView(); // Tetap di group view
    } else {
        populateTable(); // Normal view
    }
    
    
    // Update title based on filter type
    let titleText = 'Detailed Task List';
    if (statusType === 'all') {
        titleText = 'Detailed Task List - All Items';
    } else if (statusType === 'onsite') {
        titleText = 'Detailed Task List - Already Onsite';
    } else if (statusType === 'notonsite') {
        titleText = 'Detailed Task List - Not Onsite Yet';
    } else if (statusType === 'inprogress') {
        titleText = 'Detailed Task List - Onsite In Progress';
    } else if (statusType === 'completed') {
        titleText = 'Detailed Task List - Completed Tasks';
    } else if (statusType === 'ontime') {
        titleText = 'Detailed Task List - On Time Mobilizations';
    } else if (statusType === 'delayed') {
        titleText = 'Detailed Task List - Delayed Mobilizations';
    }
    
    document.querySelector('.table-title').textContent = titleText;
    
    // Add clear filter button if not exists
    if (!document.getElementById('clearFilterBtn')) {
        const clearBtn = document.createElement('button');
        clearBtn.id = 'clearFilterBtn';
        clearBtn.className = 'btn-export';
        clearBtn.style.background = '#95a5a6';
        clearBtn.textContent = 'Clear Filter';
        clearBtn.onclick = clearAllFilters;
        document.querySelector('.add-item-container').appendChild(clearBtn);
    }
}

    function clearIssueFilter() {
        clearAllFilters();
    }

    function clearAllFilters() {
    // Remove all temporary filters
    window.tempIssueFilter = null;
    window.tempStatusFilter = null;
    currentFilter = 'all'; // ‚úÖ Reset filter
    
    // Reset to page 1
    currentTablePage = 1;
    
    // Reset search
    const searchBox = document.getElementById('searchBox');
    if (searchBox) searchBox.value = '';
    isSearching = false;
    searchResults = [];
    
    // ‚úÖ CHECK VIEW MODE
    if (window.isGroupedView) {
        renderGroupedView(); // Tetap di group view
    } else {
        populateTable(); // Normal view
    }
    
    // Reset title
    document.querySelector('.table-title').textContent = 'Detailed Task List';
    
    // Remove clear button
    const clearBtn = document.getElementById('clearFilterBtn');
    if (clearBtn) clearBtn.remove();
    
    // Reset filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('[data-filter="all"]').classList.add('active');
}

// ===== PAGINATION INFO DISPLAY =====
function updatePaginationInfo(displayedCount, totalCount) {
    // If parameters not provided, calculate from current state
    if (displayedCount === undefined || totalCount === undefined) {
        const tableRows = document.querySelectorAll('#tableBody tr:not([style*="display: none"])');
        displayedCount = tableRows.length;
        
        // Get total based on current filter
        if (isSearching) {
            totalCount = searchResults.length;
        } else if (currentFilter === 'highlighted') {
            totalCount = projectData.filter(item => item.highlighted).length;
        } else if (currentFilter === 'all') {
            totalCount = projectData.length;
        } else {
            totalCount = projectData.filter(item => item.priority === currentFilter).length;
        }
    }
    
    // Find or create pagination info element
    let paginationInfo = document.getElementById('paginationInfo');
    
    if (!paginationInfo) {
        // Create pagination info container if doesn't exist
        const tableContainer = document.querySelector('.data-table-container');
        if (tableContainer) {
            paginationInfo = document.createElement('div');
            paginationInfo.id = 'paginationInfo';
            paginationInfo.style.cssText = `
                padding: 10px 15px;
                text-align: center;
                font-size: 12px;
                color: #7f8c8d;
                background: #f8f9fa;
                border-top: 1px solid #ecf0f1;
                border-radius: 0 0 4px 4px;
            `;
            tableContainer.parentNode.insertBefore(paginationInfo, tableContainer.nextSibling);
        } else {
            console.warn('Table container not found for pagination info');
            return;
        }
    }
    
    // Update text
    if (totalCount === 0) {
        paginationInfo.textContent = 'No items to display';
        paginationInfo.style.color = '#95a5a6';
    } else if (displayedCount === totalCount) {
        paginationInfo.innerHTML = `Showing <strong>${totalCount}</strong> item${totalCount !== 1 ? 's' : ''}`;
        paginationInfo.style.color = '#27ae60';
    } else {
        const startNum = (currentTablePage - 1) * itemsPerTablePage + 1;
        const endNum = Math.min(currentTablePage * itemsPerTablePage, totalCount);
        paginationInfo.innerHTML = `Showing <strong>${startNum}-${endNum}</strong> of <strong>${totalCount}</strong> items`;
        paginationInfo.style.color = '#3498db';
    }
}

    // ===== TABLE POPULATION =====
    function populateTable() {
console.log('‚ö†Ô∏è populateTable() called - WHO CALLED ME?');
    console.trace('‚ö†Ô∏è Call stack:');

// Remove grouped view class from body
    document.body.classList.remove('grouped-view-active');

    console.log('üìä populateTable() called');
  // ‚úÖ TAMBAHKAN INI - Check if search box has value
    console.log('üìä autoSortEnabled:', autoSortEnabled);
    console.log('üìä projectData.length:', projectData.length);

// ‚úÖ TAMBAHKAN INI DI SINI (SETELAH CONSOLE.LOG)
    // Force show pagination for detail view
    const paginationDiv = document.getElementById('pagination');
    if (paginationDiv) {
        paginationDiv.style.display = 'flex'; // atau 'block'
    }
    
    // Re-enable all pagination controls
    const paginationElements = document.querySelectorAll(
        '.pagination-controls, .pagination-info, #tablePagination, ' +
        'button[onclick*="changeTablePage"], button[onclick*="goToTablePage"], ' +
        '#pageInput, .page-number-input, .hide-in-group-mode'
    );
    
    paginationElements.forEach(el => {
        if (el) {
            el.style.display = '';
            el.style.visibility = 'visible';
            el.style.height = '';
            el.style.overflow = '';
            el.style.pointerEvents = 'auto';
            el.classList.remove('hide-in-group-mode');
            if (el.tagName === 'BUTTON' || el.tagName === 'INPUT') {
                el.disabled = false;
            }
        }
    });
    
    // Set flag: we are NOT in grouped view
    window.isGroupedView = false;
    
    // ‚úÖ SAMPAI SINI

    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';

    let filteredData;
    
    // Jika sedang searching, gunakan searchResults
    if (isSearching) {
        filteredData = searchResults;
    } else if (currentFilter === 'highlighted') {
        filteredData = projectData.filter(item => item.highlighted);
    } else if (currentFilter === 'all') {
        filteredData = projectData;
    } else {
        filteredData = projectData.filter(item => item.priority === currentFilter);
    }
    
    // Jika tidak ada hasil pencarian, tampilkan pesan
    if (isSearching && filteredData.length === 0) {
        const searchTerm = document.getElementById('searchBox').value;
        tableBody.innerHTML = `
            <tr>
                <td colspan="13" style="text-align: center; padding: 60px 20px; color: #95a5a6;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #7f8c8d;">No results found</div>
                    <div style="font-size: 14px; color: #95a5a6;">No items match "<strong>${searchTerm}</strong>"</div>
                    <div style="font-size: 13px; color: #bdc3c7; margin-top: 10px;">Try different keywords or clear the search</div>
                </td>
            </tr>
        `;
        updatePaginationInfo(0, 0);
        return;
    }

// Apply issue filter if exists
// Apply issue filter if exists
// Apply issue filter if exists
if (window.tempIssueFilter) {
    const issueType = window.tempIssueFilter;
    filteredData = filteredData.filter(item => {
        if (issueType === 'contract') {
            return item.status.includes('Contract Issue') || 
                   item.status.includes('Contract Review') || 
                   item.contract === 'Quotation' || 
                   item.contract === 'Under Review' || 
                   item.contract === 'Reviewing';
        } else if (issueType === 'payment') {
            return item.status.includes('Payment Issue') || 
                   item.contract === 'Waiting AP';
        } else if (issueType === 'visa') {
            return item.status.includes('VISA Processing') || 
                   item.visa === 'Processing' || 
                   item.visa === 'Ongoing';
        } else if (issueType === 'workdelayed') {
            // Filter Work Delayed: Prognosa >= Target Completion Date
            return item.targetCompDate && item.prognosaCompDate && 
                   new Date(item.prognosaCompDate) >= new Date(item.targetCompDate);
        }
        return false;
    });
}

// Apply status filter if exists
if (window.tempStatusFilter) {
    const statusType = window.tempStatusFilter;
    filteredData = filteredData.filter(item => {
        if (statusType === 'all') {
            return true;
        } else if (statusType === 'onsite') {
            return item.status.includes('Onsite') || item.status.includes('Completed');
        } else if (statusType === 'notonsite') {
            return !item.status.includes('Onsite') && !item.status.includes('Completed');
        } else if (statusType === 'inprogress') {
            return item.status.includes('Onsite') && !item.status.includes('Completed');
        } else if (statusType === 'completed') {
            return item.status.includes('Completed');
        } else if (statusType === 'ontime') {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status === 'ON TIME';
        } else if (statusType === 'delayed') {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status.includes('DELAYED');
        }
        return false;
    });
}
// Apply status filter if exists
if (window.tempStatusFilter) {
    const statusType = window.tempStatusFilter;
    filteredData = filteredData.filter(item => {
        if (statusType === 'all') {
            return true;
        } else if (statusType === 'onsite') {
            return item.status.includes('Onsite') || item.status.includes('Completed');
        } else if (statusType === 'notonsite') {
            return !item.status.includes('Onsite') && !item.status.includes('Completed');
        } else if (statusType === 'inprogress') {
            return item.status.includes('Onsite') && !item.status.includes('Completed');
        } else if (statusType === 'completed') {
            return item.status.includes('Completed');
        } else if (statusType === 'ontime') {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status === 'ON TIME';
        } else if (statusType === 'delayed') {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status.includes('DELAYED');
        }
        return false;
    });
}

// ===== AUTO-SORT: Permanent Ranking by Last Update =====
if (autoSortEnabled && filteredData.length > 0) {
    const NOW = Date.now();
    
    console.log('üîÑ AUTO-SORT ACTIVE (Permanent Ranking Mode)');
    console.log('üìä Items to sort:', filteredData.length);
    
    filteredData = filteredData.slice().sort((a, b) => {
        const hasUpdateA = !!a.lastUpdated;
        const hasUpdateB = !!b.lastUpdated;
        
        // ‚≠ê Item yang PERNAH diupdate SELALU di atas item yang BELUM PERNAH diupdate
        if (hasUpdateA && !hasUpdateB) return -1; // A pernah update, B belum ‚Üí A di atas
        if (!hasUpdateA && hasUpdateB) return 1;  // B pernah update, A belum ‚Üí B di atas
        
        // ‚≠ê Jika KEDUANYA pernah diupdate ‚Üí Sort by NEWEST first
        if (hasUpdateA && hasUpdateB) {
            const timeA = new Date(a.lastUpdated).getTime();
            const timeB = new Date(b.lastUpdated).getTime();
            const diff = timeB - timeA; // Newest first
            
            // Debug log untuk item yang baru diupdate (< 5 menit)
            if (diff !== 0) {
                const timeSinceA = Math.floor((NOW - timeA) / 1000);
                const timeSinceB = Math.floor((NOW - timeB) / 1000);
                
                if (timeSinceA < 300 || timeSinceB < 300) { // < 5 menit
                    console.log(`üì¶ ${a.equipment}: ${timeSinceA}s ago vs ${b.equipment}: ${timeSinceB}s ago`);
                }
            }
            
            return diff;
        }
        
        // ‚≠ê Jika KEDUANYA belum pernah diupdate ‚Üí Gunakan urutan original
        return (a.originalOrder || 0) - (b.originalOrder || 0);
    });
    
    // Summary log
    const updatedItems = filteredData.filter(i => i.lastUpdated).length;
    const neverUpdatedItems = filteredData.length - updatedItems;
    console.log(`‚úÖ Sorted: ${updatedItems} updated items on top, ${neverUpdatedItems} never-updated items at bottom`);
}

        // Calculate pagination

        // Calculate pagination
        const totalPages = Math.ceil(filteredData.length / itemsPerTablePage);
        const startIndex = (currentTablePage - 1) * itemsPerTablePage;
        const endIndex = startIndex + itemsPerTablePage;
        const pageData = filteredData.slice(startIndex, endIndex);

        pageData.forEach((item, index) => {
    const rowNumber = startIndex + index + 1;
    const dateStatus = getDateStatus(item.targetDate, item.mobDate);
    const row = document.createElement('tr');

// Add highlight class if item is highlighted
let rowClasses = `priority-${item.priority}`;
if (item.highlighted) {
    rowClasses += ' highlighted';
}

// ===== CHECK IF RECENTLY UPDATED (LAST 30 SECONDS) =====
const now = new Date();
const lastUpdate = item.lastUpdated ? new Date(item.lastUpdated) : null;
const isRecentlyUpdated = lastUpdate && (now - lastUpdate) < 30000; // 30 seconds

if (isRecentlyUpdated) {
    rowClasses += ' recently-updated';
}

row.className = rowClasses;
row.setAttribute('data-firebase-key', item.firebaseKey);

// ‚ú®‚ú®‚ú® HIGHLIGHT ITEM YANG BARU DIUPDATE (< 5 MENIT) ‚ú®‚ú®‚ú®
if (item.lastUpdated) {
    const timeSinceUpdate = Date.now() - new Date(item.lastUpdated).getTime();
    
    // ‚≠ê Highlight kuning HANYA untuk yang BARU SAJA diupdate (< 5 menit)
    // Item tetap di atas meskipun highlight hilang setelah 5 menit
    if (timeSinceUpdate < 5 * 60 * 1000) { // 5 menit
        // Gunakan setProperty dengan important untuk override CSS class
        row.style.setProperty('background-color', '#fff3cd', 'important');
        row.style.setProperty('border-left', '4px solid #ffc107', 'important');
        row.style.setProperty('transition', 'all 0.5s ease', 'important');
        
        // console.log(`üé® Highlight applied: ${item.equipment} (${Math.floor(timeSinceUpdate/1000)}s ago)`);
        
        // Tambahkan badge "üî• NEW"
        const firstCell = row.cells[0];
        if (firstCell) {
            const badge = document.createElement('span');
            badge.textContent = 'üî• NEW';
            badge.style.cssText = 'background: #ffc107; color: #000; padding: 2px 6px; border-radius: 10px; font-size: 8px; font-weight: bold; margin-left: 5px;';
            firstCell.appendChild(badge);
        }
    } else {
        // Item sudah > 5 menit, tapi TETAP di atas karena pernah diupdate
        console.log(`üìå ${item.equipment}: Updated ${Math.floor(timeSinceUpdate/60000)} minutes ago (still on top)`);
    }
}
// ‚ú®‚ú®‚ú® AKHIR HIGHLIGHT CODE ‚ú®‚ú®‚ú®

// Calculate time since update
let timeSinceUpdate = '';
if (lastUpdate) {
    const seconds = Math.floor((now - lastUpdate) / 1000);
    if (seconds < 60) {
        timeSinceUpdate = `${seconds}s ago`;
    } else if (seconds < 3600) {
        timeSinceUpdate = `${Math.floor(seconds / 60)}m ago`;
    } else {
        timeSinceUpdate = `${Math.floor(seconds / 3600)}h ago`;
    }
}

row.innerHTML = `
    <td style="text-align: center;">${rowNumber}</td>
    <td style="text-align: center;"><span class="priority-badge priority-${item.priority}">${item.priority}</span></td>
    <td class="wrap-text" style="font-weight: ${item.highlighted ? '700' : '500'}; padding-right: 8px;">
    ${item.highlighted ? '<span class="warning-badge">‚ö†Ô∏è</span>' : ''}
    <span style="cursor: help; text-decoration: underline dotted;" 
      onmouseenter="showTasksTooltip(event, '${item.equipment.replace(/'/g, "\\'")}', '${item.disc || item.task}')" 
      onmouseleave="hideTasksTooltip()">
    ${item.equipment}
</span>
    ${isRecentlyUpdated ? `<span class="recent-update-badge">üîÑ NEW</span><span class="recent-update-time">${timeSinceUpdate}</span>` : ''}
</td>
    <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.vendor}"><strong>${item.vendor}</strong></td>
<td style="text-align: center;"><span class="status-badge">${item.disc || '-'}</span></td>
<td class="wrap-text" style="font-size: 11px;">${item.taskName || '-'}</td>
<td><span class="status-badge ${getStatusClass(item.status)}">${item.status}</span></td>
                <td><span class="status-badge ${getContractClass(item.contract)}">${item.contract}</span></td>
                <td><span class="status-badge ${getVisaClass(item.visa)}">${item.visa}</span></td>
                <td style="white-space: nowrap;">${item.targetDate ? formatDateForDisplay(item.targetDate) : '-'}</td>
                <td style="white-space: nowrap;">${item.mobDate}</td>
<td><span class="status-badge ${dateStatus.class}">${dateStatus.status}</span></td>
<td style="white-space: nowrap;">${item.targetCompDate ? formatDateForDisplay(item.targetCompDate) : '-'}</td>
<td style="white-space: nowrap;">${item.prognosaCompDate ? formatDateForDisplay(item.prognosaCompDate) : '-'}</td>
<td>
    <div class="progress-bar" style="width: 50px;">
                        <div class="progress-fill" style="width: ${item.progress}%;"></div>
                    </div>
                    <small style="font-size: 8px; margin-left: 3px;">${item.progress}%</small>
                <td style="white-space: nowrap; text-align: center; position: relative; overflow: visible;">
    <button class="action-btn primary" onclick="openUpdateModal('${item.firebaseKey}')" style="font-size: 9px; padding: 4px 8px;">Update</button>
    ${item.status && (item.status.includes('Onsite') || item.status.includes('Completed')) ? `
        <div style="display: inline-block; position: relative; vertical-align: middle; z-index: 100;">
            <button class="action-btn dropdown-trigger" onclick="toggleDropdown('dropdown-${item.firebaseKey}')" style="background: #9b59b6; color: white; font-size: 9px; padding: 4px 8px; margin-left: 3px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
    üìã More ‚ñº
</button>
            <div id="dropdown-${item.firebaseKey}" class="action-dropdown" style="display: none;">
                <button class="dropdown-item" data-action="tasks" data-key="${item.firebaseKey}">
                    <span style="font-size: 14px;">üìã</span>
                    <span>Onsite Tasks</span>
                </button>
                <button class="dropdown-item" data-action="progress" data-key="${item.firebaseKey}">
                    <span style="font-size: 14px;">üìä</span>
                    <span>Progress Report</span>
                </button>
            </div>
        </div>
    ` : `
        <button class="action-btn success" onclick="showProgressReportById('${item.firebaseKey}')" title="View Progress Report" style="background: #27ae60; font-size: 9px; padding: 4px 8px; margin-left: 3px;">üìä Progress</button>
    `}
    <button class="btn-delete" onclick="deleteItem('${item.firebaseKey}')" title="Delete" style="font-size: 12px; padding: 4px 7px; line-height: 1; margin-left: 3px;">üóëÔ∏è</button>
</td>
        `;
        
        tableBody.appendChild(row);

        // Auto-remove badge after 2 minutes (tetapi highlight tetap sampai 5 menit)
if (isRecentlyUpdated) {
    setTimeout(() => {
        row.classList.add('fading');
        setTimeout(() => {
            row.classList.remove('recently-updated', 'fading');
            // Remove badge and time
            const badge = row.querySelector('.recent-update-badge');
            const timeSpan = row.querySelector('.recent-update-time');
            if (badge) badge.remove();
            if (timeSpan) timeSpan.remove();
        }, 2000);
    }, 120000); // ‚≠ê Ubah dari 30000 (30 detik) jadi 120000 (2 menit)
}
        });

        // Update pagination info
        updateTablePagination(filteredData.length, totalPages);

        // Update upcoming mobilizations
        updateUpcomingMobilizations();
    }

function updateTablePagination(totalItems, totalPages) {
        const startIndex = (currentTablePage - 1) * itemsPerTablePage;
        const endIndex = Math.min(startIndex + itemsPerTablePage, totalItems);
        
        document.getElementById('tablePageInfo').textContent = `${startIndex + 1}-${endIndex} of ${totalItems}`;
        
        document.getElementById('prevTablePageBtn').disabled = currentTablePage === 1;
        document.getElementById('nextTablePageBtn').disabled = currentTablePage === totalPages || totalPages === 0;
        
        renderTablePageNumbers(totalPages);
    }

    function renderTablePageNumbers(totalPages) {
    const pageNumbersDiv = document.getElementById('tablePageNumbers');
    pageNumbersDiv.innerHTML = ''; // Clear dulu
    
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentTablePage - 2 && i <= currentTablePage + 2)) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.style.cssText = `
                padding: 6px 10px; 
                background: ${i === currentTablePage ? '#3498db' : '#ecf0f1'}; 
                color: ${i === currentTablePage ? 'white' : '#2c3e50'}; 
                border: none; 
                border-radius: 4px; 
                font-size: 11px; 
                cursor: pointer; 
                min-width: 30px;
                margin: 0 2px;
            `;
            
            // üëá EVENT LISTENER DENGAN SCROLL
            btn.addEventListener('click', function() {
    if (window.isGroupedView) {
        return;
    }
    
    currentTablePage = i;
    populateTable();
    
    // ‚úÖ HANYA 1 scroll command
    window.scrollTo({ 
        top: 0, 
        behavior: 'smooth' 
    });
});
            
            pageNumbersDiv.appendChild(btn);
        } else if (i === currentTablePage - 3 || i === currentTablePage + 3) {
            const dots = document.createElement('span');
            dots.textContent = '...';
            dots.style.cssText = 'padding: 0 5px;';
            pageNumbersDiv.appendChild(dots);
        }
    }
}

  function changeTablePage(direction) {
    // ‚úÖ UBAH JADI window.window.isGroupedView
    if (window.isGroupedView) {
        return; // Mode group tidak pakai pagination
    }
    
    const filteredData = currentFilter === 'all' ? projectData : projectData.filter(item => item.priority === currentFilter);
    const totalPages = Math.ceil(filteredData.length / itemsPerTablePage);
    const newPage = currentTablePage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentTablePage = newPage;
        populateTable();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function goToTablePage(pageNumber) {
    if (!pageNumber) {
        const pageInput = document.getElementById('pageInput');
        if (!pageInput) return;
        pageNumber = parseInt(pageInput.value);
    }
    
    if (window.isGroupedView) {
        return;
    }
    
    const filteredData = currentFilter === 'all' ? projectData : projectData.filter(item => item.priority === currentFilter);
    const totalPages = Math.ceil(filteredData.length / itemsPerTablePage);
    
    if (pageNumber >= 1 && pageNumber <= totalPages) {
        currentTablePage = pageNumber;
        populateTable();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

    function getStatusClass(status) {
        if (status.includes('Completed')) return 'status-done';
        if (status.includes('Onsite')) return 'status-onsite';
        if (status.includes('Issue')) return 'status-issue';
        if (status.includes('Processing')) return 'status-ongoing';
        return 'status-waiting';
    }

    function getContractClass(contract) {
        if (contract === 'Done') return 'status-done';
        if (contract.includes('Ongoing') || contract.includes('Reviewing')) return 'status-ongoing';
        if (contract.includes('Quotation') || contract.includes('Review')) return 'status-issue';
        return 'status-waiting';
    }

    function getVisaClass(visa) {
        if (visa === 'Done') return 'status-done';
        if (visa === 'Processing' || visa === 'Ongoing') return 'status-ongoing';
        if (visa === 'Local') return 'status-onsite';
        return 'status-issue';
    }

    // ===== STATISTICS =====
    function updateStats() {
// ‚úÖ CHECK: Apakah di Group View?
    if (window.isGroupedView && window.currentFilteredGroups) {
        updateStatsForGroupView();
        return;
    }

    let filteredData;
    if (currentFilter === 'highlighted') {
        filteredData = projectData.filter(item => item.highlighted);
    } else if (currentFilter === 'all') {
        filteredData = projectData;
    } else {
        filteredData = projectData.filter(item => item.priority === currentFilter);
    }

        const total = filteredData.length;
        const belumOnsite = filteredData.filter(item => !item.status.includes('Completed') && !item.status.includes('Onsite')).length;
        const sudahOnsite = total - belumOnsite;
        const contractIssues = filteredData.filter(item => item.status === 'Contract Issue' || item.status === 'Contract Review' || item.contract === 'Quotation' || item.contract === 'Under Review' || item.contract === 'Reviewing').length;
        const paymentIssues = filteredData.filter(item => item.status === 'Payment Issue' || item.contract === 'Waiting AP').length;
        const visaProcessing = filteredData.filter(item => item.status === 'VISA Processing' || item.visa === 'Processing' || item.visa === 'Ongoing').length;
        const inProgress = filteredData.filter(item => item.status.includes('Onsite') && !item.status.includes('Completed')).length;
        const completed = filteredData.filter(item => item.status.includes('Completed')).length;
        
        const onTime = filteredData.filter(item => {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status === 'ON TIME';
        }).length;
        
        const delayed = filteredData.filter(item => {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status.includes('DELAYED');
        }).length;

        // Calculate Work Delayed count (Prognosa >= Target Completion)
const workDelayed = filteredData.filter(item => {
    if (!item.targetCompDate || !item.prognosaCompDate) return false;
    return new Date(item.prognosaCompDate) >= new Date(item.targetCompDate);
}).length;

document.getElementById('totalCount').textContent = total;
document.getElementById('belumOnsiteCount').textContent = belumOnsite;
document.getElementById('sudahOnsiteCount').textContent = sudahOnsite;

// ‚úÖ Calculate and display weighted progress for onsite equipment
const onsiteEquipment = filteredData.filter(item => item.status === 'onsite');
let allOnsiteTasks = [];

onsiteEquipment.forEach(equip => {
    const tasks = onsiteTasks[equip.firebaseKey] || [];
    allOnsiteTasks = allOnsiteTasks.concat(tasks);
});

const onsiteOverallProgress = calculateWeightedProgress(allOnsiteTasks);

// Update progress display (check if elements exist)
const progressPercentElem = document.getElementById('onsiteProgressPercent');
const progressBarElem = document.getElementById('onsiteProgressBar');

if (progressPercentElem && progressBarElem) {
    progressPercentElem.textContent = onsiteOverallProgress + '%';
    progressBarElem.style.width = onsiteOverallProgress + '%';
}
document.getElementById('contractIssueCount').textContent = contractIssues;
document.getElementById('paymentIssueCount').textContent = paymentIssues;
document.getElementById('visaProcessingCount').textContent = visaProcessing;
document.getElementById('inProgressCount').textContent = inProgress;
document.getElementById('completedCount').textContent = completed;
document.getElementById('onTimeCount').textContent = onTime;
document.getElementById('delayedCount').textContent = delayed;
document.getElementById('criticalContract').textContent = contractIssues;
document.getElementById('criticalVisa').textContent = visaProcessing;
document.getElementById('criticalPayment').textContent = paymentIssues;
document.getElementById('criticalWorkDelayed').textContent = workDelayed;
// Hide label in normal view
document.getElementById('totalCountLabel').textContent = '';

// Update upcoming mobilizations
updateUpcomingMobilizations();
    }

function updateStatsForGroupView() {
    const groups = window.currentFilteredGroups || [];
    
    // Total groups
    document.getElementById('totalCount').textContent = groups.length;
document.getElementById('totalCountLabel').textContent = 'groups'; // ‚úÖ TAMBAHKAN INI
    
    // Count by aggregating tasks from all groups
    let allTasks = [];
    groups.forEach(group => {
        allTasks = allTasks.concat(group.tasks);
    });
    
    const belumOnsite = allTasks.filter(item => !item.status.includes('Completed') && !item.status.includes('Onsite')).length;
    const sudahOnsite = allTasks.length - belumOnsite;
    const contractIssues = allTasks.filter(item => item.status === 'Contract Issue' || item.status === 'Contract Review' || item.contract === 'Quotation' || item.contract === 'Under Review' || item.contract === 'Reviewing').length;
    const paymentIssues = allTasks.filter(item => item.status === 'Payment Issue' || item.contract === 'Waiting AP').length;
    const visaProcessing = allTasks.filter(item => item.status === 'VISA Processing' || item.visa === 'Processing' || item.visa === 'Ongoing').length;
    const inProgress = allTasks.filter(item => item.status.includes('Onsite') && !item.status.includes('Completed')).length;
    const completed = allTasks.filter(item => item.status.includes('Completed')).length;
    
    const onTime = allTasks.filter(item => {
        const dateStatus = getDateStatus(item.targetDate, item.mobDate);
        return dateStatus.status === 'ON TIME';
    }).length;
    
    const delayed = allTasks.filter(item => {
        const dateStatus = getDateStatus(item.targetDate, item.mobDate);
        return dateStatus.status.includes('DELAYED');
    }).length;
    
    const workDelayed = allTasks.filter(item => {
        if (!item.targetCompDate || !item.prognosaCompDate) return false;
        return new Date(item.prognosaCompDate) >= new Date(item.targetCompDate);
    }).length;

    // Update UI with labels
document.getElementById('totalCount').textContent = groups.length;
document.getElementById('totalCountLabel').textContent = 'groups';
document.getElementById('belumOnsiteCount').textContent = belumOnsite;
document.getElementById('belumOnsiteCount').innerHTML = `${belumOnsite} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('sudahOnsiteCount').textContent = sudahOnsite;
document.getElementById('sudahOnsiteCount').innerHTML = `${sudahOnsite} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;

// ‚úÖ Calculate and display weighted progress for onsite items
const onsiteGroups = groups.filter(g => g.status === 'onsite');
let allOnsiteTasks = [];

onsiteGroups.forEach(group => {
    const tasks = onsiteTasks[group.firebaseKey] || [];
    allOnsiteTasks = allOnsiteTasks.concat(tasks);
});

const onsiteOverallProgress = calculateWeightedProgress(allOnsiteTasks);

// Update progress display (check if elements exist)
const progressPercentElem = document.getElementById('onsiteProgressPercent');
const progressBarElem = document.getElementById('onsiteProgressBar');

if (progressPercentElem && progressBarElem) {
    progressPercentElem.textContent = onsiteOverallProgress + '%';
    progressBarElem.style.width = onsiteOverallProgress + '%';
}

document.getElementById('contractIssueCount').innerHTML = `${contractIssues} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('paymentIssueCount').innerHTML = `${paymentIssues} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('visaProcessingCount').innerHTML = `${visaProcessing} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('inProgressCount').innerHTML = `${inProgress} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('completedCount').innerHTML = `${completed} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('onTimeCount').innerHTML = `${onTime} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('delayedCount').innerHTML = `${delayed} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;

// Critical stats
document.getElementById('criticalContract').innerHTML = `${contractIssues} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('criticalVisa').innerHTML = `${visaProcessing} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('criticalPayment').innerHTML = `${paymentIssues} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
document.getElementById('criticalWorkDelayed').innerHTML = `${workDelayed} <span style="font-size:11px;font-weight:400;opacity:0.8;">tasks</span>`;
    
    // Upcoming mobilizations tetap sama
    updateUpcomingMobilizations();
}

// ===== UPCOMING MOBILIZATIONS =====
    function updateUpcomingMobilizations() {
        const container = document.getElementById('upcomingContainer');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Filter items dengan target date dalam 30 hari ke depan
        const upcomingItems = projectData.filter(item => {
            if (!item.targetDate) return false;
            const targetDate = new Date(item.targetDate);
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            return daysUntil >= 0 && daysUntil <= 30;
        }).sort((a, b) => {
            return new Date(a.targetDate) - new Date(b.targetDate);
        });

        document.getElementById('upcomingCount').textContent = upcomingItems.length;

        if (upcomingItems.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #95a5a6; font-size: 11px;">No upcoming mobilizations in next 30 days</div>';
            return;
        }

        container.innerHTML = upcomingItems.map(item => {
            const targetDate = new Date(item.targetDate);
targetDate.setHours(0, 0, 0, 0);
const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            // Determine urgency
            let urgencyColor, urgencyText, urgencyIcon;
            if (daysUntil <= 2) {
                urgencyColor = '#e74c3c';
                urgencyText = 'URGENT';
                urgencyIcon = 'üî¥';
            } else if (daysUntil <= 7) {
                urgencyColor = '#f39c12';
                urgencyText = 'HIGH';
                urgencyIcon = 'üü°';
            } else {
                urgencyColor = '#27ae60';
                urgencyText = 'NORMAL';
                urgencyIcon = 'üü¢';
            }

            // Get blockers
            let blockers = [];
            if (item.status.includes('Payment Issue') || item.contract === 'Waiting AP') {
                blockers.push('Payment pending');
            }
            if (item.status.includes('Contract Issue') || item.contract === 'Quotation') {
                blockers.push('Contract pending');
            }
            if (item.status.includes('VISA Processing') || item.visa === 'Processing') {
                blockers.push('VISA processing');
            }

            const blockerText = blockers.length > 0 ? `‚ö†Ô∏è ${blockers.join(', ')}` : '‚úì All Clear - Ready to mobilize';
            const blockerColor = blockers.length > 0 ? '#e74c3c' : '#27ae60';

            return `
                <div style="border: 2px solid ${urgencyColor}; border-radius: 6px; padding: 10px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 9px; background: ${urgencyColor}; color: white; padding: 2px 6px; border-radius: 3px; font-weight: 600;">${urgencyIcon} ${urgencyText}</span>
                        <span style="font-size: 10px; color: #7f8c8d; font-weight: 600;">${daysUntil} day${daysUntil !== 1 ? 's' : ''} left</span>
                    </div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50; margin-bottom: 3px;">${formatDateForDisplay(item.targetDate)}</div>
                    <div style="font-size: 10px; color: #34495e; margin-bottom: 5px;">${item.equipment}</div>
                    <div style="font-size: 10px; color: #7f8c8d; margin-bottom: 5px;"><strong>${item.vendor}</strong></div>
                    <div style="font-size: 9px; color: ${blockerColor}; background: ${blockers.length > 0 ? '#fff3cd' : '#d4edda'}; padding: 4px 6px; border-radius: 3px;">${blockerText}</div>
                    <button onclick="openUpdateModal('${item.firebaseKey}')" style="width: 100%; margin-top: 6px; padding: 4px; background: #3498db; color: white; border: none; border-radius: 3px; font-size: 9px; cursor: pointer; font-weight: 600;">Quick Update</button>
                </div>
            `;
        }).join('');
    }

    // ===== HISTORY =====
    function populateEquipmentHistoryFilter() {
         const filterSelect = document.getElementById('equipmentHistoryFilter');
    const searchInput = document.getElementById('equipmentSearch');
    const currentValue = filterSelect.value;
        
        filterSelect.innerHTML = '<option value="all">All Equipment</option>';
        
        const uniqueEquipmentMap = new Map();
        
        activityHistory.forEach(item => {
            if (item.equipmentId && !uniqueEquipmentMap.has(item.equipmentId)) {
                uniqueEquipmentMap.set(item.equipmentId, {
                    id: item.equipmentId,
                    name: item.equipment,
                    vendor: item.vendor
                });
            }
        });
        
        const sortedEquipment = Array.from(uniqueEquipmentMap.values()).sort((a, b) => a.name.localeCompare(b.name));
        
        sortedEquipment.forEach(eq => {
    const option = document.createElement('option');
    option.value = eq.id;
    
    // Find equipment data to get disc
    const equipmentData = projectData.find(p => p.id === eq.id);
    const disc = equipmentData ? equipmentData.disc : null;
    
    // Add disc to display text
    option.textContent = disc ? 
        `${eq.name} (${eq.vendor}) - ${disc}` : 
        `${eq.name} (${eq.vendor})`;
    
    option.setAttribute('data-equipment', eq.name.toLowerCase());
    option.setAttribute('data-vendor', eq.vendor.toLowerCase());
    if (disc) {
        option.setAttribute('data-disc', disc.toLowerCase());
    }
    filterSelect.appendChild(option);
});
        
        filterSelect.value = currentValue;
if (searchInput) {
        searchInput.value = '';
    }
    }

// NEW FUNCTION: Search Equipment
function searchEquipment() {
    const searchInput = document.getElementById('equipmentSearch');
    const filterSelect = document.getElementById('equipmentHistoryFilter');
    const searchTerm = searchInput.value.toLowerCase();
    
    const options = filterSelect.querySelectorAll('option');
    
    options.forEach(option => {
        if (option.value === 'all') {
            option.style.display = ''; // Always show "All Equipment"
            return;
        }
        
        const searchableText = option.getAttribute('data-searchable') || option.textContent.toLowerCase();
        
        if (searchableText.includes(searchTerm)) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Auto-select first visible option if search is active
    if (searchTerm) {
        const firstVisible = Array.from(options).find(opt => opt.style.display !== 'none' && opt.value !== 'all');
        if (firstVisible) {
            filterSelect.value = firstVisible.value;
            filterEquipmentHistory();
        }
    }
}

    function filterEquipmentHistory() {
        const filterValue = document.getElementById('equipmentHistoryFilter').value;
        const container = document.getElementById('historyContainer');
	const progressBtn = document.getElementById('viewProgressReportBtn');

// Show/hide progress report button
        if (filterValue === 'all') {
            progressBtn.style.display = 'none';
        } else {
            progressBtn.style.display = 'block';
        }
        
        let filteredHistory = activityHistory;
        
        if (filterValue !== 'all') {
            const equipmentId = parseInt(filterValue);
            filteredHistory = activityHistory.filter(item => item.equipmentId === equipmentId);
            
            if (filteredHistory.length === 0) {
                container.innerHTML = '<div style="padding: 15px; text-align: center; color: #95a5a6; font-size: 11px;"><p>No history found for this equipment</p></div>';
                return;
            }
        }
        
        const recentItems = filteredHistory.slice(0, 6);
        
        container.innerHTML = recentItems.map(item => `
        <div class="timeline-item" style="border-left: 3px solid ${item.color}; padding-left: 8px; margin-bottom: 10px; position: relative;">
                <button onclick="deleteHistory('${item.firebaseKey}')" style="position: absolute; top: 25px; right: 5px; background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 9px; cursor: pointer; font-weight: 600;" title="Delete">üóë</button>
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 3px;">
                <strong style="font-size: 10px; color: #2c3e50;">${new Date(item.timestamp).toLocaleString()}</strong>
                <span style="font-size: 8px; background: ${item.color}; color: white; padding: 1px 4px; border-radius: 8px;">${item.category}</span>
            </div>
            <div style="font-size: 11px; font-weight: 500; margin-bottom: 2px;">${item.title}</div>
            <div style="font-size: 10px; color: #666; margin-bottom: 3px;">${item.description}</div>
            <div style="font-size: 10px; color: #999; background: #f8f9fa; padding: 6px 8px; border-radius: 3px; word-wrap: break-word; white-space: pre-wrap; line-height: 1.5; overflow-wrap: break-word; max-width: 100%; word-break: break-word;">${item.icon} ${item.notes}</div>
            <div style="font-size: 8px; color: #95a5a6; margin-top: 3px;">by ${item.user}</div>
        </div>
    `).join('');
}

    // ===== MODAL FUNCTIONS =====
    function openAddModal() {
        currentEditId = null;
        document.getElementById('modalTitle').textContent = 'Add New Task';
        clearForm();
        document.getElementById('updateModal').style.display = 'block';
    }

    function openUpdateModal(firebaseKey) {
        const item = projectData.find(p => p.firebaseKey === firebaseKey);
        if (!item) return;

        currentEditId = firebaseKey;
        document.getElementById('modalTitle').textContent = 'Update Task';
        document.getElementById('modalEquipment').value = item.equipment;
document.getElementById('modalVendor').value = item.vendor;
document.getElementById('modalPriority').value = item.priority;
 // ‚≠ê GANTI BARIS 4199 DENGAN CODE BARU INI ‚≠ê
    // Handle custom discipline on edit
    const modalDiscSelect = document.getElementById('modalDisc');
    const customDiscGroup = document.getElementById('customDiscGroup');
    const customDiscInput = document.getElementById('customDiscInput');

    if (modalDiscSelect) {
        const discValue = item.disc || item.task || 'CI';
        
        // Check if the disc value exists in dropdown options
        const discExists = Array.from(modalDiscSelect.options).some(option => 
            option.value === discValue && option.value !== 'custom'
        );
        
        if (discExists) {
            // Standard disc - select from dropdown
            modalDiscSelect.value = discValue;
            if (customDiscGroup) customDiscGroup.style.display = 'none';
            if (customDiscInput) customDiscInput.value = '';
        } else if (discValue && discValue !== 'CI') {
            // Custom disc - set to custom and show input
            modalDiscSelect.value = 'custom';
            if (customDiscInput) customDiscInput.value = discValue;
            if (customDiscGroup) customDiscGroup.style.display = 'block';
        } else {
            // Default to CI
            modalDiscSelect.value = 'CI';
            if (customDiscGroup) customDiscGroup.style.display = 'none';
        }
    }
    // ‚≠ê AKHIR CODE BARU ‚≠ê
document.getElementById('modalDisplaySequence').value = item.displaySequence || 999;
document.getElementById('modalTask').value = item.taskName || '';
document.getElementById('modalStatus').value = item.status;
        document.getElementById('modalContract').value = item.contract;
        document.getElementById('modalVisa').value = item.visa;
        document.getElementById('modalTargetDate').value = item.targetDate || '';
        document.getElementById('modalMobDate').value = formatDateForInput(item.mobDate);
document.getElementById('modalTargetCompDate').value = item.targetCompDate || '';
document.getElementById('modalPrognosaCompDate').value = item.prognosaCompDate || '';
document.getElementById('modalProgress').value = item.progress;
document.getElementById('modalHighlight').checked = item.highlighted || false;
document.getElementById('modalMitigationPlan').value = item.mitigationPlan || '';
document.getElementById('modalNotes').value = '';
        document.getElementById('updateModal').style.display = 'block';
    // ‚úÖ Attach Save button event IMMEDIATELY after modal shown
const saveBtn = document.getElementById('saveButton');
if (saveBtn) {
    saveBtn.onclick = saveUpdate;
    console.log('‚úÖ Save button onclick attached');
} else {
    console.error('‚ùå saveButton not found!');
}
    }

    function clearForm() {
       document.getElementById('modalEquipment').value = '';
document.getElementById('modalVendor').value = '';
document.getElementById('modalPriority').value = '2nd';
document.getElementById('modalDisc').value = 'CI';
// Reset custom discipline input
    const customDiscGroup = document.getElementById('customDiscGroup');
    const customDiscInput = document.getElementById('customDiscInput');
    if (customDiscGroup) customDiscGroup.style.display = 'none';
    if (customDiscInput) customDiscInput.value = '';
document.getElementById('modalTask').value = '';
document.getElementById('modalStatus').value = 'Contract Issue';
        document.getElementById('modalContract').value = 'Quotation';
        document.getElementById('modalVisa').value = 'Not Applied';
        document.getElementById('modalTargetDate').value = '';
        document.getElementById('modalMobDate').value = '';
document.getElementById('modalTargetCompDate').value = '';
document.getElementById('modalPrognosaCompDate').value = '';
document.getElementById('modalProgress').value = '0';
document.getElementById('modalHighlight').checked = false;
document.getElementById('modalMitigationPlan').value = '';
document.getElementById('modalNotes').value = '';
    }

    function closeModal() {
        document.getElementById('updateModal').style.display = 'none';
        currentEditId = null;
    }

// ===== HELPER: GET DISCIPLINE VALUE =====
function getDiscValue() {
    const discSelect = document.getElementById('modalDisc');
    const customDiscInput = document.getElementById('customDiscInput');
    
    if (!discSelect) return 'CI'; // Default fallback
    
    if (discSelect.value === 'custom') {
        const customValue = customDiscInput ? customDiscInput.value.trim() : '';
        if (!customValue) {
            showNotification('Please enter a custom discipline', 'error');
            return null;
        }
        return customValue.toUpperCase(); // Convert to uppercase for consistency
    }
    
    return discSelect.value;
}

    // ===== CRUD OPERATIONS =====
    function saveUpdate() {
        const equipment = document.getElementById('modalEquipment').value.trim();
        const vendor = document.getElementById('modalVendor').value.trim();

// ‚úÖ GET USER NAME ONCE at the beginning
    const userName = prompt('Enter your name:');
    if (!userName || !userName.trim()) {
        showNotification('Name is required for tracking', 'error');
        return;
    }
        
        if (!equipment || !vendor) {
            showNotification('Please fill in Equipment and Vendor fields', 'error');
            return;
        }

// ‚≠ê TAMBAHKAN CODE BARU INI DI SINI ‚≠ê
    // Validate discipline
    const discValue = getDiscValue();
    if (!discValue) {
        return; // getDiscValue already showed error notification
    }
    // ‚≠ê AKHIR CODE BARU ‚≠ê

        const mobDateValue = document.getElementById('modalMobDate').value;
        const mobDateFormatted = mobDateValue ? formatDateForDisplay(mobDateValue) : 'TBD';

      const taskData = {
    equipment: equipment,
    vendor: vendor,
    priority: document.getElementById('modalPriority').value,
    disc: getDiscValue(),
    task: document.getElementById('modalDisc').value,
    taskName: document.getElementById('modalTask').value,
    status: document.getElementById('modalStatus').value,
    contract: document.getElementById('modalContract').value,
    visa: document.getElementById('modalVisa').value,
    targetDate: document.getElementById('modalTargetDate').value,
    mobDate: mobDateFormatted,
    targetCompDate: document.getElementById('modalTargetCompDate').value,
    prognosaCompDate: document.getElementById('modalPrognosaCompDate').value,
    progress: parseInt(document.getElementById('modalProgress').value.toString().replace('%', '')) || 0,
    highlighted: document.getElementById('modalHighlight').checked,
    mitigationPlan: document.getElementById('modalMitigationPlan').value,
    displaySequence: parseInt(document.getElementById('modalDisplaySequence').value) || 999,  // ‚úÖ ADD THIS
    lastUpdated: new Date().toISOString()
};

// Debug log
console.log('üíæ taskData.progress:', taskData.progress);
console.log('üíæ Full taskData:', taskData);

        if (currentEditId) {
            // Update existing item
            const item = projectData.find(p => p.firebaseKey === currentEditId);
            
            // Detect changes
            let changes = [];
            if (item.equipment !== taskData.equipment) changes.push(`Equipment: "${item.equipment}" ‚Üí "${taskData.equipment}"`);
            if (item.vendor !== taskData.vendor) changes.push(`Vendor: "${item.vendor}" ‚Üí "${taskData.vendor}"`);
           if (item.priority !== taskData.priority) changes.push(`Priority: ${item.priority} ‚Üí ${taskData.priority}`);
if (item.disc !== taskData.disc) changes.push(`Discipline: ${item.disc || item.task} ‚Üí ${taskData.disc}`);
if (item.taskName !== taskData.taskName) changes.push(`Task: ${item.taskName || 'N/A'} ‚Üí ${taskData.taskName}`);
if (item.status !== taskData.status) changes.push(`Status: ${item.status} ‚Üí ${taskData.status}`);
            if (item.contract !== taskData.contract) changes.push(`Contract: ${item.contract} ‚Üí ${taskData.contract}`);
            if (item.visa !== taskData.visa) changes.push(`VISA: ${item.visa} ‚Üí ${taskData.visa}`);
            if (item.targetDate !== taskData.targetDate) changes.push(`Target Date: ${item.targetDate || 'N/A'} ‚Üí ${taskData.targetDate || 'N/A'}`);
            if (item.mobDate !== taskData.mobDate) changes.push(`MOB Date: ${item.mobDate} ‚Üí ${taskData.mobDate}`);
            if (item.progress !== taskData.progress) changes.push(`Progress: ${item.progress}% ‚Üí ${taskData.progress}%`);
if (item.targetCompDate !== taskData.targetCompDate) changes.push(`Target Comp Date: ${item.targetCompDate || 'N/A'} ‚Üí ${taskData.targetCompDate || 'N/A'}`);
if (item.prognosaCompDate !== taskData.prognosaCompDate) changes.push(`Prognosa Comp Date: ${item.prognosaCompDate || 'N/A'} ‚Üí ${taskData.prognosaCompDate || 'N/A'}`);
if (item.mitigationPlan !== taskData.mitigationPlan) changes.push(`Mitigation Plan updated`);
            
            const changeDescription = changes.length > 0 ? changes.join(', ') : 'No changes detected';
            const userNotes = document.getElementById('modalNotes').value;
            const detailedNotes = userNotes ? `${userNotes} | Changes: ${changeDescription}` : `Changes: ${changeDescription}`;
            
            projectDataRef.child(currentEditId).update(taskData).then(() => {
console.log('‚úÖ Firebase update SUCCESS, progress:', taskData.progress);

   // ‚≠ê UPDATE LOCAL DATA IMMEDIATELY
    const itemIndex = projectData.findIndex(p => p.firebaseKey === currentEditId);
    if (itemIndex !== -1) {
        projectData[itemIndex] = { ...projectData[itemIndex], ...taskData };
        console.log('‚úÖ Local data updated, new progress:', projectData[itemIndex].progress);
    }
    
    // Add to history
    activityHistoryRef.push({
        timestamp: new Date().toISOString(),
        type: 'update',
        category: 'UPDATE',
        title: vendor + ' - ' + equipment.substring(0, 30),
        equipmentId: item.id,
        equipment: equipment,
        vendor: vendor,
        description: `${changes.length} field(s) updated`,
        notes: detailedNotes,
        user: userName.trim(),  // ‚úÖ CHANGED
        icon: 'üìù',
        color: '#27ae60'
    });
    
    showNotification('‚úÖ Task updated successfully! Check the highlighted row.', 'success');
    closeModal();
    
    // ‚≠ê FORCE REPOPULATE TABLE TO TRIGGER SORT
    populateTable();
                
                // Scroll to updated item
                setTimeout(() => {
                    const updatedRow = document.querySelector(`tr[data-firebase-key="${currentEditId}"]`);
                    if (updatedRow) {
                        updatedRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
            }).catch((error) => {
                showNotification('Error updating task: ' + error.message, 'error');
            });
        } else {
            // Add new item
            const newId = Date.now();
            const newItem = {
                id: newId,
                no: projectData.length + 1,
                ...taskData
            };
            
            projectDataRef.push(newItem).then(() => {
                // Add to history
                activityHistoryRef.push({
                    timestamp: new Date().toISOString(),
                    type: 'add',
                    category: 'ADD',
                    title: 'New Task Added',
                    equipmentId: newId,
                    equipment: equipment,
                    vendor: vendor,
                    description: equipment + ' - ' + vendor,
                    notes: 'Priority: ' + taskData.priority + ', Status: ' + taskData.status,
                    user: userName.trim(),  // ‚úÖ CHANGED
                    icon: '‚ûï',
                    color: '#e74c3c'
                });
                
                showNotification('Task added successfully', 'success');
                closeModal();
            }).catch((error) => {
                showNotification('Error adding task: ' + error.message, 'error');
            });
        }
    }


    function deleteItem(firebaseKey) {
        const item = projectData.find(p => p.firebaseKey === firebaseKey);
        if (!item) return;

        if (confirm(`Are you sure you want to delete this item?\n\n${item.equipment} - ${item.vendor}`)) {
            projectDataRef.child(firebaseKey).remove().then(() => {
                // Add to history
                activityHistoryRef.push({
                    timestamp: new Date().toISOString(),
                    type: 'delete',
                    category: 'DELETE',
                    title: 'Task Deleted',
                    equipmentId: null,
                    equipment: item.equipment,
                    vendor: item.vendor,
                    description: item.equipment + ' - ' + item.vendor,
                    notes: 'Task removed from tracking',
                    user:  prompt('Enter your name:') || 'Anonymous',
                    icon: 'üóëÔ∏è',
                    color: '#e74c3c'
                });
                
                showNotification('Item deleted successfully', 'success');
            }).catch((error) => {
                showNotification('Error deleting item: ' + error.message, 'error');
            });
        }
    }

function deleteHistory(firebaseKey) {
    if (confirm('Are you sure you want to delete this history item?')) {
        // ‚≠ê TAMBAHAN BARU - Ambil data history sebelum dihapus
        const historyItem = activityHistory.find(h => h.firebaseKey === firebaseKey);
        
        activityHistoryRef.child(firebaseKey).remove().then(() => {
            showNotification('History deleted successfully', 'success');
            
            // ‚≠ê CEK: Apakah ini delete history dari TASK COMPLETE?
            if (historyItem && historyItem.category === 'TASK COMPLETE') {
                console.log('üîÑ Deleted TASK COMPLETE history - checking if equipment needs reset');
                
                // Cari equipment terkait
                const equipment = projectData.find(p => 
                    p.equipment === historyItem.equipment && 
                    p.vendor === historyItem.vendor
                );
                
                if (equipment && equipment.firebaseKey) {
                    const equipmentKey = equipment.firebaseKey;
                    
                    // Cek apakah masih ada task completed lainnya
                    const tasks = onsiteTasks[equipmentKey] || [];
                    const hasActiveTasks = tasks.some(t => 
                        t.status === 'inprogress' || t.status === 'completed'
                    );
                    
                    if (!hasActiveTasks) {
                        console.log('üîÑ No active tasks left - resetting equipment timestamp');
                        resetEquipmentUpdateTime(equipmentKey);
                        showNotification('History deleted. Equipment returned to original position.', 'info');
                    } else {
                        console.log('‚ÑπÔ∏è Equipment still has active tasks - timestamp not reset');
                    }
                }
            }
        }).catch((error) => {
            showNotification('Error deleting history: ' + error.message, 'error');
        });
    }
}

 let currentHistoryPage = 1;
    const itemsPerPage = 20;
    let filteredHistoryData = [];
    let selectedHistoryItems = new Set();

    function showFullHistory() {
        document.getElementById('historyModal').style.display = 'block';
        currentHistoryPage = 1;
        selectedHistoryItems.clear();
        filteredHistoryData = [...activityHistory];
        renderFullHistory();
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    function renderFullHistory() {
        const searchTerm = document.getElementById('historySearch').value.toLowerCase();
        
        filteredHistoryData = activityHistory.filter(item => {
            return item.title.toLowerCase().includes(searchTerm) ||
                   item.equipment.toLowerCase().includes(searchTerm) ||
                   item.vendor.toLowerCase().includes(searchTerm) ||
                   item.description.toLowerCase().includes(searchTerm);
        });

        const totalPages = Math.ceil(filteredHistoryData.length / itemsPerPage);
        const startIndex = (currentHistoryPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageItems = filteredHistoryData.slice(startIndex, endIndex);

        const container = document.getElementById('fullHistoryContainer');
        
        if (pageItems.length === 0) {
            container.innerHTML = '<div style="padding: 40px; text-align: center; color: #95a5a6;">No history found</div>';
        } else {
            container.innerHTML = pageItems.map(item => `
                <div style="border: 1px solid #ecf0f1; border-radius: 4px; padding: 12px; margin-bottom: 10px; background: ${selectedHistoryItems.has(item.firebaseKey) ? '#e8f4f8' : 'white'};">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <input type="checkbox" ${selectedHistoryItems.has(item.firebaseKey) ? 'checked' : ''} onchange="toggleHistorySelection('${item.firebaseKey}')" style="margin-top: 3px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong style="font-size: 11px; color: #2c3e50;">${new Date(item.timestamp).toLocaleString()}</strong>
                                <span style="font-size: 9px; background: ${item.color}; color: white; padding: 2px 8px; border-radius: 10px;">${item.category}</span>
                            </div>
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 3px;">${item.title}</div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">${item.description}</div>
                            <div style="font-size: 10px; color: #999; background: #f8f9fa; padding: 4px 8px; border-radius: 3px; word-wrap: break-word; white-space: pre-wrap; line-height: 1.4; overflow-wrap: break-word; max-width: 100%; word-break: break-word;">${item.icon} ${item.notes}</div>
                            <div style="font-size: 9px; color: #95a5a6; margin-top: 5px;">by ${item.user}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('historyPageInfo').textContent = `${startIndex + 1}-${Math.min(endIndex, filteredHistoryData.length)} of ${filteredHistoryData.length}`;
        
        document.getElementById('prevPageBtn').disabled = currentHistoryPage === 1;
        document.getElementById('nextPageBtn').disabled = currentHistoryPage === totalPages || totalPages === 0;

        renderPageNumbers(totalPages);
    }

    function renderPageNumbers(totalPages) {
        const pageNumbersDiv = document.getElementById('pageNumbers');
        let html = '';
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentHistoryPage - 2 && i <= currentHistoryPage + 2)) {
                html += `<button onclick="goToHistoryPage(${i})" style="padding: 6px 10px; background: ${i === currentHistoryPage ? '#3498db' : '#ecf0f1'}; color: ${i === currentHistoryPage ? 'white' : '#2c3e50'}; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; min-width: 30px;">${i}</button>`;
            } else if (i === currentHistoryPage - 3 || i === currentHistoryPage + 3) {
                html += '<span style="padding: 0 5px;">...</span>';
            }
        }
        
        pageNumbersDiv.innerHTML = html;
    }

    function changeHistoryPage(direction) {
        const totalPages = Math.ceil(filteredHistoryData.length / itemsPerPage);
        const newPage = currentHistoryPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentHistoryPage = newPage;
            renderFullHistory();
        }
    }

    function goToHistoryPage(page) {
        currentHistoryPage = page;
        renderFullHistory();
    }

    function toggleHistorySelection(firebaseKey) {
        if (selectedHistoryItems.has(firebaseKey)) {
            selectedHistoryItems.delete(firebaseKey);
        } else {
            selectedHistoryItems.add(firebaseKey);
        }
        renderFullHistory();
    }

    function selectAllHistory() {
        const pageItems = filteredHistoryData.slice((currentHistoryPage - 1) * itemsPerPage, currentHistoryPage * itemsPerPage);
        pageItems.forEach(item => selectedHistoryItems.add(item.firebaseKey));
        renderFullHistory();
    }

    function deleteSelectedHistory() {
        if (selectedHistoryItems.size === 0) {
            showNotification('No items selected', 'error');
            return;
        }

        if (confirm(`Delete ${selectedHistoryItems.size} selected history items?`)) {
            const promises = Array.from(selectedHistoryItems).map(key => 
                activityHistoryRef.child(key).remove()
            );

            Promise.all(promises).then(() => {
                showNotification(`${selectedHistoryItems.size} items deleted`, 'success');
                selectedHistoryItems.clear();
                renderFullHistory();
            }).catch((error) => {
                showNotification('Error deleting items: ' + error.message, 'error');
            });
        }
    }

    function exportHistoryPDF() {
        const printWindow = window.open('', '_blank');
        const currentDate = new Date().toLocaleString();
        
        const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Activity History Report</title>
        <style>
            body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                font-size: 11px; 
                background: white; 
                color: #333; 
            }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                    .header h1 { margin: 0; font-size: 20px; color: #333; }
                    .history-item { border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; page-break-inside: avoid; }
                    .timestamp { font-weight: bold; color: #2c3e50; font-size: 10px; }
                    .category { background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 9px; display: inline-block; }
                    .title { font-weight: bold; margin: 5px 0; font-size: 12px; }
                    .description { color: #666; margin: 3px 0; }
                    .notes { background: #f8f9fa; padding: 6px 10px; margin: 5px 0; border-radius: 3px; font-size: 10px; word-wrap: break-word; white-space: pre-wrap; line-height: 1.6; overflow-wrap: break-word; word-break: break-word; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Activity History Report</h1>
                    <p>Generated on: ${currentDate}</p>
                    <p>Total Records: ${filteredHistoryData.length}</p>
                </div>
                ${filteredHistoryData.map(item => `
                    <div class="history-item">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span class="timestamp">${new Date(item.timestamp).toLocaleString()}</span>
                            <span class="category">${item.category}</span>
                        </div>
                        <div class="title">${item.title}</div>
                        <div class="description">${item.description}</div>
                        <div class="notes">${item.icon} ${item.notes}</div>
                        <div style="font-size: 9px; color: #999; margin-top: 5px;">by ${item.user}</div>
                    </div>
                `).join('')}
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #333; text-align: center;">
                    <p style="margin: 0; font-size: 10px; font-weight: bold;">Developed by TS-KPB</p>
                    <p style="margin: 5px 0 0 0; font-size: 8px; color: #999;">¬© 2025 All Rights Reserved</p>
                </div>
            </body>
            </html>
        `;
        
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.print();
        };
    }

    // Search history on input
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('historySearch');
        if (searchInput) {
            searchInput.addEventListener('keyup', renderFullHistory);
        }
});

// ===== PROGRESS REPORT =====
let currentEquipmentReport = null;
let currentReportPage = 1;
const itemsPerReportPage = 5;
let reportFilterDateFrom = null;
let reportFilterDateTo = null;
let reportFilterType = 'all';

    function showProgressReport() {
        const filterValue = document.getElementById('equipmentHistoryFilter').value;
        
        if (filterValue === 'all') {
            showNotification('Please select an equipment first', 'error');
            return;
        }

        const equipmentId = parseInt(filterValue);
        const equipmentHistory = activityHistory.filter(item => item.equipmentId === equipmentId);
        
        if (equipmentHistory.length === 0) {
            showNotification('No history found for this equipment', 'error');
            return;
        }

        // Get current equipment data
        const currentEquipment = projectData.find(item => item.id === equipmentId);
        
        if (!currentEquipment) {
            showNotification('Equipment not found', 'error');
            return;
        }

        currentEquipmentReport = {
            equipment: currentEquipment,
            history: equipmentHistory
        };

        renderProgressReport();
        document.getElementById('progressReportModal').style.display = 'block';
    }

// NEW FUNCTION: Show Progress Report by Firebase Key (from table button)
function showProgressReportById(firebaseKey) {
    console.log('showProgressReportById called with:', firebaseKey);
    
    const item = projectData.find(p => p.firebaseKey === firebaseKey);
    console.log('Found item:', item);
    
    if (!item) {
        showNotification('Equipment not found', 'error');
        return;
    }

    const equipmentId = item.id;
    const equipmentHistory = activityHistory.filter(h => h.equipmentId === equipmentId);
    
    console.log('Equipment history:', equipmentHistory);
    
    // Create equipment title with disc
    const equipmentTitle = item.disc ? 
        `${item.equipment} (${item.vendor}) - ${item.disc}` : 
        `${item.equipment} (${item.vendor})`;
    
    // Allow showing report even with no history
    currentEquipmentReport = {
        equipment: item,
        equipmentTitle: equipmentTitle,
        history: equipmentHistory
    };

    renderProgressReport();
    document.getElementById('progressReportModal').style.display = 'block';
    
    if (equipmentHistory.length === 0) {
        showNotification('No activity history yet for this equipment', 'success');
    }
}

    function closeProgressReport() {
        document.getElementById('progressReportModal').style.display = 'none';
    }
// ===== REPORT FILTER & PAGINATION FUNCTIONS =====

function applyReportFilter() {
    reportFilterDateFrom = document.getElementById('reportDateFrom').value;
    reportFilterDateTo = document.getElementById('reportDateTo').value;
    reportFilterType = document.getElementById('reportFilterType').value;
    currentReportPage = 1;
    renderProgressReport();
}

function clearReportFilter() {
    document.getElementById('reportDateFrom').value = '';
    document.getElementById('reportDateTo').value = '';
    document.getElementById('reportFilterType').value = 'all';
    reportFilterDateFrom = null;
    reportFilterDateTo = null;
    reportFilterType = 'all';
    currentReportPage = 1;
    renderProgressReport();
    showNotification('Filter direset', 'success');
}

function changeReportPage(direction) {
    if (!currentEquipmentReport) return;
    
    const filteredHistory = getFilteredHistory();
    const totalPages = Math.ceil(filteredHistory.length / itemsPerReportPage);
    const newPage = currentReportPage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentReportPage = newPage;
        renderProgressReport();
        
        // Scroll to top of timeline
        document.getElementById('progressReportContent').scrollTop = 0;
    }
}

function goToReportPage(page) {
    currentReportPage = page;
    renderProgressReport();
    document.getElementById('progressReportContent').scrollTop = 0;
}

function getFilteredHistory() {
    if (!currentEquipmentReport) return [];
    
    let filtered = currentEquipmentReport.history.filter(item => item && item.timestamp);
    
    // Filter by date range
    if (reportFilterDateFrom) {
        const fromDate = new Date(reportFilterDateFrom);
        fromDate.setHours(0, 0, 0, 0);
        filtered = filtered.filter(item => new Date(item.timestamp) >= fromDate);
    }
    
    if (reportFilterDateTo) {
        const toDate = new Date(reportFilterDateTo);
        toDate.setHours(23, 59, 59, 999);
        filtered = filtered.filter(item => new Date(item.timestamp) <= toDate);
    }
    
    // Filter by type
    if (reportFilterType !== 'all') {
        filtered = filtered.filter(item => item.category === reportFilterType);
    }
    
    return filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
}

function renderReportPageNumbers(totalPages) {
    const pageNumbersDiv = document.getElementById('reportPageNumbers');
    let html = '';
    
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentReportPage - 1 && i <= currentReportPage + 1)) {
            html += `<button onclick="goToReportPage(${i})" style="padding: 6px 10px; background: ${i === currentReportPage ? '#667eea' : '#ecf0f1'}; color: ${i === currentReportPage ? 'white' : '#2c3e50'}; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; min-width: 32px; font-weight: ${i === currentReportPage ? '700' : '600'};">${i}</button>`;
        } else if (i === currentReportPage - 2 || i === currentReportPage + 2) {
            html += '<span style="padding: 0 5px; color: #95a5a6;">...</span>';
        }
    }
    
    pageNumbersDiv.innerHTML = html;
}
    function renderProgressReport() {
    if (!currentEquipmentReport) return;

    const { equipment, equipmentTitle, history } = currentEquipmentReport;
    const container = document.getElementById('progressReportContent');
    
    // Use equipmentTitle with disc format
    const displayTitle = equipmentTitle || 
        (equipment.disc ? 
            `${equipment.equipment} (${equipment.vendor}) - ${equipment.disc}` : 
            `${equipment.equipment} (${equipment.vendor})`);
    
    // Filter and sort history
    // Get filtered history with pagination
const filteredHistory = getFilteredHistory();
const totalPages = Math.ceil(filteredHistory.length / itemsPerReportPage);
const startIndex = (currentReportPage - 1) * itemsPerReportPage;
const endIndex = startIndex + itemsPerReportPage;
const sortedHistory = filteredHistory.slice(startIndex, endIndex);

// Update filter stats
document.getElementById('reportTotalCount').textContent = filteredHistory.length;
    
    // Handle empty history
    if (sortedHistory.length === 0) {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h2 style="margin: 0 0 10px 0; font-size: 18px;">${displayTitle}</h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 12px;">
                    <div><strong>Vendor:</strong> ${equipment.vendor}</div>
                    <div><strong>Priority:</strong> ${equipment.priority}</div>
                    <div><strong>Status:</strong> ${equipment.status}</div>
                    <div><strong>Progress:</strong> ${equipment.progress}%</div>
                </div>
            </div>
            <div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                <p style="font-size: 16px; color: #95a5a6; margin-bottom: 10px;">üìã No activity history yet</p>
                <p style="font-size: 12px; color: #bdc3c7;">Updates will appear here as changes are made</p>
            </div>
        `;
        return;
    }
    
    const firstUpdate = sortedHistory[0];
    const lastUpdate = sortedHistory[sortedHistory.length - 1];
    const duration = sortedHistory.length > 1 
        ? Math.ceil((new Date(lastUpdate.timestamp) - new Date(firstUpdate.timestamp)) / (1000 * 60 * 60 * 24))
        : 0;

    const statusChanges = sortedHistory.filter(item => item.category === 'UPDATE');

   // Use the displayTitle that was created at the beginning (line 11-13)
    const vendorInfo = equipment.vendor ? 
        `${equipment.vendor}` : 
        'N/A';
    
    container.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h2 style="margin: 0 0 10px 0; font-size: 18px;">${displayTitle}</h2>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 12px;">
                <div><strong>Vendor:</strong> ${vendorInfo}</div>
                <div><strong>Priority:</strong> <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">${equipment.priority}</span></div>
                <div><strong>Discipline/Phase:</strong> <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">${equipment.disc || 'N/A'}</span></div>
                <div><strong>Task Name:</strong> ${equipment.taskName || '-'}</div>
                <div><strong>Current Status:</strong> <span style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">${equipment.status}</span></div>
                <div><strong>Overall Progress:</strong> 
                    <span style="background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 3px; font-weight: bold;">
                        ${equipment.progress}%
                    </span>
                </div>
            </div>
        </div>

        ${equipment.mitigationPlan ? `
        <div style="background: #fff3cd; border-left: 4px solid #f39c12; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #f39c12;">‚ö†Ô∏è Work Mitigation Plan</h3>
            <div style="font-size: 12px; color: #856404; white-space: pre-wrap;">${equipment.mitigationPlan}</div>
        </div>
        ` : ''}

        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #2c3e50;">Summary Statistics</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div style="background: white; padding: 15px; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">${sortedHistory.length}</div>
                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 5px;">Total Updates</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${duration || 'N/A'}</div>
                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 5px;">${duration > 0 ? 'Days' : 'New'}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${statusChanges.length}</div>
                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 5px;">Changes</div>
                </div>
            </div>
        </div>

        <div style="background: white; border: 1px solid #ecf0f1; border-radius: 8px; padding: 20px;">
            <h3 style="margin: 0 0 20px 0; font-size: 14px;">Timeline</h3>
            ${sortedHistory.map(item => `
                <div style="padding: 12px; margin-bottom: 10px; background: #f8f9fa; border-left: 3px solid ${item.color}; border-radius: 6px;">
                    <div style="font-size: 11px; color: #2c3e50; margin-bottom: 5px;">
                        <strong>${new Date(item.timestamp).toLocaleString()}</strong>
                        <span style="float: right; background: ${item.color}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 9px;">${item.category}</span>
                    </div>
                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 3px;">${item.title}</div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 5px;">${item.description}</div>
                    <div style="font-size: 10px; color: #999; background: white; padding: 8px; border-radius: 4px; white-space: pre-wrap;">${item.icon} ${item.notes}</div>
                    <div style="font-size: 9px; color: #95a5a6; margin-top: 5px;">by ${item.user}</div>
                </div>
            `).join('')}
        </div>

        ${onsiteTasks[equipment.firebaseKey] && onsiteTasks[equipment.firebaseKey].length > 0 ? `
        <div style="background: white; border: 1px solid #ecf0f1; border-radius: 8px; padding: 20px; margin-top: 20px;">
            <h3 style="margin: 0 0 20px 0; font-size: 14px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">
                üìã Onsite Task Completion History
            </h3>
            ${renderTaskCompletionHistory(equipment.firebaseKey)}
        </div>
        ` : ''}
    `;
// Update pagination
    const pageStart = startIndex + 1;
    const pageEnd = Math.min(endIndex, filteredHistory.length);
    document.getElementById('reportPageInfo').textContent = 
        `${pageStart}-${pageEnd} dari ${filteredHistory.length}`;
    
    document.getElementById('prevReportPageBtn').disabled = currentReportPage === 1;
    document.getElementById('nextReportPageBtn').disabled = currentReportPage === totalPages || totalPages === 0;
    
    renderReportPageNumbers(totalPages);
}

    function exportProgressReportPDF() {
        if (!currentEquipmentReport) return;

        const { equipment, equipmentTitle, history } = currentEquipmentReport;
        const sortedHistory = [...history].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
// Add this line:
const displayTitle = equipmentTitle || 
    (equipment.disc ? 
        `${equipment.equipment} (${equipment.vendor}) - ${equipment.disc}` : 
        `${equipment.equipment} (${equipment.vendor})`);
        const printWindow = window.open('', '_blank');
        const currentDate = new Date().toLocaleString();
        
        const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Progress Report - ${equipmentTitle || equipment.equipment}</title>
        <style>
            body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                font-size: 11px; 
                background: white; 
                color: #333; 
            }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                    .header h1 { margin: 0; font-size: 18px; color: #333; }
                    .info-box { background: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 6px; }
                    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
                    .timeline-item { margin-bottom: 20px; padding: 12px; padding-left: 20px; border-left: 3px solid #3498db; page-break-inside: avoid; background: #f8f9fa; }
                    .timestamp { font-weight: bold; font-size: 10px; margin-bottom: 5px; }
                    .title { font-weight: bold; margin: 5px 0; font-size: 11px; }
                    .description { margin: 5px 0; font-size: 10px; color: #666; }
                    .notes { 
                        background: white; 
                        padding: 8px 10px; 
                        margin: 8px 0; 
                        border-radius: 4px; 
                        font-size: 10px; 
                        color: #666; 
                        white-space: pre-wrap;
                        word-wrap: break-word;
                        line-height: 1.6;
                        border: 1px solid #e0e0e0;
                    }
                    .user-info { font-size: 9px; color: #999; margin-top: 5px; }
                </style>
            </head>
            <body>
                <div class="header">
<h1>Equipment Progress Report</h1>
<p>${equipmentTitle || (equipment.disc ? `${equipment.equipment} (${equipment.vendor}) - ${equipment.disc}` : `${equipment.equipment} (${equipment.vendor})`)}</p>
<p style="font-size: 10px;">Generated on: ${currentDate}</p>                    
                </div>
                
                <div class="info-box">
    <div class="info-grid">
        <div><strong>Vendor:</strong> ${equipment.vendor}</div>
        <div><strong>Priority:</strong> ${equipment.priority}</div>
        <div><strong>Discipline:</strong> ${equipment.disc || equipment.task}</div>
        <div><strong>Task:</strong> ${equipment.taskName || '-'}</div>
        <div><strong>Status:</strong> ${equipment.status}</div>
        <div><strong>Progress:</strong> ${equipment.progress}%</div>
        <div><strong>Contract:</strong> ${equipment.contract}</div>
        <div><strong>VISA:</strong> ${equipment.visa}</div>
    </div>
</div>

${equipment.mitigationPlan ? `
<div style="background: #fff3cd; border-left: 4px solid #f39c12; padding: 15px; border-radius: 6px; margin: 20px 0;">
    <h3 style="margin: 0 0 10px 0; font-size: 13px; color: #f39c12;">‚ö†Ô∏è Work Mitigation Plan</h3>
    <div style="font-size: 11px; color: #856404; white-space: pre-wrap; line-height: 1.6;">${equipment.mitigationPlan}</div>
</div>
` : ''}

<h3 style="margin-top: 30px;">Activity Timeline:</h3>
                ${sortedHistory.map(item => `
                    <div class="timeline-item">
                        <div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>
                        <div class="title">${item.icon} ${item.title}</div>
                        <div class="description">${item.description}</div>
                        <div class="notes">${item.notes}</div>
                        <div class="user-info">by ${item.user}</div>
                    </div>
                `).join('')}

                <div style="margin-top: 30px; padding-top: 15px; border-top: 2px solid #333; text-align: center;">
                    <p style="margin: 0; font-size: 10px; font-weight: bold;">Developed by TS-KPB</p>
                    <p style="margin: 5px 0 0 0; font-size: 8px; color: #999;">¬© 2025 All Rights Reserved</p>
                </div>
            </body>
            </html>
        `;
        
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.print();
        };
    }

// ===== ONSITE TASK TRACKER FUNCTIONS =====

function openTaskTracker(firebaseKey) {
    const item = projectData.find(p => p.firebaseKey === firebaseKey);
    if (!item) {
        showNotification('Equipment not found', 'error');
        return;
    }

    currentEquipmentTasks = {
        equipment: item,
        firebaseKey: firebaseKey
    };

    renderTaskTracker();
    document.getElementById('taskTrackerModal').style.display = 'block';
}

function closeTaskTracker() {
    document.getElementById('taskTrackerModal').style.display = 'none';
    currentEquipmentTasks = null;
}

function renderTaskTracker() {
    if (!currentEquipmentTasks) return;

    const { equipment, firebaseKey } = currentEquipmentTasks;
    const tasks = onsiteTasks[firebaseKey] || [];
    
    // Update modal title
    document.getElementById('taskTrackerTitle').textContent = 
        `üìã Onsite Task Tracker - ${equipment.equipment}`;

    // Calculate statistics
    // Calculate statistics
    const completedTasks = tasks.filter(t => t.status === 'completed');
    const inProgressTasks = tasks.filter(t => t.status === 'inprogress');
    const pendingTasks = tasks.filter(t => t.status === 'pending');
    
    // ===== AUTO-SORT ONSITE TASKS BY LAST UPDATE =====
    const sortTasksByUpdate = (taskArray) => {
        if (!autoSortEnabled || taskArray.length === 0) return taskArray;
        
        return taskArray.sort((a, b) => {
            const dateA = a.lastTaskUpdate ? new Date(a.lastTaskUpdate) : new Date(0);
            const dateB = b.lastTaskUpdate ? new Date(b.lastTaskUpdate) : new Date(0);
            return dateB - dateA; // Newest first
        });
    };
    
    // Sort by sequence instead of update time
const sortBySequence = (taskArray) => {
    return taskArray.sort((a, b) => (a.sequence || 999) - (b.sequence || 999));
};

const sortedCompleted = sortBySequence([...completedTasks]);
const sortedInProgress = sortBySequence([...inProgressTasks]);
const sortedPending = sortBySequence([...pendingTasks]);
    
    const totalTasks = tasks.length;
    const completedCount = completedTasks.length;
    const overallProgress = calculateWeightedProgress(tasks);

    // Calculate prognosis
    const mobDate = equipment.mobDate ? new Date(parseDateString(equipment.mobDate)) : null;
    const targetCompDate = equipment.targetCompDate ? new Date(equipment.targetCompDate) : null;
    const today = new Date();
    
    let daysSinceMob = 0;
    let daysToTarget = 0;
    let prognosisDate = null;
    let riskLevel = 'low';
    
    if (mobDate && targetCompDate) {
        daysSinceMob = Math.ceil((today - mobDate) / (1000 * 60 * 60 * 24));
        daysToTarget = Math.ceil((targetCompDate - today) / (1000 * 60 * 60 * 24));
        
        // Calculate average task completion time
        const completedTasksWithDates = completedTasks.filter(t => t.startDate && t.completedDate);
        let avgTaskDays = 0;
        
        if (completedTasksWithDates.length > 0) {
            const totalDays = completedTasksWithDates.reduce((sum, t) => {
                const start = new Date(t.startDate);
                const end = new Date(t.completedDate);
                return sum + Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            }, 0);
            avgTaskDays = totalDays / completedTasksWithDates.length;
        } else {
            avgTaskDays = 3; // default estimate
        }
        
        // Calculate remaining work
        const remainingTasks = totalTasks - completedCount;
        const estimatedRemainingDays = remainingTasks * avgTaskDays;
        
        prognosisDate = new Date(today);
        prognosisDate.setDate(prognosisDate.getDate() + estimatedRemainingDays);
        
        // Determine risk level
        const delayDays = Math.ceil((prognosisDate - targetCompDate) / (1000 * 60 * 60 * 24));
        if (delayDays > 5) {
            riskLevel = 'high';
        } else if (delayDays > 0) {
            riskLevel = 'medium';
        } else {
            riskLevel = 'low';
        }
    }

    const content = `
        <!-- Overall Progress -->
        <div class="task-overall-progress">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0; font-size: 14px; color: #2c3e50;">Overall Progress</h4>
                <span style="font-size: 12px; color: #7f8c8d;">${completedCount}/${totalTasks} tasks completed</span>
            </div>
            <div class="task-overall-bar">
                <div class="task-overall-fill" style="width: ${overallProgress}%;">
                    ${overallProgress}%
                </div>
            </div>
        </div>

        <!-- Analytics -->
        <div class="task-analytics">
            <h4 style="margin: 0 0 5px 0; font-size: 14px;">üìä Performance Analytics</h4>
            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 10px;">
                ${equipment.vendor} | MOB: ${equipment.mobDate} | Target: ${targetCompDate ? formatDateForDisplay(equipment.targetCompDate) : 'N/A'}
            </div>
            
            <div class="task-analytics-grid">
                <div class="task-analytics-item">
                    <div class="task-analytics-value">${daysSinceMob}</div>
                    <div class="task-analytics-label">Days Since Mobilization</div>
                </div>
                <div class="task-analytics-item">
                    <div class="task-analytics-value">${daysToTarget}</div>
                    <div class="task-analytics-label">Days to Target</div>
                </div>
                <div class="task-analytics-item">
                    <div class="task-analytics-value">${completedCount}/${totalTasks}</div>
                    <div class="task-analytics-label">Tasks Completed</div>
                </div>
                <div class="task-analytics-item">
                    <div class="task-analytics-value">${overallProgress}%</div>
                    <div class="task-analytics-label">Work Completed</div>
                </div>
            </div>

            ${prognosisDate ? `
            <div class="task-prognosis">
                <div class="task-prognosis-header">
                    üéØ Prognosa Completion: ${formatDateForDisplay(prognosisDate.toISOString().split('T')[0])}
                    <span class="task-risk-badge task-risk-${riskLevel}">
                        ${riskLevel === 'high' ? 'üî¥ HIGH RISK' : riskLevel === 'medium' ? 'üü° MEDIUM' : 'üü¢ ON TRACK'}
                    </span>
                </div>
                <div style="font-size: 11px; color: #6c757d;">
                    ${prognosisDate > targetCompDate ? 
                        `‚ö†Ô∏è Estimated ${Math.ceil((prognosisDate - targetCompDate) / (1000 * 60 * 60 * 24))} days delay from target` : 
                        `‚úÖ Expected to complete ${Math.ceil((targetCompDate - prognosisDate) / (1000 * 60 * 60 * 24))} days early`
                    }
                </div>
            </div>
            ` : ''}
        </div>

        ${riskLevel !== 'low' ? `
        <div class="task-recommendations">
            <div class="task-recommendations-title">üí° Recommended Actions:</div>
            <ul class="task-recommendations-list">
                ${riskLevel === 'high' ? `
                    <li>Fast-track in-progress tasks with additional resources</li>
                    <li>Consider parallel execution of independent tasks</li>
                    <li>Schedule weekend/overtime work if necessary</li>
                    <li>Review and optimize task dependencies</li>
                ` : `
                    <li>Monitor progress closely for next few days</li>
                    <li>Ensure resources are available as planned</li>
                    <li>Prepare mitigation plan if delays occur</li>
                `}
            </ul>
        </div>
        ` : ''}

        <!-- Task Groups -->
       <!-- Task Groups -->
        ${renderTaskGroup('completed', 'Completed', sortedCompleted, 'üü¢', true)}
        ${renderTaskGroup('inprogress', 'In Progress', sortedInProgress, 'üü°', false)}
        ${renderTaskGroup('pending', 'Pending', sortedPending, '‚ö™', false)}

        <!-- Add Task Button -->
        <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
    <button onclick="openProgressReportModal()" style="padding: 12px 24px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
        üìä Generate Report
    </button>
    <button onclick="openTaskEditModal()" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
        ‚ûï Add New Task
    </button>
</div>
    `;

    document.getElementById('taskTrackerContent').innerHTML = content;
}

// Helper: Calculate weighted progress for specific tasks array
function calculateWeightedProgressForTasks(tasks) {
    if (!tasks || tasks.length === 0) return 0;
    
    const totalWeight = tasks.reduce((sum, t) => sum + (parseFloat(t.weight) || 1), 0);
    const weightedProgress = tasks.reduce((sum, t) => {
        const weight = parseFloat(t.weight) || 1;
        const progress = parseFloat(t.progress) || 0;
        return sum + (weight * progress / 100);
    }, 0);
    
    return totalWeight > 0 ? Math.round((weightedProgress / totalWeight) * 100) : 0;
}

// Helper: Get status for a group based on progress
function getGroupStatus(progress, tasks) {
    const completed = tasks.filter(t => t.progress === 100).length;
    const blocked = tasks.filter(t => t.status === 'blocked').length;
    const total = tasks.length;
    
    if (progress === 100) {
        return { text: 'COMPLETED', color: '#27ae60' };
    }
    
    if (blocked > 0) {
        return { text: 'BLOCKED', color: '#e74c3c' };
    }
    
    if (progress >= 75) {
        return { text: 'ON TRACK', color: '#3498db' };
    }
    
    if (progress >= 50) {
        return { text: 'AT RISK', color: '#f39c12' };
    }
    
    if (progress >= 25) {
        return { text: 'BEHIND', color: '#e67e22' };
    }
    
    return { text: 'CRITICAL', color: '#e74c3c' };
}

// ===== REPORT GENERATION FUNCTIONS =====

function openProgressReportModal() {
    if (!currentEquipmentTasks || !currentEquipmentTasks.equipment) {
        showNotification('Please open a task tracker first', 'error');
        return;
    }
    
    const equipment = currentEquipmentTasks.equipment;
    
    // Extract base equipment name
// Supports formats: "(WGC) K-052-03" or "Equipment (K-052-03)"
const equipmentName = equipment.equipment || '';

let baseName = '';

// Check for tag pattern after parentheses: "(WGC) K-052-03"
const afterParens = equipmentName.match(/\)\s*([A-Z0-9\-]+)/);
if (afterParens) {
    baseName = afterParens[1].trim();
} else {
    // Try to extract from inside parentheses: "Equipment (K-052-03)"
    const inParens = equipmentName.match(/\(([^)]+)\)/);
    if (inParens) {
        baseName = inParens[1].replace(/\s+[A-Z]+$/g, '').trim();
    } else {
        baseName = equipmentName.trim();
    }
}
    
    // Set base name
    document.getElementById('reportEquipmentBase').value = baseName;
    
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('reportDate').value = today;
    
    // Find and display related groups
populateRelatedGroups(baseName);

// ‚úÖ Initialize milestones (preserve existing data)
if (!reportMilestones) {
    reportMilestones = [];
}
renderMilestones();

// ‚úÖ LOAD Previous Highlights & Action Plan
loadPreviousReportSettings(baseName);
    
    // Show modal
    document.getElementById('reportModal').style.display = 'block';
}

function closeProgressReportModal() {
    document.getElementById('reportModal').style.display = 'none';
}

// Populate related groups based on equipment base name
function populateRelatedGroups(baseName) {
    const relatedContainer = document.getElementById('reportGroupsList');
    if (!relatedContainer) {
        console.log('‚ùå reportGroupsList not found');
        return;
    }
    
    relatedContainer.innerHTML = '<div style="padding: 10px; color: #95a5a6;">Searching for related groups...</div>';
    
    // Find all tasks matching the base name
    const matchingTasks = projectData.filter(task => {
        const equipmentName = task.equipment || '';
        
        // Extract base from task
        let taskBase = '';

// Check for tag pattern after parentheses: "(WGC) K-052-03"
const afterParens = equipmentName.match(/\)\s*([A-Z0-9\-]+)/);
if (afterParens) {
    taskBase = afterParens[1].trim();
} else {
    // Try to extract from inside parentheses: "Equipment (K-052-03)"
    const inParens = equipmentName.match(/\(([^)]+)\)/);
    if (inParens) {
        taskBase = inParens[1].replace(/\s+[A-Z]+$/g, '').trim();
    } else {
        taskBase = equipmentName.trim();
    }
}
        
        return taskBase === baseName;
    });
    
    if (matchingTasks.length === 0) {
        relatedContainer.innerHTML = '<div style="padding: 10px; color: #e74c3c;">No related groups found</div>';
        return;
    }
    
    // Group by Equipment + Disc + Vendor + Task
    const groups = {};
    
    matchingTasks.forEach(task => {
    const equipment = task.equipment || 'Unknown';
    
    // Clean disc - remove parentheses suffix like "(1)", "(2)"
    let disc = task.disc || 'N/A';
    disc = disc.replace(/\s*\([0-9]+\)\s*$/, '').trim();
    
    const vendor = task.vendor || 'Unknown';
    
    // Use taskName field (not task field which is "custom")
    const taskName = task.taskName || 'N/A';
    
    // Create unique key: equipment + disc + vendor + taskName
    const groupKey = `${equipment}|${disc}|${vendor}|${taskName}`;
        
        if (!groups[groupKey]) {
            groups[groupKey] = {
                equipment: equipment,
                disc: disc,
                vendor: vendor,
                task: taskName,
                tasks: [],
                displayName: `${equipment} - ${disc} (${vendor}) - ${taskName}`,
		displaySequence: task.displaySequence || 999  // ‚úÖ ADD THIS!
            };
        }
        
        groups[groupKey].tasks.push(task);
    });
    
    // Convert to array and sort
    const groupArray = Object.values(groups);
    
    // Sort by displaySequence if available
    groupArray.sort((a, b) => {
        const seqA = a.tasks[0]?.displaySequence || 999;
        const seqB = b.tasks[0]?.displaySequence || 999;
        
        if (seqA !== seqB) return seqA - seqB;
        
        const equipCompare = a.equipment.localeCompare(b.equipment);
        if (equipCompare !== 0) return equipCompare;
        
        const discCompare = a.disc.localeCompare(b.disc);
        if (discCompare !== 0) return discCompare;
        
        return a.task.localeCompare(b.task);
    });
    
    // Render groups
    relatedContainer.innerHTML = '';
    
    if (groupArray.length === 0) {
        relatedContainer.innerHTML = '<div style="padding: 10px; color: #95a5a6;">No groups found</div>';
        return;
    }
    
    // Add header with count
    const headerDiv = document.createElement('div');
    headerDiv.style.cssText = 'padding: 10px; background: #f8f9fa; border-bottom: 2px solid #3498db; font-weight: bold; color: #2c3e50;';
    headerDiv.textContent = `Found ${groupArray.length} related group${groupArray.length > 1 ? 's' : ''}:`;
    relatedContainer.appendChild(headerDiv);
    
    groupArray.forEach((group, index) => {
        const groupDiv = document.createElement('div');
        groupDiv.style.cssText = 'padding: 10px; border-bottom: 1px solid #ecf0f1; display: flex; align-items: center; gap: 10px;';
        
        const checkbox = document.createElement('input');
checkbox.type = 'checkbox';
checkbox.checked = true;
checkbox.id = `group_${index}`;
checkbox.className = 'report-group-checkbox'; // ‚úÖ ADD CLASS
checkbox.value = group.tasks[0]?.firebaseKey || ''; // ‚úÖ ADD VALUE
checkbox.dataset.equipment = group.equipment;
checkbox.dataset.disc = group.disc;
checkbox.dataset.vendor = group.vendor;
checkbox.dataset.task = group.task;
checkbox.dataset.displaysequence = group.displaySequence || 999; // ‚úÖ ADD THIS LINE!
checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
        
        const label = document.createElement('label');
        label.htmlFor = `group_${index}`;
        label.style.cssText = 'flex: 1; cursor: pointer; font-size: 13px; color: #2c3e50;';
        
        // Display with task name
        label.innerHTML = `
            <span style="font-weight: 600; color: #3498db;">${group.equipment}</span>
            <span style="padding: 2px 8px; background: #3498db; color: white; border-radius: 3px; font-size: 11px; margin: 0 5px;">${group.disc}</span>
            <span style="color: #7f8c8d;">(${group.vendor})</span>
            <span style="padding: 2px 8px; background: #27ae60; color: white; border-radius: 3px; font-size: 11px; margin: 0 5px;">${group.task}</span>
            <span style="color: #95a5a6; font-size: 11px; margin-left: 10px;">${group.tasks.length} item(s)</span>
        `;
        
        groupDiv.appendChild(checkbox);
        groupDiv.appendChild(label);
        relatedContainer.appendChild(groupDiv);
    });
    
    console.log(`‚úÖ Found ${groupArray.length} related groups for ${baseName}`);
}

// Helper function to calculate task timeline status
function getTaskTimelineStatus(task) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const progress = parseInt(task.progress) || 0;
    const targetStart = task.targetStart ? new Date(task.targetStart) : null;
    const targetEnd = task.targetEnd ? new Date(task.targetEnd) : null;
    const startDate = task.startDate ? new Date(task.startDate) : null;
    const completedDate = task.completedDate ? new Date(task.completedDate) : null;
    
    let timelineStatus = '';
    let timelineIcon = '';
    let timelineColor = '#95a5a6'; // Default gray
    
    // COMPLETED TASKS
    if (progress === 100 || task.status === 'completed') {
        if (completedDate && targetEnd) {
            const daysDiff = Math.ceil((targetEnd - completedDate) / (1000 * 60 * 60 * 24));
            if (daysDiff > 0) {
                timelineStatus = `${daysDiff}d early`;
                timelineIcon = 'üîµ';
                timelineColor = '#3498db';
            } else if (daysDiff < 0) {
                timelineStatus = `${Math.abs(daysDiff)}d late`;
                timelineIcon = 'üî¥';
                timelineColor = '#e74c3c';
            } else {
                timelineStatus = 'on time';
                timelineIcon = 'üü¢';
                timelineColor = '#27ae60';
            }
        } else {
            timelineStatus = 'completed';
            timelineIcon = '‚úÖ';
            timelineColor = '#27ae60';
        }
    }
    // IN PROGRESS TASKS
    else if (progress > 0 && progress < 100) {
        // Check if overdue
        if (targetEnd && today > targetEnd) {
            const daysOverdue = Math.ceil((today - targetEnd) / (1000 * 60 * 60 * 24));
            timelineStatus = `${daysOverdue}d overdue`;
            timelineIcon = 'üî¥';
            timelineColor = '#e74c3c';
        }
        // Calculate expected progress
        else if (targetStart && targetEnd && startDate) {
            const totalDuration = (targetEnd - targetStart) / (1000 * 60 * 60 * 24);
            const elapsed = (today - startDate) / (1000 * 60 * 60 * 24);
            const expectedProgress = totalDuration > 0 ? (elapsed / totalDuration) * 100 : 0;
            const progressDiff = progress - expectedProgress;
            
            if (progressDiff >= 10) {
                timelineStatus = 'ahead';
                timelineIcon = 'üîµ';
                timelineColor = '#3498db';
            } else if (progressDiff >= -10) {
                timelineStatus = 'on track';
                timelineIcon = 'üü¢';
                timelineColor = '#27ae60';
            } else if (progressDiff >= -25) {
                timelineStatus = 'at risk';
                timelineIcon = 'üü°';
                timelineColor = '#f39c12';
            } else {
                timelineStatus = 'delayed';
                timelineIcon = 'üî¥';
                timelineColor = '#e74c3c';
            }
        } else {
            timelineStatus = `${progress}% done`;
            timelineIcon = 'üîÑ';
            timelineColor = '#3498db';
        }
    }
    // PENDING/READY TASKS
    else {
        if (targetStart) {
            const daysUntil = Math.ceil((targetStart - today) / (1000 * 60 * 60 * 24));
            
            if (daysUntil < 0) {
                timelineStatus = `${Math.abs(daysUntil)}d late start`;
                timelineIcon = 'üü°';
                timelineColor = '#f39c12';
            } else if (daysUntil <= 3) {
                timelineStatus = `starts in ${daysUntil}d`;
                timelineIcon = '‚è∞';
                timelineColor = '#3498db';
            } else {
                timelineStatus = 'ready';
                timelineIcon = 'üéØ';
                timelineColor = '#27ae60';
            }
        } else {
            timelineStatus = 'pending';
            timelineIcon = '‚è≥';
            timelineColor = '#95a5a6';
        }
    }
    
    return {
        status: timelineStatus,
        icon: timelineIcon,
        color: timelineColor
    };
}

function previewReport() {
    // Get selected groups (same validation as generateReport)
    const selectedCheckboxes = document.querySelectorAll('.report-group-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        showNotification('Please select at least one group', 'error');
        return;
    }
    
    // Collect data (reuse same logic)
const reportData = {
    equipmentBase: document.getElementById('reportEquipmentBase').value,
    reportDate: document.getElementById('reportDate').value,
    highlights: document.getElementById('reportHighlights').value.trim(),
    actionPlan: document.getElementById('reportActionPlan').value.trim(),
    milestones: reportMilestones.filter(m => m.name.trim()),  // ‚úÖ ADD - Only include filled milestones
    groups: []
};
    
    // Group checkboxes by equipment first
const equipmentGroups = {};

selectedCheckboxes.forEach(checkbox => {
    const equipment = checkbox.dataset.equipment;
    
    if (!equipmentGroups[equipment]) {
        equipmentGroups[equipment] = [];
    }
    
    equipmentGroups[equipment].push(checkbox);
});

// Process each equipment (aggregate all groups)
Object.keys(equipmentGroups).forEach(equipment => {
    const checkboxes = equipmentGroups[equipment];
    
    // Collect ALL tasks for this equipment
    const allTasks = [];
    const groupDetails = [];
    
    checkboxes.forEach(checkbox => {
        const firebaseKey = checkbox.value;
        const disc = checkbox.dataset.disc;
        const vendor = checkbox.dataset.vendor;
        const taskName = checkbox.dataset.task || 'N/A';
        const displaySequence = parseInt(checkbox.dataset.displaysequence) || 999;
        
        const tasks = onsiteTasks[firebaseKey] || [];
        
        // ‚úÖ FIX: Enrich each task with parent info
        const enrichedTasks = tasks.map(task => ({
            ...task,
            disc: task.disc || disc,
            vendor: task.vendor || vendor,
            parentTask: task.parentTask || taskName,
            equipment: task.equipment || equipment
        }));
        
        allTasks.push(...enrichedTasks);
        
        groupDetails.push({
            disc,
            vendor,
            task: taskName,
            firebaseKey,
            displaySequence,
            taskCount: tasks.length
        });
    });
    
    // Now calculate with ALL tasks (same as VM)
    // ‚úÖ FIX: Prioritize progress value over status field (match VM card logic)
const completedTasks = allTasks.filter(t => {
    const progress = parseInt(t.progress) || 0;
    return progress === 100;  // Completed = 100% regardless of status
});

const inProgressTasks = allTasks.filter(t => {
    const progress = parseInt(t.progress) || 0;
    return progress > 0 && progress < 100;  // InProgress = 1-99% regardless of status
});

const pendingTasks = allTasks.filter(t => {
    const progress = parseInt(t.progress) || 0;
    return progress === 0;  // Pending = 0% regardless of status
});
    
    // Separate blocked vs ready
    const blockedTasks = [];
    const readyTasks = [];
    
    pendingTasks.forEach(task => {
        if (checkIfBlocked(task, allTasks)) {
            blockedTasks.push(task);
        } else {
            readyTasks.push(task);
        }
    });
    
    const totalTasks = allTasks.length;
    const overallProgress = calculateWeightedProgress(allTasks);
    
    // Calculate timeline with ALL tasks
    const equipmentStartDate = allTasks.reduce((earliest, t) => {
        if (!t.targetStart) return earliest;
        const start = new Date(t.targetStart);
        return !earliest || start < earliest ? start : earliest;
    }, null);
    
    const equipmentTargetDate = allTasks.reduce((latest, t) => {
        if (!t.targetEnd) return latest;
        const end = new Date(t.targetEnd);
        return !latest || end > latest ? end : latest;
    }, null);
    
    const smartStatus = calculateSmartStatus(
        overallProgress,
        equipmentStartDate,
        equipmentTargetDate
    );
    
    let status = smartStatus.status;
    let statusColor;
    
    // Convert to RGB array for PDF
    switch(smartStatus.status) {
        case 'COMPLETED':
            statusColor = [39, 174, 96];
            break;
        case 'AHEAD':
            statusColor = [39, 174, 96];
            break;
        case 'ON TRACK':
            statusColor = [52, 152, 219];
            break;
        case 'IN PROGRESS':
            statusColor = [52, 152, 219];
            break;
        case 'BEHIND':
            statusColor = [243, 156, 18];
            break;
        case 'OVERDUE':
            statusColor = [231, 76, 60];
            break;
        default:
            statusColor = [149, 165, 166];
    }
    
    // Override with critical conditions
    if (blockedTasks.length > 0 && smartStatus.status !== 'COMPLETED') {
        status = 'BLOCKED';
        statusColor = [231, 76, 60];
    }
    
    // Add timeline to tasks and sort by group + sequence
    const tasksWithTimeline = allTasks.map(task => ({
        ...task,
        timeline: getTaskTimelineStatus(task)
    }));
    
    const completedWithTimeline = completedTasks.map(t => ({
        ...t,
        timeline: getTaskTimelineStatus(t)
    }));
    
    const inProgressWithTimeline = inProgressTasks.map(t => ({
        ...t,
        timeline: getTaskTimelineStatus(t)
    }));
    
    const readyWithTimeline = readyTasks.map(t => ({
        ...t,
        timeline: getTaskTimelineStatus(t)
    }));
    
    const blockedWithTimeline = blockedTasks.map(t => ({
        ...t,
        timeline: getTaskTimelineStatus(t)
    }));
    
    // Get first group's info for display
    const firstGroup = groupDetails[0];
    
    reportData.groups.push({
        equipment,
        disc: firstGroup.disc,
        vendor: groupDetails.map(g => g.vendor).filter((v, i, arr) => arr.indexOf(v) === i).join(', '),
        task: groupDetails.map(g => g.task).join(', '),
        firebaseKey: firstGroup.firebaseKey,
        displaySequence: firstGroup.displaySequence,
        tasks: tasksWithTimeline,
        completedTasks: completedWithTimeline,
        inProgressTasks: inProgressWithTimeline,
        readyTasks: readyWithTimeline,
        blockedTasks: blockedWithTimeline,
        totalTasks,
        overallProgress,
        status,
        statusColor,
        groupDetails  // ‚Üê Add this for reference
    });
});

// ‚úÖ ADD: Calculate summary counts for Executive Summary
    let totalTasksCount = 0;
    let completedTasksCount = 0;
    let inProgressTasksCount = 0;
    let blockedTasksCount = 0;
    let readyTasksCount = 0;
    
    reportData.groups.forEach(group => {
        totalTasksCount += group.totalTasks;
        completedTasksCount += group.completedTasks.length;
        inProgressTasksCount += group.inProgressTasks.length;
        blockedTasksCount += group.blockedTasks.length;
        readyTasksCount += group.readyTasks.length;
    });
    
    // Add to reportData
    reportData.totalTasksCount = totalTasksCount;
    reportData.completedTasksCount = completedTasksCount;
    reportData.inProgressTasksCount = inProgressTasksCount;
    reportData.blockedTasksCount = blockedTasksCount;
    reportData.readyTasksCount = readyTasksCount;
    
    
    // Collect all tasks from all groups
let allReportTasks = [];
reportData.groups.forEach(group => {
    allReportTasks = allReportTasks.concat(group.tasks);
});

// Calculate weighted overall progress
reportData.overallProgress = calculateWeightedProgress(allReportTasks);
reportData.progressBreakdown = calculateProgressBreakdown(allReportTasks);

// Calculate weighted progress per group
reportData.groups.forEach(group => {
    group.weightedProgress = calculateWeightedProgress(group.tasks);
    group.progressBreakdown = calculateProgressBreakdown(group.tasks);
});
// ‚úÖ CALCULATE TIMELINE - Find earliest/latest dates from all tasks
let allTasks = [];
reportData.groups.forEach(group => {
    allTasks = allTasks.concat(group.tasks);
});

const tasksWithDates = allTasks.filter(t => t.targetStart || t.targetEnd);

if (tasksWithDates.length > 0) {
    const startDates = tasksWithDates.map(t => t.targetStart).filter(d => d).map(d => new Date(d));
    const endDates = tasksWithDates.map(t => t.targetEnd).filter(d => d).map(d => new Date(d));
    
    const projectStart = startDates.length > 0 ? new Date(Math.min(...startDates)) : new Date();
    const targetEnd = endDates.length > 0 ? new Date(Math.max(...endDates)) : new Date();
    const currentDate = new Date();
    
    const totalDays = Math.ceil((targetEnd - projectStart) / (1000 * 60 * 60 * 24));
    const daysElapsed = Math.ceil((currentDate - projectStart) / (1000 * 60 * 60 * 24));
    const daysRemaining = Math.ceil((targetEnd - currentDate) / (1000 * 60 * 60 * 24));
    const percentTimeElapsed = totalDays > 0 ? Math.round((daysElapsed / totalDays) * 100) : 0;
    
    reportData.timeline = {
        projectStart: projectStart.toISOString().split('T')[0],
        currentDate: currentDate.toISOString().split('T')[0],
        targetEnd: targetEnd.toISOString().split('T')[0],
        totalDays: totalDays,
        daysElapsed: Math.max(0, daysElapsed),
        daysRemaining: Math.max(0, daysRemaining),
        percentTimeElapsed: Math.max(0, Math.min(100, percentTimeElapsed))
    };
} else {
    reportData.timeline = null;
}

// ‚úÖ SORT GROUPS BY DISPLAY SEQUENCE
reportData.groups.sort((a, b) => {
    const seqA = a.displaySequence || 999;
    const seqB = b.displaySequence || 999;
    
    // If sequences are equal, sort by equipment name then disc
    if (seqA === seqB) {
        const equipCompare = (a.equipment || '').localeCompare(b.equipment || '');
        if (equipCompare !== 0) return equipCompare;
        return (a.disc || '').localeCompare(b.disc || '');
    }
    
    return seqA - seqB;
});

// ‚úÖ DEBUG: Check after sort
console.log('‚úÖ Groups after sort:', reportData.groups.map(g => ({
    equipment: g.equipment,
    disc: g.disc,
    displaySequence: g.displaySequence
})));

// ‚úÖ SAVE Highlights, Action Plan & Milestones to Firebase
if (reportData.highlights || reportData.actionPlan || reportData.milestones.length > 0) {
    const equipmentBase = reportData.equipmentBase.replace(/[.#$[\]]/g, '_');
    const reportDate = reportData.reportDate;
    
    database.ref(`reportSettings/${equipmentBase}`).set({
    highlights: reportData.highlights || '',
    actionPlan: reportData.actionPlan || '',
    milestones: reportData.milestones || [],
    timestamp: new Date().toISOString(),
    updatedBy: 'Report Generator'
}).then(() => {
    console.log('‚úÖ Report settings saved (from preview)');
}).catch(error => {
    console.error('‚ùå Error saving report settings:', error);
});
}

// Generate HTML preview in new window
const previewWindow = window.open('', '_blank');
previewWindow.document.write(generateHTMLReport(reportData));
previewWindow.document.close();
window.lastReportData = reportData;  // ‚úÖ ADD THIS for debugging
}

// Helper: Calculate weighted progress for specific tasks array
function calculateWeightedProgressForTasks(tasks) {
    if (!tasks || tasks.length === 0) return 0;
    
    const totalWeight = tasks.reduce((sum, t) => sum + (parseFloat(t.weight) || 1), 0);
    const weightedProgress = tasks.reduce((sum, t) => {
        const weight = parseFloat(t.weight) || 1;
        const progress = parseFloat(t.progress) || 0;
        return sum + (weight * progress / 100);
    }, 0);
    
    return totalWeight > 0 ? Math.round((weightedProgress / totalWeight) * 100) : 0;
}

// Helper: Get status for a group based on progress
function getGroupStatus(progress, tasks) {
    const completed = tasks.filter(t => t.progress === 100).length;
    const blocked = tasks.filter(t => t.status === 'blocked').length;
    
    // ‚úÖ Professional, constructive status labels
    
    if (progress === 100) {
        return { text: 'COMPLETED', color: '#27ae60' };
    }
    
    if (blocked > 0) {
        return { text: 'ON HOLD', color: '#e74c3c' };  // ‚Üê More professional than "BLOCKED"
    }
    
    if (progress >= 75) {
        return { text: 'ON SCHEDULE', color: '#3498db' };  // ‚Üê Positive framing
    }
    
    if (progress >= 50) {
        return { text: 'NEEDS ATTENTION', color: '#f39c12' };  // ‚Üê Softer than "AT RISK"
    }
    
    if (progress >= 25) {
        return { text: 'REQUIRES FOCUS', color: '#e67e22' };  // ‚Üê Constructive, not blaming
    }
    
    return { text: 'URGENT ACTION', color: '#e74c3c' };  // ‚Üê Clear but professional
}

// Helper: Filter tasks by group detail
function getTasksForGroup(allTasks, groupDetail) {
    return allTasks.filter(t => {
        if (t.disc !== groupDetail.disc) return false;
        
        const taskMatch = t.parentTask === groupDetail.task || 
                         t.taskName === groupDetail.task ||
                         t.task === groupDetail.task;
        
        return taskMatch;
    });
}

function generateHTMLReport(data) {
    const totalBlocked = data.groups.reduce((sum, g) => sum + g.blockedTasks.length, 0);

// ‚úÖ ADD THIS - Sort groups by display sequence before rendering
    data.groups.sort((a, b) => {
        const seqA = a.displaySequence || 999;
        const seqB = b.displaySequence || 999;
        
        // If sequences equal, sort by equipment name then disc
        if (seqA === seqB) {
            const equipCompare = (a.equipment || '').localeCompare(b.equipment || '');
            if (equipCompare !== 0) return equipCompare;
            return (a.disc || '').localeCompare(b.disc || '');
        }
        
        return seqA - seqB;
    });

    return `
<!DOCTYPE html>
<html>
<head>
    <title>Progress Report Preview - ${data.equipmentBase}</title>
    <!-- ‚úÖ SCRIPT DI SINI (dalam HTML string) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"><\/script>
<style>
/* Screen & Print Shared Styles */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f5f5; 
    font-size: 11px;
    line-height: 1.4;
    color: #2c3e50;
}

.container { 
    max-width: 210mm;
    margin: 0 auto; 
    background: white; 
    padding: 15mm;
}

.header {
    text-align: center;
    padding: 15px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 5px;
    margin-bottom: 20px;
}

.header h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
}

.header h2 {
    margin: 8px 0 0 0;
    font-size: 17px;
    font-weight: 600;
}

.header p {
    margin: 5px 0 0 0;
    font-size: 11px;
    opacity: 0.95;
}

.section {
    margin-bottom: 18px;
    page-break-inside: avoid;
}

.section-title {
    font-size: 13px;
    font-weight: 700;
    color: white;
    margin-bottom: 10px;
    padding: 8px 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 4px;
    page-break-after: avoid;
}

.group-card {
    background: #f8f9fa;
    border-left: 4px solid #3498db;
    padding: 10px 12px;
    margin-bottom: 12px;
    border-radius: 4px;
    page-break-inside: avoid;
}

.group-card h3 {
    margin: 0 0 6px 0;
    font-size: 12px;
    color: #2c3e50;
    font-weight: 600;
}

.group-card p {
    margin: 3px 0;
    font-size: 10px;
    line-height: 1.5;
}

.progress-bar {
    background: #ecf0f1;
    height: 18px;
    border-radius: 9px;
    overflow: hidden;
    margin: 8px 0;
}

.progress-fill {
    background: linear-gradient(90deg, #27ae60, #2ecc71);
    height: 100%;
    display: flex;
    align-items: center;
    padding-left: 8px;
    color: white;
    font-size: 10px;
    font-weight: 600;
}

.gantt-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    font-size: 9px;
    page-break-inside: auto;
}

.gantt-table thead {
    display: table-header-group;
}

.gantt-table th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 6px 8px;
    text-align: left;
    font-size: 9px;
    font-weight: 600;
    border: 1px solid #5a67d8;
}

.gantt-table td {
    padding: 5px 8px;
    border: 1px solid #dee2e6;
    vertical-align: top;
    line-height: 1.4;
}

.gantt-table tbody tr {
    page-break-inside: avoid;
    page-break-after: auto;
}

.gantt-table tr:nth-child(even) {
    background: #f8f9fa;
}

.mode-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 8px;
    font-weight: 600;
    color: white;
    margin-top: 2px;
}

.mode-sequential { background: #e74c3c; }
.mode-parallel { background: #f39c12; }
.mode-independent { background: #27ae60; }

/* Print-Specific Optimizations */
@media print {
    @page {
        size: A4;
        margin: 12mm 10mm;
    }
    
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    
    body {
        background: white;
        margin: 0;
        padding: 0;
    }
    
    .container {
        max-width: 100%;
        padding: 0;
        margin: 0;
        box-shadow: none;
    }
    
    .header {
        margin-bottom: 15px;
    }
    
    .section {
        page-break-inside: avoid;
        margin-bottom: 15px;
    }
    
    .section-title {
        page-break-after: avoid;
        page-break-inside: avoid;
    }
    
    .group-card {
        page-break-inside: avoid;
        margin-bottom: 10px;
    }
    
    .gantt-table {
        page-break-inside: auto;
    }
    
    .gantt-table thead {
        display: table-header-group;
    }
    
    .gantt-table tbody tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
    
    /* Hide print button */
    .print-btn,
    button {
        display: none !important;
    }
    
    /* Ensure colors print */
    .header,
    .section-title,
    .gantt-table th,
    .progress-fill,
    .mode-badge {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
}

/* Screen-only styles */
@media screen {
    .print-btn {
        transition: all 0.3s ease;
    }
    
    .print-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }
}
</style>    
</head>
<body>
    <div class="container">
        <div class="header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; color: white !important; padding: 20px; text-align: center; border-radius: 5px; margin-bottom: 30px;">
    <h1 style="margin: 0; font-size: 24px; color: white !important;">üìä PROGRESS REPORT</h1>
    <h2 style="margin: 10px 0 0 0; font-size: 18px; color: white !important;">${data.equipmentBase} System</h2>
    <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9; color: white !important;">
        Report Date: ${formatDateForDisplay(data.reportDate)} | Generated: ${new Date().toLocaleDateString()}
    </p>
</div>
        
        
<div class="section">
    <div class="section-title">EXECUTIVE SUMMARY</div>
    <p><strong>Overall Progress:</strong> ${data.overallProgress}%</p>
    <div class="progress-bar">
        <div class="progress-fill" style="width: ${data.overallProgress}%; background: ${data.overallProgress >= 80 ? '#27ae60' : data.overallProgress >= 50 ? '#f39c12' : '#e74c3c'}">
            ${data.overallProgress}%
        </div>
    </div>
    
    
${data.timeline ? `
<div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
    <h4 style="margin: 0 0 15px 0; font-size: 15px; font-weight: 600;">üìç PROJECT TIMELINE</h4>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
        <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 5px;">
            <div style="font-size: 11px; opacity: 0.9;">Project Start</div>
            <div style="font-size: 14px; font-weight: 600;">${formatDateForDisplay(data.timeline.projectStart)}</div>
        </div>
        <div style="background: rgba(255,255,255,0.25); padding: 10px; border-radius: 5px; border: 2px solid white;">
            <div style="font-size: 11px; opacity: 0.9;">Current Date</div>
            <div style="font-size: 14px; font-weight: 600;">${formatDateForDisplay(data.timeline.currentDate)}</div>
            <div style="font-size: 10px; margin-top: 3px;">${data.timeline.daysElapsed} days elapsed</div>
        </div>
        <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 5px;">
            <div style="font-size: 11px; opacity: 0.9;">Target End</div>
            <div style="font-size: 14px; font-weight: 600;">${formatDateForDisplay(data.timeline.targetEnd)}</div>
            <div style="font-size: 10px; margin-top: 3px;">${data.timeline.daysRemaining} days remaining</div>
        </div>
    </div>
    
    <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 30px; overflow: hidden; position: relative;">
        <div style="background: linear-gradient(90deg, #27ae60, #2ecc71); height: 100%; width: ${data.timeline.percentTimeElapsed}%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; transition: width 0.3s ease;">
            ${data.timeline.percentTimeElapsed}% Time Elapsed
        </div>
        <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: 600;">
            ${data.timeline.totalDays} days total
        </div>
    </div>
</div>
` : ''}

${data.milestones && data.milestones.length > 0 ? `
<div style="margin-top: 20px;">
    <h4 style="color: #2c3e50; margin-bottom: 10px; font-size: 15px; font-weight: 600;">üìä MILESTONE STATUS</h4>
    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
        <thead>
            <tr style="background: #34495e; color: white;">
                <th style="padding: 10px; text-align: left; border: 1px solid #2c3e50;">Milestone</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #2c3e50; width: 120px;">Target Date</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #2c3e50; width: 100px;">Progress</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #2c3e50; width: 120px;">Status</th>
            </tr>
        </thead>
        <tbody>
                ${data.milestones.map(milestone => {
    const targetDate = new Date(milestone.targetDate);
    const today = new Date();
    const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
    const progress = parseInt(milestone.progress) || 0;
    
    const smartStatus = calculateSmartStatus(
        milestone.progress,
        null,
        milestone.targetDate
    );
    
    const status = smartStatus.status;
    const statusColor = smartStatus.color;
    
    // ‚úÖ DETERMINE DATE DISPLAY
    let dateDisplay = '';
    
    if (progress === 100) {
        // COMPLETED - Show completion date OR placeholder
        if (milestone.completedDate && milestone.completedDate !== '' && milestone.completedDate !== 'null') {
            dateDisplay = `
                <div style="font-weight: 600; color: #2c3e50;">
                    ${formatDateForDisplay(milestone.targetDate)}
                </div>
                <div style="font-size: 11px; color: #27ae60; font-weight: 600; margin-top: 4px;">
                    ‚úÖ Completed on ${formatDateForDisplay(milestone.completedDate)}
                </div>
            `;
        } else {
            dateDisplay = `
                <div style="font-weight: 600; color: #2c3e50;">
                    ${formatDateForDisplay(milestone.targetDate)}
                </div>
                <div style="font-size: 10px; color: #95a5a6; font-style: italic; margin-top: 4px;">
                    ‚úÖ Completed (date not recorded)
                </div>
            `;
        }
    } else {
        // NOT COMPLETED - Show target date with days info
        if (daysUntil >= 0) {
            dateDisplay = `
                <div style="font-weight: 600; color: #2c3e50;">
                    ${formatDateForDisplay(milestone.targetDate)}
                </div>
                <div style="font-size: 10px; color: #3498db; margin-top: 4px;">
                    üìÖ in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}
                </div>
            `;
        } else {
            dateDisplay = `
                <div style="font-weight: 600; color: #2c3e50;">
                    ${formatDateForDisplay(milestone.targetDate)}
                </div>
                <div style="font-size: 10px; color: #e74c3c; font-weight: 600; margin-top: 4px;">
                    ‚ö†Ô∏è ${Math.abs(daysUntil)} day${Math.abs(daysUntil) !== 1 ? 's' : ''} overdue
                </div>
            `;
        }
    }
    
    return `
        <tr style="border-bottom: 1px solid #ddd;">
            <td style="padding: 10px; border: 1px solid #ddd;">
                <strong>${milestone.name}</strong>
            </td>
            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                ${dateDisplay}
            </td>
            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                <strong style="color: #3498db; font-size: 14px;">${milestone.progress}%</strong>
            </td>
            <td style="padding: 10px; text-align: center; border: 1px solid #ddd;">
                <strong style="color: ${statusColor};">${status}</strong>
            </td>
        </tr>
    `;
}).join('')}


		
        </tbody>
    </table>
</div>
` : ''}
    

${data.highlights || data.actionPlan ? `
<div class="section" style="page-break-inside: avoid;">
    ${data.highlights ? `
        <div style="margin-bottom: 30px;">
            <div class="section-title">‚ú® KEY HIGHLIGHTS</div>
            <pre style="background: #fffbf0; border-left: 4px solid #f39c12; padding: 20px; border-radius: 5px; line-height: 1.8; font-size: 13px; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-family: inherit; margin: 0; white-space: pre-wrap; word-wrap: break-word;">${data.highlights.trim()}</pre>
        </div>
    ` : ''}
    
    ${data.actionPlan ? `
        <div style="margin-bottom: 30px;">
            <div class="section-title">üìã ACTION PLAN</div>
            <pre style="background: #f0f8ff; border-left: 4px solid #3498db; padding: 20px; border-radius: 5px; line-height: 1.8; font-size: 13px; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-family: inherit; margin: 0; white-space: pre-wrap; word-wrap: break-word;">${data.actionPlan.trim()}</pre>
        </div>
    ` : ''}
</div>
` : ''}
        
      
        
<div class="section">
    <div class="section-title">TASK STATUS DETAILS</div>
    ${data.groups.map((group, groupIndex) => `
        ${groupIndex > 0 ? '<div class="group-separator"></div>' : ''}
        
        <!-- MAIN EQUIPMENT HEADER (Aggregated) -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px 20px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h3 style="color: white; margin: 0; font-size: 18px; font-weight: 600;">
                ${group.equipment}
            </h3>
            <p style="color: rgba(255,255,255,0.9); margin: 5px 0 0 0; font-size: 12px;">
                ${group.vendor} | Progress: ${group.overallProgress}% | Status: ${group.status}
            </p>
        </div>
        
     <!-- GROUP BREAKDOWN SECTION -->
        ${group.groupDetails && group.groupDetails.length > 1 ? `
            <div style="background: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                <h4 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 14px; font-weight: 600;">
                    üìä GROUP BREAKDOWN (${group.groupDetails.length} groups)
                </h4>
                <div style="display: grid; gap: 10px;">
                    ${group.groupDetails.map((detail, idx) => {
                        // ‚úÖ FIX: Match by parentTask (now enriched!)
                        const groupTasks = group.tasks.filter(t => {
                            return t.parentTask === detail.task && t.disc === detail.disc;
                        });
                        
                        const groupProgress = calculateWeightedProgressForTasks(groupTasks);
                        const groupCompleted = groupTasks.filter(t => t.progress === 100 || t.status === 'completed').length;
                        const groupStatus = getGroupStatus(groupProgress, groupTasks);
                        
                        return `
                            <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="flex: 1;">
                                        <span style="font-weight: 600; color: #2c3e50; font-size: 13px;">
                                            ${idx + 1}. ${detail.disc} - ${detail.task}
                                        </span>
                                        <span style="color: #7f8c8d; font-size: 11px; margin-left: 10px;">
                                            (${detail.vendor})
                                        </span>
                                    </div>
                                    <span style="padding: 3px 10px; background: ${groupStatus.color}; color: white; border-radius: 3px; font-size: 11px; font-weight: 600;">
                                        ${groupStatus.text}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 15px; font-size: 11px; color: #555;">
                                    <span>üì¶ ${groupCompleted}/${groupTasks.length} completed</span>
                                    <span>üìà ${groupProgress}%</span>
                                    <div style="flex: 1; background: #ecf0f1; border-radius: 10px; height: 8px; align-self: center;">
                                        <div style="width: ${groupProgress}%; background: linear-gradient(90deg, #3498db, #2ecc71); height: 100%; border-radius: 10px; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        ` : ''}
    
        
        <!-- DETAILED TASK LIST (All tasks combined) -->
        <div style="margin-top: 20px;">
                
                ${group.completedTasks.length > 0 ? `
    <p style="font-weight: bold; color: #27ae60; margin: 20px 0 10px 0; font-size: 14px;">‚úÖ COMPLETED (${group.completedTasks.length})</p>
    <table class="gantt-table">
        <thead>
    <tr>
        <th style="width: 7%;">Seq<br>Mode</th>
        <th style="width: 22%;">Task Name & Description</th>
        <th style="width: 9%;">Plan<br>Start</th>
        <th style="width: 9%;">Plan<br>End</th>
        <th style="width: 9%;">Actual<br>Start</th>
        <th style="width: 9%;">Actual<br>End</th>
        <th style="width: 15%;">Timeline<br>Status</th>
        <th style="width: 20%;">Notes</th>
    </tr>
</thead>
        <tbody>
            ${group.completedTasks.sort((a, b) => (a.sequence || 999) - (b.sequence || 999)).slice(0, 10).map((task, taskIndex) => {
                const modeLabel = task.executionMode === 'sequential' ? 'Sequential' : 
                                task.executionMode === 'parallel' ? 'Parallel' : 'Independent';
                const modeClass = 'mode-' + (task.executionMode || 'independent');
                
                // ‚úÖ ADD: Get group name for this task
                const taskGroupName = task.parentTask || 'N/A';
                
                return `
                <tr>
                    <td style="text-align: center; font-weight: 700; font-size: 13px;">
                        <div style="color: #3498db; font-size: 11px; margin-bottom: 2px;">#${taskIndex + 1}</div>
                        <div style="color: #7f8c8d; font-size: 9px;">(Seq ${task.sequence || '?'} - ${taskGroupName})</div>
                        <span class="mode-badge ${modeClass}">${modeLabel}</span>
                    </td>
                    <td>
                        <strong style="color: #2c3e50;">${task.name}</strong>
                        ${task.description ? `<div style="font-size: 10px; color: #7f8c8d; margin-top: 3px; font-style: italic;">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</div>` : ''}
                    </td>
                    <td style="text-align: center; font-size: 10px;">${task.targetStart ? formatDateForDisplay(task.targetStart) : '-'}</td>
                    <td style="text-align: center; font-size: 10px;">${task.targetEnd ? formatDateForDisplay(task.targetEnd) : '-'}</td>
                    <td style="text-align: center; font-size: 10px;">${task.startDate ? formatDateForDisplay(task.startDate) : '-'}</td>
                    <td style="text-align: center; font-size: 10px;">${task.completedDate ? formatDateForDisplay(task.completedDate) : '-'}</td>
                    <td style="color: ${task.timeline ? task.timeline.color : '#95a5a6'}; font-weight: 600; text-align: center; font-size: 11px;">
                        ${task.timeline ? `${task.timeline.icon} ${task.timeline.status}` : '-'}
                    </td>
<td style="font-size: 10px; color: #555; font-style: italic; padding: 8px; white-space: pre-wrap;">
    ${task.notes ? (task.notes.length > 100 ? task.notes.substring(0, 100) + '...' : task.notes) : '-'}
</td>
                </tr>
                `;
            }).join('')}
        </tbody>
    </table>
    ${group.completedTasks.length > 10 ? `<p style="color: #95a5a6; margin: 5px 0; font-style: italic; font-size: 11px;">+ ${group.completedTasks.length - 10} more completed tasks</p>` : ''}
` : ''}

${group.inProgressTasks.length > 0 ? `
    <p style="font-weight: bold; color: #f39c12; margin: 20px 0 10px 0; font-size: 14px;">üîÑ IN PROGRESS (${group.inProgressTasks.length})</p>
    <table class="gantt-table">
        <thead>
    <tr>
        <th style="width: 7%;">Seq<br>Mode</th>
        <th style="width: 23%;">Task Name & Description</th>
        <th style="width: 9%;">Plan<br>Start</th>
        <th style="width: 9%;">Plan<br>End</th>
        <th style="width: 9%;">Actual<br>Start</th>
        <th style="width: 8%;">Progress</th>
        <th style="width: 15%;">Timeline<br>Status</th>
        <th style="width: 20%;">Notes</th>
    </tr>
</thead>
        <tbody>
            <tbody>
                ${group.inProgressTasks.sort((a, b) => (a.sequence || 999) - (b.sequence || 999)).map((task, taskIndex) => {
                const modeLabel = task.executionMode === 'sequential' ? 'Sequential' : 
                                task.executionMode === 'parallel' ? 'Parallel' : 'Independent';
                const modeClass = `mode-${task.executionMode || 'independent'}`;
                
                // ‚úÖ ADD: Get group name for this task
                const taskGroupName = task.parentTask || 'N/A';
                
                return `
                <tr>
                    <td style="text-align: center; font-weight: 700; font-size: 13px;">
                        <div style="color: #3498db; font-size: 11px; margin-bottom: 2px;">#${taskIndex + 1}</div>
                        <div style="color: #7f8c8d; font-size: 9px;">(Seq ${task.sequence || '?'} - ${taskGroupName})</div>
                        <span class="mode-badge ${modeClass}">${modeLabel}</span>
                    </td>
                    <td>
                        <strong style="color: #2c3e50;">${task.name}</strong>
                        ${task.description ? `<div style="font-size: 10px; color: #7f8c8d; margin-top: 3px; font-style: italic;">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</div>` : ''}
                    </td>
                    <td style="text-align: center; font-size: 10px;">${task.targetStart ? formatDateForDisplay(task.targetStart) : '-'}</td>
                    <td style="text-align: center; font-size: 10px;">${task.targetEnd ? formatDateForDisplay(task.targetEnd) : '-'}</td>
                    <td style="text-align: center; font-size: 10px;">${task.startDate ? formatDateForDisplay(task.startDate) : '-'}</td>
                    <td style="text-align: center; font-weight: 700; color: #3498db; font-size: 13px;">${task.progress || 0}%</td>
                    <td style="color: ${task.timeline ? task.timeline.color : '#95a5a6'}; font-weight: 600; text-align: center; font-size: 11px;">
    ${task.timeline ? `${task.timeline.icon} ${task.timeline.status}` : '-'}
</td>
<td style="font-size: 10px; color: #555; font-style: italic; padding: 8px;">
    ${task.notes ? (task.notes.length > 100 ? task.notes.substring(0, 100) + '...' : task.notes) : '-'}
</td>
                </tr>
                `;
            }).join('')}
        </tbody>
    </table>
` : ''}

${group.readyTasks && group.readyTasks.length > 0 ? `
    <p style="font-weight: bold; color: #3498db; margin: 20px 0 10px 0; font-size: 14px;">üéØ READY TO START (${group.readyTasks.length})</p>
    <table class="gantt-table">
        <thead>
    <tr>
        <th style="width: 7%;">Seq<br>Mode</th>
        <th style="width: 25%;">Task Name & Description</th>
        <th style="width: 10%;">Plan<br>Start</th>
        <th style="width: 10%;">Plan<br>End</th>
        <th style="width: 15%;">Dependencies</th>
        <th style="width: 13%;">Status</th>
        <th style="width: 20%;">Notes</th>
    </tr>
</thead>
        <tbody>
                ${group.readyTasks.sort((a, b) => (a.sequence || 999) - (b.sequence || 999)).map((task, taskIndex) => {
                const modeLabel = task.executionMode === 'sequential' ? 'Sequential' : 
                                task.executionMode === 'parallel' ? 'Parallel' : 'Independent';
                const modeClass = `mode-${task.executionMode || 'independent'}`;
                
                // ‚úÖ ADD: Get group name for this task
                const taskGroupName = task.parentTask || 'N/A';
                
                // Dependencies info
                let depsInfo = '<span style="color: #95a5a6;">None</span>';
                if (task.executionMode === 'sequential' && task.dependencies && task.dependencies.length > 0) {
                    const depTasks = task.dependencies.map(depId => {
                        const depTask = group.tasks.find(t => t.id === depId);
                        return depTask ? `#${depTask.sequence || '?'}` : '?';
                    }).join(', ');
                    depsInfo = `<span style="color: #e74c3c; font-weight: 600;">Waits: ${depTasks}</span>`;
                } else if (task.executionMode === 'parallel' && task.parallelWith && task.parallelWith.length > 0) {
                    depsInfo = `<span style="color: #f39c12; font-weight: 600;">With: ${task.parallelWith.length} task(s)</span>`;
                }
                
                return `
                <tr>
                    <td style="text-align: center; font-weight: 700; font-size: 13px;">
                        <div style="color: #3498db; font-size: 11px; margin-bottom: 2px;">#${taskIndex + 1}</div>
                        <div style="color: #7f8c8d; font-size: 9px;">(Seq ${task.sequence || '?'} - ${taskGroupName})</div>
                        <span class="mode-badge ${modeClass}">${modeLabel}</span>
                    </td>
                    <td>
                        <strong style="color: #2c3e50;">${task.name}</strong>
                        ${task.description ? `<div style="font-size: 10px; color: #7f8c8d; margin-top: 3px; font-style: italic;">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</div>` : ''}
                    </td>
                    <td style="text-align: center; font-size: 10px;">${task.targetStart ? formatDateForDisplay(task.targetStart) : '-'}</td>
                    <td style="text-align: center; font-size: 10px;">${task.targetEnd ? formatDateForDisplay(task.targetEnd) : '-'}</td>
                    <td style="text-align: center; font-size: 10px;">${depsInfo}</td>
                    <td style="color: ${task.timeline ? task.timeline.color : '#3498db'}; font-weight: 600; text-align: center; font-size: 11px;">
                        ${task.timeline ? `${task.timeline.icon} ${task.timeline.status}` : 'üéØ Ready'}
                    </td>
		<td style="font-size: 10px; color: #555; font-style: italic; padding: 8px; white-space: pre-wrap;">
    ${task.notes ? (task.notes.length > 100 ? task.notes.substring(0, 100) + '...' : task.notes) : '-'}
</td>
                </tr>
                `;
            }).join('')}
        </tbody>

    </table>
` : ''}

${group.blockedTasks.length > 0 ? `
    <p style="font-weight: bold; color: #e74c3c; margin: 20px 0 10px 0; font-size: 14px;">üîí BLOCKED (${group.blockedTasks.length})</p>
    <table class="gantt-table">
        <thead>
    <tr>
        <th style="width: 7%;">Seq<br>Mode</th>
        <th style="width: 25%;">Task Name & Description</th>
        <th style="width: 10%;">Plan<br>Start</th>
        <th style="width: 10%;">Plan<br>End</th>
        <th style="width: 20%;">Blocking Issue</th>
        <th style="width: 28%;">Notes</th>
    </tr>
</thead>
        <tbody>
                ${group.blockedTasks.sort((a, b) => (a.sequence || 999) - (b.sequence || 999)).map((task, taskIndex) => {
                const modeLabel = task.executionMode === 'sequential' ? 'Sequential' : 
                                task.executionMode === 'parallel' ? 'Parallel' : 'Independent';
                const modeClass = `mode-${task.executionMode || 'independent'}`;
                
                // ‚úÖ ADD: Get group name for this task
                const taskGroupName = task.parentTask || 'N/A';
                
                // Get blocking tasks info
                let blockingInfo = '<span style="color: #e74c3c; font-style: italic;">Waiting dependencies</span>';
                if (task.dependencies && task.dependencies.length > 0) {
                    const blockingTasks = task.dependencies.map(depId => {
                        const depTask = group.tasks.find(t => t.id === depId);
                        if (!depTask) return null;
                        const progress = parseInt(depTask.progress) || 0;
                        if (progress < 100) {
                            return '<span style="font-weight: 600;">#' + (depTask.sequence || '?') + '</span> ' + depTask.name + ' (' + progress + '%)';
                        }
                        return null;
                    }).filter(t => t !== null);
                    
                    if (blockingTasks.length > 0) {
                        blockingInfo = '<span style="color: #c0392b; font-weight: 600;">Waiting:</span><br>' + blockingTasks.join('<br>');
                    }
                }
                
                return `
                <tr>
                    <td style="text-align: center; font-weight: 700; font-size: 13px;">
                        <div style="color: #3498db; font-size: 11px; margin-bottom: 2px;">#${taskIndex + 1}</div>
                        <div style="color: #7f8c8d; font-size: 9px;">(Seq ${task.sequence || '?'} - ${taskGroupName})</div>
                        <span class="mode-badge ${modeClass}">${modeLabel}</span>
                    </td>
                    <td>
                        <strong style="color: #2c3e50;">${task.name}</strong>
                        ${task.description ? `<div style="font-size: 10px; color: #7f8c8d; margin-top: 3px; font-style: italic;">${task.description.substring(0, 80)}${task.description.length > 80 ? '...' : ''}</div>` : ''}
                    </td>
                    <td style="text-align: center; font-size: 10px;">${task.targetStart ? formatDateForDisplay(task.targetStart) : '-'}</td>
                    <td style="text-align: center; font-size: 10px;">${task.targetEnd ? formatDateForDisplay(task.targetEnd) : '-'}</td>
                    <td style="font-size: 10px; color: #e74c3c;">${blockingInfo}</td>
		<td style="font-size: 10px; color: #555; font-style: italic; padding: 8px; white-space: pre-wrap;">
    ${task.notes ? (task.notes.length > 150 ? task.notes.substring(0, 150) + '...' : task.notes) : '-'}
</td>
                </tr>
                `;
            }).join('')}
        </tbody>
    </table>
` : ''}
            `).join('')}
        </div>
        
       <div style="text-align: center; margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
    <button class="print-btn" onclick="window.print()" style="padding: 12px 30px; font-size: 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);">
        üñ®Ô∏è Print to PDF
    </button>
    <p style="margin: 10px 0 0 0; font-size: 12px; color: #7f8c8d;">
        Use your browser's "Save as PDF" option in the print dialog
    </p>
</div>
<!-- Scripts for print optimization -->
<script>
// Auto-focus for better UX
window.onload = function() {
    document.title = 'Progress_Report_' + document.querySelector('.header h2').textContent.replace(/[^a-zA-Z0-9]/g, '_');
};
<\/script>
    </div>
</body>
</html>
    `;
}

// ‚úÖ TAMBAHKAN DI SINI - Function baru di global scope
function loadPreviousReportSettings(baseName) {
    const equipmentBase = baseName.replace(/[.#$[\]]/g, '_');
    
    database.ref(`reportSettings/${equipmentBase}`).once('value').then(snapshot => {
        if (snapshot.exists()) {
    const data = snapshot.val();
    
    // Pre-fill with previous data
    document.getElementById('reportHighlights').value = data.highlights || '';
    document.getElementById('reportActionPlan').value = data.actionPlan || '';
    
    // ‚úÖ LOAD MILESTONES
    if (data.milestones && Array.isArray(data.milestones) && data.milestones.length > 0) {
        reportMilestones = data.milestones;
        renderMilestones();
    }
    
    // Show info that data was loaded
    const highlightLabel = document.querySelector('label[for="reportHighlights"]');
    if (highlightLabel && (data.highlights || data.milestones)) {
        highlightLabel.innerHTML = '‚ú® Key Highlights (Optional): <span style="color: #27ae60; font-size: 11px;">(Loaded from ' + new Date(data.timestamp).toLocaleDateString() + ')</span>';
    }
} else {
            document.getElementById('reportHighlights').value = '';
            document.getElementById('reportActionPlan').value = '';
        }
    }).catch(error => {
        console.error('Error loading report settings:', error);
        document.getElementById('reportHighlights').value = '';
        document.getElementById('reportActionPlan').value = '';
    });
}

// Global array to store milestones
window.reportMilestones = [];  // ‚úÖ EXPLICITLY GLOBAL!

// Add milestone
function addMilestone() {
    const milestoneId = Date.now();
    reportMilestones.push({
        id: milestoneId,
        name: '',
        targetDate: '',
        progress: 0,
        completedDate: null  // ‚úÖ ADD completion date field
    });
    renderMilestones();
}

// Remove milestone
function removeMilestone(id) {
    reportMilestones = reportMilestones.filter(m => m.id !== id);
    renderMilestones();
}

// Update milestone data
function updateMilestone(id, field, value) {
    const milestone = reportMilestones.find(m => m.id === id);
    if (milestone) {
        milestone[field] = value;
    }
}

// Render milestones list
function renderMilestones() {
    const container = document.getElementById('milestonesList');
    
    if (reportMilestones.length === 0) {
        container.innerHTML = '<div style="color: #95a5a6; font-size: 12px; padding: 10px; text-align: center; border: 1px dashed #ddd; border-radius: 4px;">No milestones added yet. Click "+ Add Milestone" to add one.</div>';
        return;
    }
    
    container.innerHTML = reportMilestones.map((milestone, index) => {
        const progress = parseInt(milestone.progress) || 0;
        const isCompleted = progress === 100;
        
        // Determine grid columns based on completion status
        const gridColumns = isCompleted ? '2fr 1fr 1fr 1fr' : '2fr 1fr 1fr';
        
        return `
        <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; padding: 12px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: #2c3e50; font-size: 12px;">Milestone ${index + 1}</strong>
                <button onclick="removeMilestone(${milestone.id})" type="button"
                        style="padding: 2px 8px; font-size: 11px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer;">
                    Remove
                </button>
            </div>
            <div style="display: grid; grid-template-columns: ${gridColumns}; gap: 8px;">
                <input type="text" 
                       placeholder="Milestone name (e.g., Installation Complete)" 
                       value="${milestone.name}"
                       onchange="updateMilestone(${milestone.id}, 'name', this.value)"
                       style="padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                <input type="date" 
                       value="${milestone.targetDate}"
                       onchange="updateMilestone(${milestone.id}, 'targetDate', this.value)"
                       style="padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;"
                       title="Target completion date">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <input type="number" 
                           min="0" max="100" 
                           value="${milestone.progress}"
                           onchange="updateMilestone(${milestone.id}, 'progress', parseInt(this.value))"
                           style="padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; width: 60px;">
                    <span style="font-size: 11px;">%</span>
                </div>
                ${isCompleted ? `
                    <input type="date" 
                           value="${milestone.completedDate || ''}"
                           onchange="updateMilestone(${milestone.id}, 'completedDate', this.value)"
                           style="padding: 6px; border: 1px solid #27ae60; border-radius: 3px; font-size: 11px; background: #f0fff4;"
                           placeholder="Completed on..."
                           title="Actual completion date">
                ` : ''}
            </div>
            ${isCompleted && !milestone.completedDate ? `
                <div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-left: 3px solid #f39c12; border-radius: 3px; font-size: 11px; color: #856404;">
                    ‚ö†Ô∏è Please enter the actual completion date for this milestone
                </div>
            ` : ''}
        </div>
        `;
    }).join('');
}

// Calculate weighted progress from tasks
function calculateWeightedProgress(tasks) {
    if (!tasks || tasks.length === 0) return 0;
    
    let totalProgress = 0;
    let totalTasks = tasks.length;
    
    tasks.forEach(task => {
        if (task.status === 'completed') {
            totalProgress += 100;
        } else if (task.status === 'in-progress' || task.status === 'inprogress' || task.status === 'blocked') {  // ‚úÖ FIX
            totalProgress += (task.progress || 0);
        }
    });
    
    return Math.round(totalProgress / totalTasks);
}

// Calculate smart status based on progress vs time
// Calculate smart status based on progress vs time
function calculateSmartStatus(actualProgress, startDate, targetDate) {
    actualProgress = parseInt(actualProgress) || 0;
    
    // Completed
    if (actualProgress >= 100) {
        return { status: 'COMPLETED', color: '#27ae60', icon: '‚úÖ' };
    }
    
    // Not started
    if (actualProgress === 0) {
        return { status: 'NOT STARTED', color: '#95a5a6', icon: '‚è∏Ô∏è' };
    }
    
    // If no target date, default to IN PROGRESS
    if (!targetDate) {
        return { status: 'IN PROGRESS', color: '#3498db', icon: 'üîÑ' };
    }
    
    const target = new Date(targetDate);
    const today = new Date();
    
    // If past target date
    if (today > target) {
        return { status: 'OVERDUE', color: '#e74c3c', icon: 'üî¥' };
    }
    
    // If we have start date, calculate expected progress
    if (startDate) {
        const start = new Date(startDate);
        const totalDays = Math.ceil((target - start) / (1000 * 60 * 60 * 24));
        const elapsedDays = Math.ceil((today - start) / (1000 * 60 * 60 * 24));
        
        // Prevent division by zero
        if (totalDays > 0) {
            const expectedProgress = (elapsedDays / totalDays) * 100;
            const tolerance = 15; // ¬±15% tolerance
            
            if (actualProgress > expectedProgress + tolerance) {
                return { status: 'AHEAD', color: '#27ae60', icon: 'üöÄ' };
            } else if (actualProgress < expectedProgress - tolerance) {
                return { status: 'BEHIND', color: '#f39c12', icon: '‚ö†Ô∏è' };
            } else {
                return { status: 'ON TRACK', color: '#3498db', icon: '‚úÖ' };
            }
        }
    }
    
    // Default: In Progress (if no start date or can't calculate)
    return { status: 'IN PROGRESS', color: '#3498db', icon: 'üîÑ' };
}

// Calculate progress breakdown for display
function calculateProgressBreakdown(tasks) {
    if (!tasks || tasks.length === 0) {
        return {
            completed: { count: 0, progress: 0, weight: 0 },
            inProgress: { count: 0, progress: 0, weight: 0 },
            ready: { count: 0, progress: 0, weight: 0 },
            blocked: { count: 0, progress: 0, weight: 0 },
            total: { count: 0, progress: 0, weight: 0 }
        };
    }
    
    const breakdown = {
        completed: { count: 0, totalProgress: 0 },
        inProgress: { count: 0, totalProgress: 0 },
        ready: { count: 0, totalProgress: 0 },
        blocked: { count: 0, totalProgress: 0 }
    };
    
    tasks.forEach(task => {
        if (task.status === 'completed') {
            breakdown.completed.count++;
            breakdown.completed.totalProgress += 100;
        } else if (task.status === 'in-progress') {
            breakdown.inProgress.count++;
            breakdown.inProgress.totalProgress += (task.progress || 0);
        } else if (task.status === 'blocked') {
            breakdown.blocked.count++;
            breakdown.blocked.totalProgress += (task.progress || 0);
        } else {
            breakdown.ready.count++;
            breakdown.ready.totalProgress += 0;
        }
    });
    
    const totalTasks = tasks.length;
    const totalWeight = breakdown.completed.totalProgress + 
                       breakdown.inProgress.totalProgress + 
                       breakdown.ready.totalProgress + 
                       breakdown.blocked.totalProgress;
    
    return {
        completed: {
            count: breakdown.completed.count,
            progress: breakdown.completed.count > 0 ? Math.round(breakdown.completed.totalProgress / breakdown.completed.count) : 0,
            weight: breakdown.completed.totalProgress,
            percentage: Math.round((breakdown.completed.count / totalTasks) * 100)
        },
        inProgress: {
            count: breakdown.inProgress.count,
            progress: breakdown.inProgress.count > 0 ? Math.round(breakdown.inProgress.totalProgress / breakdown.inProgress.count) : 0,
            weight: breakdown.inProgress.totalProgress,
            percentage: Math.round((breakdown.inProgress.count / totalTasks) * 100)
        },
        ready: {
            count: breakdown.ready.count,
            progress: 0,
            weight: 0,
            percentage: Math.round((breakdown.ready.count / totalTasks) * 100)
        },
        blocked: {
            count: breakdown.blocked.count,
            progress: breakdown.blocked.count > 0 ? Math.round(breakdown.blocked.totalProgress / breakdown.blocked.count) : 0,
            weight: breakdown.blocked.totalProgress,
            percentage: Math.round((breakdown.blocked.count / totalTasks) * 100)
        },
        total: {
            count: totalTasks,
            progress: Math.round(totalWeight / totalTasks),
            weight: totalWeight,
            maxWeight: totalTasks * 100
        }
    };
}

function recalculateAllProgress() {
    console.log('üîÑ Starting recalculation of all equipment progress...');
    
    let updatedCount = 0;
    
    Object.keys(onsiteTasks).forEach(equipmentKey => {
        const tasks = onsiteTasks[equipmentKey];
        if (tasks && tasks.length > 0) {
            updateEquipmentProgress(equipmentKey);
            updatedCount++;
        }
    });
    
    console.log(`‚úÖ Recalculated progress for ${updatedCount} equipment`);
    showNotification(`Progress recalculated for ${updatedCount} equipment`, 'success');
}

// ===== PDF GENERATION FUNCTIONS =====

function generateReport() {
    // Get selected groups
    const selectedCheckboxes = document.querySelectorAll('.report-group-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        showNotification('Please select at least one group', 'error');
        return;
    }
    
    // Collect data from selected groups
// Collect data (reuse same logic)
const reportData = {
    equipmentBase: document.getElementById('reportEquipmentBase').value,
    reportDate: document.getElementById('reportDate').value,
    highlights: document.getElementById('reportHighlights').value.trim(),
    actionPlan: document.getElementById('reportActionPlan').value.trim(),
    milestones: reportMilestones.filter(m => m.name.trim()),  // ‚úÖ ADD - Only include filled milestones
    groups: []
};
    
    selectedCheckboxes.forEach(checkbox => {
    const firebaseKey = checkbox.value;
    const equipment = checkbox.dataset.equipment;
    const disc = checkbox.dataset.disc;
    const vendor = checkbox.dataset.vendor;
    const taskName = checkbox.dataset.task || 'N/A';  // ‚úÖ ADD THIS
    const displaySequence = parseInt(checkbox.dataset.displaysequence) || 999;
        
        const tasks = onsiteTasks[firebaseKey] || [];
        
        // Calculate metrics for this group
       const completedTasks = tasks.filter(t => t.status === 'completed' || t.progress === 100);
const inProgressTasks = tasks.filter(t => t.status === 'inprogress' || (t.progress > 0 && t.progress < 100));
const pendingTasks = tasks.filter(t => (!t.status || t.status === 'pending') && (!t.progress || t.progress === 0));

// Separate blocked vs ready to start
const blockedTasks = [];
const readyTasks = [];

pendingTasks.forEach(task => {
    if (checkIfBlocked(task, tasks)) {
        blockedTasks.push(task);
    } else {
        readyTasks.push(task);
    }
});
        
        const totalTasks = tasks.length;
const overallProgress = calculateWeightedProgress(tasks);  // ‚úÖ WEIGHTED CALCULATION
        
        // Determine status
        // Determine status based on ACTUAL task conditions
let status = 'NOT YET STARTED';
let statusColor = [149, 165, 166]; // Gray

if (overallProgress === 100) {
    status = 'COMPLETED';
    statusColor = [39, 174, 96]; // Green
} else if (inProgressTasks.length > 0) {
    // Has tasks in progress - check if on track
    const overdueTasks = inProgressTasks.filter(t => {
        if (!t.targetEnd) return false;
        const targetEnd = new Date(t.targetEnd);
        const today = new Date();
        return today > targetEnd && t.progress < 100;
    });
    
    if (overdueTasks.length > 0 || blockedTasks.length > 0) {
        status = 'REQUIRES ATTENTION';
        statusColor = [243, 156, 18]; // Orange
    } else {
        status = 'IN PROGRESS';
        statusColor = [52, 152, 219]; // Blue
    }
} else if (readyTasks.length > 0) {
    status = 'READY TO START';
    statusColor = [46, 204, 113]; // Light green
} else if (blockedTasks.length > 0) {
    status = 'REQUIRES ATTENTION';
    statusColor = [243, 156, 18]; // Orange
} else {
    status = 'NOT YET STARTED';
    statusColor = [149, 165, 166]; // Gray
}
        
        // Add timeline status to each task
const tasksWithTimeline = tasks.map(task => ({
    ...task,
    timeline: getTaskTimelineStatus(task)
})).sort((a, b) => (a.sequence || 999) - (b.sequence || 999));

// Update task arrays with timeline info
const completedWithTimeline = completedTasks.map(t => ({
    ...t,
    timeline: getTaskTimelineStatus(t)
}));

const inProgressWithTimeline = inProgressTasks.map(t => ({
    ...t,
    timeline: getTaskTimelineStatus(t)
}));

const readyWithTimeline = readyTasks.map(t => ({
    ...t,
    timeline: getTaskTimelineStatus(t)
}));

const blockedWithTimeline = blockedTasks.map(t => ({
    ...t,
    timeline: getTaskTimelineStatus(t)
}));


reportData.groups.push({
    equipment,
    disc,
    vendor,
task: taskName,  // ‚úÖ ADD THIS
    firebaseKey,
    displaySequence,  // ‚úÖ ADD THIS
    tasks: tasksWithTimeline,
    completedTasks: completedWithTimeline,
    inProgressTasks: inProgressWithTimeline,
    readyTasks: readyWithTimeline,
    blockedTasks: blockedWithTimeline,
    totalTasks,
    overallProgress,
    status,
    statusColor
});
    });
    
    // Calculate overall metrics
    // Collect all tasks from all groups
let allReportTasks = [];
reportData.groups.forEach(group => {
    allReportTasks = allReportTasks.concat(group.tasks);
});

// Calculate weighted overall progress
reportData.overallProgress = calculateWeightedProgress(allReportTasks);
reportData.progressBreakdown = calculateProgressBreakdown(allReportTasks);

// Calculate weighted progress per group
reportData.groups.forEach(group => {
    group.weightedProgress = calculateWeightedProgress(group.tasks);
    group.progressBreakdown = calculateProgressBreakdown(group.tasks);
});
 
// ‚úÖ CALCULATE TIMELINE - Find earliest/latest dates from all tasks
let allTasks = [];
reportData.groups.forEach(group => {
    allTasks = allTasks.concat(group.tasks);
});

const tasksWithDates = allTasks.filter(t => t.targetStart || t.targetEnd);

if (tasksWithDates.length > 0) {
    const startDates = tasksWithDates.map(t => t.targetStart).filter(d => d).map(d => new Date(d));
    const endDates = tasksWithDates.map(t => t.targetEnd).filter(d => d).map(d => new Date(d));
    
    const projectStart = startDates.length > 0 ? new Date(Math.min(...startDates)) : new Date();
    const targetEnd = endDates.length > 0 ? new Date(Math.max(...endDates)) : new Date();
    const currentDate = new Date();
    
    const totalDays = Math.ceil((targetEnd - projectStart) / (1000 * 60 * 60 * 24));
    const daysElapsed = Math.ceil((currentDate - projectStart) / (1000 * 60 * 60 * 24));
    const daysRemaining = Math.ceil((targetEnd - currentDate) / (1000 * 60 * 60 * 24));
    const percentTimeElapsed = totalDays > 0 ? Math.round((daysElapsed / totalDays) * 100) : 0;
    
    reportData.timeline = {
        projectStart: projectStart.toISOString().split('T')[0],
        currentDate: currentDate.toISOString().split('T')[0],
        targetEnd: targetEnd.toISOString().split('T')[0],
        totalDays: totalDays,
        daysElapsed: Math.max(0, daysElapsed),
        daysRemaining: Math.max(0, daysRemaining),
        percentTimeElapsed: Math.max(0, Math.min(100, percentTimeElapsed))
    };
} else {
    reportData.timeline = null;
}
   
// ‚úÖ SORT GROUPS BY DISPLAY SEQUENCE
reportData.groups.sort((a, b) => {
    const seqA = a.displaySequence || 999;
    const seqB = b.displaySequence || 999;
    
    // If sequences are equal, sort by equipment name then disc
    if (seqA === seqB) {
        const equipCompare = (a.equipment || '').localeCompare(b.equipment || '');
        if (equipCompare !== 0) return equipCompare;
        return (a.disc || '').localeCompare(b.disc || '');
    }
    
    return seqA - seqB;
});

// ‚úÖ SAVE Highlights, Action Plan & Milestones to Firebase
const equipmentBase = reportData.equipmentBase.replace(/[.#$[\]]/g, '_');

// Always save latest version (no date in path)
database.ref(`reportSettings/${equipmentBase}`).set({
    highlights: reportData.highlights || '',
    actionPlan: reportData.actionPlan || '',
    milestones: reportData.milestones || [],
    timestamp: new Date().toISOString(),
    updatedBy: 'Report Generator'
}).then(() => {
    console.log('‚úÖ Report settings saved successfully');
}).catch(error => {
    console.error('‚ùå Error saving report settings:', error);
    showNotification('Failed to save report settings: ' + error.message, 'error');
});


    // Generate PDF
    generatePDF(reportData);
}

function generatePDF(data) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    const pageWidth = doc.internal.pageSize.width;
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);
    
    // ===== HEADER =====
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('PROGRESS REPORT', pageWidth / 2, yPos, { align: 'center' });
    yPos += 10;
    
    doc.setFontSize(14);
    doc.text(`${data.equipmentBase} System`, pageWidth / 2, yPos, { align: 'center' });
    yPos += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Report Date: ${formatDateForDisplay(data.reportDate)}`, pageWidth / 2, yPos, { align: 'center' });
    yPos += 3;
    
    // Line separator
    doc.setDrawColor(44, 62, 80);
    doc.setLineWidth(0.5);
    doc.line(margin, yPos, pageWidth - margin, yPos);
    yPos += 10;
    
    // ===== EXECUTIVE SUMMARY =====
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('EXECUTIVE SUMMARY', margin, yPos);
    yPos += 8;
    
    // Overall progress bar
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Overall Progress: ${data.overallProgress}%`, margin, yPos);
    
    // Progress bar
    const barWidth = 60;
    const barHeight = 6;
    const barX = margin + 50;
    const barY = yPos - 4;
    
    doc.setDrawColor(200);
    doc.setFillColor(240);
    doc.rect(barX, barY, barWidth, barHeight, 'FD');
    
    const fillWidth = (data.overallProgress / 100) * barWidth;
    const fillColor = data.overallProgress >= 80 ? [39, 174, 96] : data.overallProgress >= 50 ? [243, 156, 18] : [231, 76, 60];
    doc.setFillColor(...fillColor);
    doc.rect(barX, barY, fillWidth, barHeight, 'F');
    
    yPos += 10;
    
    // Critical issues count
    const totalBlocked = data.groups.reduce((sum, g) => sum + g.blockedTasks.length, 0);
    doc.text(`Critical Issues: ${totalBlocked} blocked tasks`, margin, yPos);
yPos += 6;
doc.text(`Groups Included: ${data.groups.length}`, margin, yPos);
yPos += 12;  // ‚úÖ INCREASED from 8 to 12

// Check page break before highlights
if (yPos > 220) {
    doc.addPage();
    yPos = 20;
}

// ===== PROGRESS BY DISCIPLINE =====
doc.setFontSize(11);
doc.setFont(undefined, 'bold');
doc.text('PROGRESS BY DISCIPLINE', margin, yPos);
yPos += 8;

data.groups.forEach(group => {
    if (yPos > 250) {
        doc.addPage();
        yPos = 20;
    }
    
    // Discipline name and equipment
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(0, 0, 0);
    doc.text(`${group.disc}`, margin + 3, yPos);
    
    doc.setFont(undefined, 'normal');
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.text(`${group.equipment}`, margin + 20, yPos);
    
    // Progress percentage and status
    doc.setFont(undefined, 'bold');
    doc.setFontSize(9);
    const barColor = group.overallProgress >= 80 ? [39, 174, 96] : 
                     group.overallProgress >= 50 ? [52, 152, 219] : 
                     group.overallProgress > 0 ? [243, 156, 18] : [149, 165, 166];
    doc.setTextColor(...barColor);
    doc.text(`${group.overallProgress}%`, pageWidth - margin - 40, yPos);
    
    const statusColor = 
        group.status === 'COMPLETED' ? [39, 174, 96] : 
        group.status === 'ON SCHEDULE' ? [39, 174, 96] : 
        group.status === 'IN PROGRESS' ? [52, 152, 219] : 
        group.status === 'REQUIRES ATTENTION' ? [243, 156, 18] : 
        [149, 165, 166];
    doc.setFontSize(7);
    doc.setTextColor(...statusColor);
    doc.text(`${group.status}`, pageWidth - margin - 15, yPos, { align: 'right' });
    
    yPos += 4;
    
    // Progress bar background
    const barWidth = contentWidth - 6;
    const barHeight = 6;
    const barX = margin + 3;
    const barY = yPos - 2;
    
    doc.setDrawColor(200, 200, 200);
    doc.setFillColor(236, 240, 241);
    doc.roundedRect(barX, barY, barWidth, barHeight, 2, 2, 'FD');
    
    // Progress bar fill
    const fillWidth = (group.overallProgress / 100) * barWidth;
    if (fillWidth > 0) {
        doc.setFillColor(...barColor);
        doc.roundedRect(barX, barY, fillWidth, barHeight, 2, 2, 'F');
    }
    
    // Task count inside bar
    doc.setFontSize(7);
    doc.setTextColor(255, 255, 255);
    if (fillWidth > 20) {
        doc.text(`${group.completedTasks.length}/${group.totalTasks} tasks`, barX + 3, barY + 4.5);
    }
    
    doc.setTextColor(0, 0, 0);
    yPos += 10;
});

yPos += 5;

// ‚úÖ PROJECT TIMELINE
if (data.timeline) {
    if (yPos > 200) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('PROJECT TIMELINE', margin, yPos);
    yPos += 6;
    
    // Timeline boxes
    const boxWidth = contentWidth / 3 - 2;
    const boxHeight = 15;
    
    // Start
    doc.setFillColor(102, 126, 234);
    doc.rect(margin, yPos, boxWidth, boxHeight, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(8);
    doc.text('Project Start', margin + 2, yPos + 4);
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text(formatDateForDisplay(data.timeline.projectStart), margin + 2, yPos + 10);
    
    // Current
    doc.setFillColor(118, 75, 162);
    doc.rect(margin + boxWidth + 2, yPos, boxWidth, boxHeight, 'F');
    doc.setFontSize(8);
    doc.text('Current Date', margin + boxWidth + 4, yPos + 4);
    doc.setFontSize(10);
    doc.text(formatDateForDisplay(data.timeline.currentDate), margin + boxWidth + 4, yPos + 10);
    doc.setFontSize(7);
    doc.text(`${data.timeline.daysElapsed} days elapsed`, margin + boxWidth + 4, yPos + 13);
    
    // End
    doc.setFillColor(102, 126, 234);
    doc.rect(margin + (boxWidth + 2) * 2, yPos, boxWidth, boxHeight, 'F');
    doc.setFontSize(8);
    doc.text('Target End', margin + (boxWidth + 2) * 2 + 2, yPos + 4);
    doc.setFontSize(10);
    doc.text(formatDateForDisplay(data.timeline.targetEnd), margin + (boxWidth + 2) * 2 + 2, yPos + 10);
    doc.setFontSize(7);
    doc.text(`${data.timeline.daysRemaining} days remaining`, margin + (boxWidth + 2) * 2 + 2, yPos + 13);
    
    doc.setTextColor(0, 0, 0);
    yPos += boxHeight + 5;
    
    // Progress bar
    doc.setFillColor(220, 220, 220);
    doc.rect(margin, yPos, contentWidth, 8, 'F');
    doc.setFillColor(39, 174, 96);
    doc.rect(margin, yPos, contentWidth * (data.timeline.percentTimeElapsed / 100), 8, 'F');
    doc.setFontSize(8);
    doc.setTextColor(255, 255, 255);
    doc.text(`${data.timeline.percentTimeElapsed}% Time Elapsed`, margin + 3, yPos + 5);
    doc.setTextColor(0, 0, 0);
    
    yPos += 12;
}

// ‚úÖ MILESTONES TABLE
if (data.milestones && data.milestones.length > 0) {
    if (yPos > 220) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('MILESTONE STATUS', margin, yPos);
    yPos += 6;
    
    const milestoneData = data.milestones.map(m => {
        const targetDate = new Date(m.targetDate);
        const today = new Date();
        const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        
        let status = m.progress >= 100 ? 'COMPLETED' : m.progress > 0 ? (daysUntil < 0 ? 'DELAYED' : 'ON TRACK') : 'PENDING';
        
        return [
            m.name,
            formatDateForDisplay(m.targetDate),
            `${m.progress}%`,
            status
        ];
    });
    
    doc.autoTable({
        startY: yPos,
        head: [['Milestone', 'Target Date', 'Progress', 'Status']],
        body: milestoneData,
        theme: 'grid',
        headStyles: {
            fillColor: [52, 73, 94],
            textColor: 255,
            fontSize: 9,
            fontStyle: 'bold'
        },
        bodyStyles: {
            fontSize: 8
        },
        columnStyles: {
            0: { cellWidth: 70 },
            1: { cellWidth: 35, halign: 'center' },
            2: { cellWidth: 25, halign: 'center', fontStyle: 'bold', textColor: [52, 152, 219] },
            3: { cellWidth: 'auto', halign: 'center', fontStyle: 'bold' }
        },
        margin: { left: margin, right: margin }
    });
    
    yPos = doc.lastAutoTable.finalY + 8;
}

// ‚úÖ KEY HIGHLIGHTS
if (data.highlights && data.highlights.trim()) {
    if (yPos > 220) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('KEY HIGHLIGHTS', margin, yPos);
    yPos += 6;
    
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    const highlightLines = doc.splitTextToSize(data.highlights, contentWidth - 10);
    
    const highlightHeight = (highlightLines.length * 4.5) + 10;
    doc.setFillColor(255, 251, 240);
    doc.rect(margin, yPos, contentWidth, highlightHeight, 'F');
    doc.setDrawColor(243, 156, 18);
    doc.setLineWidth(2);
    doc.line(margin, yPos, margin, yPos + highlightHeight);
    doc.setTextColor(44, 62, 80);
    doc.text(highlightLines, margin + 5, yPos + 5);
    doc.setTextColor(0, 0, 0);
    
    yPos += highlightHeight + 8;
}

// ‚úÖ ACTION PLAN
if (data.actionPlan && data.actionPlan.trim()) {
    if (yPos > 220) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('ACTION PLAN', margin, yPos);
    yPos += 6;
    
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    const actionLines = doc.splitTextToSize(data.actionPlan, contentWidth - 10);
    
    const actionHeight = (actionLines.length * 4.5) + 10;
    doc.setFillColor(240, 248, 255);
    doc.rect(margin, yPos, contentWidth, actionHeight, 'F');
    doc.setDrawColor(52, 152, 219);
    doc.setLineWidth(2);
    doc.line(margin, yPos, margin, yPos + actionHeight);
    doc.setTextColor(44, 62, 80);
    doc.text(actionLines, margin + 5, yPos + 5);
    doc.setTextColor(0, 0, 0);
    
    yPos += actionHeight + 8;
}
    
    // ===== EQUIPMENT BREAKDOWN =====
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('EQUIPMENT BREAKDOWN', margin, yPos);
    yPos += 8;
    
    data.groups.forEach((group, idx) => {
        // Check if need new page
        if (yPos > 250) {
            doc.addPage();
            yPos = 20;
        }
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text(`${idx + 1}. ${group.equipment} - ${group.disc}`, margin + 3, yPos);
        yPos += 5;
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        doc.text(`Vendor: ${group.vendor}`, margin + 5, yPos);
        yPos += 4;
        
        doc.text(`Progress: ${group.overallProgress}% | Tasks: ${group.completedTasks.length}/${group.totalTasks} completed`, margin + 5, yPos);
        yPos += 4;
        
        // Status indicator
        const statusText = group.status.toUpperCase();
        const statusColor = 
    group.status === 'COMPLETED' ? [39, 174, 96] : 
    group.status === 'ON SCHEDULE' ? [39, 174, 96] : 
    group.status === 'IN PROGRESS' ? [52, 152, 219] : 
    group.status === 'REQUIRES ATTENTION' ? [243, 156, 18] : 
    [149, 165, 166];
        doc.setTextColor(...statusColor);
        doc.text(`Status: ${statusText}`, margin + 5, yPos);
        doc.setTextColor(0, 0, 0);
        yPos += 8;
    });
    
    yPos += 5;
    
    // ===== TASK STATUS DETAILS =====
    if (yPos > 230) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('TASK STATUS DETAILS', margin, yPos);
    yPos += 8;
    
    data.groups.forEach((group, groupIdx) => {
    // Add separator between groups
    if (groupIdx > 0) {
        if (yPos > 230) {
            doc.addPage();
            yPos = 20;
        }
        
        // Separator line
        doc.setDrawColor(52, 152, 219);
        doc.setLineWidth(1);
        doc.line(margin, yPos, pageWidth - margin, yPos);
        yPos += 8;
    }
    
    if (yPos > 240) {
        doc.addPage();
        yPos = 20;
    }
    
    // Group header with background
    doc.setFillColor(102, 126, 234);
    doc.rect(margin, yPos - 5, contentWidth, 12, 'F');
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(255, 255, 255);
    doc.text(`${group.equipment} - ${group.disc}`, margin + 3, yPos + 2);
    
    doc.setFontSize(8);
    doc.text(`${group.vendor} | Progress: ${group.overallProgress}% | Status: ${group.status}`, margin + 3, yPos + 7);
    
    doc.setTextColor(0, 0, 0);
    yPos += 15;
        
        // COMPLETED
// COMPLETED
if (group.completedTasks.length > 0) {
    if (yPos > 235) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(39, 174, 96);
    doc.text(`COMPLETED (${group.completedTasks.length})`, margin + 5, yPos);
    doc.setTextColor(0, 0, 0);
    yPos += 6;
    
    const completedData = group.completedTasks.slice(0, 10).map(task => {
    const modeIcon = task.executionMode === 'sequential' ? '>' : 
                    task.executionMode === 'parallel' ? '||' : 'o';
    
    let taskInfo = task.name;
    if (task.description && task.description.trim()) {
        const shortDesc = task.description.length > 40 ? 
                        task.description.substring(0, 40) + '...' : 
                        task.description;
        taskInfo += `\n${shortDesc}`;
    }
    
    // ‚úÖ ADD NOTES
    const notes = task.notes ? 
             (task.notes.length > 60 ? task.notes.substring(0, 60) + '...' : task.notes) : 
             '-';

return [
    `${task.sequence || '?'}\n${modeIcon}`,
    taskInfo,
    task.targetStart ? formatDateForDisplay(task.targetStart) : '-',
    task.targetEnd ? formatDateForDisplay(task.targetEnd) : '-',
    task.startDate ? formatDateForDisplay(task.startDate) : '-',
    `${task.progress || 0}%`,
    task.timeline ? task.timeline.status : '-',
    notes  // ‚úÖ NEW
];
});
    
    doc.autoTable({
    startY: yPos,
    head: [['Seq\nMode', 'Task Name', 'Plan\nStart', 'Plan\nEnd', 'Actual\nStart', 'Actual\nEnd', 'Timeline', 'Notes']],
        body: completedData,
        theme: 'striped',
        headStyles: { 
            fillColor: [39, 174, 96],
            textColor: 255,
            fontSize: 7,
            fontStyle: 'bold',
            halign: 'center',
            cellPadding: { top: 3, right: 2, bottom: 3, left: 2 },
            lineWidth: 0.1,
            lineColor: [200, 200, 200]
        },
        bodyStyles: { 
            fontSize: 6.5,
            cellPadding: { top: 3, right: 2, bottom: 3, left: 2 },
            valign: 'top',
            lineWidth: 0.1,
            lineColor: [220, 220, 220]
        },
        alternateRowStyles: {
            fillColor: [245, 250, 245]
        },
        columnStyles: {
    0: { halign: 'center', cellWidth: 10, fontSize: 6 },
    1: { cellWidth: 40, fontSize: 6.5 },  // Reduced from 48
    2: { halign: 'center', cellWidth: 15, fontSize: 6 },
    3: { halign: 'center', cellWidth: 15, fontSize: 6 },
    4: { halign: 'center', cellWidth: 15, fontSize: 6 },
    5: { halign: 'center', cellWidth: 15, fontSize: 6 },
    6: { cellWidth: 18, fontSize: 6, fontStyle: 'bold' },
    7: { cellWidth: 'auto', fontSize: 5.5, fontStyle: 'italic', textColor: [100, 100, 100] }  // ‚úÖ NEW
},
        didParseCell: function(data) {
            // Add color to timeline status
            if (data.column.index === 6 && data.section === 'body') {
                const status = data.cell.text[0];
                if (status && status.includes('early')) {
                    data.cell.styles.textColor = [52, 152, 219]; // Blue
                } else if (status && status.includes('on time')) {
                    data.cell.styles.textColor = [39, 174, 96]; // Green
                } else if (status && status.includes('late')) {
                    data.cell.styles.textColor = [231, 76, 60]; // Red
                }
            }
        },
        margin: { left: margin, right: margin }
    });
    
    yPos = doc.lastAutoTable.finalY + 8;
    
    if (group.completedTasks.length > 10) {
        doc.setFontSize(7);
        doc.setTextColor(120);
        doc.text(`+ ${group.completedTasks.length - 10} more completed tasks`, margin + 7, yPos);
        doc.setTextColor(0);
        yPos += 6;
    }
}
        
        // IN PROGRESS
// IN PROGRESS
if (group.inProgressTasks.length > 0) {
    if (yPos > 235) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(243, 156, 18);
    doc.text(`IN PROGRESS (${group.inProgressTasks.length})`, margin + 5, yPos);
    doc.setTextColor(0, 0, 0);
    yPos += 6;
    
    const inProgressData = group.inProgressTasks.map(task => {
        const modeIcon = task.executionMode === 'sequential' ? '>' : 
                        task.executionMode === 'parallel' ? '||' : 'o';
        
        let taskInfo = task.name;
        if (task.description && task.description.trim()) {
            const shortDesc = task.description.length > 60 ? 
                            task.description.substring(0, 60) + '...' : 
                            task.description;
            taskInfo += `\n${shortDesc}`;
        }
        
        return [
            `${task.sequence || '?'}\n${modeIcon}`,
            taskInfo,
            task.targetStart ? formatDateForDisplay(task.targetStart) : '-',
            task.targetEnd ? formatDateForDisplay(task.targetEnd) : '-',
            task.startDate ? formatDateForDisplay(task.startDate) : '-',
            `${task.progress || 0}%`,
            task.timeline ? task.timeline.status : '-'
        ];
    });
    
    doc.autoTable({
        startY: yPos,
        head: [['Seq\nMode', 'Task Name', 'Plan\nStart', 'Plan\nEnd', 'Actual\nStart', 'Progress', 'Timeline', 'Notes']],
        body: inProgressData,
        theme: 'striped',
        headStyles: { 
            fillColor: [243, 156, 18],
            textColor: 255,
            fontSize: 7,
            fontStyle: 'bold',
            halign: 'center',
            cellPadding: { top: 3, right: 2, bottom: 3, left: 2 },
            lineWidth: 0.1,
            lineColor: [200, 200, 200]
        },
        bodyStyles: { 
            fontSize: 6.5,
            cellPadding: { top: 3, right: 2, bottom: 3, left: 2 },
            valign: 'top',
            lineWidth: 0.1,
            lineColor: [220, 220, 220]
        },
        alternateRowStyles: {
            fillColor: [255, 250, 245]
        },
        columnStyles: {
    0: { halign: 'center', cellWidth: 10, fontSize: 6 },
    1: { cellWidth: 42, fontSize: 6.5 },  // Reduced from 50
    2: { halign: 'center', cellWidth: 15, fontSize: 6 },
    3: { halign: 'center', cellWidth: 15, fontSize: 6 },
    4: { halign: 'center', cellWidth: 15, fontSize: 6 },
    5: { halign: 'center', cellWidth: 10, fontSize: 7, fontStyle: 'bold', textColor: [52, 152, 219] },
    6: { cellWidth: 18, fontSize: 6, fontStyle: 'bold' },
    7: { cellWidth: 'auto', fontSize: 5.5, fontStyle: 'italic', textColor: [100, 100, 100] }  // ‚úÖ NEW
},
        didParseCell: function(data) {
            if (data.column.index === 6 && data.section === 'body') {
                const status = data.cell.text[0];
                if (status && status.includes('ahead')) {
                    data.cell.styles.textColor = [52, 152, 219];
                } else if (status && status.includes('on track')) {
                    data.cell.styles.textColor = [39, 174, 96];
                } else if (status && (status.includes('at risk') || status.includes('delayed'))) {
                    data.cell.styles.textColor = [231, 76, 60];
                } else if (status && status.includes('overdue')) {
                    data.cell.styles.textColor = [192, 57, 43];
                    data.cell.styles.fontStyle = 'bold';
                }
            }
        },
        margin: { left: margin, right: margin }
    });
    
    yPos = doc.lastAutoTable.finalY + 8;
}

// ‚úÖ TAMBAHKAN INI - READY TO START
// READY TO START
// READY TO START
if (group.readyTasks && group.readyTasks.length > 0) {
    if (yPos > 235) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(52, 152, 219);
    doc.text(`READY TO START (${group.readyTasks.length})`, margin + 5, yPos);
    doc.setTextColor(0, 0, 0);
    yPos += 6;
    
    const readyData = group.readyTasks.map(task => {
        const modeIcon = task.executionMode === 'sequential' ? '>' : 
                        task.executionMode === 'parallel' ? '||' : 'o';
        
        let taskInfo = task.name;
        if (task.description && task.description.trim()) {
            const shortDesc = task.description.length > 60 ? 
                            task.description.substring(0, 60) + '...' : 
                            task.description;
            taskInfo += `\n${shortDesc}`;
        }
        
        // Dependencies info
        let depsInfo = '-';
        if (task.executionMode === 'sequential' && task.dependencies && task.dependencies.length > 0) {
            depsInfo = `Waits: ${task.dependencies.length} task(s)`;
        } else if (task.executionMode === 'parallel' && task.parallelWith && task.parallelWith.length > 0) {
            depsInfo = `With: ${task.parallelWith.length} task(s)`;
        }
        
        return [
            `${task.sequence || '?'}\n${modeIcon}`,
            taskInfo,
            task.targetStart ? formatDateForDisplay(task.targetStart) : '-',
            task.targetEnd ? formatDateForDisplay(task.targetEnd) : '-',
            depsInfo,
            task.timeline ? task.timeline.status : 'Ready'
        ];
    });
    
    doc.autoTable({
        startY: yPos,
        head: [['Seq\nMode', 'Task Name & Description', 'Plan\nStart', 'Plan\nEnd', 'Dependencies', 'Status']],
        body: readyData,
        theme: 'striped',
        headStyles: { 
            fillColor: [52, 152, 219],
            textColor: 255,
            fontSize: 7,
            fontStyle: 'bold',
            halign: 'center',
            cellPadding: { top: 3, right: 2, bottom: 3, left: 2 },
            lineWidth: 0.1,
            lineColor: [200, 200, 200]
        },
        bodyStyles: { 
            fontSize: 6.5,
            cellPadding: { top: 3, right: 2, bottom: 3, left: 2 },
            valign: 'top',
            lineWidth: 0.1,
            lineColor: [220, 220, 220]
        },
        alternateRowStyles: {
            fillColor: [240, 248, 255]
        },
        columnStyles: {
            0: { halign: 'center', cellWidth: 10, fontSize: 6 },
            1: { cellWidth: 60, fontSize: 6.5 },
            2: { halign: 'center', cellWidth: 20, fontSize: 6 },
            3: { halign: 'center', cellWidth: 20, fontSize: 6 },
            4: { cellWidth: 25, fontSize: 6, textColor: [100, 100, 100] },
            5: { cellWidth: 'auto', fontSize: 6, fontStyle: 'bold', textColor: [52, 152, 219] }
        },
        margin: { left: margin, right: margin }
    });
    
    yPos = doc.lastAutoTable.finalY + 8;
}

        
        // BLOCKED
// BLOCKED
if (group.blockedTasks.length > 0) {
    if (yPos > 235) {
        doc.addPage();
        yPos = 20;
    }
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(231, 76, 60);
    doc.text(`BLOCKED (${group.blockedTasks.length})`, margin + 5, yPos);
    doc.setTextColor(0, 0, 0);
    yPos += 6;
    
    const blockedData = group.blockedTasks.map(task => {
        const modeIcon = task.executionMode === 'sequential' ? '>' : 
                        task.executionMode === 'parallel' ? '||' : 'o';
        
        let taskInfo = task.name;
        if (task.description && task.description.trim()) {
            const shortDesc = task.description.length > 60 ? 
                            task.description.substring(0, 60) + '...' : 
                            task.description;
            taskInfo += `\n${shortDesc}`;
        }
        
        // Get blocking tasks info
        let blockingInfo = 'Waiting dependencies';
        if (task.dependencies && task.dependencies.length > 0) {
            const blockingTasks = task.dependencies.map(depId => {
                const depTask = group.tasks.find(t => t.id === depId);
                return depTask ? `#${depTask.sequence || '?'}` : '?';
            }).join(', ');
            blockingInfo = `Waiting: ${blockingTasks}`;
        }
        
        return [
            `${task.sequence || '?'}\n${modeIcon}`,
            taskInfo,
            task.targetStart ? formatDateForDisplay(task.targetStart) : '-',
            task.targetEnd ? formatDateForDisplay(task.targetEnd) : '-',
            blockingInfo
        ];
    });
    
    doc.autoTable({
        startY: yPos,
        head: [['Seq\nMode', 'Task Name & Description', 'Plan\nStart', 'Plan\nEnd', 'Blocking Issue']],
        body: blockedData,
        theme: 'striped',
        headStyles: { 
            fillColor: [231, 76, 60],
            textColor: 255,
            fontSize: 7,
            fontStyle: 'bold',
            halign: 'center',
            cellPadding: { top: 3, right: 2, bottom: 3, left: 2 },
            lineWidth: 0.1,
            lineColor: [200, 200, 200]
        },
        bodyStyles: { 
            fontSize: 6.5,
            cellPadding: { top: 3, right: 2, bottom: 3, left: 2 },
            valign: 'top',
            lineWidth: 0.1,
            lineColor: [220, 220, 220]
        },
        alternateRowStyles: {
            fillColor: [255, 245, 245]
        },
        columnStyles: {
            0: { halign: 'center', cellWidth: 10, fontSize: 6 },
            1: { cellWidth: 65, fontSize: 6.5 },
            2: { halign: 'center', cellWidth: 20, fontSize: 6 },
            3: { halign: 'center', cellWidth: 20, fontSize: 6 },
            4: { cellWidth: 'auto', fontSize: 6, textColor: [192, 57, 43], fontStyle: 'italic' }
        },
        margin: { left: margin, right: margin }
    });
    
    yPos = doc.lastAutoTable.finalY + 8;
}
        
        yPos += 5;
    });
    
    // ===== FOOTER =====
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, doc.internal.pageSize.height - 10, { align: 'center' });
        doc.text(`Generated: ${new Date().toLocaleString()}`, pageWidth - margin, doc.internal.pageSize.height - 10, { align: 'right' });
    }
    
    // Save PDF
    const fileName = `Progress_Report_${data.equipmentBase}_${data.reportDate}.pdf`;
    doc.save(fileName);
    
    showNotification('PDF Report generated successfully!', 'success');
    closeProgressReportModal();
}

function renderTaskGroup(status, title, tasks, icon, collapsed) {
    if (tasks.length === 0) return '';

    const groupId = `task-group-${status}`;
    
    return `
        <div class="task-group">
            <div class="task-group-header ${status}" onclick="toggleTaskGroup('${groupId}')">
                <div class="task-group-title">
                    <span>${icon}</span>
                    <span>${title.toUpperCase()}</span>
                    <span class="task-group-count">${tasks.length} task${tasks.length > 1 ? 's' : ''}</span>
                </div>
                <span class="task-group-toggle" id="${groupId}-toggle">
                    ${collapsed ? '‚ñ∂' : '‚ñº'}
                </span>
            </div>
            <div id="${groupId}" style="display: ${collapsed ? 'none' : 'block'};">
                ${tasks.map(task => renderTaskItem(task, status)).join('')}
            </div>
        </div>
    `;
}

function renderTaskItem(task, status) {
    const progressPercent = task.progress || 0;
    const sequence = task.sequence || '?';
    const executionMode = task.executionMode || 'independent';
    
    // Execution mode badge
    let modeBadge = '';
    if (executionMode === 'sequential') {
        modeBadge = '<span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">üîó Sequential</span>';
    } else if (executionMode === 'parallel') {
        modeBadge = '<span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">‚ö° Parallel</span>';
    } else {
        modeBadge = '<span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-left: 5px;">üéØ Independent</span>';
    }
    
    return `
        <div class="task-item ${status}">
            <div class="task-header">
                <div class="task-title">
                    <span style="display: inline-block; min-width: 30px; font-weight: 700; color: #3498db; font-size: 14px;">#${sequence}</span>
                    ${task.name}
                    ${modeBadge}
                </div>
                <span class="task-status-badge ${status}">
                    ${status === 'completed' ? '‚úÖ DONE' : 
                      status === 'inprogress' ? `‚è≥ ${progressPercent}%` : 
                      '‚¨ú PENDING'}
                </span>
            </div>
            
            ${task.description ? `
                <div style="font-size: 11px; color: #6c757d; margin-bottom: 8px; margin-left: 35px;">
                    ${task.description}
                </div>
            ` : ''}
            
            <div class="task-meta" style="margin-left: 35px;">
                ${task.startDate ? `
                    <div class="task-meta-item">
                        <span>üìÖ</span>
                        <span>${task.completedDate ? 
                            `${formatDateForDisplay(task.startDate)} - ${formatDateForDisplay(task.completedDate)}` : 
                            `Started: ${formatDateForDisplay(task.startDate)}`
                        }</span>
                    </div>
                ` : task.targetStart ? `
                    <div class="task-meta-item">
                        <span>üéØ</span>
                        <span>Target: ${formatDateForDisplay(task.targetStart)}${task.targetEnd ? ` - ${formatDateForDisplay(task.targetEnd)}` : ''}</span>
                    </div>
                ` : ''}
                
                ${task.duration ? `
                    <div class="task-meta-item">
                        <span>‚è±Ô∏è</span>
                        <span>${task.duration} day${task.duration > 1 ? 's' : ''}</span>
                    </div>
                ` : ''}
                
                ${task.assignedTo ? `
                    <div class="task-meta-item">
                        <span>üë§</span>
                        <span>${task.assignedTo}</span>
                    </div>
                ` : ''}
            </div>
            
            ${status === 'inprogress' && progressPercent < 100 ? `
                <div class="task-progress-bar" style="margin-left: 35px;">
                    <div class="task-progress-fill" style="width: ${progressPercent}%;"></div>
                </div>
            ` : ''}
            
            ${task.notes ? `
                <div class="task-notes" style="margin-left: 35px;">
                    üìù ${task.notes}
                </div>
            ` : ''}
            
            <div class="task-actions" style="margin-left: 35px;">
                ${status === 'pending' ? `
                    <button class="task-btn task-btn-start" onclick="startTask('${task.id}')">
                        ‚ñ∂Ô∏è Start Task
                    </button>
                ` : ''}
                
                ${status === 'inprogress' ? `
                    <button class="task-btn task-btn-complete" onclick="completeTask('${task.id}')">
                        ‚úÖ Mark Complete
                    </button>
                    <button class="task-btn task-btn-update" onclick="updateTaskProgress('${task.id}')">
                        üìä Update Progress
                    </button>
                ` : ''}
                
                <button class="task-btn task-btn-edit" onclick="editTask('${task.id}')">
                    ‚úèÔ∏è Edit
                </button>
                <button class="task-btn task-btn-delete" onclick="deleteTask('${task.id}')">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
    `;
}

function toggleTaskGroup(groupId) {
    const group = document.getElementById(groupId);
    const toggle = document.getElementById(`${groupId}-toggle`);
    
    if (group.style.display === 'none') {
        group.style.display = 'block';
        toggle.textContent = '‚ñº';
    } else {
        group.style.display = 'none';
        toggle.textContent = '‚ñ∂';
    }
}

function openTaskEditModal(taskId = null) {
    if (taskId) {
        // Edit existing task
        const tasks = onsiteTasks[currentEquipmentTasks.firebaseKey] || [];
        const task = tasks.find(t => t.id === taskId);
        
        if (!task) {
            showNotification('Task not found', 'error');
            return;
        }
        
        currentTaskEditId = taskId;
        document.getElementById('taskEditTitle').textContent = 'Edit Task';
        
        document.getElementById('taskNameInput').value = task.name || '';
        document.getElementById('taskDescInput').value = task.description || '';
        document.getElementById('taskStartInput').value = task.targetStart || '';
        document.getElementById('taskEndInput').value = task.targetEnd || '';
        document.getElementById('taskDurationInput').value = task.duration || '';
        document.getElementById('taskStatusInput').value = task.status || 'pending';
        document.getElementById('taskProgressInput').value = task.progress || 0;
// Show/hide actual date fields based on status

document.getElementById('taskNotesInput').value = task.notes || '';
document.getElementById('taskUpdatedByInput').value = task.updatedBy || '';  // ‚úÖ ADD THIS

// ‚úÖ NEW: Set sequence & execution mode
document.getElementById('taskSequenceInput').value = task.sequence || 999;
document.getElementById('taskExecutionModeInput').value = task.executionMode || 'independent';

// ‚úÖ NEW: Show/hide fields based on status
const status = task.status || 'pending';

// Actual date fields
document.getElementById('taskActualDatesGroup').style.display = 
    (status === 'inprogress' || status === 'completed') ? 'block' : 'none';
document.getElementById('taskActualEndGroup').style.display = 
    status === 'completed' ? 'block' : 'none';

// Set actual dates
document.getElementById('taskActualStartInput').value = task.startDate || '';
document.getElementById('taskActualEndInput').value = task.completedDate || '';

// Progress field
document.getElementById('taskProgressGroup').style.display = 
    status === 'inprogress' ? 'block' : 'none';
    } else {
        // Add new task
        currentTaskEditId = null;
        document.getElementById('taskEditTitle').textContent = 'Add New Task';
        
        document.getElementById('taskNameInput').value = '';
        document.getElementById('taskDescInput').value = '';
        document.getElementById('taskStartInput').value = '';
        document.getElementById('taskEndInput').value = '';
        document.getElementById('taskDurationInput').value = '';
        document.getElementById('taskStatusInput').value = 'pending';
        document.getElementById('taskProgressInput').value = 0;
        document.getElementById('taskNotesInput').value = '';
document.getElementById('taskUpdatedByInput').value = '';  // ‚úÖ ADD THIS

// ‚úÖ NEW: Auto-suggest next sequence number
const tasks = onsiteTasks[currentEquipmentTasks.firebaseKey] || [];
        const maxSeq = tasks.length > 0 ? Math.max(...tasks.map(t => t.sequence || 0)) : 0;
        document.getElementById('taskSequenceInput').value = maxSeq + 1;
        document.getElementById('taskExecutionModeInput').value = 'independent';
        
        document.getElementById('taskProgressGroup').style.display = 'none';
    }
    
    // ‚úÖ NEW: Setup execution mode event listener
    setupExecutionModeListener();
    
    // ‚úÖ NEW: Trigger initial display based on mode
    const initialMode = document.getElementById('taskExecutionModeInput').value;
    handleExecutionModeChange(initialMode);
    
    document.getElementById('taskEditModal').style.display = 'block';
// ‚úÖ Auto-calculate duration when dates change
const startInput = document.getElementById('taskStartInput');
const endInput = document.getElementById('taskEndInput');
const durationInput = document.getElementById('taskDurationInput');

function calculateDuration() {
    const start = startInput.value;
    const end = endInput.value;
    
    if (start && end) {
        const startDate = new Date(start);
        const endDate = new Date(end);
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
        
        if (days >= 0) {
            durationInput.value = days;
            durationInput.style.backgroundColor = '#e8f5e9';
        } else {
            durationInput.value = '';
            durationInput.style.backgroundColor = '#ffebee';
        }
    }
}

if (startInput && endInput) {
    startInput.addEventListener('change', calculateDuration);
    endInput.addEventListener('change', calculateDuration);
}
// Listen to status changes to show/hide date fields
document.getElementById('taskStatusInput').addEventListener('change', function() {
    const newStatus = this.value;
    const actualDatesGroup = document.getElementById('taskActualDatesGroup');
    const actualEndGroup = document.getElementById('taskActualEndGroup');
    const actualStartInput = document.getElementById('taskActualStartInput');
    const actualEndInput = document.getElementById('taskActualEndInput');
    
    if (newStatus === 'inprogress' || newStatus === 'completed') {
        actualDatesGroup.style.display = 'block';
        // Auto-fill start date if empty
        if (!actualStartInput.value) {
            actualStartInput.value = new Date().toISOString().split('T')[0];
        }
    } else {
        actualDatesGroup.style.display = 'none';
    }
    
    if (newStatus === 'completed') {
        actualEndGroup.style.display = 'block';
        // Auto-fill end date if empty
        if (!actualEndInput.value) {
            actualEndInput.value = new Date().toISOString().split('T')[0];
        }
    } else {
        actualEndGroup.style.display = 'none';
    }
});
// ‚úÖ Add visual indicators for required fields based on execution mode
document.getElementById('taskExecutionModeInput').addEventListener('change', function() {
    const mode = this.value;
    const depGroup = document.getElementById('taskDependenciesGroup');
    const parGroup = document.getElementById('taskParallelGroup');
    
    // Update labels to show required/optional
    const depLabel = document.querySelector('label[for="taskDependenciesGroup"]');
    const parLabel = document.querySelector('label[for="taskParallelGroup"]');
    
    if (mode === 'sequential' && depGroup.style.display === 'block') {
        if (depLabel) depLabel.innerHTML = 'Dependencies (must complete first): <span style="color: #e74c3c;">*Required</span>';
    } else if (mode === 'parallel' && parGroup.style.display === 'block') {
        if (parLabel) parLabel.innerHTML = 'Can run parallel with: <span style="color: #e74c3c;">*Required</span>';
    }
});
}  // ‚Üê Ini closing brace dari openTaskEditModal()




// ‚úÖ NEW: Setup event listener for execution mode
function setupExecutionModeListener() {
    const modeSelect = document.getElementById('taskExecutionModeInput');
    
    // Remove old listener if exists
    const newModeSelect = modeSelect.cloneNode(true);
    modeSelect.parentNode.replaceChild(newModeSelect, modeSelect);
    
    // Add new listener
    newModeSelect.addEventListener('change', function() {
        handleExecutionModeChange(this.value);
    });
}

// ‚úÖ NEW: Handle execution mode change
function handleExecutionModeChange(mode) {
    const depGroup = document.getElementById('taskDependenciesGroup');
    const parGroup = document.getElementById('taskParallelGroup');
    const depLabel = document.getElementById('taskDependenciesLabel');
    const parLabel = document.getElementById('taskParallelLabel');
    
    if (mode === 'sequential') {
        depGroup.style.display = 'block';
        parGroup.style.display = 'none';
        populateTaskDependencies();
        if (depLabel) depLabel.innerHTML = 'Dependencies (must complete first): <span style="color: #e74c3c; font-weight: 600;">*Required</span>';
    } else if (mode === 'parallel') {
        depGroup.style.display = 'none';
        parGroup.style.display = 'block';
        populateTaskParallel();
        if (parLabel) parLabel.innerHTML = 'Can run parallel with: <span style="color: #e74c3c; font-weight: 600;">*Required</span>';
    } else {
        depGroup.style.display = 'none';
        parGroup.style.display = 'none';
    }
}

// ‚úÖ NEW: Populate dependencies checkboxes
function populateTaskDependencies() {
    const container = document.getElementById('taskDependenciesList');
    if (!container) return;
    
    const tasks = onsiteTasks[currentEquipmentTasks.firebaseKey] || [];
    
    // Exclude current task if editing
    const availableTasks = tasks.filter(t => t.id !== currentTaskEditId);
    
    if (availableTasks.length === 0) {
        container.innerHTML = '<div style="color: #95a5a6; font-size: 12px; padding: 10px;">No other tasks available</div>';
        return;
    }
    
    // Sort by sequence
    availableTasks.sort((a, b) => (a.sequence || 999) - (b.sequence || 999));
    
    // Get current task dependencies if editing
    let currentDeps = [];
    if (currentTaskEditId) {
        const currentTask = tasks.find(t => t.id === currentTaskEditId);
        currentDeps = currentTask?.dependencies || [];
    }
    
    container.innerHTML = availableTasks.map(task => {
        const isChecked = currentDeps.includes(task.id);
        const progressIcon = task.progress === 100 ? '‚úÖ' : task.progress > 0 ? 'üîÑ' : '‚è≥';
        return `
            <label style="display: block; padding: 5px; font-size: 12px; cursor: pointer; border-radius: 4px;" 
                   onmouseover="this.style.background='#e3f2fd'" 
                   onmouseout="this.style.background='transparent'">
                <input type="checkbox" class="task-dep-checkbox" value="${task.id}" 
                       ${isChecked ? 'checked' : ''} 
                       style="margin-right: 8px; cursor: pointer;">
                ${progressIcon} ${task.sequence || '?'}. ${task.name} ${task.progress > 0 ? `(${task.progress}%)` : ''}
            </label>
        `;
    }).join('');
}

// ‚úÖ NEW: Populate parallel tasks checkboxes
function populateTaskParallel() {
    const container = document.getElementById('taskParallelTasksList');
    if (!container) return;
    
    const tasks = onsiteTasks[currentEquipmentTasks.firebaseKey] || [];
    const availableTasks = tasks.filter(t => t.id !== currentTaskEditId);
    
    if (availableTasks.length === 0) {
        container.innerHTML = '<div style="color: #95a5a6; font-size: 12px; padding: 10px;">No other tasks available</div>';
        return;
    }
    
    availableTasks.sort((a, b) => (a.sequence || 999) - (b.sequence || 999));
    
    let currentParallel = [];
    if (currentTaskEditId) {
        const currentTask = tasks.find(t => t.id === currentTaskEditId);
        currentParallel = currentTask?.parallelWith || [];
    }
    
    container.innerHTML = availableTasks.map(task => {
        const isChecked = currentParallel.includes(task.id);
        return `
            <label style="display: block; padding: 5px; font-size: 12px; cursor: pointer; border-radius: 4px;" 
                   onmouseover="this.style.background='#fff3cd'" 
                   onmouseout="this.style.background='transparent'">
                <input type="checkbox" class="task-parallel-checkbox" value="${task.id}" 
                       ${isChecked ? 'checked' : ''} 
                       style="margin-right: 8px; cursor: pointer;">
                ${task.sequence || '?'}. ${task.name}
            </label>
        `;
    }).join('');
}

function closeTaskEditModal() {
    document.getElementById('taskEditModal').style.display = 'none';
    currentTaskEditId = null;
}

function saveTask() {
    const name = document.getElementById('taskNameInput').value.trim();
    const targetStart = document.getElementById('taskStartInput').value;
    const targetEnd = document.getElementById('taskEndInput').value;
    const actualStart = document.getElementById('taskActualStartInput').value;
    const actualEnd = document.getElementById('taskActualEndInput').value;
    const executionMode = document.getElementById('taskExecutionModeInput').value;
    const description = document.getElementById('taskDescInput').value.trim();
    
    // ‚úÖ VALIDATION 1: Task name required
    if (!name) {
        showNotification('Please enter task name', 'error');
        return;
    }

// ‚úÖ VALIDATION 1B: User name required
const updatedBy = document.getElementById('taskUpdatedByInput').value.trim();
if (!updatedBy) {
    showNotification('Please enter your name in "Updated By" field', 'error');
    document.getElementById('taskUpdatedByInput').focus();
    document.getElementById('taskUpdatedByInput').style.borderColor = '#e74c3c';
    return;
}
    
    // ‚úÖ VALIDATION 2: Sequential mode must have dependencies
    if (executionMode === 'sequential') {
        const selectedDeps = document.querySelectorAll('.task-dep-checkbox:checked');
        if (selectedDeps.length === 0) {
            showNotification('Sequential mode requires at least one dependency task to be selected', 'error');
            return;
        }
    }
    
    // ‚úÖ VALIDATION 3: Parallel mode must have parallel tasks
    if (executionMode === 'parallel') {
        const selectedParallel = document.querySelectorAll('.task-parallel-checkbox:checked');
        if (selectedParallel.length === 0) {
            showNotification('Parallel mode requires at least one parallel task to be selected', 'error');
            return;
        }
    }
    
    // ‚úÖ VALIDATION 4: Target end date must be after start date
    if (targetStart && targetEnd) {
        const startDate = new Date(targetStart);
        const endDate = new Date(targetEnd);
        if (endDate < startDate) {
            showNotification('Target End Date cannot be earlier than Target Start Date', 'error');
            return;
        }
    }
    
    // ‚úÖ VALIDATION 5: Actual end date must be after actual start date
    if (actualStart && actualEnd) {
        const actStartDate = new Date(actualStart);
        const actEndDate = new Date(actualEnd);
        if (actEndDate < actStartDate) {
            showNotification('Actual Completion Date cannot be earlier than Actual Start Date', 'error');
            return;
        }
    }
    
    // ‚úÖ VALIDATION 6: Check for incomplete fields (warning, but allow save)
    const missingFields = [];
    if (!description) missingFields.push('Description');
    if (!targetStart) missingFields.push('Target Start Date');
    if (!targetEnd) missingFields.push('Target End Date');
    
    if (missingFields.length > 0) {
        const confirmSave = confirm(
            `The following fields are empty:\n- ${missingFields.join('\n- ')}\n\nDo you want to save anyway?`
        );
        if (!confirmSave) {
            return;
        }
    }
        
    // Get dependencies and parallel tasks
    const selectedDeps = Array.from(document.querySelectorAll('.task-dep-checkbox:checked')).map(cb => cb.value);
    const selectedParallel = Array.from(document.querySelectorAll('.task-parallel-checkbox:checked')).map(cb => cb.value);
    
    const taskData = {
    name: name,
    description: document.getElementById('taskDescInput').value.trim(),
    targetStart: document.getElementById('taskStartInput').value,
    targetEnd: document.getElementById('taskEndInput').value,
    duration: parseInt(document.getElementById('taskDurationInput').value) || null,
    assignedTo: currentEquipmentTasks.equipment.vendor || '',
    status: document.getElementById('taskStatusInput').value,
    progress: parseInt(document.getElementById('taskProgressInput').value) || 0,
    notes: document.getElementById('taskNotesInput').value.trim(),
    updatedBy: updatedBy,  // ‚úÖ ADD THIS
    lastTaskUpdate: new Date().toISOString(),
    sequence: parseInt(document.getElementById('taskSequenceInput').value) || 999,
    executionMode: document.getElementById('taskExecutionModeInput').value || 'independent',
    dependencies: selectedDeps,
    parallelWith: selectedParallel
};
    
    // Get actual dates from input fields (manual or auto-filled)
const actualStartInput = document.getElementById('taskActualStartInput').value;
const actualEndInput = document.getElementById('taskActualEndInput').value;

// Set actual dates based on input or auto-fill
if (taskData.status === 'inprogress' || taskData.status === 'completed') {
    // Use manual input if provided, otherwise auto-fill
    if (actualStartInput) {
        taskData.startDate = actualStartInput;
    } else if (!currentTaskEditId) {
        // Only auto-fill for NEW tasks starting
        taskData.startDate = new Date().toISOString().split('T')[0];
    }
}

if (taskData.status === 'completed') {
    // Use manual input if provided, otherwise auto-fill
    if (actualEndInput) {
        taskData.completedDate = actualEndInput;
    } else {
        taskData.completedDate = new Date().toISOString().split('T')[0];
    }
    taskData.progress = 100;
    
    // Ensure start date exists for completed tasks
    if (!taskData.startDate) {
        taskData.startDate = taskData.completedDate;
    }
}
    
    const equipmentKey = currentEquipmentTasks.firebaseKey;
    
    // Get current tasks from Firebase (fresh read)
    database.ref(`onsiteTasks/${equipmentKey}`).once('value').then(snapshot => {
        let tasks = snapshot.val() || [];
        
        if (currentTaskEditId) {
            // Update existing task
            const taskIndex = tasks.findIndex(t => t.id === currentTaskEditId);
            if (taskIndex !== -1) {
                const oldStatus = tasks[taskIndex].status;
                const newStatus = taskData.status;
                const isUndo = (oldStatus === 'completed' && newStatus !== 'completed');
                
                tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                
                if (isUndo) {
                    const hasOtherActiveTasks = tasks.some(t => 
                        (t.status === 'inprogress' || t.status === 'completed') && 
                        t.id !== currentTaskEditId
                    );
                    if (!hasOtherActiveTasks) {
                        window._resetTimestampAfterSave = equipmentKey;
                    }
                }
            }
        } else {
            // Add new task
            taskData.id = Date.now().toString();
            taskData.createdAt = new Date().toISOString();
            tasks.push(taskData);
        }
        
        // Save back to Firebase
        return database.ref(`onsiteTasks/${equipmentKey}`).set(tasks);
        
    }).then(() => {
        showNotification(currentTaskEditId ? 'Task updated successfully' : 'Task added successfully', 'success');
        
        // Update local cache
        database.ref(`onsiteTasks/${equipmentKey}`).once('value').then(snapshot => {
            onsiteTasks[equipmentKey] = snapshot.val() || [];
            closeTaskEditModal();
            renderTaskTracker();
            updateEquipmentProgress(equipmentKey);
            
            if (window._resetTimestampAfterSave === equipmentKey) {
                resetEquipmentUpdateTime(equipmentKey);
                showNotification('Task reverted. Equipment returned to original position.', 'info');
                delete window._resetTimestampAfterSave;
            }
            
            // Add to activity history
            const equipment = currentEquipmentTasks.equipment;
            const tasks = onsiteTasks[equipmentKey];
            let savedTask;
            if (currentTaskEditId) {
                savedTask = tasks.find(t => t.id === currentTaskEditId);
            } else {
                savedTask = tasks[tasks.length - 1];
            }
            
            if (savedTask) {
                activityHistoryRef.push({
                    timestamp: new Date().toISOString(),
                    type: currentTaskEditId ? 'update' : 'add',
                    category: currentTaskEditId ? 'TASK UPDATE' : 'TASK ADD',
                    title: equipment.vendor + ' - ' + equipment.equipment,
                    equipmentId: equipment.id,
                    equipment: equipment.equipment,
                    vendor: equipment.vendor,
                    description: `${currentTaskEditId ? 'Updated' : 'Added'} task: ${savedTask.name}`,
                    notes: `${savedTask.description ? savedTask.description + '\n\n' : ''}Target: ${savedTask.targetStart || 'TBD'} to ${savedTask.targetEnd || 'TBD'}${savedTask.duration ? ' (' + savedTask.duration + ' days)' : ''}\nAssigned to: ${savedTask.assignedTo || 'Unassigned'}\nStatus: ${savedTask.status} | Progress: ${savedTask.progress}%\nSequence: ${savedTask.sequence}\nMode: ${savedTask.executionMode}\n${savedTask.notes ? '\nTask Notes: ' + savedTask.notes : ''}`,
                    user: savedTask.updatedBy || 'Unknown',  // ‚úÖ USE updatedBy instead
                    icon: currentTaskEditId ? 'üìù' : '‚ûï',
                    color: currentTaskEditId ? '#17a2b8' : '#28a745'
                });
            }
        });
        
    }).catch((error) => {
        console.error('Error saving task:', error);
        showNotification('Error saving task: ' + error.message, 'error');
    });
}

function editTask(taskId) {
    openTaskEditModal(taskId);
}

function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) return;
    
    const equipmentKey = currentEquipmentTasks.firebaseKey;
    const tasks = onsiteTasks[equipmentKey] || [];
    const task = tasks.find(t => t.id === taskId);
    
    if (!task) {
        showNotification('Task not found', 'error');
        return;
    }
    
    const updatedTasks = tasks.filter(t => t.id !== taskId);
    
   database.ref(`onsiteTasks/${equipmentKey}`).set(updatedTasks).then(() => {
    showNotification('Task deleted successfully', 'success');
    renderTaskTracker();
    updateEquipmentProgress(equipmentKey);
    
    // ‚≠ê‚≠ê‚≠ê TAMBAHKAN BLOCK INI ‚≠ê‚≠ê‚≠ê
    // CEK: Apakah masih ada task aktif tersisa?
    // ‚≠ê CEK: Apakah masih ada task yang aktif (inprogress atau completed)?
const hasActiveTasks = updatedTasks.some(t => 
    t.status === 'inprogress' || t.status === 'completed'
);

if (!hasActiveTasks) {
    console.log('üîÑ No active tasks left - resetting equipment timestamp');
    resetEquipmentUpdateTime(equipmentKey);
    showNotification('Task deleted. Equipment returned to original position.', 'info');
}
    // ‚≠ê‚≠ê‚≠ê AKHIR BLOCK TAMBAHAN ‚≠ê‚≠ê‚≠ê
    
    const equipment = currentEquipmentTasks.equipment;
    const deletedTask = tasks.find(t => t.id === taskId);
    
    activityHistoryRef.push({
        timestamp: new Date().toISOString(),
        type: 'delete',
        category: 'TASK DELETE',
        title: equipment.vendor + ' - ' + equipment.equipment,
        equipmentId: equipment.id,
        equipment: equipment.equipment,
        vendor: equipment.vendor,
        description: `Deleted task: ${deletedTask ? deletedTask.name : 'Unknown Task'}`,
        notes: `${deletedTask && deletedTask.description ? deletedTask.description + '\n\n' : ''}Task was: ${deletedTask ? deletedTask.status : 'unknown'}\n${deletedTask && deletedTask.notes ? 'Notes: ' + deletedTask.notes : ''}`,
        user: deletedTask && deletedTask.assignedTo ? deletedTask.assignedTo : 'System',
        icon: 'üóëÔ∏è',
        color: '#e74c3c'
    });
    }).catch((error) => {
        showNotification('Error deleting task: ' + error.message, 'error');
    });
}

// ‚≠ê FUNGSI BARU - REVERT TASK KE PENDING
function revertTaskToPending(taskId) {
    if (!confirm('Revert this task back to pending status?')) return;
    
    const equipmentKey = currentEquipmentTasks.firebaseKey;
    const tasks = onsiteTasks[equipmentKey] || [];
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    
    if (taskIndex === -1) {
        showNotification('Task not found', 'error');
        return;
    }
    
    const oldStatus = tasks[taskIndex].status;
    tasks[taskIndex].status = 'pending';
    tasks[taskIndex].progress = 0;
    delete tasks[taskIndex].startDate;
    delete tasks[taskIndex].completedDate;
    tasks[taskIndex].lastTaskUpdate = new Date().toISOString();
    
    database.ref(`onsiteTasks/${equipmentKey}`).set(tasks).then(() => {
        showNotification('Task reverted to pending', 'success');
        renderTaskTracker();
        
        // ‚≠ê CEK APAKAH PERLU RESET TIMESTAMP
        const activeTasks = tasks.filter(t => 
            t.status === 'inprogress' || t.status === 'completed'
        );
        
        if (activeTasks.length === 0) {
            console.log('üîÑ No active tasks - resetting equipment timestamp');
            resetEquipmentUpdateTime(equipmentKey);
            showNotification('All tasks reverted. Equipment returned to original position.', 'info');
        }
        
        // Activity history
        const equipment = currentEquipmentTasks.equipment;
        activityHistoryRef.push({
            timestamp: new Date().toISOString(),
            type: 'update',
            category: 'TASK REVERT',
            title: equipment.vendor + ' - ' + equipment.equipment,
            equipmentId: equipment.id,
            equipment: equipment.equipment,
            vendor: equipment.vendor,
            description: `Reverted task to pending: ${tasks[taskIndex].name}`,
            notes: `Task was ${oldStatus}, now pending`,
            user: 'System',
            icon: '‚Ü©Ô∏è',
            color: '#f39c12'
        });
    }).catch((error) => {
        showNotification('Error reverting task: ' + error.message, 'error');
    });
}

// Make globally accessible
window.revertTaskToPending = revertTaskToPending;

function startTask(taskId) {
    const equipmentKey = currentEquipmentTasks.firebaseKey;
    const tasks = onsiteTasks[equipmentKey] || [];
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    
    if (taskIndex === -1) {
        showNotification('Task not found', 'error');
        return;
    }
    
    tasks[taskIndex].status = 'inprogress';
    tasks[taskIndex].startDate = new Date().toISOString().split('T')[0];
    tasks[taskIndex].progress = 0;
    tasks[taskIndex].lastTaskUpdate = new Date().toISOString(); // ‚≠ê TIMESTAMP
    
    database.ref(`onsiteTasks/${equipmentKey}`).set(tasks).then(() => {
        showNotification('Task started', 'success');
        renderTaskTracker();
        
        // Add to activity history
        const equipment = currentEquipmentTasks.equipment;
        const startedTask = tasks[taskIndex];
        
        activityHistoryRef.push({
            timestamp: new Date().toISOString(),
            type: 'update',
            category: 'TASK START',
            title: equipment.vendor + ' - ' + equipment.equipment,
            equipmentId: equipment.id,
            equipment: equipment.equipment,
            vendor: equipment.vendor,
            description: `Started task: ${startedTask.name}`,
            notes: `${startedTask.description ? startedTask.description + '\n\n' : ''}Target: ${startedTask.targetStart} to ${startedTask.targetEnd} (${startedTask.duration} days)\nAssigned to: ${startedTask.assignedTo || 'Unassigned'}`,
            user: startedTask.assignedTo || 'System',
            icon: '‚ñ∂Ô∏è',
            color: '#3498db'
        });
    }).catch((error) => {
        showNotification('Error starting task: ' + error.message, 'error');
    });
}

function completeTask(taskId) {
    const equipmentKey = currentEquipmentTasks.firebaseKey;
    const tasks = onsiteTasks[equipmentKey] || [];
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    
    if (taskIndex === -1) {
        showNotification('Task not found', 'error');
        return;
    }
    
   tasks[taskIndex].status = 'completed';
    tasks[taskIndex].completedDate = new Date().toISOString().split('T')[0];
    tasks[taskIndex].progress = 100;
    tasks[taskIndex].lastTaskUpdate = new Date().toISOString(); // ‚≠ê TIMESTAMP
    
    database.ref(`onsiteTasks/${equipmentKey}`).set(tasks).then(() => {
        showNotification('Task completed! üéâ', 'success');
        renderTaskTracker();
// Update equipment progress based on completed tasks
        updateEquipmentProgress(equipmentKey);  // ‚Üê TAMBAHKAN BARIS INI
        
        // Add to activity history
        const equipment = currentEquipmentTasks.equipment;
        const completedTask = tasks[taskIndex];
        
        activityHistoryRef.push({
            timestamp: new Date().toISOString(),
            type: 'update',
            category: 'TASK COMPLETE',
            title: equipment.vendor + ' - ' + equipment.equipment,
            equipmentId: equipment.id,
            equipment: equipment.equipment,
            vendor: equipment.vendor,
            description: `Completed task: ${completedTask.name}`,
            notes: `${completedTask.description ? completedTask.description + '\n\n' : ''}Task completed successfully.\n${completedTask.notes ? '\nTask Notes: ' + completedTask.notes : ''}`,
            user: completedTask.assignedTo || prompt('Enter your name:') || 'Anonymous',
            icon: '‚úÖ',
            color: '#28a745'
        });
    }).catch((error) => {
        showNotification('Error completing task: ' + error.message, 'error');
    });
}

function updateTaskProgress(taskId) {
    const equipmentKey = currentEquipmentTasks.firebaseKey;
    const tasks = onsiteTasks[equipmentKey] || [];
    const taskIndex = tasks.findIndex(t => t.id === taskId);
    
    if (taskIndex === -1) {
        showNotification('Task not found', 'error');
        return;
    }
    
    const currentProgress = tasks[taskIndex].progress || 0;
    const newProgress = prompt(`Update progress for "${tasks[taskIndex].name}"\nCurrent: ${currentProgress}%\n\nEnter new progress (0-100):`, currentProgress);
    
    if (newProgress === null) return; // User cancelled
    
    const progress = parseInt(newProgress);
    
    if (isNaN(progress) || progress < 0 || progress > 100) {
        showNotification('Please enter a valid progress (0-100)', 'error');
        return;
    }
    
   tasks[taskIndex].progress = progress;
    tasks[taskIndex].lastTaskUpdate = new Date().toISOString(); // ‚≠ê TIMESTAMP
    
    // If 100%, mark as completed
    if (progress === 100) {
        tasks[taskIndex].status = 'completed';
        tasks[taskIndex].completedDate = new Date().toISOString().split('T')[0];
    }
    
    database.ref(`onsiteTasks/${equipmentKey}`).set(tasks).then(() => {
        showNotification('Progress updated to ' + progress + '%', 'success');
        renderTaskTracker();
renderTaskTracker();
        updateEquipmentProgress(equipmentKey);  // ‚Üê TAMBAHKAN
        
        // Add to activity history
        
        // Add to activity history
        const equipment = currentEquipmentTasks.equipment;
        const updatedTask = tasks[taskIndex];
        
        activityHistoryRef.push({
            timestamp: new Date().toISOString(),
            type: 'update',
            category: 'TASK PROGRESS',
            title: equipment.vendor + ' - ' + equipment.equipment,
            equipmentId: equipment.id,
            equipment: equipment.equipment,
            vendor: equipment.vendor,
            description: `Updated task progress: ${updatedTask.name}`,
            notes: `Progress: ${progress}%\n${updatedTask.description ? '\nTask: ' + updatedTask.description : ''}\n${updatedTask.notes ? '\nNotes: ' + updatedTask.notes : ''}`,
            user: updatedTask.assignedTo || 'System',
            icon: 'üìä',
            color: '#f39c12'
        });
    }).catch((error) => {
        showNotification('Error updating progress: ' + error.message, 'error');
    });
}



// ===== UPDATE EQUIPMENT PROGRESS BASED ON TASKS =====

function updateEquipmentProgress(equipmentKey) {
    const tasks = onsiteTasks[equipmentKey] || [];
    
    if (tasks.length === 0) return;
    
    // ‚úÖ Calculate WEIGHTED overall progress
    const overallProgress = calculateWeightedProgress(tasks);
    
    // ‚≠ê‚≠ê‚≠ê CRITICAL: Update lastUpdated timestamp ‚≠ê‚≠ê‚≠ê
    const updateData = {
        progress: overallProgress,
        lastUpdated: new Date().toISOString()
    };
    
    // Update equipment progress AND lastUpdated in Firebase
    database.ref(`projectData/${equipmentKey}`).update(updateData).then(() => {
        console.log('‚úÖ Equipment progress updated (WEIGHTED):', overallProgress + '%');
        console.log('‚úÖ lastUpdated timestamp set:', updateData.lastUpdated);
        
        // ‚≠ê Update local data immediately
        const equipmentIndex = projectData.findIndex(p => p.firebaseKey === equipmentKey);
        if (equipmentIndex !== -1) {
            projectData[equipmentIndex].progress = overallProgress;
            projectData[equipmentIndex].lastUpdated = updateData.lastUpdated;
            console.log('‚úÖ Local data updated for:', projectData[equipmentIndex].equipment);
        }
        
        // ‚≠ê Force re-populate table to trigger auto-sort
        // ‚ö†Ô∏è JANGAN panggil populateTable() di sini!
        // Biarkan Firebase listener yang handle re-render
        // Ini memastikan semua device sync dengan benar
        console.log('‚è≥ Waiting for Firebase listener to re-render table...');
        
        // Log to activity history
        const equipment = projectData.find(p => p.firebaseKey === equipmentKey);
        if (equipment) {
            // Calculate task breakdown for history log
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'completed').length;
            const inProgressTasks = tasks.filter(t => t.status === 'in-progress').length;
            const avgInProgressPercent = inProgressTasks > 0 ? 
                Math.round(tasks.filter(t => t.status === 'in-progress').reduce((sum, t) => sum + (t.progress || 0), 0) / inProgressTasks) : 0;
            
            activityHistoryRef.push({
                timestamp: new Date().toISOString(),
                type: 'update',
                category: 'PROGRESS UPDATE',
                title: equipment.vendor + ' - ' + equipment.equipment,
                equipmentId: equipment.id,
                equipment: equipment.equipment,
                vendor: equipment.vendor,
                description: `Weighted progress updated based on task completion and in-progress status`,
                notes: `Overall: ${overallProgress}% | Completed: ${completedTasks}/${totalTasks} | In Progress: ${inProgressTasks} tasks (avg ${avgInProgressPercent}%)`,
                user: 'System Auto-Update',
                icon: 'üìä',
                color: '#17a2b8'
            });
        }
    }).catch((error) => {
        console.error('‚ùå Error updating equipment progress:', error);
    });
}

// ===== RENDER TASK COMPLETION HISTORY =====
// ===== RESET EQUIPMENT UPDATE TIMESTAMP =====
function resetEquipmentUpdateTime(equipmentKey) {
    // Reset lastUpdated ke null (item kembali ke posisi original)
    database.ref(`projectData/${equipmentKey}/lastUpdated`).remove().then(() => {
        console.log('üîÑ Equipment update time reset, item will return to original position');
        
        // ‚≠ê Update local data IMMEDIATELY
        const equipmentIndex = projectData.findIndex(p => p.firebaseKey === equipmentKey);
        if (equipmentIndex !== -1) {
            delete projectData[equipmentIndex].lastUpdated;
            console.log('‚úÖ Local data updated:', projectData[equipmentIndex].equipment);
        }
        
        // ‚≠ê‚≠ê‚≠ê FORCE RE-RENDER TABLE IMMEDIATELY ‚≠ê‚≠ê‚≠ê
        populateTable();
        console.log('‚úÖ Table re-rendered - item moved to original position');
        
        // Firebase listener akan sync untuk device lain
    }).catch((error) => {
        console.error('‚ùå Error resetting update time:', error);
    });
}

// Make it globally accessible
window.resetEquipmentUpdateTime = resetEquipmentUpdateTime;

function renderTaskCompletionHistory(equipmentKey) {
    const tasks = onsiteTasks[equipmentKey] || [];
    
    if (tasks.length === 0) {
        return '<p style="color: #7f8c8d; font-style: italic;">No tasks recorded yet.</p>';
    }
    
    const completedTasks = tasks.filter(t => t.status === 'completed').sort((a, b) => {
        return new Date(b.completedDate) - new Date(a.completedDate);
    });
    
    const inProgressTasks = tasks.filter(t => t.status === 'inprogress');
    const pendingTasks = tasks.filter(t => t.status === 'pending');
    
    let html = `
        <div style="margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                <div style="background: #d4edda; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">${completedTasks.length}</div>
                    <div style="font-size: 12px; color: #155724;">Completed</div>
                </div>
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${inProgressTasks.length}</div>
                    <div style="font-size: 12px; color: #856404;">In Progress</div>
                </div>
                <div style="background: #d1ecf1; padding: 15px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #0c5460;">${pendingTasks.length}</div>
                    <div style="font-size: 12px; color: #0c5460;">Pending</div>
                </div>
            </div>
        </div>
    `;
    
    if (completedTasks.length > 0) {
        html += '<h4 style="margin: 15px 0 10px 0; color: #28a745; font-size: 14px;">‚úÖ Completed Tasks:</h4>';
        completedTasks.forEach(task => {
            const startDate = task.startDate ? formatDateForDisplay(task.startDate) : 'N/A';
            const endDate = task.completedDate ? formatDateForDisplay(task.completedDate) : 'N/A';
            const duration = task.duration || 'N/A';
            
            html += `
    <div style="padding: 12px; margin-bottom: 10px; background: #f8fff9; border-left: 4px solid #28a745; border-radius: 4px;">
        <div style="font-weight: bold; font-size: 13px; color: #2c3e50; margin-bottom: 5px;">
            ‚úÖ ${task.name}
        </div>
        <div style="font-size: 11px; color: #6c757d; line-height: 1.5;">
            ${task.description ? `<div>${task.description}</div>` : ''}
            <div><strong>Duration:</strong> ${duration} days | <strong>Period:</strong> ${startDate} - ${endDate}</div>
            ${task.assignedTo ? `<div><strong>By:</strong> ${task.assignedTo}</div>` : ''}
            ${task.notes ? `<div style="background: white; padding: 6px; border-radius: 3px; margin-top: 5px;"><strong>Notes:</strong> ${task.notes}</div>` : ''}
        </div>
    </div>
`;
        });
    }
    
    if (inProgressTasks.length > 0) {
        html += '<h4 style="margin: 15px 0 10px 0; color: #ffc107; font-size: 14px;">‚è≥ In Progress:</h4>';
        inProgressTasks.forEach(task => {
            html += `
                <div style="padding: 12px; margin-bottom: 10px; background: #fffef8; border-left: 4px solid #ffc107; border-radius: 4px;">
                    <div style="font-weight: bold; font-size: 13px; color: #2c3e50; margin-bottom: 5px;">
                        ‚è≥ ${task.name} - ${task.progress || 0}%
                    </div>
                    <div style="font-size: 11px; color: #6c757d;">
                        ${task.assignedTo ? `<strong>By:</strong> ${task.assignedTo}` : ''}
                    </div>
                    <div style="width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; margin-top: 5px;">
                        <div style="width: ${task.progress || 0}%; height: 100%; background: #ffc107; border-radius: 3px;"></div>
                    </div>
                </div>
            `;
        });
    }
    
    if (pendingTasks.length > 0) {
        html += '<h4 style="margin: 15px 0 10px 0; color: #6c757d; font-size: 14px;">‚¨ú Pending:</h4>';
        pendingTasks.forEach(task => {
            html += `
                <div style="padding: 12px; margin-bottom: 10px; background: #f8f9fa; border-left: 4px solid #6c757d; border-radius: 4px;">
                    <div style="font-weight: bold; font-size: 13px; color: #2c3e50; margin-bottom: 5px;">
                        ‚¨ú ${task.name}
                    </div>
                    <div style="font-size: 11px; color: #6c757d;">
                        ${task.targetStart ? `<strong>Target:</strong> ${formatDateForDisplay(task.targetStart)}` : ''}
                        ${task.assignedTo ? ` | <strong>Assigned:</strong> ${task.assignedTo}` : ''}
                    </div>
                </div>
            `;
        });
    }
    
    return html;
}

// ===== DROPDOWN FUNCTIONS =====

// ===== DROPDOWN FUNCTIONS (Event Delegation) =====

function initDropdowns() {
    document.body.addEventListener('click', function(e) {
        let target = e.target;
        
        for (let i = 0; i < 3; i++) {
            if (target && target.classList && target.classList.contains('dropdown-item')) {
                
                // Skip VM task dropdowns
                if (target.closest('.task-dropdown-menu')) {
                    console.log('üîµ VM task dropdown - handled by own onclick');
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                
                const action = target.getAttribute('data-action');
                const key = target.getAttribute('data-key');
                
                console.log('‚úÖ Main table dropdown clicked:', action, key);
                
                // Close dropdown first
                closeAllDropdowns();
                
                // Handle actions with delay
                if (action && key) {
                    setTimeout(() => {
                        switch(action) {
                            case 'tasks':
                                console.log('üìã Opening Onsite Tasks for:', key);
                                if (typeof openTaskTracker === 'function') {
                                    openTaskTracker(key);
                                }
                                break;
                                
                            case 'progress':
                                console.log('üìÑ Opening Progress Report from Actions for key:', key);
                                // ‚úÖ Use existing function!
                                if (typeof showProgressReportById === 'function') {
                                    showProgressReportById(key);
                                } else {
                                    console.error('‚ùå showProgressReportById not available');
                                }
                                break;
                                
                            case 'edit':
                                console.log('‚úèÔ∏è Opening Edit Modal for:', key);
                                if (typeof openUpdateModal === 'function') {
                                    openUpdateModal(key);
                                }
                                break;
                                
                            case 'delete':
                                console.log('üóëÔ∏è Deleting:', key);
                                if (typeof deleteTask === 'function') {
                                    deleteTask(key);
                                }
                                break;
                                
                            default:
                                console.warn('‚ö†Ô∏è Unknown action:', action);
                        }
                    }, 150);
                }
                
                break;
            }
            
            target = target.parentElement;
            if (!target) break;
        }
    });
}

function handleDropdownScroll() {
    closeAllDropdowns();
}

function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    if (!dropdown) return;
    
    const isVisible = dropdown.style.display === 'block';
    
    // Close all dropdowns first
    closeAllDropdowns();
    
    if (!isVisible) {
        // Get button position
        const button = dropdown.previousElementSibling;
        const rect = button.getBoundingClientRect();
        
        // Position dropdown below button with FIXED positioning
        dropdown.style.display = 'block';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.left = rect.left + 'px';
        
        // Mark button as active
        button.classList.add('active');
        
        // Create backdrop
        createDropdownBackdrop();
    }
}

function closeAllDropdowns() {
    document.querySelectorAll('.action-dropdown').forEach(dropdown => {
        dropdown.style.display = 'none';
    });
    
    // Remove active state from buttons
    document.querySelectorAll('.dropdown-trigger').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Remove backdrop
    removeDropdownBackdrop();
}

function createDropdownBackdrop() {
    // DISABLE BACKDROP - it was blocking clicks!
    // Just log, don't create anything
    console.log('Backdrop disabled to prevent blocking clicks');
}

function removeDropdownBackdrop() {
    const backdrop = document.querySelector('.dropdown-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
}
    

    // ===== EXPORT =====
    function exportToPDF() {
        const printWindow = window.open('', '_blank');
        const currentDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let filteredData = currentFilter === 'all' ? projectData : projectData.filter(item => item.priority === currentFilter);
        
       const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Vendor Mobilization Report</title>
        <style>
            body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                font-size: 12px; 
                background: white; 
                color: #333; 
            }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                    .header h1 { margin: 0; font-size: 24px; color: #333; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #333; padding: 8px; text-align: left; font-size: 10px; }
                    th { background: #2c3e50; color: white; }
                    tr:nth-child(even) { background: #f9f9f9; }
                    .ontime { color: #27ae60; font-weight: bold; }
                    .delayed { color: #e74c3c; font-weight: bold; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Vendor Mobilization Report</h1>
                    <p>Generated on: ${currentDate}</p>
                    <p>Filter: ${currentFilter === 'all' ? 'All Tasks' : currentFilter + ' Priority'}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Priority</th>
                            <th>Equipment</th>
                            <th>Vendor</th>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Target MOB Date</th>
                            <th>MOB Date</th>
                            <th>Date Status</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map(item => {
                            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
                            return `
                            <tr>
                                <td>${item.no}</td>
                                <td>${item.priority}</td>
                                <td>${item.equipment}</td>
                                <td>${item.vendor}</td>
                                <td class="wrap-text">${item.task}</td>
                                <td>${item.status}</td>

<td>${item.targetDate ? formatDateForDisplay(item.targetDate) : '-'}</td>
                                    <td>${item.mobDate}</td>
                                    <td class="${dateStatus.status === 'ON TIME' ? 'ontime' : 'delayed'}">${dateStatus.status}</td>
                                    <td>${item.progress}%</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #666;">
    <p>Vendor Mobilization Tracking System</p>
    <p>Report contains ${filteredData.length} tasks</p>
</div>

<div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #333; text-align: center;">
    <p style="margin: 0; font-size: 11px; font-weight: bold;">Developed by TS-KPB</p>
    <p style="margin: 5px 0 0 0; font-size: 9px; color: #999;">¬© 2025 All Rights Reserved</p>
</div>

                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }

        // ===== NOTIFICATION =====
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
// ===== AUTO-SORT TOGGLE FUNCTION =====
        function toggleAutoSort(enabled) {
            autoSortEnabled = enabled;
            const status = enabled ? 'enabled ‚úÖ' : 'disabled ‚ùå';
            showNotification(`üîÑ Auto-sort ${status}`, 'success');
            
            // Re-populate table with new sort setting
            populateTable();
            
            // Update localStorage to remember setting
            localStorage.setItem('autoSortEnabled', enabled);
        }
        
        // Load saved setting on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedSortSetting = localStorage.getItem('autoSortEnabled');
            if (savedSortSetting !== null) {
                autoSortEnabled = savedSortSetting === 'true';
                const checkbox = document.getElementById('sortToggle');
                if (checkbox) {
                    checkbox.checked = autoSortEnabled;
                }
            }
        });
        // Make functions globally accessible
        window.openUpdateModal = openUpdateModal;
        window.deleteItem = deleteItem;
window.filterByStatus = filterByStatus;
window.openGanttModal = openGanttModal;
window.closeGanttModal = closeGanttModal;
window.changeGanttView = changeGanttView;
window.exportGanttPDF = exportGanttPDF;
window.exportGanttPDFSafe = exportGanttPDFSafe; // ADD THIS LINE
window.applyGanttColors = applyGanttColors;
window.jumpToGanttDate = jumpToGanttDate;
window.filterGanttChart = filterGanttChart;
window.searchGanttChart = searchGanttChart;
window.clearGanttSearch = clearGanttSearch;
window.filterGanttByDateRange = filterGanttByDateRange;
window.showMitigationTooltip = showMitigationTooltip; // Add this
window.attachGanttHoverEvents = attachGanttHoverEvents; // Add this
window.enhanceGanttHeader = enhanceGanttHeader; // ADD THIS LINE
window.applyReportFilter = applyReportFilter;
window.clearReportFilter = clearReportFilter;
window.changeReportPage = changeReportPage;
window.goToReportPage = goToReportPage;
function exportGanttImage() {
    if (!ganttInstance) {
        showNotification('Please open Gantt chart first', 'error');
        return;
    }
    
    showNotification('Exporting Gantt chart as image...', 'success');
    
    // Use html2canvas or similar library
    // For now, just use print dialog
    exportGanttPDF();
}
window.clearAllFilters = clearAllFilters;
	window.deleteHistory = deleteHistory;
        window.closeHistoryModal = closeHistoryModal;
        window.toggleHistorySelection = toggleHistorySelection;
        window.selectAllHistory = selectAllHistory;
        window.deleteSelectedHistory = deleteSelectedHistory;
        window.exportHistoryPDF = exportHistoryPDF;
        window.changeHistoryPage = changeHistoryPage;
        window.goToHistoryPage = goToHistoryPage;
        window.showProgressReport = showProgressReport;
window.showProgressReportById = showProgressReportById;
        window.closeProgressReport = closeProgressReport;
        window.exportProgressReportPDF = exportProgressReportPDF;
// Task Tracker Global Functions
window.openTaskTracker = openTaskTracker;
window.closeTaskTracker = closeTaskTracker;
window.toggleTaskGroup = toggleTaskGroup;
window.openTaskEditModal = openTaskEditModal;
window.closeTaskEditModal = closeTaskEditModal;
window.saveTask = saveTask;
window.editTask = editTask;
window.deleteTask = deleteTask;
window.startTask = startTask;
window.completeTask = completeTask;
window.updateTaskProgress = updateTaskProgress;
window.revertTaskToPending = revertTaskToPending; // ‚≠ê TAMBAH INI
window.openProgressReportModal = openProgressReportModal;
// Dropdown Global Functions
window.initDropdowns = initDropdowns;
window.toggleDropdown = toggleDropdown;
window.closeAllDropdowns = closeAllDropdowns;
window.updateEquipmentProgress = updateEquipmentProgress;
// Task History Render
window.renderTaskCompletionHistory = renderTaskCompletionHistory;
window.toggleDropdown = toggleDropdown;
window.closeAllDropdowns = closeAllDropdowns;
        window.exportToPDF = exportToPDF;
        window.closeModal = closeModal;
        window.filterByIssueType = filterByIssueType;
        window.clearIssueFilter = clearIssueFilter;
        window.filterEquipmentHistory = filterEquipmentHistory;
        window.saveUpdate = saveUpdate;
	window.changeTablePage = changeTablePage;
        window.goToTablePage = goToTablePage;
// Make functions globally accessible
window.toggleDropdown = toggleDropdown;
window.closeAllDropdowns = closeAllDropdowns;
window.createDropdownBackdrop = createDropdownBackdrop;
window.removeDropdownBackdrop = removeDropdownBackdrop;


let currentEquipmentGroups = [];

function toggleGroupedView() {
    console.log('üü£ BEFORE toggle, window.isGroupedView:', window.isGroupedView);
    window.isGroupedView = !window.isGroupedView;
    console.log('üü£ AFTER toggle, window.isGroupedView:', window.isGroupedView);
    
    const btn = document.getElementById('groupViewBtn');
    
    if (window.isGroupedView) {
        // === ENTERING GROUP MODE ===
        console.log('üü¢ Entering Group Mode');
        
        btn.style.background = '#27ae60';
        btn.innerHTML = 'üìã Normal View';
        currentTablePage = 1;
        
        // IMPORTANT: Add class to body
        document.body.classList.add('in-group-mode');
        
        // Force hide pagination immediately
        const paginationHTML = `
            <style id="temp-hide-pagination">
                .pagination-controls, 
                .pagination-info, 
                #tablePagination,
                [class*="pagination"],
                button[onclick*="changeTablePage"],
                button[onclick*="goToTablePage"] {
                    display: none !important;
                    visibility: hidden !important;
                }
            </style>
        `;
        
        // Add temporary style to head
        if (!document.getElementById('temp-hide-pagination')) {
            document.head.insertAdjacentHTML('beforeend', paginationHTML);
        }
        
        // Hide pagination controls
        const paginationControls = document.querySelector('.pagination-controls');
        const paginationInfo = document.querySelector('.pagination-info');
        
        if (paginationControls) paginationControls.style.display = 'none';
        if (paginationInfo) paginationInfo.style.display = 'none';
        
        renderGroupedView();
        
    } else {
        // === RETURNING TO NORMAL MODE ===
        console.log('Entering Normal Mode');
        
        btn.style.background = '#e67e22';
        btn.innerHTML = 'üîß Group Equipment';
        currentTablePage = 1;
        
        // IMPORTANT: Remove class from body
        document.body.classList.remove('in-group-mode');
        
        // Remove temporary style
        const tempStyle = document.getElementById('temp-hide-pagination');
        if (tempStyle) tempStyle.remove();
        
        // Show pagination controls
        setTimeout(() => {
            const paginationControls = document.querySelector('.pagination-controls');
            const paginationInfo = document.querySelector('.pagination-info');
            
            if (paginationControls) {
                paginationControls.style.display = '';
                paginationControls.style.visibility = '';
            }
            if (paginationInfo) {
                paginationInfo.style.display = '';
                paginationInfo.style.visibility = '';
            }
        }, 100);
        
        populateTable();
        
        setTimeout(() => {
            updateGroupTableHeader();
        }, 50);
    }
}

function renderGroupedView() {
    console.log('üü¢ renderGroupedView() CALLED');
    console.log('üü¢ Setting window.window.isGroupedView = true');

// Add class to body for CSS targeting
    document.body.classList.add('grouped-view-active');

// Force hide pagination IMMEDIATELY
    const paginationDiv = document.getElementById('pagination');
    if (paginationDiv) {
        paginationDiv.style.display = 'none';
    }
    
    // Set flag untuk track current view
    window.isGroupedView = true;
    console.log('üü¢ window.window.isGroupedView is now:', window.window.isGroupedView);

    // Group tasks by equipment
    const equipmentMap = new Map();
    
    projectData.forEach(task => {
        const key = task.equipment;
        if (!equipmentMap.has(key)) {
            equipmentMap.set(key, {
                equipment: task.equipment,
                vendor: task.vendor,
                priority: task.priority,
                tasks: []
            });
        }
        equipmentMap.get(key).tasks.push(task);
    });
    
    // Calculate progress for each group
    equipmentMap.forEach((group) => {
        // ‚úÖ Calculate weighted progress for onsite tasks
const onsiteTasksForGroup = onsiteTasks[group.tasks[0]?.firebaseKey] || [];
if (onsiteTasksForGroup.length > 0) {
    group.overallProgress = calculateWeightedProgress(onsiteTasksForGroup);
} else {
    // Fallback to main task progress if no onsite tasks
    const total = group.tasks.reduce((sum, t) => {
        let progress = 0;
        if (t.progress) {
            progress = typeof t.progress === 'string' ? 
                       parseInt(t.progress.replace('%', '')) : 
                       parseInt(t.progress);
        }
        return sum + (progress || 0);
    }, 0);
    group.overallProgress = group.tasks.length > 0 ? Math.round(total / group.tasks.length) : 0;
}
        
        // Phase breakdown
        group.phases = {};
        group.tasks.forEach(t => {
            const disc = t.disc || 'OTHER';
            if (!group.phases[disc]) {
                group.phases[disc] = { count: 0, progress: 0 };
            }// Calculate overall progress
            group.phases[disc].count++;
            let taskProgress = 0;
if (t.progress) {
    taskProgress = typeof t.progress === 'string' ? 
                   parseInt(t.progress.replace('%', '')) : 
                   parseInt(t.progress);
}
group.phases[disc].progress += (taskProgress || 0);
        });
        
        // Calculate phase status
Object.keys(group.phases).forEach(disc => {
    const p = group.phases[disc];
    p.avgProgress = Math.round(p.progress / p.count);
    p.status = p.avgProgress === 100 ? 'complete' : 
               p.avgProgress > 0 ? 'ongoing' : 'pending';
});

// ‚úÖ RECALCULATE overall progress as average of all phases
const phaseProgresses = Object.values(group.phases).map(p => p.avgProgress);
if (phaseProgresses.length > 0) {
    group.overallProgress = Math.round(phaseProgresses.reduce((sum, p) => sum + p, 0) / phaseProgresses.length);
}
    });
    
    currentEquipmentGroups = Array.from(equipmentMap.values());
// ‚úÖ SORT groups by latest update (auto-sort feature)
if (autoSortEnabled) {
    currentEquipmentGroups.sort((a, b) => {
        // Find most recent update in each group
        const latestA = Math.max(...a.tasks.map(t => new Date(t.lastUpdated || 0).getTime()));
        const latestB = Math.max(...b.tasks.map(t => new Date(t.lastUpdated || 0).getTime()));
        return latestB - latestA; // Descending (newest first)
    });
}

// ‚úÖ TAMBAHKAN FILTERING BERDASARKAN SEARCH
// ‚úÖ FILTERING BERDASARKAN PRIORITY - FILTER TASKS DALAM GROUP
let filteredGroups = currentEquipmentGroups;

// Filter tasks within each group based on priority
if (currentFilter !== 'all' && currentFilter !== 'highlighted') {
    filteredGroups = currentEquipmentGroups.map(group => {
        const filteredTasks = group.tasks.filter(task => task.priority === currentFilter);
        
        if (filteredTasks.length === 0) return null;
        
        // ‚úÖ Recalculate weighted progress for filtered tasks
const onsiteTasksForGroup = onsiteTasks[filteredTasks[0]?.firebaseKey] || [];
const newProgress = onsiteTasksForGroup.length > 0 ? 
                    calculateWeightedProgress(onsiteTasksForGroup) : 
                    Math.round(filteredTasks.reduce((sum, t) => sum + (t.progress || 0), 0) / filteredTasks.length);
        
        // ‚úÖ RECALCULATE PHASES berdasarkan filteredTasks
        const newPhases = {};
        filteredTasks.forEach(t => {
            const disc = t.disc || 'OTHER';
            if (!newPhases[disc]) {
                newPhases[disc] = { count: 0, progress: 0 };
            }
            newPhases[disc].count++;
            newPhases[disc].progress += (t.progress || 0);
        });
        
        // Calculate phase status
Object.keys(group.phases).forEach(disc => {
    const p = group.phases[disc];
    p.avgProgress = Math.round(p.progress / p.count);
    p.status = p.avgProgress === 100 ? 'complete' : 
               p.avgProgress > 0 ? 'ongoing' : 'pending';
});

// ‚úÖ RECALCULATE overall progress as average of all phases
const phaseProgresses = Object.values(group.phases).map(p => p.avgProgress);
if (phaseProgresses.length > 0) {
    group.overallProgress = Math.round(phaseProgresses.reduce((sum, p) => sum + p, 0) / phaseProgresses.length);
}
        
        return {
            equipment: filteredTasks[0].equipment,
            vendor: filteredTasks[0].vendor,
            priority: filteredTasks[0].priority,
            tasks: filteredTasks,
            overallProgress: newProgress,
            phases: newPhases  // ‚úÖ GUNAKAN phases yang baru di-recalculate
        };
    }).filter(group => group !== null);
}

// ‚úÖ TAMBAHKAN INI DI BAWAH - Filter by highlighted/critical
if (currentFilter === 'highlighted') {
    filteredGroups = currentEquipmentGroups.map(group => {
        const filteredTasks = group.tasks.filter(task => task.highlighted);
        
        if (filteredTasks.length === 0) return null;
        
        // ‚úÖ Recalculate weighted progress for filtered tasks
const onsiteTasksForGroup = onsiteTasks[filteredTasks[0]?.firebaseKey] || [];
const newProgress = onsiteTasksForGroup.length > 0 ? 
                    calculateWeightedProgress(onsiteTasksForGroup) : 
                    Math.round(filteredTasks.reduce((sum, t) => sum + (t.progress || 0), 0) / filteredTasks.length);
        
        // Recalculate phases
        const newPhases = {};
        filteredTasks.forEach(t => {
            const disc = t.disc || 'OTHER';
            if (!newPhases[disc]) {
                newPhases[disc] = { count: 0, progress: 0 };
            }
            newPhases[disc].count++;
            newPhases[disc].progress += (t.progress || 0);
        });
        
        Object.keys(newPhases).forEach(disc => {
            const p = newPhases[disc];
            p.avgProgress = Math.round(p.progress / p.count);
            p.status = p.avgProgress === 100 ? 'complete' : 
                       p.avgProgress > 0 ? 'ongoing' : 'pending';
        });
        
        return {
            equipment: filteredTasks[0].equipment,
            vendor: filteredTasks[0].vendor,
            priority: filteredTasks[0].priority,
            tasks: filteredTasks,
            overallProgress: newProgress,
            phases: newPhases
        };
    }).filter(group => group !== null);
}

// Filter by search term
const searchBox = document.getElementById('searchBox');
if (searchBox && searchBox.value.trim() !== '') {
    const searchTerm = searchBox.value.trim().toLowerCase();
    filteredGroups = filteredGroups.filter(group => {
        return (
            group.equipment.toLowerCase().includes(searchTerm) ||
            group.vendor.toLowerCase().includes(searchTerm)
        );
    });
}

// Show "no results" message if nothing found
if (filteredGroups.length === 0) {
    const tableBody = document.getElementById('tableBody');
    
    let message = '';
    const searchTerm = searchBox ? searchBox.value.trim() : '';
    
    if (searchTerm !== '') {
        // Search tidak ada hasil
        message = `No equipment match "<strong>${searchTerm}</strong>"`;
    } else if (currentFilter !== 'all') {
        // Filter priority tidak ada hasil
        message = `No equipment with priority "<strong>${currentFilter}</strong>"`;
    } else {
        // Tidak ada data sama sekali
        message = 'No equipment data available';
    }
    
    tableBody.innerHTML = `
        <tr>
            <td colspan="5" style="text-align: center; padding: 60px 20px; color: #95a5a6;">
                <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px; color: #7f8c8d;">No results found</div>
                <div style="font-size: 14px; color: #95a5a6;">${message}</div>
                <div style="font-size: 13px; color: #bdc3c7; margin-top: 10px;">Try different keywords or clear the filter</div>
            </td>
        </tr>
    `;
    
    // Set header for empty state
    setTimeout(() => updateGroupTableHeader(), 50);
    return;
}

// ‚úÖ Store filteredGroups in global variable so toggleGroup can access it
window.currentFilteredGroups = filteredGroups;

// Render
const tableBody = document.getElementById('tableBody');
tableBody.innerHTML = '';


// ‚úÖ GANTI currentEquipmentGroups DENGAN filteredGroups
filteredGroups.forEach((group, idx) => {
        // Group row
        const groupRow = document.createElement('tr');
        groupRow.className = 'equipment-group-row collapsed';
        groupRow.dataset.groupId = `grp-${idx}`;
        groupRow.dataset.groupNumber = idx + 1;
        
        const phaseHTML = Object.entries(group.phases)
            .map(([disc, data]) => {
                const icon = data.status === 'complete' ? '‚úÖ' : 
            data.status === 'ongoing' ? 'üîÑ' : '‚è≥';
const bgColor = data.status === 'complete' ? '#3498db' : 
               data.status === 'ongoing' ? '#22c55e' : '#95a5a6';
return `<span class="phase-badge ${data.status}" style="font-size:10px; background: ${bgColor};">${icon}${disc}:${data.avgProgress}%</span>`;
            }).join('');
        
        const groupNumber = idx + 1;
        // Calculate color BEFORE template string
const progressColor1 = (group.overallProgress === 100) ? '#3498db' : '#22c55e';

groupRow.innerHTML = `
    <td style="width:3%;text-align:center;font-weight:600;">${groupNumber}</td>
    <td style="width:35%;">
        <span class="collapse-icon">‚ñ∂</span>
        <strong>${group.equipment}</strong>
        <span style="font-size:10px;opacity:0.8;margin-left:5px;">(${group.tasks.length} tasks)</span>
    </td>
    <td style="width:20%;">${group.vendor}</td>
    <td style="width:22%;">${phaseHTML}</td>
    <td style="width:20%;">
        <div style="display:flex;align-items:center;">
            <div class="overall-progress-bar" style="flex:1;margin-right:8px;">
                <div class="overall-progress-fill" style="width:${group.overallProgress}%; background:${progressColor1};"></div>
            </div>
                    <span style="font-weight:700;min-width:35px;text-align:right;">${group.overallProgress}%</span>
                </div>
            </td>
        `;
        
        groupRow.onclick = () => toggleGroup(idx);
        tableBody.appendChild(groupRow);
        
        // Child rows
        group.tasks.forEach((task, tIdx) => {
            const childRow = document.createElement('tr');
            childRow.className = 'child-task-row hidden';
            childRow.dataset.parentGroup = `grp-${idx}`;
            
            const dateStatus = getDateStatus(task.targetDate, task.mobDate);
            
            childRow.innerHTML = `
                <td>${tIdx + 1}</td>
                <td><span class="priority-badge priority-${task.priority}">${task.priority}</span></td>
                <td>
    <span style="cursor: help; text-decoration: underline dotted;" 
      onmouseenter="showTasksTooltip(event, '${task.equipment.replace(/'/g, "\\'")}', '${task.disc || task.task}')" 
      onmouseleave="hideTasksTooltip()">
    ${task.equipment}
</span>
</td>
                <td>${task.vendor}</td>
                <td><span class="status-badge">${task.disc || '-'}</span></td>
                <td class="wrap-text">${task.taskName || '-'}</td>
                <td><span class="status-badge ${getStatusClass(task.status)}">${task.status}</span></td>
                <td><span class="status-badge">${task.contract}</span></td>
                <td><span class="status-badge">${task.visa}</span></td>
                <td>${task.targetDate ? formatDateForDisplay(task.targetDate) : '-'}</td>
                <td>${task.mobDate}</td>
                <td><span class="status-badge ${dateStatus.class}">${dateStatus.status}</span></td>
                <td>${task.targetCompDate ? formatDateForDisplay(task.targetCompDate) : '-'}</td>
                <td>${task.prognosaCompDate ? formatDateForDisplay(task.prognosaCompDate) : '-'}</td>
                <td>
                    <div class="progress-bar" style="width:50px;">
                        <div class="progress-fill" style="width:${task.progress}%;"></div>
                    </div>
                    <small>${task.progress}%</small>
                </td>
                <td style="white-space: nowrap; text-align: center; position: relative; overflow: visible;">
                    <button class="action-btn primary" onclick="openUpdateModal('${task.firebaseKey}')" style="font-size: 9px; padding: 4px 8px;">Update</button>
                    ${task.status && (task.status.includes('Onsite') || task.status.includes('Completed')) ? `
                        <div style="display: inline-block; position: relative; vertical-align: middle; z-index: 100;">
                            <button class="action-btn dropdown-trigger" onclick="toggleDropdown('dropdown-${task.firebaseKey}')" style="background: #9b59b6; color: white; font-size: 9px; padding: 4px 8px; margin-left: 3px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                üìã More ‚ñº
                            </button>
                            <div id="dropdown-${task.firebaseKey}" class="action-dropdown" style="display: none;">
                                <button class="dropdown-item" data-action="tasks" data-key="${task.firebaseKey}">
                                    <span style="font-size: 14px;">üìã</span>
                                    <span>Onsite Tasks</span>
                                </button>
                                <button class="dropdown-item" data-action="progress" data-key="${task.firebaseKey}">
                                    <span style="font-size: 14px;">üìä</span>
                                    <span>Progress Report</span>
                                </button>
                            </div>
                        </div>
                    ` : `
                        <button class="action-btn success" onclick="showProgressReportById('${task.firebaseKey}')" title="View Progress Report" style="background: #27ae60; font-size: 9px; padding: 4px 8px; margin-left: 3px;">üìä Progress</button>
                    `}
                    <button class="btn-delete" onclick="deleteItem('${task.firebaseKey}')" title="Delete" style="font-size: 12px; padding: 4px 7px; line-height: 1; margin-left: 3px;">üóëÔ∏è</button>
                </td>
            `;
            
            tableBody.appendChild(childRow);
        });
    });
    
    // Set initial header
    setTimeout(() => updateGroupTableHeader(), 50);

    // Hide pagination
    setTimeout(() => {
    const selectors = [
        '.pagination-controls',
        '.pagination-info', 
        '#tablePagination',
        '#pagination',  // ‚úÖ TAMBAH INI
        '[class*="pagination"]',
        '[id*="pagination"]',
        '[class*="Pagination"]',
        '[id*="Pagination"]',
        '[id*="PageNumbers"]',  // ‚úÖ TAMBAH INI
        '[id*="pageNumbers"]',  // ‚úÖ TAMBAH INI
        '#tablePageNumbers',  // ‚úÖ TAMBAH INI (dari code sebelumnya)
        '#tablePageInfo',  // ‚úÖ TAMBAH INI
        '#prevTablePageBtn',  // ‚úÖ TAMBAH INI
        '#nextTablePageBtn'  // ‚úÖ TAMBAH INI
    ];
    
    selectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
            el.style.display = 'none';
            el.style.visibility = 'hidden';
            el.style.height = '0';
            el.style.overflow = 'hidden';
            el.classList.add('hide-in-group-mode');
        });
    });
    
    // Disable all pagination controls
    const paginationElements = document.querySelectorAll(
        '.pagination-controls, .pagination-info, #tablePagination, ' +
        'button[onclick*="changeTablePage"], button[onclick*="goToTablePage"], ' +
        '#pageInput, .page-number-input, #prevTablePageBtn, #nextTablePageBtn'
    );
    
    paginationElements.forEach(el => {
        if (el) {
            el.style.display = 'none';
            el.style.pointerEvents = 'none';
            if (el.tagName === 'BUTTON' || el.tagName === 'INPUT') {
                el.disabled = true;
            }
        }
    });
    
    updateGroupTableHeader();
}, 100);
}

let tasksTooltip = null;

function showTasksTooltip(event, equipmentName, disc) {
    const mainEquipment = projectData.find(t => t.equipment === equipmentName && (t.disc === disc || t.task === disc));
    if (!mainEquipment || !mainEquipment.firebaseKey) {
        console.warn('Equipment not found');
        return;
    }
    
    const onsiteTasksList = onsiteTasks[mainEquipment.firebaseKey] || [];
    
    // ‚úÖ LANGSUNG KE SINI - Cek onsite tasks
    if (onsiteTasksList.length === 0) {
        let content = `<div style="font-weight: 600; margin-bottom: 8px;">${equipmentName} - ${disc}</div>`;
        content += '<div style="font-size: 11px; color: #95a5a6; margin-bottom: 10px;">Onsite work not started yet</div>';
        
        // Get last update from activity history
        activityHistoryRef.orderByChild('equipmentId').equalTo(mainEquipment.id).limitToLast(3).once('value').then(snapshot => {
            const activities = [];
            snapshot.forEach(child => {
                activities.push(child.val());
            });
            
            if (activities.length > 0) {
                content += '<div style="border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px;">';
                content += '<div style="font-weight: 600; font-size: 11px; color: #3498db; margin-bottom: 5px;">üìã Recent Updates:</div>';
                
                // Show only last 2 activities
activities.reverse().slice(0, 2).forEach(activity => {
    const date = new Date(activity.timestamp);
    const dateStr = date.toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: '2-digit'});
    
    // Get notes content
    const notes = activity.notes || activity.description || 'No details available';
    
    // Truncate if too long
    const displayNotes = notes.length > 200 ? notes.substring(0, 200) + '...' : notes;
    
    content += `<div style="font-size: 10px; margin: 5px 0; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #3498db;">
        <div style="font-weight: 600; color: #2c3e50; margin-bottom: 3px;">
            ${activity.icon || 'üìù'} ${dateStr}
            ${activity.user ? `<span style="color: #7f8c8d; font-weight: normal;"> by ${activity.user}</span>` : ''}
        </div>
        <div style="color: #34495e; line-height: 1.4; white-space: pre-wrap;">
            ${displayNotes}
        </div>
    </div>`;
});
                content += '</div>';
            }
            
            showTooltipElement(content, event);
        });
        return;
    }
       
    // Calculate task statuses with time-based indicators
    const tasksWithStatus = onsiteTasksList.map(task => {
        const progress = parseInt(task.progress) || 0;
        let status = 'pending';
        let statusIcon = '‚è≥';
        let statusColor = '#95a5a6';
        let timeStatus = '';
        let timeIcon = '';
        
        // Calculate time-based status
        const today = new Date();
        const targetStart = task.targetStart ? new Date(task.targetStart) : null;
        const targetEnd = task.targetEnd ? new Date(task.targetEnd) : null;
        const startDate = task.startDate ? new Date(task.startDate) : null;
        const completedDate = task.completedDate ? new Date(task.completedDate) : null;
        
        if (progress === 100 || task.status === 'completed') {
            status = 'completed';
            statusIcon = '‚úÖ';
            statusColor = '#27ae60';
            
            if (completedDate && targetEnd) {
                const daysDiff = Math.ceil((targetEnd - completedDate) / (1000 * 60 * 60 * 24));
                if (daysDiff > 0) {
                    timeStatus = `${daysDiff}d early`;
                    timeIcon = 'üîµ';
                } else if (daysDiff < 0) {
                    timeStatus = `${Math.abs(daysDiff)}d late`;
                    timeIcon = 'üî¥';
                } else {
                    timeStatus = 'on time';
                    timeIcon = 'üü¢';
                }
            }
        } else if (progress > 0) {
            status = 'inProgress';
            statusIcon = 'üîÑ';
            statusColor = '#f39c12';
            
            if (targetStart && targetEnd) {
                const totalDuration = (targetEnd - targetStart) / (1000 * 60 * 60 * 24);
                const elapsed = startDate ? (today - startDate) / (1000 * 60 * 60 * 24) : 0;
                const expectedProgress = totalDuration > 0 ? Math.round((elapsed / totalDuration) * 100) : 0;
                const progressDiff = progress - expectedProgress;
                
                if (progressDiff >= 10) {
                    timeStatus = 'ahead';
                    timeIcon = 'üîµ';
                } else if (progressDiff >= -10) {
                    timeStatus = 'on track';
                    timeIcon = 'üü¢';
                } else if (progressDiff >= -25) {
                    timeStatus = 'at risk';
                    timeIcon = 'üü°';
                } else {
                    timeStatus = 'delayed';
                    timeIcon = 'üî¥';
                }
            }
            
            if (targetEnd && today > targetEnd) {
                const daysOverdue = Math.ceil((today - targetEnd) / (1000 * 60 * 60 * 24));
                timeStatus = `${daysOverdue}d overdue`;
                timeIcon = 'üî¥';
            }
        } else {
            const isBlocked = checkIfBlocked(task, onsiteTasksList);
            if (isBlocked) {
                status = 'blocked';
                statusIcon = 'üîí';
                statusColor = '#e74c3c';
            } else {
                status = 'ready';
                statusIcon = 'üéØ';
                statusColor = '#3498db';
            }
            
            if (targetStart && today > targetStart) {
                const daysLate = Math.ceil((today - targetStart) / (1000 * 60 * 60 * 24));
                timeStatus = `${daysLate}d late start`;
                timeIcon = 'üü°';
            } else if (targetStart) {
                const daysUntil = Math.ceil((targetStart - today) / (1000 * 60 * 60 * 24));
                if (daysUntil <= 3) {
                    timeStatus = `starts in ${daysUntil}d`;
                    timeIcon = '‚è∞';
                }
            }
        }
        
        return { ...task, status, statusIcon, statusColor, timeStatus, timeIcon };
    });
    
    // Sort by sequence
    tasksWithStatus.sort((a, b) => (a.sequence || 999) - (b.sequence || 999));
    
    // Group by status
    const ready = tasksWithStatus.filter(t => t.status === 'ready');
    const inProgress = tasksWithStatus.filter(t => t.status === 'inProgress');
    const blocked = tasksWithStatus.filter(t => t.status === 'blocked');
    const pending = tasksWithStatus.filter(t => t.status === 'pending');
    const completed = tasksWithStatus.filter(t => t.status === 'completed');
    
    // Build tooltip
    let content = `<div style="font-weight: 600; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">${equipmentName} - ${disc}</div>`;
    
    // Ready to start
    if (ready.length > 0) {
        content += '<div style="font-size: 11px; margin: 8px 0 5px 0; font-weight: 600; color: #3498db;">üéØ READY TO START:</div>';
        ready.forEach(t => {
            content += `<div style="margin: 3px 0 3px 10px; font-size: 11px;">
                ‚Ä¢ Step ${t.sequence || '?'}: ${t.name}
                ${t.timeStatus ? `<span style="margin-left: 8px; color: #7f8c8d;">${t.timeIcon} ${t.timeStatus}</span>` : ''}
            </div>`;
        });
    }
    
    // In Progress
    if (inProgress.length > 0) {
        content += '<div style="font-size: 11px; margin: 8px 0 5px 0; font-weight: 600; color: #f39c12;">üîÑ IN PROGRESS:</div>';
        inProgress.forEach(t => {
            content += `<div style="margin: 3px 0 3px 10px; font-size: 11px;">
                ‚Ä¢ Step ${t.sequence || '?'}: ${t.name} - <strong>${t.progress}%</strong>
                ${t.timeStatus ? `<span style="margin-left: 8px;">${t.timeIcon} ${t.timeStatus}</span>` : ''}
            </div>`;
        });
    }
    
    // Blocked
    if (blocked.length > 0) {
        content += '<div style="font-size: 11px; margin: 8px 0 5px 0; font-weight: 600; color: #e74c3c;">üîí BLOCKED:</div>';
        blocked.forEach(t => {
            const blockingTasks = getBlockingTasks(t, onsiteTasksList);
            content += `<div style="margin: 3px 0 3px 10px; font-size: 11px;">
                ‚Ä¢ Step ${t.sequence || '?'}: ${t.name}
                ${t.timeStatus ? `<span style="margin-left: 8px; color: #7f8c8d;">${t.timeIcon} ${t.timeStatus}</span>` : ''}
                <br><span style="margin-left: 15px; color: #e74c3c; font-size: 10px;">Waiting: ${blockingTasks}</span>
            </div>`;
        });
    }
    
    // Pending
    if (pending.length > 0) {
        content += '<div style="font-size: 11px; margin: 8px 0 5px 0; font-weight: 600; color: #95a5a6;">‚è≥ PENDING:</div>';
        pending.forEach(t => {
            content += `<div style="margin: 3px 0 3px 10px; font-size: 11px; color: #7f8c8d;">
                ‚Ä¢ Step ${t.sequence || '?'}: ${t.name}
                ${t.timeStatus ? `<span style="margin-left: 8px;">${t.timeIcon} ${t.timeStatus}</span>` : ''}
            </div>`;
        });
    }
    
    // Completed
    if (completed.length > 0) {
        content += '<div style="font-size: 11px; margin: 8px 0 5px 0; font-weight: 600; color: #27ae60;">‚úÖ COMPLETED:</div>';
        completed.forEach(t => {
            content += `<div style="margin: 3px 0 3px 10px; font-size: 11px; color: #27ae60;">
                ‚Ä¢ Step ${t.sequence || '?'}: ${t.name} - 100%
                ${t.timeStatus ? `<span style="margin-left: 8px;">${t.timeIcon} ${t.timeStatus}</span>` : ''}
            </div>`;
        });
    }
    
    // Summary
    const totalTasks = tasksWithStatus.length;
    const canProceed = ready.length + inProgress.length;
    content += `<div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ddd; font-size: 11px;">
        <strong>Summary:</strong> ${completed.length} completed, ${canProceed} can proceed, ${blocked.length} blocked
    </div>`;
    
    showTooltipElement(content, event);
}

// Helper function to check if task is blocked
function checkIfBlocked(task, allTasks) {
    if (task.executionMode === 'independent') return false;
    if (!task.dependencies || task.dependencies.length === 0) return false;
    
    return task.dependencies.some(depId => {
        const depTask = allTasks.find(t => t.id === depId);
        if (!depTask) return false;
        const progress = parseInt(depTask.progress) || 0;
        return progress < 100 && depTask.status !== 'completed';
    });
}

// Helper function to get blocking tasks names
function getBlockingTasks(task, allTasks) {
    if (!task.dependencies || task.dependencies.length === 0) return 'None';
    
    const blocking = task.dependencies
        .map(depId => {
            const depTask = allTasks.find(t => t.id === depId);
            if (!depTask) return null;
            const progress = parseInt(depTask.progress) || 0;
            if (progress < 100 && depTask.status !== 'completed') {
                return `${depTask.name} (${progress}%)`;
            }
            return null;
        })
        .filter(t => t !== null);
    
    return blocking.length > 0 ? blocking.join(', ') : 'None';
}

// Helper to show tooltip element
function showTooltipElement(content, event) {
    if (!tasksTooltip) {
        tasksTooltip = document.createElement('div');
        tasksTooltip.style.cssText = `
            position: fixed;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            min-width: 300px;
            max-width: 450px;
            font-size: 12px;
            line-height: 1.6;
        `;
        document.body.appendChild(tasksTooltip);
    }
    
    tasksTooltip.innerHTML = content;
    tasksTooltip.style.display = 'block';
    tasksTooltip.style.left = (event.clientX + 15) + 'px';
    tasksTooltip.style.top = (event.clientY + 15) + 'px';
}

function hideTasksTooltip() {
    if (tasksTooltip) {
        tasksTooltip.style.display = 'none';
    }
}

function toggleGroup(groupIdx) {
    const groupRow = document.querySelector(`[data-group-id="grp-${groupIdx}"]`);
    const childRows = document.querySelectorAll(`[data-parent-group="grp-${groupIdx}"]`);
    const isCollapsed = groupRow.classList.contains('collapsed');
    
     // ‚úÖ Get group data from FILTERED groups, not original
    // Store filteredGroups in global variable
    const group = window.currentFilteredGroups ? window.currentFilteredGroups[groupIdx] : currentEquipmentGroups[groupIdx];
    
    
    if (isCollapsed) {
        // Expand - update to expanded view (16 columns)
        groupRow.classList.remove('collapsed');
        childRows.forEach(r => r.classList.remove('hidden'));
        
        // Update group row to match 16 columns
        const phaseHTML = Object.entries(group.phases)
            .map(([disc, data]) => {
                const icon = data.status === 'complete' ? '‚úÖ' : 
            data.status === 'ongoing' ? 'üîÑ' : '‚è≥';
const bgColor = data.status === 'complete' ? '#3498db' : 
               data.status === 'ongoing' ? '#22c55e' : '#95a5a6';
return `<span class="phase-badge ${data.status}" style="font-size:10px; background: ${bgColor};">${icon}${disc}:${data.avgProgress}%</span>`;
            }).join('');
            
        // Calculate color BEFORE template string
const progressColor2 = (group.overallProgress === 100) ? '#3498db' : '#22c55e';

groupRow.innerHTML = `
    <td colspan="3">
        <span class="collapse-icon">‚ñº</span>
        <strong>${group.equipment}</strong>
        <span style="font-size:10px;opacity:0.8;">(${group.tasks.length} tasks)</span>
    </td>
    <td>${group.vendor}</td>
    <td colspan="2">${phaseHTML}</td>
    <td colspan="7">
        <div class="overall-progress-bar">
            <div class="overall-progress-fill" style="width:${group.overallProgress}%; background:${progressColor2};"></div>
        </div>
                <span style="margin-left:10px;font-weight:700;">${group.overallProgress}%</span>
            </td>
            <td colspan="3" style="text-align:center;color:#7f8c8d;font-size:11px;">Overall Progress</td>
        `;
    } else {
        // Collapse - update to collapsed view (5 columns)
        groupRow.classList.add('collapsed');
        childRows.forEach(r => r.classList.add('hidden'));
        
        // Update group row to match 5 columns
        const phaseHTML = Object.entries(group.phases)
            .map(([disc, data]) => {
                const icon = data.status === 'complete' ? '‚úÖ' : 
            data.status === 'ongoing' ? 'üîÑ' : '‚è≥';
const bgColor = data.status === 'complete' ? '#3498db' : 
               data.status === 'ongoing' ? '#22c55e' : '#95a5a6';
return `<span class="phase-badge ${data.status}" style="font-size:10px; background: ${bgColor};">${icon}${disc}:${data.avgProgress}%</span>`;
            }).join(' ');
            
        // Get group number from data attribute or calculate it
        const groupNumber = parseInt(groupRow.dataset.groupNumber) || groupIdx + 1;
        
        // Calculate color BEFORE template string
const progressColor3 = (group.overallProgress === 100) ? '#3498db' : '#22c55e';

groupRow.innerHTML = `
    <td style="width:3%;text-align:center;font-weight:600;">${groupNumber}</td>
    <td style="width:35%;">
        <span class="collapse-icon">‚ñ∂</span>
        <strong>${group.equipment}</strong>
        <span style="font-size:10px;opacity:0.8;margin-left:5px;">(${group.tasks.length} tasks)</span>
    </td>
    <td style="width:20%;">${group.vendor}</td>
    <td style="width:22%;">${phaseHTML}</td>
    <td style="width:20%;">
        <div style="display:flex;align-items:center;">
            <div class="overall-progress-bar" style="flex:1;margin-right:8px;">
                <div class="overall-progress-fill" style="width:${group.overallProgress}%; background:${progressColor3};"></div>
            </div>
            <span style="font-weight:700;min-width:35px;text-align:right;">${group.overallProgress}%</span>
        </div>
    </td>
`;
    }
    
    // Re-bind onclick event
    groupRow.onclick = () => toggleGroup(groupIdx);
    
    // Update header to match current state
    setTimeout(() => updateGroupTableHeader(), 50);
}

// ========== VISUAL MANAGEMENT FUNCTIONS ==========

// Load user's Visual Management settings from localStorage
function loadVMSettings() {
    try {
        const savedSettings = localStorage.getItem('vmSettings');
        
        if (savedSettings) {
            const parsed = JSON.parse(savedSettings);
            
            // Merge with defaults
            vmSettings = {
                layout: parsed.layout || 3,
                maxRows: parsed.maxRows || 2,
                selectedEquipment: parsed.selectedEquipment || [],
                displayOptions: parsed.displayOptions || {
                    showVendor: true,
                    showMilestone: true,
                    showHighlight: true,
                    showSPI: true
                }
            };
            
            console.log('‚úÖ VM Settings loaded from localStorage:', vmSettings);
            
            // ‚úÖ AUTO-CLEANUP: Remove invalid/old format equipment
            if (vmSettings.selectedEquipment.length > 0 && projectData && projectData.length > 0) {
                const originalCount = vmSettings.selectedEquipment.length;
                
                // Keep only equipment that exists in current projectData
                vmSettings.selectedEquipment = vmSettings.selectedEquipment.filter(equipmentId => {
                    // Check if this equipment exists in projectData
                    const exists = projectData.some(task => task.equipment === equipmentId);
                    
                    if (!exists) {
                        console.log('üßπ Removing invalid equipment:', equipmentId);
                    }
                    
                    return exists;
                });
                
                const removedCount = originalCount - vmSettings.selectedEquipment.length;
                
                if (removedCount > 0) {
                    console.log(`üßπ Cleaned ${removedCount} invalid equipment from settings`);
                    saveVMSettings(); // Save cleaned data
                }
            }
        } else {
            console.log('‚ÑπÔ∏è No saved VM settings, using defaults');
        }
        
        // Apply settings to UI
        applyVMSettings();
        
        // Load equipment data if any selected
        if (vmSettings.selectedEquipment.length > 0) {
            loadVMEquipmentData();
        }
    } catch (error) {
        console.error('‚ùå Error loading VM settings:', error);
        applyVMSettings();
    }
}

// Save user's Visual Management settings to localStorage
function saveVMSettings() {
    // Clear previous timeout
    if (vmSaveTimeout) {
        clearTimeout(vmSaveTimeout);
    }
    
    // Debounce save (wait 1 second after last change)
    vmSaveTimeout = setTimeout(() => {
        try {
            // ‚úÖ FIX: Normalize equipment IDs before saving (remove NBSP)
            const normalizedEquipment = vmSettings.selectedEquipment.map(id => normalizeEquipmentId(id));
            
            // Save to localStorage
            localStorage.setItem('vmSettings', JSON.stringify({
                layout: vmSettings.layout,
                maxRows: vmSettings.maxRows,
                selectedEquipment: normalizedEquipment,  // ‚úÖ Use normalized
                displayOptions: vmSettings.displayOptions,
                timestamp: new Date().toISOString()
            }));
            
            // ‚úÖ Also update in-memory version
            vmSettings.selectedEquipment = normalizedEquipment;
            
            console.log('‚úÖ VM Settings saved to localStorage (normalized)');
            
            // Show save indicator
            const indicator = document.getElementById('vmAutoSaveIndicator');
            if (indicator) {
                indicator.textContent = 'üíæ Auto-saved';
                indicator.style.color = '#27ae60';
                setTimeout(() => {
                    indicator.textContent = '';
                }, 2000);
            }
        } catch (error) {
            console.error('‚ùå Error saving VM settings:', error);
        }
    }, 1000);
}

// Apply settings to UI elements
function applyVMSettings() {
    // Show/hide section
    const section = document.getElementById('visualManagementSection');
    if (section) {
        section.style.display = vmSettings.selectedEquipment.length > 0 ? 'block' : 'none';
    }
    
    // Update subtitle
    const subtitle = document.getElementById('vmSubtitle');
    if (subtitle) {
        const count = vmSettings.selectedEquipment.length;
        subtitle.textContent = count > 0 
            ? `Showing ${count} equipment (${vmSettings.layout} columns √ó ${vmSettings.maxRows} rows max)`
            : 'No equipment selected';
    }
    
    // Update settings dialog
    const layoutSelect = document.getElementById('vmLayoutSelect');
    if (layoutSelect) {
        layoutSelect.value = vmSettings.layout;
    }
    
    const maxRowsSelect = document.getElementById('vmMaxRowsSelect');
    if (maxRowsSelect) {
        maxRowsSelect.value = vmSettings.maxRows;
    }
    
    // Update checkboxes
    document.getElementById('vmShowVendor').checked = vmSettings.displayOptions.showVendor;
    document.getElementById('vmShowMilestone').checked = vmSettings.displayOptions.showMilestone;
    document.getElementById('vmShowHighlight').checked = vmSettings.displayOptions.showHighlight;
    document.getElementById('vmShowSPI').checked = vmSettings.displayOptions.showSPI;
    
    // Apply grid layout
    const container = document.getElementById('vmCardsContainer');
    if (container) {
        container.className = `vm-cards-grid-${vmSettings.layout}`;
    }
// Show/hide quick access button
    const quickAccessBtn = document.getElementById('vmQuickAccessButton');
    if (quickAccessBtn) {
        // Show button ONLY if no equipment selected
        quickAccessBtn.style.display = vmSettings.selectedEquipment.length > 0 ? 'none' : 'block';
    }
}

// Helper: Normalize equipment ID (remove non-breaking spaces, etc)
function normalizeEquipmentId(id) {
    if (!id) return id;
    // Replace non-breaking space (160) with normal space (32)
    return id.replace(/\u00A0/g, ' ').trim();
}

// Load equipment data - using equipment ID (equipment___vendor)
// Load equipment data - using EQUIPMENT ONLY (all vendors combined)
function loadVMEquipmentData() {
    console.log('üîÑ Loading VM equipment data...');
    
    // ‚úÖ ADD: Show loading state, hide empty state and clear cards
    const loadingState = document.getElementById('vmLoadingState');
    const emptyState = document.getElementById('vmEmptyState');
    const container = document.getElementById('vmCardsContainer');
    
    if (loadingState) loadingState.style.display = 'block';
    if (emptyState) emptyState.style.display = 'none';
    if (container) container.innerHTML = '';
    
    vmEquipmentData = {};
    
    const promises = vmSettings.selectedEquipment.map(equipmentId => {
    return new Promise((resolve) => {
        // Handle old format with __vendor
        let equipment = equipmentId;
        
        // If contains __, it's old format - extract equipment name only
        if (equipmentId.includes('__')) {
            equipment = equipmentId.split('__')[0];
            console.log('‚ö†Ô∏è Old format detected:', equipmentId, '‚Üí Using:', equipment);
        }
        
        // ‚úÖ FIX: Normalize equipment name
        equipment = normalizeEquipmentId(equipment);
        
        const allTasks = [];
        
        // Get ALL parent tasks matching this equipment (all vendors)
        // ‚úÖ FIX: Use normalized comparison
        const parentTasks = projectData.filter(task => {
            return normalizeEquipmentId(task.equipment) === equipment;
        });
        
        console.log(`üîç Found ${parentTasks.length} parent tasks for "${equipment}"`);
        
        // Get subtasks from all parent tasks
        parentTasks.forEach(parentTask => {
            const firebaseKey = parentTask.firebaseKey || parentTask.id;
            const subtasks = onsiteTasks[firebaseKey] || [];
            
            console.log(`   ${parentTask.disc}: ${subtasks.length} tasks (key: ${firebaseKey})`);
            
            if (subtasks.length > 0) {
                // Has subtasks - add them with parent info
                subtasks.forEach(subtask => {
                    allTasks.push({
                        ...subtask,
                        equipment: parentTask.equipment,
                        disc: parentTask.disc,
                        vendor: parentTask.vendor,
                        parentTask: parentTask.task || parentTask.taskName
                    });
                });
            }
        });
        
        // Collect all unique vendors
        const vendors = [...new Set(allTasks.map(t => t.vendor))];
        const vendorText = vendors.join(', ');
        
        // Load shared data
        const sanitizedId = equipment.replace(/[.#$[\]()]/g, '_').replace(/\s+/g, '_');
        database.ref(`reportSettings/${sanitizedId}`).once('value').then(reportSnap => {
            const reportData = reportSnap.val() || {};
            
            vmEquipmentData[equipmentId] = {
                equipment: equipment,
                vendor: vendorText,
                tasks: allTasks,
                highlights: reportData.highlights || '',
                actionPlan: reportData.actionPlan || '',
                milestones: reportData.milestones || []
            };
            
            console.log(`‚úÖ Loaded ${allTasks.length} tasks for ${equipment} (${vendorText})`);
            resolve();
        }).catch(error => {
            vmEquipmentData[equipmentId] = {
                equipment: equipment,
                vendor: vendorText,
                tasks: allTasks,
                highlights: '',
                actionPlan: '',
                milestones: []
            };
            resolve();
        });
    });
});
    
   Promise.all(promises).then(() => {
    console.log('‚úÖ VM Equipment data loaded:', vmEquipmentData);
    
    // Check if any equipment has 0 tasks
    const allTaskCounts = Object.values(vmEquipmentData).map(d => d.tasks.length);
    const totalTasks = allTaskCounts.reduce((sum, count) => sum + count, 0);
    
    // ‚úÖ ADD: Retry counter to prevent infinite retries
    if (!window.vmLoadRetryCount) window.vmLoadRetryCount = 0;
    
    if (totalTasks === 0 && vmSettings.selectedEquipment.length > 0 && window.vmLoadRetryCount < 3) {
        window.vmLoadRetryCount++;
        console.warn(`‚ö†Ô∏è All equipment have 0 tasks - onsiteTasks may not be loaded yet (Retry ${window.vmLoadRetryCount}/3)`);
        console.log('üîÑ Retrying in 2 seconds...');
        
        setTimeout(() => {
            console.log(`üîÑ Retry attempt ${window.vmLoadRetryCount}...`);
            loadVMEquipmentData();
        }, 2000);
    } else {
    // Success or max retries reached
    if (totalTasks > 0) {
        window.vmLoadRetryCount = 0; // Reset on success
        console.log(`üìä Total tasks loaded: ${totalTasks}`);
    } else if (window.vmLoadRetryCount >= 3) {
        console.error('‚ùå Failed to load tasks after 3 retries');
        window.vmLoadRetryCount = 0; // Reset counter
    }
    
    // ‚úÖ Load previous state before rendering (for change detection)
    loadPreviousVMState();
    
    renderVMCards();
}
});
}

// ===== CHANGE DETECTION & INDICATORS =====

// Store previous values for comparison
let previousVMData = {};

// Calculate changes and determine badge type
function detectEquipmentChanges(equipmentId, currentData) {
    const previous = previousVMData[equipmentId];
    
    if (!previous) {
        // First load - save current state
        previousVMData[equipmentId] = {
            progress: currentData.equipment.progress || 0,
            status: currentData.equipment.status || '',
            completedTasks: currentData.tasks.filter(t => t.progress === 100).length,
            timestamp: Date.now()
        };
        return null;
    }
    
    const current = {
        progress: currentData.equipment.progress || 0,
        status: currentData.equipment.status || '',
        completedTasks: currentData.tasks.filter(t => t.progress === 100).length,
        timestamp: Date.now()
    };
    
    // Calculate deltas
    const progressDelta = current.progress - previous.progress;
    const tasksDelta = current.completedTasks - previous.completedTasks;
    const statusChanged = current.status !== previous.status;
    const timeSinceUpdate = (current.timestamp - previous.timestamp) / (1000 * 60 * 60); // hours
    
    // Only show changes if within last 24 hours
    if (timeSinceUpdate > 24) {
        return null;
    }
    
    // Determine badge type and details
    let badgeType = null;
    let details = {
        progressDelta: progressDelta,
        tasksDelta: tasksDelta,
        statusChanged: statusChanged,
        timeSince: timeSinceUpdate
    };
    
    // Priority: Milestone > High Activity > Progress
    
    // Check for milestone (25%, 50%, 75%, 100%)
    const milestones = [25, 50, 75, 100];
    const crossedMilestone = milestones.some(m => 
        previous.progress < m && current.progress >= m
    );
    
    if (crossedMilestone || current.progress === 100) {
        badgeType = 'milestone';
    }
    // Check for high activity (multiple changes)
    else if ((tasksDelta >= 3 || progressDelta >= 10) && timeSinceUpdate < 12) {
        badgeType = 'activity';
    }
    // Check for progress increase
    else if (progressDelta > 0) {
        badgeType = 'progress';
    }
    
    // Update stored previous data
    previousVMData[equipmentId] = current;
    
    return badgeType ? { type: badgeType, details: details } : null;
}

// Get badge HTML
function getChangeBadgeHTML(badgeInfo) {
    if (!badgeInfo) return '';
    
    const { type, details } = badgeInfo;
    
    let badgeClass = `change-badge pulse ${type}`;
    let tooltipContent = '';
    
    switch(type) {
        case 'activity':
            tooltipContent = `
                <div style="color: #3498db; font-weight: 600; margin-bottom: 6px;">
                    ‚óâ High Activity
                </div>
                ${details.tasksDelta > 0 ? `<div>‚Ä¢ ${details.tasksDelta} tasks completed</div>` : ''}
                ${details.progressDelta > 0 ? `<div>‚Ä¢ Progress +${details.progressDelta}%</div>` : ''}
                ${details.statusChanged ? `<div>‚Ä¢ Status updated</div>` : ''}
                <div style="color: #95a5a6; font-size: 11px; margin-top: 6px;">
                    ${Math.round(details.timeSince)}h ago
                </div>
            `;
            break;
            
        case 'milestone':
            tooltipContent = `
                <div style="color: #f39c12; font-weight: 600; margin-bottom: 6px;">
                    ‚òÖ Milestone Achieved
                </div>
                <div>‚Ä¢ Progress: ${details.progressDelta > 0 ? '+' : ''}${details.progressDelta}%</div>
                ${details.tasksDelta > 0 ? `<div>‚Ä¢ ${details.tasksDelta} tasks completed</div>` : ''}
                <div style="color: #95a5a6; font-size: 11px; margin-top: 6px;">
                    ${Math.round(details.timeSince)}h ago
                </div>
            `;
            break;
            
        case 'progress':
            tooltipContent = `
                <div style="color: #27ae60; font-weight: 600; margin-bottom: 6px;">
                    ‚ñ¥ Progress Increase
                </div>
                <div>‚Ä¢ Progress +${details.progressDelta}%</div>
                ${details.tasksDelta > 0 ? `<div>‚Ä¢ ${details.tasksDelta} tasks completed</div>` : ''}
                <div style="color: #95a5a6; font-size: 11px; margin-top: 6px;">
                    ${Math.round(details.timeSince)}h ago
                </div>
            `;
            break;
    }
    
    return `
        <div class="${badgeClass}" title="Recent changes"></div>
        <div class="change-badge-tooltip">
            ${tooltipContent}
        </div>
    `;
}

// Get progress delta HTML
function getProgressDeltaHTML(progressDelta, previousProgress) {
    if (!progressDelta || progressDelta === 0) return '';
    
    const isIncrease = progressDelta > 0;
    const arrow = isIncrease ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
    const deltaClass = isIncrease ? 'increase' : 'decrease';
    const sign = isIncrease ? '+' : '';
    
    return `
        <span class="progress-delta ${deltaClass}">
            <span class="arrow">${arrow}</span>
            <span>${sign}${progressDelta}%</span>
            <span class="from-value">(from ${previousProgress}%)</span>
        </span>
    `;
}

// Load/save functions
function loadPreviousVMState() {
    const saved = localStorage.getItem('vmPreviousData');
    if (saved) {
        try {
            previousVMData = JSON.parse(saved);
        } catch (e) {
            console.log('Could not load previous VM state');
        }
    }
}

function savePreviousVMState() {
    localStorage.setItem('vmPreviousData', JSON.stringify(previousVMData));
}

// ===== END CHANGE DETECTION =====


// Clear all equipment from Visual Management
function clearAllVMEquipment() {
    if (vmSettings.selectedEquipment.length === 0) {
        showNotification('No equipment to clear', 'info');
        return;
    }
    
    if (!confirm(`Remove all ${vmSettings.selectedEquipment.length} equipment from Visual Management?`)) {
        return;
    }
    
    console.log('üóëÔ∏è Clearing all VM equipment...');
    
    // Clear local data
    vmSettings.selectedEquipment = [];
    vmEquipmentData = {};
    
    // Save to localStorage (primary storage)
    try {
        localStorage.setItem('vmSettings', JSON.stringify(vmSettings));
        console.log('‚úÖ localStorage cleared');
    } catch (e) {
        console.log('‚ö†Ô∏è localStorage error:', e);
    }
    
    // Try to clear Firebase (optional - ignore if permission denied)
    if (database && database.ref) {
        database.ref('vmSettings/selectedEquipment').set([])
            .then(() => console.log('‚úÖ Firebase cleared'))
            .catch(() => console.log('‚ÑπÔ∏è Firebase sync skipped (permission)'));
    }
    
    // Re-render
    applyVMSettings();
    renderVMCards();
    
    showNotification('All equipment cleared', 'success');
    console.log('‚úÖ All VM equipment cleared successfully');
}

// SHARED: Calculate weighted progress for array of tasks
function calculateWeightedProgress(tasks) {
    if (!tasks || tasks.length === 0) return 0;
    
    const totalWeight = tasks.reduce((sum, t) => sum + (parseFloat(t.weight) || 1), 0);
    const weightedProgress = tasks.reduce((sum, t) => {
        const weight = parseFloat(t.weight) || 1;
        const progress = parseFloat(t.progress) || 0;
        return sum + (weight * progress / 100);
    }, 0);
    
    return totalWeight > 0 ? Math.round((weightedProgress / totalWeight) * 100) : 0;
}

// SHARED: Calculate timeline progress for array of tasks
function calculateTimelineProgress(tasks) {
    if (!tasks || tasks.length === 0) return { timelineProgress: 0, daysLeft: 0, targetDate: null };
    
    // ‚úÖ More flexible: Accept tasks with at least start OR end date
    const tasksWithDates = tasks.filter(t => t.targetStart || t.targetEnd);
    
    if (tasksWithDates.length === 0) {
        return { timelineProgress: 0, daysLeft: 0, targetDate: null };
    }
    
    // Get all available dates
    const startDates = tasksWithDates
        .filter(t => t.targetStart)
        .map(t => new Date(t.targetStart));
    
    const endDates = tasksWithDates
        .filter(t => t.targetEnd)
        .map(t => new Date(t.targetEnd));
    
    // If no dates at all, return 0
    if (startDates.length === 0 && endDates.length === 0) {
        return { timelineProgress: 0, daysLeft: 0, targetDate: null };
    }
    
    // Use earliest start (or today if no starts)
    const projectStart = startDates.length > 0 
        ? new Date(Math.min(...startDates))
        : new Date();  // Default to today
    
    // Use latest end (or today + 30 days if no ends)
    const projectEnd = endDates.length > 0
        ? new Date(Math.max(...endDates))
        : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);  // Default to 30 days from now
    
    const today = new Date();
    
    const totalDays = Math.ceil((projectEnd - projectStart) / (1000 * 60 * 60 * 24));
    const elapsedDays = Math.ceil((today - projectStart) / (1000 * 60 * 60 * 24));
    
    const timelineProgress = totalDays > 0 ? Math.min(100, Math.max(0, Math.round((elapsedDays / totalDays) * 100))) : 0;
    const daysLeft = Math.max(0, Math.ceil((projectEnd - today) / (1000 * 60 * 60 * 24)));
    const targetDate = projectEnd.toISOString().split('T')[0];
    
    return { timelineProgress, daysLeft, targetDate };
}

// Calculate metrics for an equipment
function calculateEquipmentMetrics(equipmentId) {
    const data = vmEquipmentData[equipmentId];
    if (!data || !data.tasks || data.tasks.length === 0) {
        console.log('‚ö†Ô∏è No tasks for equipment:', equipmentId);
        return null;
    }
    
    const tasks = data.tasks;
    const equipment = data.equipment || 'Unknown';
    const vendor = data.vendor || 'Unknown';
    
    // Count by status
    const completed = tasks.filter(t => t.progress === 100).length;
    const inProgress = tasks.filter(t => t.progress > 0 && t.progress < 100).length;
    
    // ‚úÖ FIX: Count blocked tasks properly (explicit status + dependency-blocked)
    const pendingTasks = tasks.filter(t => !t.progress || t.progress === 0);
    const blockedByStatus = tasks.filter(t => t.status === 'blocked');
    const blockedByDependencies = pendingTasks.filter(t => checkIfBlocked(t, tasks));
    
    // Combine both (avoid duplicates)
    const allBlockedIds = new Set([
        ...blockedByStatus.map(t => t.id),
        ...blockedByDependencies.map(t => t.id)
    ]);
    const blocked = allBlockedIds.size;
    
    // Ready = pending but NOT blocked
    const ready = pendingTasks.filter(t => !allBlockedIds.has(t.id)).length;
    const notStarted = pendingTasks.length;
    
    // Use shared calculation
const overallProgress = calculateWeightedProgress(tasks);
    
    // Use shared calculation
const timelineData = calculateTimelineProgress(tasks);
const timelineProgress = timelineData.timelineProgress;
const daysLeft = timelineData.daysLeft;
const targetDate = timelineData.targetDate;

// Calculate SPI
const spi = timelineProgress > 0 ? (overallProgress / timelineProgress) : 1.0;
    
    // Determine status
    let status = 'üü¢';
    let statusText = 'On Track';
    if (spi < 0.8) {
        status = 'üî¥';
        statusText = 'Critical';
    } else if (spi < 0.95) {
        status = 'üü°';
        statusText = 'At Risk';
    }
    
    
    // Get next milestone
    const milestones = data.milestones || [];
    const upcomingMilestone = milestones.find(m => m.progress < 100);
    
   return {
        equipmentId,
        equipment,
        vendor,
        status,
        statusText,
        overallProgress,
        timelineProgress,
        spi: spi.toFixed(2),
        daysLeft,
        targetDate,
        totalTasks: tasks.length,
        completedCount: completed,     // ‚úÖ Rename for clarity
        inProgressCount: inProgress,   // ‚úÖ Rename for clarity
        blockedCount: blocked,         // ‚úÖ Rename for clarity
        readyCount: ready,             // ‚úÖ ADD THIS
        notStarted,
        highlights: data.highlights,
        upcomingMilestone
    };
}

// Render equipment cards
function renderVMCards() {
    const container = document.getElementById('vmCardsContainer');
    const emptyState = document.getElementById('vmEmptyState');
    const loadingState = document.getElementById('vmLoadingState');
    
    if (!container) {
        console.error('‚ùå VM container not found!');
        return;
    }
    
    // Hide loading state when rendering starts
    if (loadingState) loadingState.style.display = 'none';
    
    // Clear existing cards
    container.innerHTML = '';
    
    let renderedCount = 0;
    
    // Render each equipment
    vmSettings.selectedEquipment.forEach(equipmentId => {
        // Normalize equipment ID before lookup
        const normalizedId = normalizeEquipmentId(equipmentId);
        const metrics = calculateEquipmentMetrics(normalizedId);
        
        if (metrics) {
            const card = createEquipmentCard(metrics);
            container.appendChild(card);
            renderedCount++;
        } else {
            console.warn(`‚ö†Ô∏è No metrics for: "${equipmentId}"`);
        }
    });
    
    // Toggle empty state based on actual rendered cards
    if (emptyState) {
        if (renderedCount > 0) {
            emptyState.style.display = 'none';
        } else {
            emptyState.style.display = 'block';
        }
    }
    
    console.log(`‚úÖ Rendered ${renderedCount} equipment card(s)`);
// ‚úÖ FIX: Update subtitle to show ACTUAL rendered count
const subtitle = document.getElementById('vmSubtitle');
if (subtitle) {
    const columns = vmSettings.layout || 3;
    const maxRows = vmSettings.maxRows || 2;
    subtitle.textContent = `Showing ${renderedCount} equipment (${columns} columns √ó ${maxRows} rows max)`;
}
    
    // ‚úÖ Save state for next comparison
    savePreviousVMState();
}

// Create a single equipment card
function createEquipmentCard(metrics) {
    const card = document.createElement('div');
    card.className = 'vm-equipment-card';
    
    // ‚úÖ NEW: Detect changes for this equipment
    const changeInfo = detectEquipmentChanges(metrics.equipmentId, {
        equipment: { progress: metrics.overallProgress, status: metrics.status },
        tasks: []
    });
    
    const borderClass = changeInfo ? `recent-${changeInfo.type}` : '';
    const badgeHTML = getChangeBadgeHTML(changeInfo);
    
    // Get progress delta
    const progressDelta = changeInfo ? changeInfo.details.progressDelta : 0;
    const previousProgress = metrics.overallProgress - progressDelta;
    const deltaHTML = getProgressDeltaHTML(progressDelta, previousProgress);
    
    // Check if progress bar should pulse
    const progressBarClass = (changeInfo && changeInfo.type === 'progress') ? 'recent-increase' : '';
    
    // Determine progress bar color
    let progressColor = 'blue';
    if (metrics.spi < 0.8) progressColor = 'red';
    else if (metrics.spi < 0.95) progressColor = 'orange';
    else if (metrics.spi > 1.05) progressColor = 'green';
    
    let html = `
        ${badgeHTML}
        <div class="vm-card-header">
            <div style="display: flex; align-items: flex-start; flex: 1;">
                <span class="vm-card-status">${metrics.status}</span>
                <span class="vm-card-title">${metrics.equipment}</span>
            </div>
            <button class="vm-card-close" onclick="removeEquipmentFromVM('${metrics.equipmentId}')" title="Remove">√ó</button>
        </div>
    `;
    
    // Vendor info (if enabled)
    if (vmSettings.displayOptions.showVendor) {
        html += `
            <div class="vm-card-meta">
                <span>üë§ ${metrics.vendor}</span>
                <span>üïê Updated recently</span>
            </div>
        `;
    }
    
    // Progress bars
    html += `
        <div class="vm-progress-section">
            <div class="vm-progress-label">
                <span>Progress:</span>
                <span><strong>${metrics.overallProgress}%</strong>${deltaHTML}</span>
            </div>
            <div class="vm-progress-bar">
                <div class="vm-progress-fill ${progressColor} ${progressBarClass}" style="width: ${metrics.overallProgress}%"></div>
            </div>
        </div>
        
        <div class="vm-progress-section">
            <div class="vm-progress-label">
                <span>Timeline:</span>
                <span><strong>${metrics.timelineProgress}%</strong></span>
            </div>
            <div class="vm-progress-bar">
                <div class="vm-progress-fill blue" style="width: ${metrics.timelineProgress}%"></div>
            </div>
        </div>
    `;
    
    // SPI (if enabled)
    if (vmSettings.displayOptions.showSPI) {
        let spiClass = 'good';
        let spiText = 'On Track';
        if (metrics.spi < 0.8) {
            spiClass = 'critical';
            spiText = `Behind -${Math.round((1 - metrics.spi) * 100)}%`;
        } else if (metrics.spi < 0.95) {
            spiClass = 'warning';
            spiText = `Slightly Behind`;
        } else if (metrics.spi > 1.05) {
            spiText = `Ahead +${Math.round((metrics.spi - 1) * 100)}%`;
        }
        
        html += `
            <div style="font-size: 11px; margin-bottom: 10px; color: #7f8c8d;">
                SPI: <strong>${metrics.spi}</strong>
                <span class="vm-spi-badge ${spiClass}">${spiText}</span>
            </div>
        `;
    }
    
    // Timeline info
    if (metrics.targetDate) {
        html += `
            <div class="vm-timeline-info">
                <span>üìÖ ${metrics.targetDate}</span>
                <span>‚è∞ ${metrics.daysLeft} days left</span>
            </div>
        `;
    }
    
    // Task counts
html += `
    <div class="vm-task-counts">
        <div class="vm-task-count">
            <span class="vm-task-count-number" style="color: #27ae60;">‚úÖ ${metrics.completedCount || 0}</span>
            <span>Done</span>
        </div>
        <div class="vm-task-count">
            <span class="vm-task-count-number" style="color: #3498db;">üîÑ ${metrics.inProgressCount || 0}</span>
            <span>Progress</span>
        </div>
        <div class="vm-task-count">
            <span class="vm-task-count-number" style="color: #95a5a6;">‚è≥ ${metrics.readyCount || 0}</span>
            <span>Ready</span>
        </div>
        <div class="vm-task-count">
            <span class="vm-task-count-number" style="color: #e74c3c;">üö´ ${metrics.blockedCount || 0}</span>
            <span>Blocked</span>
        </div>
    </div>
`;
    
    // Milestone (if enabled and exists)
    if (vmSettings.displayOptions.showMilestone && metrics.upcomingMilestone) {
        const milestone = metrics.upcomingMilestone;
        html += `
            <div class="vm-milestone">
                <div class="vm-milestone-title">üéØ ${milestone.name}</div>
                <div class="vm-milestone-due">Due: ${milestone.targetDate} | Progress: ${milestone.progress}%</div>
            </div>
        `;
    }
    
    // Highlights (if enabled and exists)
    if (vmSettings.displayOptions.showHighlight && metrics.highlights) {
        const truncated = metrics.highlights.length > 100 
            ? metrics.highlights.substring(0, 100) + '...' 
            : metrics.highlights;
        
        html += `
            <div class="vm-highlight">
                <span class="vm-highlight-label">üí° Highlight:</span>
                <div class="vm-highlight-text">${truncated}</div>
            </div>
        `;
    }
    
    // Action buttons with dropdown
    const dropdownId = 'dropdown-' + metrics.equipmentId.replace(/[^a-zA-Z0-9]/g, '_');
    
    html += `
        <div class="vm-card-actions">
            <!-- Split Button for Tasks -->
            <div class="split-button">
                <button class="split-button-main" style="cursor: default;" title="Click ‚ñº to select discipline">
                    üìä Tasks
                </button>
                <button class="split-button-dropdown" onclick="toggleTaskDropdown(event, '${metrics.equipmentId}')">
                    ‚ñº
                </button>
                <div class="task-dropdown-menu" id="${dropdownId}">
                    <!-- Dropdown populated dynamically -->
                </div>
            </div>
            
            <button class="vm-report-button" onclick="openProgressReportFromVM('${metrics.equipmentId}')">
                üìÑ Report
            </button>
        </div>
    `;
    
    card.innerHTML = html;
    
    // ‚úÖ Apply border class
    if (borderClass) {
        card.classList.add(borderClass);
    }
    
    return card;
}

// ‚úÖ NEW - Open all tasks for equipment (combined view)
function openAllTasksFromVM(equipmentId) {
    console.log('üîç openAllTasksFromVM called with:', equipmentId);
    
    const normalizedId = normalizeEquipmentId(equipmentId);
    console.log('   Normalized:', normalizedId);
    
    const data = vmEquipmentData[normalizedId];
    console.log('   Data found?', !!data);
    
    if (!data || !data.tasks || data.tasks.length === 0) {
        console.error('‚ùå No data or tasks:', data);
        showNotification('No tasks found', 'error');
        return;
    }
    
    const equipment = data.equipment;
    const parentTasks = projectData.filter(t => 
        normalizeEquipmentId(t.equipment) === normalizeEquipmentId(equipment)
    );
    
    console.log('   Parent tasks found:', parentTasks.length);
    
    if (!parentTasks || parentTasks.length === 0) {
        console.error('‚ùå No parent tasks found');
        showNotification('Task tracker not found', 'error');
        return;
    }
    
    // Use first parent's key to open combined view
    const firstParent = parentTasks[0];
    const taskKey = firstParent.firebaseKey || firstParent.id;
    
    console.log(`‚úÖ Opening ALL tasks for: ${equipment}`);
    console.log(`   Using key: ${taskKey} (${firstParent.disc})`);
    console.log(`   Total: ${parentTasks.length} disciplines, ${data.tasks.length} tasks`);
    
    if (typeof openTaskTracker === 'function') {
        openTaskTracker(taskKey);
    } else {
        console.error('‚ùå openTaskTracker function not available');
        showNotification('Task tracker function not available', 'error');
    }
}

// ‚úÖ NEW - Toggle dropdown menu
function toggleTaskDropdown(event, equipmentId) {
    event.stopPropagation();
    
    const normalizedId = normalizeEquipmentId(equipmentId);
    const data = vmEquipmentData[normalizedId];
    const dropdownId = 'dropdown-' + equipmentId.replace(/[^a-zA-Z0-9]/g, '_');
    const dropdown = document.getElementById(dropdownId);
    
    if (!dropdown) {
        console.error('Dropdown not found:', dropdownId);
        return;
    }
    
    // ‚úÖ Get parent elements
    const splitButton = dropdown.closest('.split-button');
    const card = dropdown.closest('.vm-equipment-card'); // ‚úÖ ADD THIS
    
    // Close all other dropdowns first
    document.querySelectorAll('.task-dropdown-menu').forEach(d => {
        if (d.id !== dropdownId) {
            d.classList.remove('show');
            const otherParent = d.closest('.split-button');
            if (otherParent) otherParent.classList.remove('dropdown-open');
            // ‚úÖ ADD - Remove from other cards
            const otherCard = d.closest('.vm-equipment-card');
            if (otherCard) otherCard.classList.remove('dropdown-active');
        }
    });
    
    // Toggle current dropdown
    const isShowing = dropdown.classList.contains('show');
    
    if (!isShowing) {
        // Populate dropdown content
        populateTaskDropdown(dropdown, equipmentId, data);
        dropdown.classList.add('show');
        if (splitButton) splitButton.classList.add('dropdown-open');
        if (card) card.classList.add('dropdown-active'); // ‚úÖ ADD THIS
    } else {
        dropdown.classList.remove('show');
        if (splitButton) splitButton.classList.remove('dropdown-open');
        if (card) card.classList.remove('dropdown-active'); // ‚úÖ ADD THIS
    }
}

// ‚úÖ NEW - Populate dropdown with discipline options
function populateTaskDropdown(dropdown, equipmentId, data) {
    const equipment = data.equipment;
    const parentTasks = projectData.filter(t => 
        normalizeEquipmentId(t.equipment) === normalizeEquipmentId(equipment)
    );
    
    let html = '';
    
    // Total count header (non-clickable - informational only)
    html += `
        <div class="dropdown-header" style="padding: 10px; background: #f8f9fa; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #3498db; cursor: default;">
            üìä Total: ${data.tasks.length} tasks across ${parentTasks.length} groups
        </div>
    `;
    
    // Individual discipline options (clickable)
    if (parentTasks.length > 0) {
        parentTasks.forEach(parent => {
            const disc = parent.disc;
            const firebaseKey = parent.firebaseKey || parent.id;
            const discTasks = onsiteTasks[firebaseKey] || [];
            
            // ‚úÖ Use taskName first (task field contains "custom")
            const taskName = parent.taskName || parent.task || '';
            const taskSnippet = taskName && taskName !== 'custom' ? 
                (taskName.length > 35 ? taskName.substring(0, 35) + '...' : taskName) : 
                '';
            
            // Display format: "ME-CI - Task name... (5 tasks)"
            const displayText = taskSnippet ? `${disc} - ${taskSnippet}` : disc;
            
            html += `
                <div class="dropdown-item" onclick="openSpecificTaskFromVM('${equipmentId}', '${disc}', '${firebaseKey}'); closeAllTaskDropdowns();">
                    ${displayText}
                    <span class="dropdown-item-count">${discTasks.length} tasks</span>
                </div>
            `;
        });
    }
    
    dropdown.innerHTML = html;
}

// ‚úÖ NEW - Open specific discipline task tracker
function openSpecificTaskFromVM(equipmentId, disc, firebaseKey) {
    console.log('üîç openSpecificTaskFromVM called');
    console.log('   Equipment:', equipmentId);
    console.log('   Discipline:', disc);
    console.log('   Firebase Key:', firebaseKey);
    
    if (!firebaseKey) {
        console.error('‚ùå No firebase key provided');
        showNotification('Invalid task reference', 'error');
        return;
    }
    
    console.log(`‚úÖ Opening ${disc} tasks for: ${equipmentId}`);
    
    if (typeof openTaskTracker === 'function') {
        openTaskTracker(firebaseKey);
    } else {
        console.error('‚ùå openTaskTracker function not available');
        showNotification('Task tracker function not available', 'error');
    }
}

// ‚úÖ RENAME - Avoid conflict with main table closeAllDropdowns
function closeAllTaskDropdowns() {
    document.querySelectorAll('.task-dropdown-menu').forEach(dropdown => {
        dropdown.classList.remove('show');
        const parent = dropdown.closest('.split-button');
        if (parent) parent.classList.remove('dropdown-open');
        // ‚úÖ ADD - Remove from cards
        const card = dropdown.closest('.vm-equipment-card');
        if (card) card.classList.remove('dropdown-active');
    });
}

// ‚úÖ NEW - Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.split-button')) {
        closeAllTaskDropdowns();
    }
});

// Open Generate Progress Report for equipment from VM
function openProgressReportFromVM(equipmentId) {
    // ‚úÖ FIX 1: Normalize equipment ID
    const normalizedId = normalizeEquipmentId(equipmentId);
    const data = vmEquipmentData[normalizedId];
    
    if (!data) {
        showNotification('Equipment data not found', 'error');
        return;
    }
    
    const equipment = data.equipment;
    
    // ‚úÖ FIX 2: Find ALL parent tasks (not just first one)
    const parentTasks = projectData.filter(t => 
        normalizeEquipmentId(t.equipment) === normalizeEquipmentId(equipment)
    );
    
    if (!parentTasks || parentTasks.length === 0) {
        showNotification('Equipment not found in project data', 'error');
        return;
    }
    
    console.log(`üìÑ Opening Generate Progress Report for: ${equipment} (${parentTasks.length} groups)`);
    
    // Use first parent for base info
    const firstParent = parentTasks[0];
    
    // Set as current equipment for report
    currentEquipmentTasks = {
        equipment: firstParent
    };
    
    // Open report modal
    const reportModal = document.getElementById('reportModal');
    if (!reportModal) {
        showNotification('Report modal not found', 'error');
        return;
    }
    
    reportModal.style.display = 'block';
    
    // ‚úÖ FIX 3: Use openProgressReportModal if exists
    if (typeof openProgressReportModal === 'function') {
        openProgressReportModal();
    } else {
        // Manual trigger
        const equipmentName = equipment || '';
        
        // Extract base equipment name for report
        let baseName = '';
        const afterParens = equipmentName.match(/\)\s*([A-Z0-9\-]+)/);
        if (afterParens) {
            baseName = afterParens[1].trim();
        } else {
            const inParens = equipmentName.match(/\(([^)]+)\)/);
            if (inParens) {
                baseName = inParens[1].replace(/\s+[A-Z]+$/g, '').trim();
            } else {
                baseName = equipmentName.trim();
            }
        }
        
        // Set base name
        const reportBaseInput = document.getElementById('reportEquipmentBase');
        if (reportBaseInput) {
            reportBaseInput.value = baseName;
        }
        
        // Set today's date
        const reportDateInput = document.getElementById('reportDate');
        if (reportDateInput) {
            const today = new Date().toISOString().split('T')[0];
            reportDateInput.value = today;
        }
        
        // ‚úÖ FIX 4: Populate related groups with ALL parent tasks
        if (typeof populateRelatedGroups === 'function') {
            populateRelatedGroups(baseName);
        }
    }
}

// Open dialog to add equipment
function openAddEquipmentDialog() {
    const dialog = document.getElementById('addEquipmentDialog');
    if (!dialog) return;
    
    dialog.style.display = 'flex';
    
    // Populate equipment list
    populateEquipmentList();
}

// Populate available equipment list - using Group Equipment logic
// Populate available equipment list - using EQUIPMENT ONLY (no vendor split)
function populateEquipmentList() {
    const listContainer = document.getElementById('vmEquipmentList');
    if (!listContainer) return;
    
    listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #95a5a6;">Loading equipment...</div>';
    
    if (!projectData || projectData.length === 0) {
        listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">No project data loaded</div>';
        return;
    }
    
    // Group by EQUIPMENT and count ACTUAL subtasks
    const equipmentMap = new Map();
    
    projectData.forEach(item => {
        const equipment = item.equipment || 'Unknown';
        
        if (!equipmentMap.has(equipment)) {
            equipmentMap.set(equipment, {
                equipment: equipment,
                vendors: new Set(),
                parentCount: 0,
                subtaskCount: 0  // ‚úÖ ADD: Count actual subtasks
            });
        }
        
        const group = equipmentMap.get(equipment);
        group.vendors.add(item.vendor || 'Unknown');
        group.parentCount++;
        
        // ‚úÖ ADD: Count subtasks from onsiteTasks
        const firebaseKey = item.firebaseKey || item.id;
        const subtasks = onsiteTasks[firebaseKey] || [];
        group.subtaskCount += subtasks.length;
    });
    
    // Convert to array and sort
    const groupArray = Array.from(equipmentMap.values()).sort((a, b) => {
        return a.equipment.localeCompare(b.equipment);
    });
    
    if (groupArray.length === 0) {
        listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #95a5a6;">No equipment found</div>';
        return;
    }
    
    // Render list
    listContainer.innerHTML = '';
    
    groupArray.forEach((group, index) => {
        const equipmentId = group.equipment;
        
        // ‚úÖ FIX: Check if already selected AND has tasks
        const isSelected = vmSettings.selectedEquipment.includes(equipmentId) && 
                           vmEquipmentData[equipmentId] && 
                           vmEquipmentData[equipmentId].tasks && 
                           vmEquipmentData[equipmentId].tasks.length > 0;
        
        // ‚úÖ FIX: Disable if no subtasks
        const hasNoTasks = group.subtaskCount === 0;
        const isDisabled = isSelected || hasNoTasks;
        
        const vendorList = Array.from(group.vendors).join(', ');
        
        const item = document.createElement('div');
        item.className = 'vm-equipment-item';
        
        // ‚úÖ FIX: Style differently if disabled due to no tasks
        if (hasNoTasks && !isSelected) {
            item.style.opacity = '0.5';
            item.style.background = '#f8f9fa';
        }
        
        item.innerHTML = `
            <input type="checkbox" 
                   id="vm_eq_${index}" 
                   ${isDisabled ? 'disabled' : ''} 
                   ${isSelected ? 'checked' : ''}
                   data-equipment="${group.equipment}"
                   data-equipmentid="${equipmentId}">
            <div class="vm-equipment-item-info">
                <div class="vm-equipment-item-name">${group.equipment}</div>
                <div class="vm-equipment-item-meta">
                    ${vendorList} | ${group.subtaskCount} task${group.subtaskCount !== 1 ? 's' : ''}
                    ${isSelected ? ' | ‚úÖ Already added' : ''}
                    ${hasNoTasks && !isSelected ? ' | ‚ö†Ô∏è No data available' : ''}
                </div>
            </div>
        `;
        
        listContainer.appendChild(item);
    });
    
    console.log(`‚úÖ Found ${groupArray.length} equipment groups`);
}

// Add selected equipment in batch
function addSelectedEquipmentBatch() {
    const checkboxes = document.querySelectorAll('#vmEquipmentList input[type="checkbox"]:checked:not([disabled])');
    
    if (checkboxes.length === 0) {
        showNotification('Please select at least one equipment', 'error');
        return;
    }
    
    let addedCount = 0;
    const promises = [];
    
    checkboxes.forEach(checkbox => {
        const equipmentId = checkbox.dataset.equipmentid;
        
        // Add to selected list if not already there
        if (!vmSettings.selectedEquipment.includes(equipmentId)) {
            vmSettings.selectedEquipment.push(equipmentId);
            addedCount++;
            
            // Load data for this equipment
            promises.push(loadSingleEquipmentDataPromise(equipmentId));
        }
    });
    
    if (addedCount === 0) {
        showNotification('All selected equipment already added', 'info');
        document.getElementById('addEquipmentDialog').style.display = 'none';
        return;
    }
    
    // Save settings
    saveVMSettings();
    
    // Wait for all data to load
    Promise.all(promises).then(() => {
        applyVMSettings();
        renderVMCards();
        showNotification(`Added ${addedCount} equipment`, 'success');
        document.getElementById('addEquipmentDialog').style.display = 'none';
    });
}

// Load data for single equipment (for real-time add)
// Load data for single equipment - returns promise
// Load data for single equipment - returns promise
// Helper: Normalize equipment ID (remove non-breaking spaces)
function normalizeEquipmentId(id) {
    if (!id) return id;
    // Replace non-breaking space (char code 160) with normal space (32)
    return id.replace(/\u00A0/g, ' ').trim();
}

function loadSingleEquipmentDataPromise(equipmentId) {
    return new Promise((resolve) => {
        // ‚úÖ FIX 1: Normalize equipment ID to handle NBSP
        const equipment = normalizeEquipmentId(equipmentId);
        
        console.log(`üîÑ Loading data for ${equipment}...`);
        
        const allTasks = [];
        
        // Get ALL tasks matching this equipment (all vendors)
        const matchingParents = projectData.filter(task => {
            // ‚úÖ FIX 2: Normalize task.equipment too for comparison
            return normalizeEquipmentId(task.equipment) === equipment;
        });
        
        // Get subtasks
        matchingParents.forEach(parentTask => {
            const firebaseKey = parentTask.firebaseKey || parentTask.id;
            const subtasks = onsiteTasks[firebaseKey] || [];
            
            if (subtasks.length > 0) {
                // Has subtasks - add them with parent info
                subtasks.forEach(subtask => {
                    allTasks.push({
                        ...subtask,
                        equipment: parentTask.equipment,
                        disc: parentTask.disc,
                        vendor: parentTask.vendor,
                        parentTask: parentTask.task || parentTask.taskName
                    });
                });
            }
        });
        
        // Collect all unique vendors
        const vendors = [...new Set(allTasks.map(t => t.vendor))];
        const vendorText = vendors.join(', ');
        
        // Load report settings
        const sanitizedId = equipment.replace(/[.#$[\]()]/g, '_').replace(/\s+/g, '_');
        database.ref(`reportSettings/${sanitizedId}`).once('value').then(reportSnap => {
            const reportData = reportSnap.val() || {};
            
            // ‚úÖ FIX 3: Store with NORMALIZED key
            vmEquipmentData[equipment] = {
                equipment: equipment,
                vendor: vendorText,
                tasks: allTasks,
                highlights: reportData.highlights || '',
                actionPlan: reportData.actionPlan || '',
                milestones: reportData.milestones || []
            };
            
            console.log(`‚úÖ Loaded ${allTasks.length} tasks for ${equipment} (${vendorText})`);
            resolve();
        }).catch(error => {
            // ‚úÖ FIX 4: Store with NORMALIZED key (error case too)
            vmEquipmentData[equipment] = {
                equipment: equipment,
                vendor: vendorText,
                tasks: allTasks,
                highlights: '',
                actionPlan: '',
                milestones: []
            };
            resolve();
        });
    });
}
// Close add equipment dialog
function closeAddEquipmentDialog() {
    const dialog = document.getElementById('addEquipmentDialog');
    if (dialog) {
        dialog.style.display = 'none';
    }
}

// Filter equipment list by search
function filterVMEquipmentList() {
    const searchInput = document.getElementById('vmEquipmentSearch');
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const items = document.querySelectorAll('.vm-equipment-item');
    
    items.forEach(item => {
        const name = item.querySelector('.vm-equipment-item-name').textContent.toLowerCase();
        item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
    });
}

// Open settings dialog
function openVMSettings() {
    const dialog = document.getElementById('vmSettingsDialog');
    if (dialog) {
        dialog.style.display = 'flex';
        applyVMSettings(); // Sync current settings to form
    }
}

// Close settings dialog
function closeVMSettings() {
    const dialog = document.getElementById('vmSettingsDialog');
    if (dialog) {
        dialog.style.display = 'none';
    }
}

// Update layout when settings change
function updateVMLayout() {
    // Get values from form
    vmSettings.layout = parseInt(document.getElementById('vmLayoutSelect').value);
    vmSettings.maxRows = parseInt(document.getElementById('vmMaxRowsSelect').value);
    
    vmSettings.displayOptions.showVendor = document.getElementById('vmShowVendor').checked;
    vmSettings.displayOptions.showMilestone = document.getElementById('vmShowMilestone').checked;
    vmSettings.displayOptions.showHighlight = document.getElementById('vmShowHighlight').checked;
    vmSettings.displayOptions.showSPI = document.getElementById('vmShowSPI').checked;
    
    // Apply changes
    applyVMSettings();
    renderVMCards();
    
    // Save to Firebase
    saveVMSettings();
}

// Remove equipment from visual management
function removeEquipmentFromVM(equipmentId) {
    const data = vmEquipmentData[equipmentId];
    const equipmentName = data ? data.equipment : equipmentId;
    
    if (!confirm(`Remove ${equipmentName} from Visual Management?`)) {
        return;
    }
    
    // Remove from selected list
    vmSettings.selectedEquipment = vmSettings.selectedEquipment.filter(eq => eq !== equipmentId);
    
    // Remove from data cache
    delete vmEquipmentData[equipmentId];
    
    // Save settings
    saveVMSettings();
    
    // Re-render
    applyVMSettings();
    renderVMCards();
    
    showNotification(`Removed ${equipmentName}`, 'success');
}


// Open task tracker for equipment
// Open task tracker for equipment
function openTaskTrackerFromVM(equipmentId) {
    // ‚úÖ DEPRECATED - Redirect to new dropdown-based function
    console.warn('‚ö†Ô∏è openTaskTrackerFromVM is deprecated, use openAllTasksFromVM instead');
    openAllTasksFromVM(equipmentId);
}

// Generate report for equipment
// Generate report for equipment
function generateReportFromVM(equipmentId) {
    const data = vmEquipmentData[equipmentId];
    
    if (!data) {
        showNotification('Equipment data not found', 'error');
        return;
    }
    
    // Find first parent task
    const equipment = data.equipment;
    
    const parentTask = projectData.find(t => t.equipment === equipment);
    
    if (!parentTask) {
        showNotification('Equipment not found', 'error');
        return;
    }
    
    // Set as current equipment tasks
    currentEquipmentTasks = {
        equipment: parentTask
    };
    
    console.log('üìÑ Opening report for:', equipment);
    
    // Open report modal
    if (typeof openProgressReportModal === 'function') {
        openProgressReportModal();
    } else {
        showNotification('Report function not available', 'error');
    }
}

// üëáüëáüëá TAMBAHKAN FUNCTION BARU DI SINI (SETELAH LINE 6833) üëáüëáüëá

function updateGroupTableHeader() {
    const headerRow = document.querySelector('.data-table thead tr');
    if (!headerRow) return;
    
    // ‚úÖ MODE NORMAL: Header 16 kolom lengkap
    if (!window.isGroupedView) {
        headerRow.innerHTML = `
            <th style="width:3%;">No</th>
            <th style="width:5%;">Priority</th>
            <th style="width:12%;">Equipment</th>
            <th style="width:8%;">Vendor</th>
            <th style="width:4%;">Disc</th>
            <th style="width:15%;">Task Name</th>
            <th style="width:8%;">Status</th>
            <th style="width:6%;">Contract</th>
            <th style="width:5%;">VISA</th>
            <th style="width:6%;">Target Date</th>
            <th style="width:6%;">MOB Date</th>
            <th style="width:6%;">Date Status</th>
            <th style="width:6%;">Target Comp</th>
            <th style="width:6%;">Prognosa</th>
            <th style="width:4%;">Progress</th>
            <th style="width:10%;">Actions</th>
        `;
        return;
    }
    
    // ‚úÖ MODE GROUP: Check if any group is expanded
    const hasExpandedGroup = document.querySelector('.equipment-group-row:not(.collapsed)');
    
    if (hasExpandedGroup) {
        // üëá GROUP EXPANDED: Header 16 kolom (cocok dengan child rows)
        headerRow.innerHTML = `
            <th style="width:3%;">No</th>
            <th style="width:5%;">Priority</th>
            <th style="width:12%;">Equipment</th>
            <th style="width:8%;">Vendor</th>
            <th style="width:4%;">Disc</th>
            <th style="width:15%;">Task Name</th>
            <th style="width:8%;">Status</th>
            <th style="width:6%;">Contract</th>
            <th style="width:5%;">VISA</th>
            <th style="width:6%;">Target Date</th>
            <th style="width:6%;">MOB Date</th>
            <th style="width:6%;">Date Status</th>
            <th style="width:6%;">Target Comp</th>
            <th style="width:6%;">Prognosa</th>
            <th style="width:4%;">Progress</th>
            <th style="width:10%;">Actions</th>
        `;
    } else {
        // üëá GROUP COLLAPSED: Header 5 kolom sederhana
        headerRow.innerHTML = `
            <th style="width:3%;">No</th>
            <th style="width:35%;">Equipment</th>
            <th style="width:20%;">Vendor</th>
            <th style="width:22%;">Phase Status</th>
            <th style="width:20%;">Overall Progress</th>
        `;
    }
}




// üëÜüëÜüëÜ SAMPAI SINI üëÜüëÜüëÜ

window.toggleGroupedView = toggleGroupedView;
window.toggleGroup = toggleGroup;
window.updateGroupTableHeader = updateGroupTableHeader;  // üëà TAMBAH INI
// Auto-migrate to weighted progress (one-time)
window.addEventListener('load', function() {
    const migrated = localStorage.getItem('progressMigrated_v2');
    if (!migrated) {
        setTimeout(function() {
            console.log('üîÑ First-time migration to weighted progress...');
            recalculateAllProgress();
            localStorage.setItem('progressMigrated_v2', 'true');
        }, 3000);
    }
});

// ========== INITIALIZE VISUAL MANAGEMENT ==========
// Load VM settings on page load (no auth required)
window.addEventListener('load', function() {
    loadVMSettings();
});

    </script>

    <!-- Footer -->
    <div style="background: #2c3e50; color: white; text-align: center; padding: 20px; margin-top: 30px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
        <p style="margin: 0; font-size: 13px; font-weight: 600; letter-spacing: 0.5px;">Developed by TS-KPB</p>
        <p style="margin: 8px 0 0 0; font-size: 10px; opacity: 0.7;">¬© 2025 All Rights Reserved</p>
    </div>

</body>
</html>
