<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Vendor Mobilization Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            padding: 20px;
            min-height: 100vh;
            font-size: 14px;
            color: #2c3e50;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #34495e;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .stats-overview {
            background: #ecf0f1;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-top: 4px solid;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card.total { border-top-color: #3498db; }
        .stat-card.belum-onsite { border-top-color: #e74c3c; }
        .stat-card.sudah-onsite { border-top-color: #27ae60; }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .stat-breakdown {
            font-size: 11px;
            color: #95a5a6;
            line-height: 1.4;
        }

        .filter-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #bdc3c7;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #34495e;
            color: white;
            border-color: #34495e;
        }

        .filter-btn:hover {
            border-color: #34495e;
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            padding: 20px;
        }

        .main-table-section {
            background: white;
            min-width: 0;
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            width: 250px;
            font-size: 12px;
        }

        .search-box:focus {
            outline: none;
            border-color: #3498db;
        }

        .add-item-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-add {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-add:hover {
            background: #229954;
            transform: translateY(-1px);
        }

        .btn-export {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-export:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 5px;
        }

        .btn-delete:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .data-table-container {
            overflow-x: auto;
            border: 1px solid #ecf0f1;
            border-radius: 4px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            table-layout: fixed;
        }

        .data-table th {
            background: #34495e;
            color: white;
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            font-size: 9px;
            white-space: nowrap;
        }

        .data-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: top;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr.priority-1st {
            background: #fdf2f2;
        }

        .data-table tr.priority-2nd {
            background: #fefbf3;
        }

        .data-table tr.priority-3rd {
            background: #f0f9f0;
        }

        .data-table tr.priority-OSBL {
            background: #f0f4ff;
        }

        .status-badge {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
            min-width: 50px;
            text-align: center;
            white-space: nowrap;
        }

        .status-done { background: #d5f4e6; color: #1e6937; }
        .status-ongoing { background: #fff3cd; color: #8a6d3b; }
        .status-issue { background: #f8d7da; color: #721c24; }
        .status-waiting { background: #d1ecf1; color: #0c5460; }
        .status-onsite { background: #d4edda; color: #155724; }
        .status-ontime { background: #d4edda; color: #155724; }
        .status-delayed { background: #f8d7da; color: #721c24; }

        .priority-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            color: white;
        }

        .priority-1st { background: #dc3545; }
        .priority-2nd { background: #fd7e14; }
        .priority-3rd { background: #198754; }
        .priority-OSBL { background: #0d6efd; }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sidebar-section {
            background: white;
            border-radius: 6px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 5px;
        }

        .timeline-item {
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
            font-size: 11px;
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .progress-bar {
            width: 60px;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            margin-left: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s ease;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background: #3498db;
            color: white;
        }

        .action-btn.success {
            background: #27ae60;
            color: white;
        }

        .action-btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 25px;
            border-radius: 8px;
            width: 600px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 15px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .close:hover {
            color: #000;
            background-color: #f0f0f0;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 13px;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            font-size: 12px;
            z-index: 1001;
            opacity: 0;
            transform: translateX(300px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: #27ae60;
        }

        .notification.error {
            background: #e74c3c;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status.connected {
            background: #27ae60;
            color: white;
        }

        .connection-status.disconnected {
            background: #e74c3c;
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                max-width: 400px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .search-box {
                width: 100%;
            }

            .table-header {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        <span class="status-dot"></span>
        <span id="statusText">Connecting...</span>
    </div>

    <div class="dashboard-container">
        <div class="header">
    <h1>RFCC VENDOR MOBILIZATION TRACKING</h1>
    <div style="display: flex; justify-content: center; align-items: center; position: relative;">
        <div class="subtitle">Real-time Multi-User Dashboard</div>
        <div style="position: absolute; right: 20px; font-size: 12px; background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px;">
            👥 Online Users: <span id="onlineCount" style="font-weight: bold;">0</span>
        </div>
    </div>
</div>

        <div class="stats-overview">
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total Items</div>
                    <div class="filter-controls">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="1st">1st</button>
                        <button class="filter-btn" data-filter="2nd">2nd</button>
                        <button class="filter-btn" data-filter="3rd">3rd</button>
                        <button class="filter-btn" data-filter="OSBL">OSBL</button>
                    </div>
                </div>

                <div class="stat-card belum-onsite">
                    <div class="stat-number" id="belumOnsiteCount">0</div>
                    <div class="stat-label">Not Onsite</div>
                    <div class="stat-breakdown">
                        <div style="cursor: pointer;" onclick="filterByIssueType('contract')">
                            Contract Issues: <span id="contractIssueCount">0</span>
                        </div>
                        <div style="cursor: pointer;" onclick="filterByIssueType('payment')">
                            Payment Issues: <span id="paymentIssueCount">0</span>
                        </div>
                        <div style="cursor: pointer;" onclick="filterByIssueType('visa')">
                            VISA Processing: <span id="visaProcessingCount">0</span>
                        </div>
                    </div>
                </div>

                <div class="stat-card sudah-onsite">
                    <div class="stat-number" id="sudahOnsiteCount">0</div>
                    <div class="stat-label">Already Onsite</div>
                    <div class="stat-breakdown">
                        <div>In Progress: <span id="inProgressCount">0</span></div>
                        <div>Completed: <span id="completedCount">0</span></div>
                        <div style="color: #27ae60;">On Time: <span id="onTimeCount">0</span></div>
                        <div style="color: #e74c3c;">Delayed: <span id="delayedCount">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="main-table-section">
                <div class="table-header">
                    <h2 class="table-title">Detailed Task List</h2>
                    <div class="add-item-container">
                        <button class="btn-add" id="addItemBtn">+ Add New Item</button>
                        <button class="btn-export" id="exportBtn">Export PDF</button>
                        <input type="text" class="search-box" placeholder="Search equipment, vendor, or task..." id="searchBox">
                    </div>
                </div>

                <div class="data-table-container">
                    <table class="data-table" id="mainDataTable">
                        <thead>
                            <tr>
                                <th style="width: 3%;">No</th>
                                <th style="width: 5%;">Priority</th>
                                <th style="width: 19%;">Equipment</th>
                                <th style="width: 9%;">Vendor</th>
                                <th style="width: 4%;">Disc</th>
                                <th style="width: 9%;">Status</th>
                                <th style="width: 7%;">Contract</th>
                                <th style="width: 5%;">VISA</th>
                                <th style="width: 7%;">Target MOB<br>Date</th>
                                <th style="width: 6%;">MOB Date</th>
                                <th style="width: 8%;">Date Status</th>
                                <th style="width: 6%;">Progress</th>
                                <th style="width: 12%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Recent Updates</h3>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Filter by Equipment:</label>
                        <select id="equipmentHistoryFilter" style="width: 100%; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 11px;" onchange="filterEquipmentHistory()">
                            <option value="all">All Equipment</option>
                        </select>
                    </div>
                    <div id="historyContainer" style="max-height: 400px; overflow-y: auto;">
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="action-btn primary" id="showAllHistoryBtn" style="flex: 1; font-size: 10px;">Show All History</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">Upcoming Mobilizations</h3>
                    <div class="timeline-item">
                        <strong>Sep 30, 2025</strong><br>
                        Payment target for multiple vendors
                    </div>
                    <div class="timeline-item">
                        <strong>Oct 1, 2025</strong><br>
                        Baker Hughes STD Compressor mobilization
                    </div>
                    <div class="timeline-item">
                        <strong>Oct 6, 2025</strong><br>
                        EETC-RSA UPS SAT
                    </div>
                    <div class="timeline-item">
                        <strong>Oct 7, 2025</strong><br>
                        BELCO Flue Gas Scrubber mobilization
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="sidebar-title">Critical Issues</h3>
                    <div style="background: #fdf2f2; padding: 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;" onclick="filterByIssueType('contract')">
                        <strong>Contract Delays</strong><br>
                        <span id="criticalContract">0</span> items waiting quotation or contract review
                    </div>
                    <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;" onclick="filterByIssueType('visa')">
                        <strong>VISA Bottleneck</strong><br>
                        <span id="criticalVisa">0</span> items in VISA processing queue
                    </div>
                    <div style="background: #f8d7da; padding: 8px; border-radius: 4px; cursor: pointer;" onclick="filterByIssueType('payment')">
                        <strong>Payment Issues</strong><br>
                        <span id="criticalPayment">0</span> vendors awaiting AP invoice processing
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="updateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Task</h3>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Equipment:</label>
                    <input type="text" id="modalEquipment" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Vendor:</label>
                    <input type="text" id="modalVendor" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority:</label>
                    <select id="modalPriority" class="form-control">
                        <option value="1st">1st Start-up</option>
                        <option value="2nd">2nd Start-up</option>
                        <option value="3rd">3rd Start-up</option>
                        <option value="OSBL">OSBL</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Task Type:</label>
                    <select id="modalTask" class="form-control">
                        <option value="CI">CI</option>
                        <option value="COM">COM</option>
                        <option value="ME">ME</option>
                        <option value="EL">EL</option>
                        <option value="CI/COM">CI/COM</option>
                        <option value="COM-EL">COM-EL</option>
                        <option value="COM-ME">COM-ME</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status:</label>
                    <select id="modalStatus" class="form-control">
                        <option value="Contract Issue">Contract Issue</option>
                        <option value="Payment Issue">Payment Issue</option>
                        <option value="VISA Processing">VISA Processing</option>
                        <option value="Contract Review">Contract Review</option>
                        <option value="Ready">Ready for Mobilization</option>
                        <option value="Onsite Working">Onsite Working</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Contract Status:</label>
                    <select id="modalContract" class="form-control">
                        <option value="Quotation">Waiting Quotation</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Reviewing">Reviewing</option>
                        <option value="Ongoing">Ongoing</option>
                        <option value="Waiting AP">Waiting AP Invoice</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">VISA Status:</label>
                    <select id="modalVisa" class="form-control">
                        <option value="Not Applied">Not Applied</option>
                        <option value="Processing">Processing</option>
                        <option value="Ongoing">Ongoing</option>
                        <option value="Local">Local</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Target MOB Date:</label>
                    <input type="date" id="modalTargetDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Mobilization Date:</label>
                    <input type="date" id="modalMobDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Progress (%):</label>
                    <input type="number" id="modalProgress" class="form-control" min="0" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes:</label>
                    <textarea id="modalNotes" class="form-control" rows="3" placeholder="Add notes about this task..."></textarea>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="saveButton">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        // IMPORTANT: Replace with your own Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD8JTPzLD2Dp6yWM2Bepjh81mwIp9f0MRM",
  authDomain: "rfcc-dashboard.firebaseapp.com",
  databaseURL: "https://rfcc-dashboard-default-rtdb.firebaseio.com",
  projectId: "rfcc-dashboard",
  storageBucket: "rfcc-dashboard.firebasestorage.app",
  messagingSenderId: "951098160331",
  appId: "1:951098160331:web:6f14f05cb05c9d2ef7574e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Database references
        const projectDataRef = database.ref('projectData');
        const activityHistoryRef = database.ref('activityHistory');

// ===== SIMPLE ONLINE USER COUNTER =====
const myConnectionsRef = database.ref('onlineUsers').push();

const connectedRefCounter = database.ref('.info/connected');
connectedRefCounter.on('value', (snap) => {
    if (snap.val() === true) {
        myConnectionsRef.set(true);
        myConnectionsRef.onDisconnect().remove();
    }
});

database.ref('onlineUsers').on('value', (snapshot) => {
    const count = snapshot.numChildren();
    const counterElement = document.getElementById('onlineCount');
    if (counterElement) {
        counterElement.textContent = count;
    }
});


        // Local state
        let projectData = [];
        let activityHistory = [];
        let currentEditId = null;
        let currentFilter = 'all';

        // Connection monitoring
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (snap.val() === true) {
                statusElement.className = 'connection-status connected';
                statusText.textContent = 'Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusText.textContent = 'Disconnected';
            }
        });

    // ===== FIREBASE REAL-TIME LISTENERS =====
    
    // Listen for project data changes
    projectDataRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            projectData = Object.keys(data).map(key => ({
                firebaseKey: key,
                ...data[key]
            }));
        } else {
            projectData = [];
        }
        populateTable();
        updateStats();
    });

    // Listen for activity history changes
    activityHistoryRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            activityHistory = Object.keys(data).map(key => ({
                firebaseKey: key,
                ...data[key]
            })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } else {
            activityHistory = [];
        }
        populateEquipmentHistoryFilter();
        filterEquipmentHistory();
    });

    // ===== INITIALIZATION =====
   document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    
    projectDataRef.once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            if (confirm('Database is empty. Would you like to initialize with sample data?')) {
                initializeSampleData();
            }
        }
    });
});

    function initializeSampleData() {
        const sampleData = [
            { id: 1, no: 1, priority: "2nd", equipment: "Air Blower Expander (K-052-02)", vendor: "MAN-RMS", task: "CI", status: "Contract Issue", contract: "Quotation", visa: "Not Applied", targetDate: "2025-10-25", mobDate: "End Oct", progress: 0 },
            { id: 2, no: 2, priority: "2nd", equipment: "Air Blower Anti-surge (K-052-01)", vendor: "MAN-Honeywell", task: "CI", status: "Contract Issue", contract: "Quotation", visa: "Not Applied", targetDate: "2025-11-01", mobDate: "Early Nov", progress: 0 },
            { id: 3, no: 3, priority: "2nd", equipment: "WGC Compressor I-SAT (K-052-03)", vendor: "EETC", task: "CI", status: "Payment Issue", contract: "Ongoing", visa: "Not Applied", targetDate: "2025-10-10", mobDate: "Oct 15", progress: 0 },
            { id: 4, no: 4, priority: "2nd", equipment: "WGC Compressor Control (K-052-03)", vendor: "EETC", task: "COM", status: "Payment Issue", contract: "Waiting AP", visa: "Not Applied", targetDate: "2025-10-10", mobDate: "Oct 15", progress: 0 },
            { id: 5, no: 5, priority: "2nd", equipment: "Flue Gas Scrubber", vendor: "BELCO", task: "CI", status: "VISA Processing", contract: "Done", visa: "Processing", targetDate: "2025-10-05", mobDate: "Oct 7", progress: 0 }
        ];

        sampleData.forEach(item => {
            projectDataRef.push(item);
        });

        activityHistoryRef.push({
            id: 1,
            timestamp: new Date().toISOString(),
            type: 'system',
            category: 'SYSTEM',
            title: 'Database Initialized',
            equipmentId: null,
            equipment: 'System',
            vendor: 'System',
            description: 'Sample data loaded successfully',
            notes: 'Database initialized with sample project data',
            user: 'System',
            icon: '🎉',
            color: '#3498db'
        });

        showNotification('Sample data initialized successfully!', 'success');
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                filterByPriority(this.getAttribute('data-filter'));
            });
        });

        const searchBox = document.getElementById('searchBox');
        if (searchBox) searchBox.addEventListener('keyup', searchTable);

        const addItemBtn = document.getElementById('addItemBtn');
        const exportBtn = document.getElementById('exportBtn');
        const showHistoryBtn = document.getElementById('showAllHistoryBtn');
        const closeModalBtn = document.getElementById('closeModal');
        const saveButton = document.getElementById('saveButton');
        
        if (addItemBtn) addItemBtn.addEventListener('click', openAddModal);
        if (exportBtn) exportBtn.addEventListener('click', exportToPDF);
        if (showHistoryBtn) showHistoryBtn.addEventListener('click', () => showNotification('Full history modal coming soon!', 'success'));
        if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
        if (saveButton) saveButton.addEventListener('click', saveUpdate);

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('updateModal');
            if (event.target === modal) {
                closeModal();
            }
        });
    }

    // ===== UTILITY FUNCTIONS =====
    function getDateStatus(targetDate, mobDate) {
        if (!targetDate || !mobDate) return { status: '-', class: '' };
        
        const target = new Date(targetDate);
        const mob = new Date(parseDateString(mobDate));
        
        if (mob <= target) {
            return { status: 'ON TIME', class: 'status-ontime' };
        } else {
            const diffDays = Math.ceil((mob - target) / (1000 * 60 * 60 * 24));
            return { status: `DELAYED ${diffDays}d`, class: 'status-delayed' };
        }
    }

    function parseDateString(dateStr) {
        if (!dateStr) return null;
        
        if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return dateStr;
        }
        
        const monthMap = {
            'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
            'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
            'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
        };
        
        const currentYear = new Date().getFullYear();
        const monthMatch = dateStr.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
        const dayMatch = dateStr.match(/\b(\d{1,2})\b/);
        
        if (monthMatch && dayMatch) {
            const month = monthMap[monthMatch[0]];
            const day = dayMatch[0].padStart(2, '0');
            return `${currentYear}-${month}-${day}`;
        }
        
        return null;
    }

    function formatDateForDisplay(dateValue) {
        if (!dateValue) return 'TBD';
        
        const date = new Date(dateValue);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        const month = monthNames[date.getMonth()];
        const day = date.getDate();
        
        return `${month} ${day}`;
    }

    function formatDateForInput(dateString) {
        if (!dateString) return '';
        if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) return dateString;
        
        const currentYear = new Date().getFullYear();
        const monthMap = {
            'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
            'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
            'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
        };
        
        const monthMatch = dateString.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
        const dayMatch = dateString.match(/\b(\d{1,2})\b/);
        
        if (monthMatch && dayMatch) {
            const month = monthMap[monthMatch[0]];
            const day = dayMatch[0].padStart(2, '0');
            return `${currentYear}-${month}-${day}`;
        }
        
        return '';
    }

    // ===== FILTER AND SEARCH =====
    function filterByPriority(priority) {
        currentFilter = priority;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-filter="${priority}"]`).classList.add('active');
        populateTable();
        updateStats();
    }

    function searchTable() {
        const searchTerm = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('#tableBody tr').forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
    }

    function filterByIssueType(issueType) {
        document.getElementById('searchBox').value = '';
        const rows = document.querySelectorAll('#tableBody tr');
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 0) return;
            
            const statusCell = cells[5];
            const contractCell = cells[6];
            const visaCell = cells[7];
            let shouldShow = false;
            
            if (issueType === 'contract') {
                shouldShow = statusCell.textContent.includes('Contract Issue') || statusCell.textContent.includes('Contract Review') || contractCell.textContent.includes('Quotation') || contractCell.textContent.includes('Under Review') || contractCell.textContent.includes('Reviewing');
            } else if (issueType === 'payment') {
                shouldShow = statusCell.textContent.includes('Payment Issue') || contractCell.textContent.includes('Waiting AP');
            } else if (issueType === 'visa') {
                shouldShow = statusCell.textContent.includes('VISA Processing') || visaCell.textContent.includes('Processing') || visaCell.textContent.includes('Ongoing');
            }
            
            row.style.display = shouldShow ? '' : 'none';
        });
        
        document.querySelector('.table-title').textContent = `Detailed Task List - ${issueType.charAt(0).toUpperCase() + issueType.slice(1)} Issues Only`;
        
        if (!document.getElementById('clearFilterBtn')) {
            const clearBtn = document.createElement('button');
            clearBtn.id = 'clearFilterBtn';
            clearBtn.className = 'btn-export';
            clearBtn.style.background = '#95a5a6';
            clearBtn.textContent = 'Clear Filter';
            clearBtn.onclick = clearIssueFilter;
            document.querySelector('.add-item-container').appendChild(clearBtn);
        }
    }

    function clearIssueFilter() {
        document.querySelectorAll('#tableBody tr').forEach(row => row.style.display = '');
        document.querySelector('.table-title').textContent = 'Detailed Task List';
        const clearBtn = document.getElementById('clearFilterBtn');
        if (clearBtn) clearBtn.remove();
    }

    // ===== TABLE POPULATION =====
    function populateTable() {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

        let filteredData = currentFilter === 'all' ? projectData : projectData.filter(item => item.priority === currentFilter);

        filteredData.forEach(item => {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            const row = document.createElement('tr');
            row.className = `priority-${item.priority}`;
            row.innerHTML = `
                <td>${item.no}</td>
                <td><span class="priority-badge priority-${item.priority}">${item.priority}</span></td>
                <td style="font-weight: 500; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.equipment}">${item.equipment}</td>
                <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.vendor}"><strong>${item.vendor}</strong></td>
                <td><span class="status-badge">${item.task}</span></td>
                <td><span class="status-badge ${getStatusClass(item.status)}">${item.status}</span></td>
                <td><span class="status-badge ${getContractClass(item.contract)}">${item.contract}</span></td>
                <td><span class="status-badge ${getVisaClass(item.visa)}">${item.visa}</span></td>
                <td style="white-space: nowrap;">${item.targetDate ? formatDateForDisplay(item.targetDate) : '-'}</td>
                <td style="white-space: nowrap;">${item.mobDate}</td>
                <td><span class="status-badge ${dateStatus.class}">${dateStatus.status}</span></td>
                <td>
                    <div class="progress-bar" style="width: 50px;">
                        <div class="progress-fill" style="width: ${item.progress}%;"></div>
                    </div>
                    <small style="font-size: 8px; margin-left: 3px;">${item.progress}%</small>
                </td>
                <td style="white-space: nowrap; text-align: center;">
                    <button class="action-btn primary" onclick="openUpdateModal('${item.firebaseKey}')" style="font-size: 9px; padding: 4px 8px;">Update</button>
                    <button class="btn-delete" onclick="deleteItem('${item.firebaseKey}')" title="Delete" style="font-size: 12px; padding: 4px 7px; line-height: 1;">🗑</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    function getStatusClass(status) {
        if (status.includes('Completed')) return 'status-done';
        if (status.includes('Onsite')) return 'status-onsite';
        if (status.includes('Issue')) return 'status-issue';
        if (status.includes('Processing')) return 'status-ongoing';
        return 'status-waiting';
    }

    function getContractClass(contract) {
        if (contract === 'Done') return 'status-done';
        if (contract.includes('Ongoing') || contract.includes('Reviewing')) return 'status-ongoing';
        if (contract.includes('Quotation') || contract.includes('Review')) return 'status-issue';
        return 'status-waiting';
    }

    function getVisaClass(visa) {
        if (visa === 'Done') return 'status-done';
        if (visa === 'Processing' || visa === 'Ongoing') return 'status-ongoing';
        if (visa === 'Local') return 'status-onsite';
        return 'status-issue';
    }

    // ===== STATISTICS =====
    function updateStats() {
        let filteredData = currentFilter === 'all' ? projectData : projectData.filter(item => item.priority === currentFilter);

        const total = filteredData.length;
        const belumOnsite = filteredData.filter(item => !item.status.includes('Completed') && !item.status.includes('Onsite')).length;
        const sudahOnsite = total - belumOnsite;
        const contractIssues = filteredData.filter(item => item.status === 'Contract Issue' || item.status === 'Contract Review' || item.contract === 'Quotation' || item.contract === 'Under Review' || item.contract === 'Reviewing').length;
        const paymentIssues = filteredData.filter(item => item.status === 'Payment Issue' || item.contract === 'Waiting AP').length;
        const visaProcessing = filteredData.filter(item => item.status === 'VISA Processing' || item.visa === 'Processing' || item.visa === 'Ongoing').length;
        const inProgress = filteredData.filter(item => item.status.includes('Onsite') && !item.status.includes('Completed')).length;
        const completed = filteredData.filter(item => item.status.includes('Completed')).length;
        
        const onTime = filteredData.filter(item => {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status === 'ON TIME';
        }).length;
        
        const delayed = filteredData.filter(item => {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status.includes('DELAYED');
        }).length;

        document.getElementById('totalCount').textContent = total;
        document.getElementById('belumOnsiteCount').textContent = belumOnsite;
        document.getElementById('sudahOnsiteCount').textContent = sudahOnsite;
        document.getElementById('contractIssueCount').textContent = contractIssues;
        document.getElementById('paymentIssueCount').textContent = paymentIssues;
        document.getElementById('visaProcessingCount').textContent = visaProcessing;
        document.getElementById('inProgressCount').textContent = inProgress;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('onTimeCount').textContent = onTime;
        document.getElementById('delayedCount').textContent = delayed;
        document.getElementById('criticalContract').textContent = contractIssues;
        document.getElementById('criticalVisa').textContent = visaProcessing;
        document.getElementById('criticalPayment').textContent = paymentIssues;
    }

    // ===== HISTORY =====
    function populateEquipmentHistoryFilter() {
        const filterSelect = document.getElementById('equipmentHistoryFilter');
        const currentValue = filterSelect.value;
        
        filterSelect.innerHTML = '<option value="all">All Equipment</option>';
        
        const uniqueEquipmentMap = new Map();
        
        activityHistory.forEach(item => {
            if (item.equipmentId && !uniqueEquipmentMap.has(item.equipmentId)) {
                uniqueEquipmentMap.set(item.equipmentId, {
                    id: item.equipmentId,
                    name: item.equipment,
                    vendor: item.vendor
                });
            }
        });
        
        const sortedEquipment = Array.from(uniqueEquipmentMap.values()).sort((a, b) => a.name.localeCompare(b.name));
        
        sortedEquipment.forEach(eq => {
            const option = document.createElement('option');
            option.value = eq.id;
            option.textContent = `${eq.name} (${eq.vendor})`;
            filterSelect.appendChild(option);
        });
        
        filterSelect.value = currentValue;
    }

    function filterEquipmentHistory() {
        const filterValue = document.getElementById('equipmentHistoryFilter').value;
        const container = document.getElementById('historyContainer');
        
        let filteredHistory = activityHistory;
        
        if (filterValue !== 'all') {
            const equipmentId = parseInt(filterValue);
            filteredHistory = activityHistory.filter(item => item.equipmentId === equipmentId);
            
            if (filteredHistory.length === 0) {
                container.innerHTML = '<div style="padding: 15px; text-align: center; color: #95a5a6; font-size: 11px;"><p>No history found for this equipment</p></div>';
                return;
            }
        }
        
        const recentItems = filteredHistory.slice(0, 6);
        
        container.innerHTML = recentItems.map(item => `
        <div class="timeline-item" style="border-left: 3px solid ${item.color}; padding-left: 8px; margin-bottom: 10px; position: relative;">
                <button onclick="deleteHistory('${item.firebaseKey}')" style="position: absolute; top: 25px; right: 5px; background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 9px; cursor: pointer; font-weight: 600;" title="Delete">🗑</button>
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 3px;">
                <strong style="font-size: 10px; color: #2c3e50;">${new Date(item.timestamp).toLocaleString()}</strong>
                <span style="font-size: 8px; background: ${item.color}; color: white; padding: 1px 4px; border-radius: 8px;">${item.category}</span>
            </div>
            <div style="font-size: 11px; font-weight: 500; margin-bottom: 2px;">${item.title}</div>
            <div style="font-size: 10px; color: #666; margin-bottom: 3px;">${item.description}</div>
            <div style="font-size: 9px; color: #999; background: #f8f9fa; padding: 3px 6px; border-radius: 3px;">${item.icon} ${item.notes}</div>
            <div style="font-size: 8px; color: #95a5a6; margin-top: 3px;">by ${item.user}</div>
        </div>
    `).join('');
}

    // ===== MODAL FUNCTIONS =====
    function openAddModal() {
        currentEditId = null;
        document.getElementById('modalTitle').textContent = 'Add New Task';
        clearForm();
        document.getElementById('updateModal').style.display = 'block';
    }

    function openUpdateModal(firebaseKey) {
        const item = projectData.find(p => p.firebaseKey === firebaseKey);
        if (!item) return;

        currentEditId = firebaseKey;
        document.getElementById('modalTitle').textContent = 'Update Task';
        document.getElementById('modalEquipment').value = item.equipment;
        document.getElementById('modalVendor').value = item.vendor;
        document.getElementById('modalPriority').value = item.priority;
        document.getElementById('modalTask').value = item.task;
        document.getElementById('modalStatus').value = item.status;
        document.getElementById('modalContract').value = item.contract;
        document.getElementById('modalVisa').value = item.visa;
        document.getElementById('modalTargetDate').value = item.targetDate || '';
        document.getElementById('modalMobDate').value = formatDateForInput(item.mobDate);
        document.getElementById('modalProgress').value = item.progress;
        document.getElementById('modalNotes').value = '';
        document.getElementById('updateModal').style.display = 'block';
    }

    function clearForm() {
        document.getElementById('modalEquipment').value = '';
        document.getElementById('modalVendor').value = '';
        document.getElementById('modalPriority').value = '2nd';
        document.getElementById('modalTask').value = 'CI';
        document.getElementById('modalStatus').value = 'Contract Issue';
        document.getElementById('modalContract').value = 'Quotation';
        document.getElementById('modalVisa').value = 'Not Applied';
        document.getElementById('modalTargetDate').value = '';
        document.getElementById('modalMobDate').value = '';
        document.getElementById('modalProgress').value = '0';
        document.getElementById('modalNotes').value = '';
    }

    function closeModal() {
        document.getElementById('updateModal').style.display = 'none';
        currentEditId = null;
    }

    // ===== CRUD OPERATIONS =====
    function saveUpdate() {
        const equipment = document.getElementById('modalEquipment').value.trim();
        const vendor = document.getElementById('modalVendor').value.trim();
        
        if (!equipment || !vendor) {
            showNotification('Please fill in Equipment and Vendor fields', 'error');
            return;
        }

        const mobDateValue = document.getElementById('modalMobDate').value;
        const mobDateFormatted = mobDateValue ? formatDateForDisplay(mobDateValue) : 'TBD';

        const taskData = {
            equipment: equipment,
            vendor: vendor,
            priority: document.getElementById('modalPriority').value,
            task: document.getElementById('modalTask').value,
            status: document.getElementById('modalStatus').value,
            contract: document.getElementById('modalContract').value,
            visa: document.getElementById('modalVisa').value,
            targetDate: document.getElementById('modalTargetDate').value,
            mobDate: mobDateFormatted,
            progress: parseInt(document.getElementById('modalProgress').value) || 0
        };

        if (currentEditId) {
            // Update existing item
            const item = projectData.find(p => p.firebaseKey === currentEditId);
            projectDataRef.child(currentEditId).update(taskData).then(() => {
                // Add to history
                activityHistoryRef.push({
                    timestamp: new Date().toISOString(),
                    type: 'update',
                    category: 'UPDATE',
                    title: vendor + ' - ' + equipment.substring(0, 30),
                    equipmentId: item.id,
                    equipment: equipment,
                    vendor: vendor,
                    description: 'Task updated',
                    notes: document.getElementById('modalNotes').value || 'Task information updated',
                    user:  prompt('Enter your name:') || 'Anonymous',
                    icon: '📝',
                    color: '#27ae60'
                });
                
                showNotification('Task updated successfully', 'success');
                closeModal();
            }).catch((error) => {
                showNotification('Error updating task: ' + error.message, 'error');
            });
        } else {
            // Add new item
            const newId = Date.now();
            const newItem = {
                id: newId,
                no: projectData.length + 1,
                ...taskData
            };
            
            projectDataRef.push(newItem).then(() => {
                // Add to history
                activityHistoryRef.push({
                    timestamp: new Date().toISOString(),
                    type: 'add',
                    category: 'ADD',
                    title: 'New Task Added',
                    equipmentId: newId,
                    equipment: equipment,
                    vendor: vendor,
                    description: equipment + ' - ' + vendor,
                    notes: 'Priority: ' + taskData.priority + ', Status: ' + taskData.status,
                    user:  prompt('Enter your name:') || 'Anonymous',
                    icon: '➕',
                    color: '#e74c3c'
                });
                
                showNotification('Task added successfully', 'success');
                closeModal();
            }).catch((error) => {
                showNotification('Error adding task: ' + error.message, 'error');
            });
        }
    }

    function deleteItem(firebaseKey) {
        const item = projectData.find(p => p.firebaseKey === firebaseKey);
        if (!item) return;

        if (confirm(`Are you sure you want to delete this item?\n\n${item.equipment} - ${item.vendor}`)) {
            projectDataRef.child(firebaseKey).remove().then(() => {
                // Add to history
                activityHistoryRef.push({
                    timestamp: new Date().toISOString(),
                    type: 'delete',
                    category: 'DELETE',
                    title: 'Task Deleted',
                    equipmentId: null,
                    equipment: item.equipment,
                    vendor: item.vendor,
                    description: item.equipment + ' - ' + item.vendor,
                    notes: 'Task removed from tracking',
                    user:  prompt('Enter your name:') || 'Anonymous',
                    icon: '🗑️',
                    color: '#e74c3c'
                });
                
                showNotification('Item deleted successfully', 'success');
            }).catch((error) => {
                showNotification('Error deleting item: ' + error.message, 'error');
            });
        }
    }

function deleteHistory(firebaseKey) {
        if (confirm('Are you sure you want to delete this history item?')) {
            activityHistoryRef.child(firebaseKey).remove().then(() => {
                showNotification('History deleted successfully', 'success');
            }).catch((error) => {
                showNotification('Error deleting history: ' + error.message, 'error');
            });
        }
    }

    // ===== EXPORT =====
    function exportToPDF() {
        const printWindow = window.open('', '_blank');
        const currentDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let filteredData = currentFilter === 'all' ? projectData : projectData.filter(item => item.priority === currentFilter);
        
        const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <title> Vendor Mobilization Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                    .header h1 { margin: 0; font-size: 24px; color: #333; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #333; padding: 8px; text-align: left; font-size: 10px; }
                    th { background: #2c3e50; color: white; }
                    tr:nth-child(even) { background: #f9f9f9; }
                    .ontime { color: #27ae60; font-weight: bold; }
                    .delayed { color: #e74c3c; font-weight: bold; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Vendor Mobilization Report</h1>
                    <p>Generated on: ${currentDate}</p>
                    <p>Filter: ${currentFilter === 'all' ? 'All Tasks' : currentFilter + ' Priority'}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Priority</th>
                            <th>Equipment</th>
                            <th>Vendor</th>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Target MOB Date</th>
                            <th>MOB Date</th>
                            <th>Date Status</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map(item => {
                            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
                            return `
                            <tr>
                                <td>${item.no}</td>
                                <td>${item.priority}</td>
                                <td>${item.equipment}</td>
                                <td>${item.vendor}</td>
                                <td>${item.task}</td>
                                <td>${item.status}</td>

<td>${item.targetDate ? formatDateForDisplay(item.targetDate) : '-'}</td>
                                    <td>${item.mobDate}</td>
                                    <td class="${dateStatus.status === 'ON TIME' ? 'ontime' : 'delayed'}">${dateStatus.status}</td>
                                    <td>${item.progress}%</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #666;">
    <p>Vendor Mobilization Tracking System</p>
    <p>Report contains ${filteredData.length} tasks</p>
</div>

<div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #333; text-align: center;">
    <p style="margin: 0; font-size: 11px; font-weight: bold;">Developed by TS-KPB</p>
    <p style="margin: 5px 0 0 0; font-size: 9px; color: #999;">© 2025 All Rights Reserved</p>
</div>

                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }

        // ===== NOTIFICATION =====
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Make functions globally accessible
        window.openUpdateModal = openUpdateModal;
        window.deleteItem = deleteItem;
	window.deleteHistory = deleteHistory;
        window.exportToPDF = exportToPDF;
        window.closeModal = closeModal;
        window.filterByIssueType = filterByIssueType;
        window.clearIssueFilter = clearIssueFilter;
        window.filterEquipmentHistory = filterEquipmentHistory;
        window.saveUpdate = saveUpdate;
    </script>

    <!-- Footer -->
    <div style="background: #2c3e50; color: white; text-align: center; padding: 20px; margin-top: 30px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
        <p style="margin: 0; font-size: 13px; font-weight: 600; letter-spacing: 0.5px;">Developed by TS-KPB</p>
        <p style="margin: 8px 0 0 0; font-size: 10px; opacity: 0.7;">© 2025 All Rights Reserved</p>
    </div>

</body>
</html>
