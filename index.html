<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Vendor Mobilization Dashboard</title>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f8f9fa;
        padding: 10px;
        min-height: 100vh;
        font-size: 14px;
        color: #2c3e50;
    }

    .dashboard-container {
        max-width: 100%;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .header {
        background: #34495e;
        color: white;
        padding: 20px;
        text-align: center;
    }

    .header h1 {
        font-size: 28px;
        margin-bottom: 5px;
        font-weight: 600;
    }

    .header .subtitle {
        font-size: 16px;
        opacity: 0.9;
    }

    .stats-overview {
        background: #ecf0f1;
        padding: 20px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 6px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-top: 4px solid;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }
.stat-card:active {
    transform: translateY(0);
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}

.stat-breakdown div:hover {
    background: rgba(52, 152, 219, 0.1);
    padding: 2px 4px;
    border-radius: 3px;
    margin: -2px -4px;
}
    .stat-card.total { border-top-color: #3498db; }
    .stat-card.belum-onsite { border-top-color: #e74c3c; }
    .stat-card.sudah-onsite { border-top-color: #27ae60; }

    .stat-number {
        font-size: 42px;
        font-weight: 700;
        margin-bottom: 8px;
        line-height: 1;
    }

    .stat-label {
        color: #7f8c8d;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .stat-breakdown {
        font-size: 13px;
        color: #95a5a6;
        line-height: 1.6;
    }

    .filter-controls {
        margin-top: 15px;
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 8px 14px;
        border: 1px solid #bdc3c7;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .filter-btn.active {
        background: #34495e;
        color: white;
        border-color: #34495e;
    }

    .filter-btn:hover {
        border-color: #34495e;
    }

    .content-area {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 20px;
        padding: 20px;
        max-width: 1800px;
        margin: 0 auto;
    }

    .main-table-section {
        background: white;
        min-width: 0;
        overflow: hidden;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
        flex-wrap: wrap;
        gap: 10px;
    }

    .table-title {
        font-size: 20px;
        font-weight: 600;
        color: #2c3e50;
    }

    .search-box {
        padding: 10px 14px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        width: 280px;
        font-size: 14px;
    }

    .search-box:focus {
        outline: none;
        border-color: #3498db;
    }

    .add-item-container {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn-add, .btn-export {
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }

    .btn-add {
        background: #27ae60;
    }

    .btn-add:hover {
        background: #229954;
        transform: translateY(-1px);
    }

    .btn-export {
        background: #3498db;
    }

    .btn-export:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    .btn-delete {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-left: 5px;
    }

    .btn-delete:hover {
        background: #c0392b;
        transform: translateY(-1px);
    }

    .data-table-container {
        overflow-x: auto;
        border: 1px solid #ecf0f1;
        border-radius: 4px;
    }

    .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    min-width: 1500px;
}

    .data-table th {
        background: #34495e;
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        font-size: 11px;
        white-space: nowrap;
    }

    .data-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #ecf0f1;
        vertical-align: middle;
        font-size: 12px;
    }

    .data-table tr:hover {
        background: #f8f9fa;
    }

    .data-table tr.priority-1st { background: #fdf2f2; }
    .data-table tr.priority-2nd { background: #fefbf3; }
    .data-table tr.priority-3rd { background: #f0f9f0; }
    .data-table tr.priority-OSBL { background: #f0f4ff; }

    .status-badge {
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
        min-width: 60px;
        text-align: center;
        white-space: nowrap;
    }

    .status-done { background: #d5f4e6; color: #1e6937; }
    .status-ongoing { background: #fff3cd; color: #8a6d3b; }
    .status-issue { background: #f8d7da; color: #721c24; }
    .status-waiting { background: #d1ecf1; color: #0c5460; }
    .status-onsite { background: #d4edda; color: #155724; }
    .status-ontime { background: #d4edda; color: #155724; }
    .status-delayed { background: #f8d7da; color: #721c24; }

    .priority-badge {
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        color: white;
    }

    .priority-1st { background: #dc3545; }
    .priority-2nd { background: #fd7e14; }
    .priority-3rd { background: #198754; }
    .priority-OSBL { background: #0d6efd; }

.data-table tr.highlighted {
    background: linear-gradient(90deg, #ffe5e5 0%, #fff8f8 100%) !important;
    border-left: 5px solid #dc3545 !important;
    position: relative;
    box-shadow: inset 0 0 0 1px rgba(220, 53, 69, 0.1);
}


@keyframes warningPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.warning-badge {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    padding: 3px 7px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    display: inline-block;
    margin-right: 5px;
    box-shadow: 0 2px 6px rgba(231, 76, 60, 0.5);
    text-transform: uppercase;
    vertical-align: middle;
    white-space: nowrap;
}

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .sidebar-section {
        background: white;
        border-radius: 6px;
        padding: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .sidebar-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #2c3e50;
        border-bottom: 2px solid #ecf0f1;
        padding-bottom: 8px;
    }

    .timeline-item {
        padding: 10px 0;
        border-bottom: 1px solid #ecf0f1;
        font-size: 13px;
    }

    .timeline-item:last-child {
        border-bottom: none;
    }

    .action-btn {
        padding: 8px 14px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .action-btn.primary {
        background: #3498db;
        color: white;
    }

    .action-btn:hover {
        opacity: 0.8;
        transform: translateY(-1px);
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow-y: auto;
    }

    .modal-content {
        background-color: white;
        margin: 3% auto;
        padding: 30px;
        border-radius: 8px;
        width: 700px;
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        position: relative;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #2c3e50;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 20px;
        top: 20px;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .close:hover {
        color: #000;
        background-color: #f0f0f0;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
        color: #2c3e50;
    }

    .form-control {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #bdc3c7;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-control:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 18px 24px;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        font-size: 14px;
        z-index: 1001;
        opacity: 0;
        transform: translateX(300px);
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    .notification.success { background: #27ae60; }
    .notification.error { background: #e74c3c; }

    .connection-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 10px 18px;
        border-radius: 25px;
        font-size: 13px;
        font-weight: 600;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .connection-status.connected {
        background: #27ae60;
        color: white;
    }

    .connection-status.disconnected {
        background: #e74c3c;
        color: white;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: white;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    @media (max-width: 1400px) {
        .content-area {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        body { padding: 5px; }
        .header h1 { font-size: 22px; }
        .stat-number { font-size: 32px; }
        .table-title { font-size: 18px; }
        .search-box { width: 100%; }
    }

/* Gantt Chart Styles */
.gantt-container {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow-x: auto;
}

.gantt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ecf0f1;
}

.gantt-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.gantt-view-btn {
    padding: 8px 16px;
    border: 1px solid #bdc3c7;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    transition: all 0.2s;
}

.gantt-view-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.gantt-view-btn:hover {
    border-color: #3498db;
}

#gantt-chart {
    min-height: 400px;
}

.gantt-legend {
    display: flex;
    gap: 20px;
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
    font-size: 11px;
}

.gantt-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.gantt-legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
}

/* Custom Gantt Bar Colors */
/* Custom Gantt Bar Colors - More Specific Selectors */
/* Custom Gantt Bar Colors - More Specific Selectors */

/* Custom Gantt Bar Colors - More Specific Selectors */
.gantt .bar-wrapper .bar-notstarted {
    fill: #95a5a6 !important; /* Abu-abu */
}

.gantt .bar-wrapper .bar-inprogress {
    fill: #27ae60 !important; /* Hijau */
}

.gantt .bar-wrapper .bar-completed {
    fill: #3498db !important; /* Biru */
}

.gantt .bar-wrapper .bar-delayedmob {
    fill: #f39c12 !important; /* Kuning - Delayed Mobilization */
}

.gantt .bar-wrapper .bar-workdelayed {
    fill: #e74c3c !important; /* Merah - Work Delayed */
}

/* Force override default Gantt colors */
/* Force override default Gantt colors */
.gantt .bar-wrapper.bar-notstarted .bar {
    fill: #95a5a6 !important; /* Abu-abu */
}

.gantt .bar-wrapper.bar-inprogress .bar {
    fill: #27ae60 !important; /* Hijau */
}

.gantt .bar-wrapper.bar-completed .bar {
    fill: #3498db !important; /* Biru */
}

.gantt .bar-wrapper.bar-delayedmob .bar {
    fill: #f39c12 !important; /* Kuning */
}

.gantt .bar-wrapper.bar-workdelayed .bar {
    fill: #e74c3c !important; /* Merah */
}

.gantt .bar-wrapper.bar-critical .bar {
    fill: #9b59b6 !important; /* Ungu */
}

.gantt .bar-progress {
    fill: rgba(255, 255, 255, 0.3) !important;
}

/* Additional override for bar group */
/* Additional override for bar group */
.gantt g.bar-group .bar-notstarted {
    fill: #95a5a6 !important; /* Abu-abu */
}

.gantt g.bar-group .bar-inprogress {
    fill: #27ae60 !important; /* Hijau */
}

.gantt g.bar-group .bar-completed {
    fill: #3498db !important; /* Biru */
}

.gantt g.bar-group .bar-delayedmob {
    fill: #f39c12 !important; /* Kuning */
}

.gantt g.bar-group .bar-workdelayed {
    fill: #e74c3c !important; /* Merah */
}

.gantt g.bar-group .bar-critical {
    fill: #9b59b6 !important; /* Ungu */
}

/* Gantt Tooltip for Mitigation Plan */
.gantt-tooltip {
    position: absolute;
    background: #fff3cd;
    border: 2px solid #f39c12;
    border-radius: 8px;
    padding: 12px 15px;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 9999;
    font-size: 12px;
    line-height: 1.6;
    pointer-events: none;
    display: none;
}

.gantt-tooltip.active {
    display: block;
}

.gantt-tooltip-header {
    font-weight: 700;
    color: #f39c12;
    margin-bottom: 8px;
    font-size: 13px;
    border-bottom: 2px solid #f39c12;
    padding-bottom: 5px;
}

.gantt-tooltip-content {
    color: #856404;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.gantt-tooltip-footer {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #f39c12;
    font-size: 10px;
    color: #999;
}

</style>
</head>
<body>
    <div class="connection-status disconnected" id="connectionStatus">
        <span class="status-dot"></span>
        <span id="statusText">Connecting...</span>
    </div>

    <div class="dashboard-container">
      <div class="header">
            <h1>RFCC VENDOR MOBILIZATION & PROGRESS TRACKING</h1>
            <div style="display: flex; justify-content: center; align-items: center; position: relative;">
                <div class="subtitle" style="font-size: 13px; opacity: 0.85;">
                    📅 Updated: <span id="currentDate"></span>
                </div>
                <div style="position: absolute; right: 20px; font-size: 11px; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px;">
                    👥 <span id="onlineCount" style="font-weight: bold;">0</span> online
                </div>
            </div>
        </div>

        <div class="stats-overview">
            <div class="stats-grid">
                <div class="stat-card total" onclick="filterByStatus('all')" style="cursor: pointer;">
    <div class="stat-number" id="totalCount">0</div>
    <div class="stat-label">Total Items</div>
                    <div class="filter-controls">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="1st">1st</button>
                        <button class="filter-btn" data-filter="2nd">2nd</button>
                        <button class="filter-btn" data-filter="3rd">3rd</button>
                        <button class="filter-btn" data-filter="OSBL">OSBL</button>
<button class="filter-btn" data-filter="highlighted" style="background: #e74c3c; color: white; border-color: #e74c3c;">⚠️ Critical</button>
                    </div>
                </div>

                <div class="stat-card belum-onsite" onclick="filterByStatus('notonsite')" style="cursor: pointer;">
    <div class="stat-number" id="belumOnsiteCount">0</div>
    <div class="stat-label">Not Yet Onsite</div>
    <div class="stat-breakdown">
        <div style="cursor: pointer;" onclick="event.stopPropagation(); filterByIssueType('contract')">
            Contract Issues: <span id="contractIssueCount">0</span>
        </div>
        <div style="cursor: pointer;" onclick="event.stopPropagation(); filterByIssueType('payment')">
            Payment Issues: <span id="paymentIssueCount">0</span>
        </div>
        <div style="cursor: pointer;" onclick="event.stopPropagation(); filterByIssueType('visa')">
            VISA Processing: <span id="visaProcessingCount">0</span>
        </div>
    </div>
</div>

                <div class="stat-card sudah-onsite" style="cursor: pointer;">
    <div class="stat-number" id="sudahOnsiteCount" onclick="filterByStatus('onsite')">0</div>
    <div class="stat-label" onclick="filterByStatus('onsite')">Already Onsite</div>
    <div class="stat-breakdown">
        <div style="cursor: pointer;" onclick="filterByStatus('inprogress')">In Progress: <span id="inProgressCount">0</span></div>
        <div style="cursor: pointer;" onclick="filterByStatus('completed')">Completed: <span id="completedCount">0</span></div>
        <div style="color: #27ae60; cursor: pointer;" onclick="filterByStatus('ontime')">On Time: <span id="onTimeCount">0</span></div>
        <div style="color: #e74c3c; cursor: pointer;" onclick="filterByStatus('delayed')">Delayed: <span id="delayedCount">0</span></div>
    </div>
</div>
            </div>
        </div>

        <div class="content-area">
            <div class="main-table-section">
                <div class="table-header">
                    <h2 class="table-title">Detailed Task List</h2>
                    <div class="add-item-container">
    <button class="btn-add" id="addItemBtn">+ Add New Item</button>
    <button class="btn-export" id="exportBtn">📄 Export PDF</button>
    <button class="btn-export" id="viewTimelineBtn" style="background: #9b59b6;">📊 View Timeline</button>
    <input type="text" class="search-box" placeholder="Search equipment, vendor, or task..." id="searchBox">
</div>
                </div>

                <div class="data-table-container">
                    <table class="data-table" id="mainDataTable">
                        <thead>
                            <tr>
                                <th style="width: 3%;">No</th>
                                <th style="width: 5%;">Priority</th>
                                <th style="width: 19%;">Equipment</th>
                                <th style="width: 9%;">Vendor</th>
                                <th style="width: 4%;">Disc</th>
<th style="width: 8%;">Task</th>
<th style="width: 8%;">Status</th>
<th style="width: 7%;">Contract</th>
                                <th style="width: 5%;">VISA</th>
                                <th style="width: 7%;">Target MOB<br>Date</th>
                               <th style="width: 5%;">MOB Date</th>
<th style="width: 6%;">MOB Status</th>
<th style="width: 6%;">Target Comp.<br>Date</th>
<th style="width: 6%;">Prognosa Comp.<br>Date</th>
<th style="width: 5%;">Progress</th>
                                <th style="width: 12%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>

            <!-- Pagination Controls -->
                <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <div style="font-size: 12px; color: #7f8c8d;">
                        Showing <span id="tablePageInfo">0</span> items
                    </div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <button onclick="changeTablePage(-1)" id="prevTablePageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Previous</button>
                        <span id="tablePageNumbers" style="display: flex; gap: 5px;"></span>
                        <button onclick="changeTablePage(1)" id="nextTablePageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">Next</button>
                    </div>
                </div>
            </div>


            <div class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">Recent Updates</h3>
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; font-size: 11px; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Filter by Equipment:</label>
<input type="text" id="equipmentSearch" placeholder="Search equipment..." style="width: 100%; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 11px; margin-bottom: 5px;" oninput="searchEquipment()">
<select id="equipmentHistoryFilter" size="5" style="width: 100%; padding: 6px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 11px; max-height: 150px; overflow-y: auto;" onchange="filterEquipmentHistory()">
    <option value="all">All Equipment</option>
</select>
                        <button id="viewProgressReportBtn" onclick="showProgressReport()" style="width: 100%; margin-top: 8px; padding: 8px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; display: none;">
                            View Progress Report
                        </button>
                    </div>

                    <div id="historyContainer" style="max-height: 400px; overflow-y: auto;">
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="action-btn primary" id="showAllHistoryBtn" style="flex: 1; font-size: 10px;">Show All History</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 class="sidebar-title" style="margin-bottom: 0;">Upcoming Mobilizations</h3>
                        <span id="upcomingCount" style="background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;">0</span>
                    </div>
                    <div id="upcomingContainer" style="max-height: 400px; overflow-y: auto;">
                        <div style="padding: 20px; text-align: center; color: #95a5a6; font-size: 11px;">
                            Loading upcoming mobilizations...
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
    <h3 class="sidebar-title">Critical Issues</h3>
    <div style="background: #fdf2f2; padding: 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;" onclick="filterByIssueType('contract')">
        <strong>Contract Delays</strong><br>
        <span id="criticalContract">0</span> items waiting quotation or contract review
    </div>
    <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;" onclick="filterByIssueType('visa')">
        <strong>VISA Bottleneck</strong><br>
        <span id="criticalVisa">0</span> items in VISA processing queue
    </div>
    <div style="background: #f8d7da; padding: 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;" onclick="filterByIssueType('payment')">
        <strong>Payment Issues</strong><br>
        <span id="criticalPayment">0</span> vendors awaiting AP invoice processing
    </div>
    <div style="background: #ffe5e5; padding: 8px; border-radius: 4px; border: 2px solid #e74c3c; cursor: pointer;" onclick="filterByIssueType('workdelayed')">
        <strong style="color: #c0392b;">⚠️ Work Delayed</strong><br>
        <span id="criticalWorkDelayed" style="font-weight: 700; color: #c0392b;">0</span> items with prognosa ≥ target completion
    </div>
</div>
            </div>
        </div>
    </div>

    <div id="updateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Task</h3>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Equipment:</label>
                    <input type="text" id="modalEquipment" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Vendor:</label>
                    <input type="text" id="modalVendor" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Priority:</label>
                    <select id="modalPriority" class="form-control">
                        <option value="1st">1st Start-up</option>
                        <option value="2nd">2nd Start-up</option>
                        <option value="3rd">3rd Start-up</option>
                        <option value="OSBL">OSBL</option>
                    </select>
                </div>
                <div class="form-group">
    <label class="form-label">Discipline:</label>
    <select id="modalDisc" class="form-control">
        <option value="CI">CI</option>
        <option value="COM">COM</option>
        <option value="ME">ME</option>
        <option value="EL">EL</option>
        <option value="CI/COM">CI/COM</option>
        <option value="COM-EL">COM-EL</option>
        <option value="COM-ME">COM-ME</option>
    </select>
</div>
<div class="form-group">
    <label class="form-label">Task Name:</label>
    <input type="text" id="modalTask" class="form-control" placeholder="e.g., FAT Inspection, SAT Testing, Installation, etc.">
</div>
                <div class="form-group">
                    <label class="form-label">Status:</label>
                    <select id="modalStatus" class="form-control">
                        <option value="Contract Issue">Contract Issue</option>
                        <option value="Payment Issue">Payment Issue</option>
                        <option value="VISA Processing">VISA Processing</option>
                        <option value="Contract Review">Contract Review</option>
                        <option value="Ready">Ready for Mobilization</option>
                        <option value="Onsite Working">Onsite Working</option>
                        <option value="Completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Contract Status:</label>
                    <select id="modalContract" class="form-control">
                        <option value="Quotation">Waiting Quotation</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Reviewing">Reviewing</option>
                        <option value="Ongoing">Ongoing</option>
                        <option value="Waiting AP">Waiting AP Invoice</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">VISA Status:</label>
                    <select id="modalVisa" class="form-control">
                        <option value="Not Applied">Not Applied</option>
                        <option value="Processing">Processing</option>
                        <option value="Ongoing">Ongoing</option>
                        <option value="Local">Local</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Target MOB Date:</label>
                    <input type="date" id="modalTargetDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Mobilization Date:</label>
                    <input type="date" id="modalMobDate" class="form-control">
                </div>

<div class="form-group">
    <label class="form-label">Target Completion Date:</label>
    <input type="date" id="modalTargetCompDate" class="form-control">
</div>
<div class="form-group">
    <label class="form-label">Prognosa Completion Date:</label>
    <input type="date" id="modalPrognosaCompDate" class="form-control">
</div>
                <div class="form-group">
                    <label class="form-label">Progress (%):</label>
                    <input type="number" id="modalProgress" class="form-control" min="0" max="100">
                </div>
<div class="form-group">
    <label class="form-label">
        <input type="checkbox" id="modalHighlight" style="margin-right: 8px; width: auto; cursor: pointer;">
        <span style="color: #e74c3c; font-weight: 700;">⚠️ Mark as Critical/Priority Item</span>
    </label>
    <small style="display: block; margin-top: 5px; color: #7f8c8d; font-size: 12px;">
        This item will be highlighted with a warning indicator
    </small>
</div>
<div class="form-group">
    <label class="form-label">⚠️ Work Mitigation Plan:</label>
    <textarea id="modalMitigationPlan" class="form-control" rows="5" placeholder="Enter work mitigation plan for potential delays or issues...&#10;Example:&#10;• Expedite quotation process with vendor&#10;• Prepare alternative vendor as backup&#10;• Fast track VISA application if contract approved"></textarea>
    <small style="display: block; margin-top: 5px; color: #7f8c8d; font-size: 12px;">
        Detail action plan to mitigate risks and delays
    </small>
</div>
                <div class="form-group">
                    <label class="form-label">Notes:</label>
                    <textarea id="modalNotes" class="form-control" rows="3" placeholder="Add notes about this task..."></textarea>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="saveButton">Save Changes</button>
            </div>
        </div>
    </div>

<div id="historyModal" class="modal">
        <div class="modal-content" style="width: 900px; max-width: 95%;">
            <div class="modal-header">
                <h3 class="modal-title">Complete Activity History</h3>
                <span class="close" onclick="closeHistoryModal()">&times;</span>
            </div>
            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="historySearch" placeholder="Search history..." style="flex: 1; padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 12px;">
                <button onclick="selectAllHistory()" style="padding: 8px 12px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Select All</button>
                <button onclick="deleteSelectedHistory()" style="padding: 8px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Delete Selected</button>
                <button onclick="exportHistoryPDF()" style="padding: 8px 12px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Export PDF</button>
            </div>
            <div id="fullHistoryContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #ecf0f1; border-radius: 4px; padding: 10px;">
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                <div style="font-size: 12px; color: #7f8c8d;">
                    Showing <span id="historyPageInfo">0</span> items
                </div>
                <div style="display: flex; gap: 5px;">
                    <button onclick="changeHistoryPage(-1)" id="prevPageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Previous</button>
                    <span id="pageNumbers" style="display: flex; gap: 5px; align-items: center; font-size: 12px; color: #2c3e50;"></span>
                    <button onclick="changeHistoryPage(1)" id="nextPageBtn" style="padding: 6px 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">Next</button>
                </div>
            </div>
        </div>
    </div>


   <!-- Progress Report Modal -->
<div id="progressReportModal" class="modal">
    <div class="modal-content" style="width: 900px; max-width: 95%;">
        <div class="modal-header">
            <h3 class="modal-title">📊 Equipment Progress Report</h3>
            <span class="close" onclick="closeProgressReport()">&times;</span>
        </div>
        <div id="progressReportContent" style="max-height: 70vh; overflow-y: auto;">
            <!-- Content will be populated by JavaScript -->
        </div>
        <div style="margin-top: 20px; text-align: center; padding-top: 15px; border-top: 1px solid #ecf0f1;">
            <button onclick="exportProgressReportPDF()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; margin-right: 10px;">📄 Export as PDF</button>
            <button onclick="closeProgressReport()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">Close</button>
        </div>
    </div>
</div>

<!-- Gantt Chart Modal -->
<div id="ganttModal" class="modal">

    <div class="modal-content" style="width: 95%; max-width: 1400px;">
        <div class="modal-header">
            <h3 class="modal-title">📊 Project Timeline - Gantt Chart</h3>
            <span class="close" onclick="closeGanttModal()">&times;</span>
        </div>
        
        <div class="gantt-container">
            <div class="gantt-header">
                <div>
                    <h4 style="margin: 0; font-size: 16px; color: #2c3e50;">Vendor Mobilization Timeline</h4>
                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #7f8c8d;">Visual representation of all tasks and their schedules</p>
                </div>
                <div class="gantt-controls">
    <label style="font-size: 12px; color: #2c3e50; font-weight: 600; margin-right: 10px;">Jump to Date:</label>
    <input type="date" id="ganttDatePicker" style="padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 12px; margin-right: 20px;" onchange="jumpToGanttDate()">
    
    <label style="font-size: 12px; color: #2c3e50; font-weight: 600; margin-right: 5px;">Filter:</label>
<select id="ganttFilterPriority" style="padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 12px; margin-right: 20px;" onchange="filterGanttChart()">
    <option value="all">All Items</option>
    <option value="1st">1st Priority</option>
    <option value="2nd">2nd Priority</option>
    <option value="3rd">3rd Priority</option>
    <option value="OSBL">OSBL</option>
    <option value="critical">⚠️ Critical Only</option>
</select>

<label style="font-size: 12px; color: #2c3e50; font-weight: 600;">View Mode:</label>
<button class="gantt-view-btn active" onclick="changeGanttView('Day')">Day</button>
<button class="gantt-view-btn" onclick="changeGanttView('Week')">Week</button>
<button class="gantt-view-btn" onclick="changeGanttView('Month')">Month</button>
</div>
            </div>
            
            <div id="gantt-chart"></div>
            
            <div class="gantt-legend">
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #95a5a6;"></div>
        <span>Not Started</span>
    </div>
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #27ae60;"></div>
        <span>In Progress / On Track</span>
    </div>
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #3498db;"></div>
        <span>Completed</span>
    </div>
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #f39c12;"></div>
        <span>Delayed Mobilization</span>
    </div>
    <div class="gantt-legend-item">
        <div class="gantt-legend-color" style="background: #e74c3c;"></div>
        <span>Work Delayed (Prognosa â‰¥ Target)</span>
    </div>
</div>
        </div>
        
        <div style="margin-top: 20px; text-align: center; padding-top: 15px; border-top: 1px solid #ecf0f1;">
            <button onclick="exportGanttPDF()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; margin-right: 10px;">📄 Export as PDF</button>
<button onclick="closeGanttModal()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer;">Close</button>
        </div>
    </div>
</div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<!-- Frappe Gantt Library -->
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">
    <script>
// Update current date automatically
        function updateCurrentDate() {
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            };
            const currentDate = new Date().toLocaleDateString('en-US', options);
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = currentDate;
            }
        }
        
        // Run on page load
        updateCurrentDate();
        // ===== FIREBASE CONFIGURATION =====
        // IMPORTANT: Replace with your own Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD8JTPzLD2Dp6yWM2Bepjh81mwIp9f0MRM",
  authDomain: "rfcc-dashboard.firebaseapp.com",
  databaseURL: "https://rfcc-dashboard-default-rtdb.firebaseio.com",
  projectId: "rfcc-dashboard",
  storageBucket: "rfcc-dashboard.firebasestorage.app",
  messagingSenderId: "951098160331",
  appId: "1:951098160331:web:6f14f05cb05c9d2ef7574e"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Database references
        const projectDataRef = database.ref('projectData');
        const activityHistoryRef = database.ref('activityHistory');

// ===== SIMPLE ONLINE USER COUNTER =====
const myConnectionsRef = database.ref('onlineUsers').push();

const connectedRefCounter = database.ref('.info/connected');
connectedRefCounter.on('value', (snap) => {
    if (snap.val() === true) {
        myConnectionsRef.set(true);
        myConnectionsRef.onDisconnect().remove();
    }
});

database.ref('onlineUsers').on('value', (snapshot) => {
    const count = snapshot.numChildren();
    const counterElement = document.getElementById('onlineCount');
    if (counterElement) {
        counterElement.textContent = count;
    }
});


        // Local state
        let projectData = [];
        let activityHistory = [];
        let currentEditId = null;
        let currentFilter = 'all';

	// Pagination
        let currentTablePage = 1;
	const itemsPerTablePage = 20;

        // Connection monitoring
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snap) => {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            if (snap.val() === true) {
                statusElement.className = 'connection-status connected';
                statusText.textContent = 'Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                statusText.textContent = 'Disconnected';
            }
        });

    // ===== FIREBASE REAL-TIME LISTENERS =====
    
    // Listen for project data changes
    projectDataRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            projectData = Object.keys(data).map(key => ({
                firebaseKey: key,
                ...data[key]
            }));
        } else {
            projectData = [];
        }
        populateTable();
        updateStats();
    });

    // Listen for activity history changes
    activityHistoryRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            activityHistory = Object.keys(data).map(key => ({
                firebaseKey: key,
                ...data[key]
            })).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } else {
            activityHistory = [];
        }
        populateEquipmentHistoryFilter();
        filterEquipmentHistory();
    });

    // ===== INITIALIZATION =====
   document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    
    projectDataRef.once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            if (confirm('Database is empty. Would you like to initialize with sample data?')) {
                initializeSampleData();
            }
        }
    });
});

    function initializeSampleData() {
        const sampleData = [
    { id: 1, no: 1, priority: "2nd", equipment: "Air Blower Expander (K-052-02)", vendor: "MAN-RMS", disc: "CI", task: "CI", taskName: "FAT Inspection", status: "Contract Issue", contract: "Quotation", visa: "Not Applied", targetDate: "2025-10-25", mobDate: "End Oct", targetCompDate: "2025-11-15", prognosaCompDate: "2025-11-20", progress: 0, mitigationPlan: "Expedite quotation process with vendor" },
    { id: 2, no: 2, priority: "2nd", equipment: "Air Blower Anti-surge (K-052-01)", vendor: "MAN-Honeywell", disc: "CI", task: "CI", taskName: "SAT Testing", status: "Contract Issue", contract: "Quotation", visa: "Not Applied", targetDate: "2025-11-01", mobDate: "Early Nov", targetCompDate: "2025-11-20", prognosaCompDate: "2025-11-25", progress: 0, mitigationPlan: "" },
    { id: 3, no: 3, priority: "2nd", equipment: "WGC Compressor I-SAT (K-052-03)", vendor: "EETC", disc: "CI", task: "CI", taskName: "Installation SAT", status: "Payment Issue", contract: "Ongoing", visa: "Not Applied", targetDate: "2025-10-10", mobDate: "Oct 15", targetCompDate: "2025-10-25", prognosaCompDate: "2025-10-28", progress: 0, mitigationPlan: "" },
    { id: 4, no: 4, priority: "2nd", equipment: "WGC Compressor Control (K-052-03)", vendor: "EETC", disc: "COM", task: "COM", taskName: "Commissioning", status: "Payment Issue", contract: "Waiting AP", visa: "Not Applied", targetDate: "2025-10-10", mobDate: "Oct 15", targetCompDate: "2025-10-25", prognosaCompDate: "2025-10-30", progress: 0, mitigationPlan: "" },
    { id: 5, no: 5, priority: "2nd", equipment: "Flue Gas Scrubber", vendor: "BELCO", disc: "CI", task: "CI", taskName: "Performance Test", status: "VISA Processing", contract: "Done", visa: "Processing", targetDate: "2025-10-05", mobDate: "Oct 7", targetCompDate: "2025-10-20", prognosaCompDate: "2025-10-22", progress: 0, mitigationPlan: "" }
];

        sampleData.forEach(item => {
            projectDataRef.push(item);
        });

        activityHistoryRef.push({
            id: 1,
            timestamp: new Date().toISOString(),
            type: 'system',
            category: 'SYSTEM',
            title: 'Database Initialized',
            equipmentId: null,
            equipment: 'System',
            vendor: 'System',
            description: 'Sample data loaded successfully',
            notes: 'Database initialized with sample project data',
            user: 'System',
            icon: '🎉',
            color: '#3498db'
        });

        showNotification('Sample data initialized successfully!', 'success');
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                filterByPriority(this.getAttribute('data-filter'));
            });
        });

        const searchBox = document.getElementById('searchBox');
        if (searchBox) searchBox.addEventListener('keyup', searchTable);

       const addItemBtn = document.getElementById('addItemBtn');
const exportBtn = document.getElementById('exportBtn');
const viewTimelineBtn = document.getElementById('viewTimelineBtn');
const showHistoryBtn = document.getElementById('showAllHistoryBtn');
const closeModalBtn = document.getElementById('closeModal');
const saveButton = document.getElementById('saveButton');

if (addItemBtn) addItemBtn.addEventListener('click', openAddModal);
if (exportBtn) exportBtn.addEventListener('click', exportToPDF);
if (viewTimelineBtn) viewTimelineBtn.addEventListener('click', openGanttModal);
if (showHistoryBtn) showHistoryBtn.addEventListener('click', showFullHistory);
if (closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
if (saveButton) saveButton.addEventListener('click', saveUpdate);

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('updateModal');
            if (event.target === modal) {
                closeModal();
            }
        });
    }
// ===== GANTT CHART FUNCTIONS =====
let ganttInstance = null;
let currentGanttView = 'Week';

function openGanttModal() {
    document.getElementById('ganttModal').style.display = 'block';
    
    // Wait for modal to be visible before rendering
    setTimeout(() => {
        renderGanttChart();
    }, 100);
}

function closeGanttModal() {
    document.getElementById('ganttModal').style.display = 'none';
    if (ganttInstance) {
        ganttInstance = null;
    }
}

function prepareGanttData() {
    const ganttTasks = [];
    
    // Apply filter
    let filteredData = projectData;
    if (currentGanttFilter === 'critical') {
        filteredData = projectData.filter(item => item.highlighted);
    } else if (currentGanttFilter !== 'all') {
        filteredData = projectData.filter(item => item.priority === currentGanttFilter);
    }
    
    filteredData.forEach((item, index) => {
        // Parse dates - use different dates if not set to avoid stacking
        let startDate = item.targetDate;
        
        // If no target date, create staggered dates based on index to avoid overlapping
        if (!startDate) {
            const today = new Date();
            today.setDate(today.getDate() + (index * 3)); // Spread tasks by 3 days each
            startDate = today.toISOString().split('T')[0];
        }
        
        let endDate = item.targetCompDate || item.prognosaCompDate;
        
        // If no end date, add 7 days to start date
        if (!endDate) {
            const start = new Date(startDate);
            start.setDate(start.getDate() + 7);
            endDate = start.toISOString().split('T')[0];
        }
        
        // Ensure end date is after start date
        if (new Date(endDate) <= new Date(startDate)) {
            const start = new Date(startDate);
            start.setDate(start.getDate() + 7);
            endDate = start.toISOString().split('T')[0];
        }
        
        // Determine task color based on status
        // Determine task color based on status

// Determine task color based on status
let customClass = '';

// Priority 1: Check completion status
if (item.status.includes('Completed')) {
    customClass = 'bar-completed';
}
// Priority 2: Check for work delay (target comp vs prognosa comp)
else if (item.targetCompDate && item.prognosaCompDate) {
    const targetComp = new Date(item.targetCompDate);
    const prognosaComp = new Date(item.prognosaCompDate);
    
    // Work Delayed: Prognosa >= Target (sama atau lebih lambat)
    if (prognosaComp >= targetComp) {
        customClass = 'bar-workdelayed'; // Merah - Work Delayed
    } 
    // On Track: Prognosa < Target (lebih cepat dari target)
    else {
        customClass = 'bar-inprogress'; // Hijau - On track
    }
}
// Priority 3: Check if onsite/in progress (no prognosa data yet)
else if (item.status.includes('Onsite')) {
    customClass = 'bar-inprogress';
}
// Priority 4: Check for mobilization delay (target mob vs actual mob)
else if (item.targetDate && item.mobDate) {
    const mobDateStatus = getDateStatus(item.targetDate, item.mobDate);
    if (mobDateStatus.status.includes('DELAYED')) {
        customClass = 'bar-delayedmob'; // Kuning - Delayed MOB
    } else {
        customClass = 'bar-notstarted'; // Abu-abu - Not started
    }
}
// Priority 5: Default - Not started
else {
    customClass = 'bar-notstarted'; // Abu-abu - Not started
}
        
        ganttTasks.push({
            id: item.firebaseKey || `task-${index}`,
            name: `${item.equipment} (${item.vendor})`,
            start: startDate,
            end: endDate,
            progress: item.progress || 0,
            custom_class: customClass,
            dependencies: ''
        });
    });
    
    return ganttTasks;
}

function renderGanttChart() {
    // Show loading
    document.getElementById('gantt-chart').innerHTML = '<div style="padding: 60px; text-align: center; color: #7f8c8d;"><div style="font-size: 24px; margin-bottom: 10px;">⏳</div>Loading timeline...</div>';
    
    setTimeout(function() {
        const tasks = prepareGanttData();
        
        if (tasks.length === 0) {
            document.getElementById('gantt-chart').innerHTML = '<div style="padding: 40px; text-align: center; color: #95a5a6;">No tasks available for timeline view</div>';
            return;
        }
        
        // Destroy existing instance
        if (ganttInstance) {
            document.getElementById('gantt-chart').innerHTML = '';
        }
        
        // Create new Gantt instance
      // Create new Gantt instance
ganttInstance = new Gantt("#gantt-chart", tasks, {
    view_mode: currentGanttView,
    bar_height: 30,
    on_click: function(task) {
        // Show mitigation plan for work delayed tasks
        showMitigationTooltip(task);
    },
    on_view_change: function(mode) {
        currentGanttView = mode;
    }
});

// Force apply colors after render
setTimeout(function() {
    applyGanttColors();
    attachGanttHoverEvents(); // Add hover events
}, 200);
    }, 100);
}

// NEW FUNCTION: Apply colors manually to Gantt bars
function applyGanttColors() {
    const tasks = prepareGanttData();
    
    tasks.forEach(function(task) {
        const barElement = document.querySelector('.gantt .bar-wrapper[data-id="' + task.id + '"] .bar');
        
        if (barElement) {
    let color = '#95a5a6'; // default gray - Not Started
    
    if (task.custom_class === 'bar-completed') {
        color = '#3498db'; // Biru - Completed
    } else if (task.custom_class === 'bar-inprogress') {
        color = '#27ae60'; // Hijau - In Progress
    } else if (task.custom_class === 'bar-delayedmob') {
        color = '#f39c12'; // Kuning - Delayed MOB
    } else if (task.custom_class === 'bar-workdelayed') {
        color = '#e74c3c'; // Merah - Work Delayed
    } else if (task.custom_class === 'bar-notstarted') {
        color = '#95a5a6'; // Abu-abu - Not Started
    }
    
    barElement.setAttribute('fill', color);
    barElement.style.fill = color;
}
    });
}

// Function to show mitigation plan tooltip
function showMitigationTooltip(task) {
    const item = projectData.find(p => p.firebaseKey === task.id);
    
    if (!item) return;
    
    // Only show for work delayed tasks
   // Only show for work delayed tasks with mitigation plan
if (task.custom_class !== 'bar-workdelayed' || !item.mitigationPlan || item.mitigationPlan.trim() === '') {
    return;
}
    
    if (item.mitigationPlan && item.mitigationPlan.trim() !== '') {
        alert('⚠️ WORK MITIGATION PLAN\n\n' + 
              'Equipment: ' + item.equipment + '\n' +
              'Vendor: ' + item.vendor + '\n\n' +
              'Mitigation Plan:\n' + item.mitigationPlan);
    } else {
        showNotification('No mitigation plan available for this task', 'error');
    }
}

// Function to attach hover events to Gantt bars
function attachGanttHoverEvents() {
    // Remove existing tooltip if any
    const existingTooltip = document.getElementById('ganttTooltip');
    if (existingTooltip) {
        existingTooltip.remove();
    }
    
    // Create tooltip element
    const tooltip = document.createElement('div');
    tooltip.id = 'ganttTooltip';
    tooltip.className = 'gantt-tooltip';
    document.body.appendChild(tooltip);
    
    // Get all gantt bars
    const bars = document.querySelectorAll('.gantt .bar-wrapper');
    
    bars.forEach(bar => {
        const taskId = bar.getAttribute('data-id');
        const task = prepareGanttData().find(t => t.id === taskId);
        const item = projectData.find(p => p.firebaseKey === taskId);
        
        if (!item) return;
        
        // Only add hover for work delayed tasks with mitigation plan
        if (task && task.custom_class === 'bar-workdelayed' && item.mitigationPlan) {
            bar.style.cursor = 'pointer';
            
            bar.addEventListener('mouseenter', function(e) {
                const targetComp = item.targetCompDate ? formatDateForDisplay(item.targetCompDate) : 'N/A';
                const prognosaComp = item.prognosaCompDate ? formatDateForDisplay(item.prognosaCompDate) : 'N/A';
                
                tooltip.innerHTML = `
                    <div class="gantt-tooltip-header">
                        ⚠️ Work Delayed - Mitigation Plan
                    </div>
                    <div style="font-size: 11px; margin-bottom: 8px;">
                        <strong>${item.equipment}</strong><br>
                        <span style="color: #666;">${item.vendor}</span>
                    </div>
                    <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 10px;">
                        <strong>Target Completion:</strong> ${targetComp}<br>
                        <strong>Prognosa Completion:</strong> ${prognosaComp}
                    </div>
                    <div class="gantt-tooltip-content">${item.mitigationPlan}</div>
                    <div class="gantt-tooltip-footer">Click for more details</div>
                `;
                tooltip.classList.add('active');
                
                // Position tooltip near cursor
                const rect = bar.getBoundingClientRect();
                tooltip.style.left = (rect.left + window.scrollX) + 'px';
                tooltip.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            });
            
            bar.addEventListener('mouseleave', function() {
                tooltip.classList.remove('active');
            });
        }
    });
}

function changeGanttView(viewMode) {
    currentGanttView = viewMode;
    
    // Update active button
    document.querySelectorAll('.gantt-view-btn').forEach(function(btn) {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Re-render gantt
    if (ganttInstance) {
        ganttInstance.change_view_mode(viewMode);
        
        // Re-apply colors and events after view change
        setTimeout(function() {
            applyGanttColors();
            attachGanttHoverEvents(); // Re-attach hover events
        }, 200);
    }
}

function jumpToGanttDate() {
    const selectedDate = document.getElementById('ganttDatePicker').value;
    if (!selectedDate || !ganttInstance) return;
    
    const dateObj = new Date(selectedDate);
    const tasks = prepareGanttData();
    
    // Find task closest to this date
    const closestTask = tasks.reduce((prev, curr) => {
        const prevDiff = Math.abs(new Date(prev.start) - dateObj);
        const currDiff = Math.abs(new Date(curr.start) - dateObj);
        return currDiff < prevDiff ? curr : prev;
    });
    
    if (closestTask) {
        // Alternative: Scroll to task bar manually using DOM
        const taskBar = document.querySelector(`.gantt .bar-wrapper[data-id="${closestTask.id}"]`);
        if (taskBar) {
            taskBar.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center',
                inline: 'center'
            });
            
            // Highlight the bar briefly
            const bar = taskBar.querySelector('.bar');
            if (bar) {
                const originalFill = bar.style.fill;
                bar.style.fill = '#fff';
                bar.style.stroke = '#000';
                bar.style.strokeWidth = '3';
                
                setTimeout(() => {
                    bar.style.fill = originalFill;
                    bar.style.stroke = '';
                    bar.style.strokeWidth = '';
                }, 1000);
            }
            
            showNotification(`Jumped to ${formatDateForDisplay(selectedDate)} - ${closestTask.name}`, 'success');
        } else {
            showNotification('Task not found in current view', 'error');
        }
    }
}

let currentGanttFilter = 'all';

function filterGanttChart() {
    currentGanttFilter = document.getElementById('ganttFilterPriority').value;
    renderGanttChart();
}

function exportGanttPDF() {
    // Capture the current Gantt chart as image first
    showNotification('Preparing timeline for export...', 'success');
    
    const printWindow = window.open('', '_blank');
    const currentDate = new Date().toLocaleString();
    
    const tasks = prepareGanttData();
    
    // Get the Gantt SVG element
    const ganttSVG = document.querySelector('#gantt-chart svg');
    let svgData = '';
    
    if (ganttSVG) {
        const serializer = new XMLSerializer();
        svgData = serializer.serializeToString(ganttSVG);
        // Encode to base64
        svgData = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
    }
    
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Project Timeline - Gantt Chart</title>
        <style>
            body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                font-size: 11px; 
                background: white; /* Fix black preview */
                color: #333; /* Ensure text is visible */
            }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                .header h1 { margin: 0; font-size: 20px; color: #333; }
                .gantt-image { width: 100%; max-width: 100%; margin: 20px 0; border: 1px solid #ddd; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; page-break-inside: avoid; }
                th, td { border: 1px solid #333; padding: 8px; text-align: left; font-size: 10px; }
                th { background: #2c3e50; color: white; }
                tr:nth-child(even) { background: #f9f9f9; }
                .legend { display: flex; gap: 15px; margin: 20px 0; font-size: 10px; justify-content: center; }
                .legend-item { display: flex; align-items: center; gap: 5px; }
                .legend-color { width: 15px; height: 15px; border-radius: 3px; }
                @media print {
                    body { margin: 10px; }
                    .gantt-image { page-break-inside: avoid; }
                    table { page-break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>📊 Project Timeline - Gantt Chart</h1>
                <p>Vendor Mobilization Timeline</p>
                <p style="font-size: 10px;">Generated on: ${currentDate}</p>
                <p style="font-size: 10px;">Filter: ${currentGanttFilter === 'all' ? 'All Items' : currentGanttFilter} | Total Tasks: ${tasks.length}</p>
            </div>
            
            <div class="legend">
    <div class="legend-item">
        <div class="legend-color" style="background: #95a5a6;"></div>
        <span>Not Started</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #27ae60;"></div>
        <span>In Progress / On Track</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #3498db;"></div>
        <span>Completed</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #f39c12;"></div>
        <span>Delayed Mobilization</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #e74c3c;"></div>
        <span>Work Delayed (Prognosa â‰¥ Target)</span>
    </div>
</div>
            
            ${svgData ? '<img src="' + svgData + '" class="gantt-image" alt="Gantt Chart Timeline">' : '<p style="text-align: center; color: #e74c3c;">⚠️ Timeline visualization not available</p>'}
            
            <h2 style="margin-top: 30px; font-size: 14px; border-bottom: 2px solid #333; padding-bottom: 8px;">Task Details</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Equipment</th>
                        <th>Vendor</th>
                        <th>Priority</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Duration</th>
                        <th>Progress</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${tasks.map(function(task, index) {
                        const item = projectData.find(function(p) { return p.firebaseKey === task.id; });
                        const duration = Math.ceil((new Date(task.end) - new Date(task.start)) / (1000 * 60 * 60 * 24));
                        return '<tr>' +
                            '<td>' + (index + 1) + '</td>' +
                            '<td>' + item.equipment + '</td>' +
                            '<td>' + item.vendor + '</td>' +
                            '<td>' + item.priority + '</td>' +
                            '<td>' + formatDateForDisplay(task.start) + '</td>' +
                            '<td>' + formatDateForDisplay(task.end) + '</td>' +
                            '<td>' + duration + ' days</td>' +
                            '<td>' + task.progress + '%</td>' +
                            '<td>' + item.status + '</td>' +
                            '</tr>';
                    }).join('')}
                </tbody>
            </table>
            
            <div style="margin-top: 30px; padding-top: 15px; border-top: 2px solid #333; text-align: center;">
                <p style="margin: 0; font-size: 10px; font-weight: bold;">Developed by TS-KPB</p>
                <p style="margin: 5px 0 0 0; font-size: 8px; color: #999;">© 2025 All Rights Reserved</p>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    printWindow.onload = function() {
        setTimeout(function() {
            printWindow.print();
        }, 250);
    };
}
                

    // ===== UTILITY FUNCTIONS =====
    function getDateStatus(targetDate, mobDate) {
        if (!targetDate || !mobDate) return { status: '-', class: '' };
        
        const target = new Date(targetDate);
        const mob = new Date(parseDateString(mobDate));
        
        if (mob <= target) {
            return { status: 'ON TIME', class: 'status-ontime' };
        } else {
            const diffDays = Math.ceil((mob - target) / (1000 * 60 * 60 * 24));
            return { status: `DELAYED ${diffDays}d`, class: 'status-delayed' };
        }
    }

    function parseDateString(dateStr) {
        if (!dateStr) return null;
        
        if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            return dateStr;
        }
        
        const monthMap = {
            'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
            'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
            'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
        };
        
        const currentYear = new Date().getFullYear();
        const monthMatch = dateStr.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
        const dayMatch = dateStr.match(/\b(\d{1,2})\b/);
        
        if (monthMatch && dayMatch) {
            const month = monthMap[monthMatch[0]];
            const day = dayMatch[0].padStart(2, '0');
            return `${currentYear}-${month}-${day}`;
        }
        
        return null;
    }

    function formatDateForDisplay(dateValue) {
        if (!dateValue) return 'TBD';
        
        const date = new Date(dateValue);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        const month = monthNames[date.getMonth()];
        const day = date.getDate();
        
        return `${month} ${day}`;
    }

    function formatDateForInput(dateString) {
        if (!dateString) return '';
        if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) return dateString;
        
        const currentYear = new Date().getFullYear();
        const monthMap = {
            'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
            'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
            'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
        };
        
        const monthMatch = dateString.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
        const dayMatch = dateString.match(/\b(\d{1,2})\b/);
        
        if (monthMatch && dayMatch) {
            const month = monthMap[monthMatch[0]];
            const day = dayMatch[0].padStart(2, '0');
            return `${currentYear}-${month}-${day}`;
        }
        
        return '';
    }

    // ===== FILTER AND SEARCH =====
    function filterByPriority(priority) {
        currentFilter = priority;
        currentTablePage = 1; // Reset to page 1
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-filter="${priority}"]`).classList.add('active');
        populateTable();
        updateStats();
    }

    function searchTable() {
        const searchTerm = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('#tableBody tr').forEach(row => {
            row.style.display = row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
        });
    }

    function filterByIssueType(issueType) {
    // Reset search box
    document.getElementById('searchBox').value = '';
    
    // Reset to page 1
    currentTablePage = 1;
    
    // Set temporary filter
    window.tempIssueFilter = issueType;
    
    // Repopulate table with filter
    populateTable();
    
    // Update title based on issue type
    let titleText = '';
    if (issueType === 'contract') {
        titleText = 'Detailed Task List - Contract Issues Only';
    } else if (issueType === 'visa') {
        titleText = 'Detailed Task List - VISA Issues Only';
    } else if (issueType === 'payment') {
        titleText = 'Detailed Task List - Payment Issues Only';
    } else if (issueType === 'workdelayed') {
        titleText = 'Detailed Task List - Work Delayed Items (Prognosa ≥ Target)';
    } else {
        const issueTypeText = issueType.charAt(0).toUpperCase() + issueType.slice(1);
        titleText = `Detailed Task List - ${issueTypeText} Issues Only`;
    }
    
    document.querySelector('.table-title').textContent = titleText;
    
    // Add clear filter button if not exists
    if (!document.getElementById('clearFilterBtn')) {
        const clearBtn = document.createElement('button');
        clearBtn.id = 'clearFilterBtn';
        clearBtn.className = 'btn-export';
        clearBtn.style.background = '#95a5a6';
        clearBtn.textContent = 'Clear Filter';
        clearBtn.onclick = clearIssueFilter;
        document.querySelector('.add-item-container').appendChild(clearBtn);
    }
}

function filterByStatus(statusType) {
    // Reset search box
    document.getElementById('searchBox').value = '';
    
    // Reset to page 1
    currentTablePage = 1;
    
    // Set temporary status filter
    window.tempStatusFilter = statusType;
    
    // Repopulate table with filter
    populateTable();
    
    // Update title based on filter type
    let titleText = 'Detailed Task List';
    if (statusType === 'all') {
        titleText = 'Detailed Task List - All Items';
    } else if (statusType === 'onsite') {
        titleText = 'Detailed Task List - Already Onsite';
    } else if (statusType === 'notonsite') {
        titleText = 'Detailed Task List - Not Onsite Yet';
    } else if (statusType === 'inprogress') {
        titleText = 'Detailed Task List - Onsite In Progress';
    } else if (statusType === 'completed') {
        titleText = 'Detailed Task List - Completed Tasks';
    } else if (statusType === 'ontime') {
        titleText = 'Detailed Task List - On Time Mobilizations';
    } else if (statusType === 'delayed') {
        titleText = 'Detailed Task List - Delayed Mobilizations';
    }
    
    document.querySelector('.table-title').textContent = titleText;
    
    // Add clear filter button if not exists
    if (!document.getElementById('clearFilterBtn')) {
        const clearBtn = document.createElement('button');
        clearBtn.id = 'clearFilterBtn';
        clearBtn.className = 'btn-export';
        clearBtn.style.background = '#95a5a6';
        clearBtn.textContent = 'Clear Filter';
        clearBtn.onclick = clearAllFilters;
        document.querySelector('.add-item-container').appendChild(clearBtn);
    }
}

    function clearIssueFilter() {
        clearAllFilters();
    }

    function clearAllFilters() {
        // Remove all temporary filters
        window.tempIssueFilter = null;
        window.tempStatusFilter = null;
        
        // Reset to page 1
        currentTablePage = 1;
        
        // Repopulate table without filter
        populateTable();
        
        // Reset title
        document.querySelector('.table-title').textContent = 'Detailed Task List';
        
        // Remove clear button
        const clearBtn = document.getElementById('clearFilterBtn');
        if (clearBtn) clearBtn.remove();
    }

    // ===== TABLE POPULATION =====
    function populateTable() {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';

let filteredData;
if (currentFilter === 'highlighted') {
    filteredData = projectData.filter(item => item.highlighted);
} else if (currentFilter === 'all') {
    filteredData = projectData;
} else {
    filteredData = projectData.filter(item => item.priority === currentFilter);
}

// Apply issue filter if exists
// Apply issue filter if exists
// Apply issue filter if exists
if (window.tempIssueFilter) {
    const issueType = window.tempIssueFilter;
    filteredData = filteredData.filter(item => {
        if (issueType === 'contract') {
            return item.status.includes('Contract Issue') || 
                   item.status.includes('Contract Review') || 
                   item.contract === 'Quotation' || 
                   item.contract === 'Under Review' || 
                   item.contract === 'Reviewing';
        } else if (issueType === 'payment') {
            return item.status.includes('Payment Issue') || 
                   item.contract === 'Waiting AP';
        } else if (issueType === 'visa') {
            return item.status.includes('VISA Processing') || 
                   item.visa === 'Processing' || 
                   item.visa === 'Ongoing';
        } else if (issueType === 'workdelayed') {
            // Filter Work Delayed: Prognosa >= Target Completion Date
            return item.targetCompDate && item.prognosaCompDate && 
                   new Date(item.prognosaCompDate) >= new Date(item.targetCompDate);
        }
        return false;
    });
}

// Apply status filter if exists
if (window.tempStatusFilter) {
    const statusType = window.tempStatusFilter;
    filteredData = filteredData.filter(item => {
        if (statusType === 'all') {
            return true;
        } else if (statusType === 'onsite') {
            return item.status.includes('Onsite') || item.status.includes('Completed');
        } else if (statusType === 'notonsite') {
            return !item.status.includes('Onsite') && !item.status.includes('Completed');
        } else if (statusType === 'inprogress') {
            return item.status.includes('Onsite') && !item.status.includes('Completed');
        } else if (statusType === 'completed') {
            return item.status.includes('Completed');
        } else if (statusType === 'ontime') {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status === 'ON TIME';
        } else if (statusType === 'delayed') {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status.includes('DELAYED');
        }
        return false;
    });
}

        // Calculate pagination
        const totalPages = Math.ceil(filteredData.length / itemsPerTablePage);
        const startIndex = (currentTablePage - 1) * itemsPerTablePage;
        const endIndex = startIndex + itemsPerTablePage;
        const pageData = filteredData.slice(startIndex, endIndex);

        pageData.forEach((item, index) => {
    const rowNumber = startIndex + index + 1;  // Tambahkan ini untuk nomor urut dinamis
    const dateStatus = getDateStatus(item.targetDate, item.mobDate);
    const row = document.createElement('tr');

// Add highlight class if item is highlighted
let rowClasses = `priority-${item.priority}`;
if (item.highlighted) {
    rowClasses += ' highlighted';
}
row.className = rowClasses;

row.innerHTML = `
    <td>${rowNumber}</td>
    <td><span class="priority-badge priority-${item.priority}">${item.priority}</span></td>
    <td style="font-weight: ${item.highlighted ? '700' : '500'}; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 8px;" title="${item.equipment}">
        ${item.highlighted ? '<span class="warning-badge">⚠</span>' : ''}${item.equipment}
    </td>
    <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${item.vendor}"><strong>${item.vendor}</strong></td>
<td><span class="status-badge">${item.disc || item.task}</span></td>
<td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; font-size: 11px;" title="${item.taskName || '-'}">${item.taskName || '-'}</td>
<td><span class="status-badge ${getStatusClass(item.status)}">${item.status}</span></td>
                <td><span class="status-badge ${getContractClass(item.contract)}">${item.contract}</span></td>
                <td><span class="status-badge ${getVisaClass(item.visa)}">${item.visa}</span></td>
                <td style="white-space: nowrap;">${item.targetDate ? formatDateForDisplay(item.targetDate) : '-'}</td>
                <td style="white-space: nowrap;">${item.mobDate}</td>
<td><span class="status-badge ${dateStatus.class}">${dateStatus.status}</span></td>
<td style="white-space: nowrap;">${item.targetCompDate ? formatDateForDisplay(item.targetCompDate) : '-'}</td>
<td style="white-space: nowrap;">${item.prognosaCompDate ? formatDateForDisplay(item.prognosaCompDate) : '-'}</td>
<td>
    <div class="progress-bar" style="width: 50px;">
                        <div class="progress-fill" style="width: ${item.progress}%;"></div>
                    </div>
                    <small style="font-size: 8px; margin-left: 3px;">${item.progress}%</small>
                </td>
                <td style="white-space: nowrap; text-align: center;">
    <button class="action-btn primary" onclick="openUpdateModal('${item.firebaseKey}')" style="font-size: 9px; padding: 4px 8px;">Update</button>
    <button class="action-btn success" onclick="showProgressReportById('${item.firebaseKey}')" title="View Progress Report" style="background: #27ae60; font-size: 9px; padding: 4px 8px; margin-left: 3px;">📊 Progress</button>
    <button class="btn-delete" onclick="deleteItem('${item.firebaseKey}')" title="Delete" style="font-size: 12px; padding: 4px 7px; line-height: 1; margin-left: 3px;">🗑️</button>
</td>
            `;
            tableBody.appendChild(row);
        });

        // Update pagination info
        updateTablePagination(filteredData.length, totalPages);

        // Update upcoming mobilizations
        updateUpcomingMobilizations();
    }

function updateTablePagination(totalItems, totalPages) {
        const startIndex = (currentTablePage - 1) * itemsPerTablePage;
        const endIndex = Math.min(startIndex + itemsPerTablePage, totalItems);
        
        document.getElementById('tablePageInfo').textContent = `${startIndex + 1}-${endIndex} of ${totalItems}`;
        
        document.getElementById('prevTablePageBtn').disabled = currentTablePage === 1;
        document.getElementById('nextTablePageBtn').disabled = currentTablePage === totalPages || totalPages === 0;
        
        renderTablePageNumbers(totalPages);
    }

    function renderTablePageNumbers(totalPages) {
        const pageNumbersDiv = document.getElementById('tablePageNumbers');
        let html = '';
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentTablePage - 2 && i <= currentTablePage + 2)) {
                html += `<button onclick="goToTablePage(${i})" style="padding: 6px 10px; background: ${i === currentTablePage ? '#3498db' : '#ecf0f1'}; color: ${i === currentTablePage ? 'white' : '#2c3e50'}; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; min-width: 30px;">${i}</button>`;
            } else if (i === currentTablePage - 3 || i === currentTablePage + 3) {
                html += '<span style="padding: 0 5px;">...</span>';
            }
        }
        
        pageNumbersDiv.innerHTML = html;
    }

    function changeTablePage(direction) {
    const filteredData = currentFilter === 'all' ? projectData : projectData.filter(item => item.priority === currentFilter);
    const totalPages = Math.ceil(filteredData.length / itemsPerTablePage);
    const newPage = currentTablePage + direction;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentTablePage = newPage;
        populateTable();
        
        // Scroll ke posisi tabel
        const tableSection = document.querySelector('.main-table-section');
        if (tableSection) {
            tableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
}

    function goToTablePage(page) {
    currentTablePage = page;
    populateTable();
    
    // Scroll ke posisi tabel
    const tableSection = document.querySelector('.main-table-section');
    if (tableSection) {
        tableSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

    function getStatusClass(status) {
        if (status.includes('Completed')) return 'status-done';
        if (status.includes('Onsite')) return 'status-onsite';
        if (status.includes('Issue')) return 'status-issue';
        if (status.includes('Processing')) return 'status-ongoing';
        return 'status-waiting';
    }

    function getContractClass(contract) {
        if (contract === 'Done') return 'status-done';
        if (contract.includes('Ongoing') || contract.includes('Reviewing')) return 'status-ongoing';
        if (contract.includes('Quotation') || contract.includes('Review')) return 'status-issue';
        return 'status-waiting';
    }

    function getVisaClass(visa) {
        if (visa === 'Done') return 'status-done';
        if (visa === 'Processing' || visa === 'Ongoing') return 'status-ongoing';
        if (visa === 'Local') return 'status-onsite';
        return 'status-issue';
    }

    // ===== STATISTICS =====
    function updateStats() {
    let filteredData;
    if (currentFilter === 'highlighted') {
        filteredData = projectData.filter(item => item.highlighted);
    } else if (currentFilter === 'all') {
        filteredData = projectData;
    } else {
        filteredData = projectData.filter(item => item.priority === currentFilter);
    }

        const total = filteredData.length;
        const belumOnsite = filteredData.filter(item => !item.status.includes('Completed') && !item.status.includes('Onsite')).length;
        const sudahOnsite = total - belumOnsite;
        const contractIssues = filteredData.filter(item => item.status === 'Contract Issue' || item.status === 'Contract Review' || item.contract === 'Quotation' || item.contract === 'Under Review' || item.contract === 'Reviewing').length;
        const paymentIssues = filteredData.filter(item => item.status === 'Payment Issue' || item.contract === 'Waiting AP').length;
        const visaProcessing = filteredData.filter(item => item.status === 'VISA Processing' || item.visa === 'Processing' || item.visa === 'Ongoing').length;
        const inProgress = filteredData.filter(item => item.status.includes('Onsite') && !item.status.includes('Completed')).length;
        const completed = filteredData.filter(item => item.status.includes('Completed')).length;
        
        const onTime = filteredData.filter(item => {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status === 'ON TIME';
        }).length;
        
        const delayed = filteredData.filter(item => {
            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
            return dateStatus.status.includes('DELAYED');
        }).length;

        // Calculate Work Delayed count (Prognosa >= Target Completion)
const workDelayed = filteredData.filter(item => {
    if (!item.targetCompDate || !item.prognosaCompDate) return false;
    return new Date(item.prognosaCompDate) >= new Date(item.targetCompDate);
}).length;

document.getElementById('totalCount').textContent = total;
document.getElementById('belumOnsiteCount').textContent = belumOnsite;
document.getElementById('sudahOnsiteCount').textContent = sudahOnsite;
document.getElementById('contractIssueCount').textContent = contractIssues;
document.getElementById('paymentIssueCount').textContent = paymentIssues;
document.getElementById('visaProcessingCount').textContent = visaProcessing;
document.getElementById('inProgressCount').textContent = inProgress;
document.getElementById('completedCount').textContent = completed;
document.getElementById('onTimeCount').textContent = onTime;
document.getElementById('delayedCount').textContent = delayed;
document.getElementById('criticalContract').textContent = contractIssues;
document.getElementById('criticalVisa').textContent = visaProcessing;
document.getElementById('criticalPayment').textContent = paymentIssues;
document.getElementById('criticalWorkDelayed').textContent = workDelayed;

// Update upcoming mobilizations
updateUpcomingMobilizations();
    }

// ===== UPCOMING MOBILIZATIONS =====
    function updateUpcomingMobilizations() {
        const container = document.getElementById('upcomingContainer');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Filter items dengan target date dalam 30 hari ke depan
        const upcomingItems = projectData.filter(item => {
            if (!item.targetDate) return false;
            const targetDate = new Date(item.targetDate);
            const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            return daysUntil >= 0 && daysUntil <= 30;
        }).sort((a, b) => {
            return new Date(a.targetDate) - new Date(b.targetDate);
        });

        document.getElementById('upcomingCount').textContent = upcomingItems.length;

        if (upcomingItems.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #95a5a6; font-size: 11px;">No upcoming mobilizations in next 30 days</div>';
            return;
        }

        container.innerHTML = upcomingItems.map(item => {
            const targetDate = new Date(item.targetDate);
targetDate.setHours(0, 0, 0, 0);
const daysUntil = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            // Determine urgency
            let urgencyColor, urgencyText, urgencyIcon;
            if (daysUntil <= 2) {
                urgencyColor = '#e74c3c';
                urgencyText = 'URGENT';
                urgencyIcon = '🔴';
            } else if (daysUntil <= 7) {
                urgencyColor = '#f39c12';
                urgencyText = 'HIGH';
                urgencyIcon = '🟡';
            } else {
                urgencyColor = '#27ae60';
                urgencyText = 'NORMAL';
                urgencyIcon = '🟢';
            }

            // Get blockers
            let blockers = [];
            if (item.status.includes('Payment Issue') || item.contract === 'Waiting AP') {
                blockers.push('Payment pending');
            }
            if (item.status.includes('Contract Issue') || item.contract === 'Quotation') {
                blockers.push('Contract pending');
            }
            if (item.status.includes('VISA Processing') || item.visa === 'Processing') {
                blockers.push('VISA processing');
            }

            const blockerText = blockers.length > 0 ? `⚠️ ${blockers.join(', ')}` : '✓ All Clear - Ready to mobilize';
            const blockerColor = blockers.length > 0 ? '#e74c3c' : '#27ae60';

            return `
                <div style="border: 2px solid ${urgencyColor}; border-radius: 6px; padding: 10px; margin-bottom: 10px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 9px; background: ${urgencyColor}; color: white; padding: 2px 6px; border-radius: 3px; font-weight: 600;">${urgencyIcon} ${urgencyText}</span>
                        <span style="font-size: 10px; color: #7f8c8d; font-weight: 600;">${daysUntil} day${daysUntil !== 1 ? 's' : ''} left</span>
                    </div>
                    <div style="font-size: 11px; font-weight: 600; color: #2c3e50; margin-bottom: 3px;">${formatDateForDisplay(item.targetDate)}</div>
                    <div style="font-size: 10px; color: #34495e; margin-bottom: 5px;">${item.equipment}</div>
                    <div style="font-size: 10px; color: #7f8c8d; margin-bottom: 5px;"><strong>${item.vendor}</strong></div>
                    <div style="font-size: 9px; color: ${blockerColor}; background: ${blockers.length > 0 ? '#fff3cd' : '#d4edda'}; padding: 4px 6px; border-radius: 3px;">${blockerText}</div>
                    <button onclick="openUpdateModal('${item.firebaseKey}')" style="width: 100%; margin-top: 6px; padding: 4px; background: #3498db; color: white; border: none; border-radius: 3px; font-size: 9px; cursor: pointer; font-weight: 600;">Quick Update</button>
                </div>
            `;
        }).join('');
    }

    // ===== HISTORY =====
    function populateEquipmentHistoryFilter() {
         const filterSelect = document.getElementById('equipmentHistoryFilter');
    const searchInput = document.getElementById('equipmentSearch');
    const currentValue = filterSelect.value;
        
        filterSelect.innerHTML = '<option value="all">All Equipment</option>';
        
        const uniqueEquipmentMap = new Map();
        
        activityHistory.forEach(item => {
            if (item.equipmentId && !uniqueEquipmentMap.has(item.equipmentId)) {
                uniqueEquipmentMap.set(item.equipmentId, {
                    id: item.equipmentId,
                    name: item.equipment,
                    vendor: item.vendor
                });
            }
        });
        
        const sortedEquipment = Array.from(uniqueEquipmentMap.values()).sort((a, b) => a.name.localeCompare(b.name));
        
        sortedEquipment.forEach(eq => {
            const option = document.createElement('option');
            option.value = eq.id;
            option.textContent = `${eq.name} (${eq.vendor})`;
	option.setAttribute('data-equipment', eq.name.toLowerCase());
        option.setAttribute('data-vendor', eq.vendor.toLowerCase());
            filterSelect.appendChild(option);
        });
        
        filterSelect.value = currentValue;
if (searchInput) {
        searchInput.value = '';
    }
    }

// NEW FUNCTION: Search Equipment
function searchEquipment() {
    const searchInput = document.getElementById('equipmentSearch');
    const filterSelect = document.getElementById('equipmentHistoryFilter');
    const searchTerm = searchInput.value.toLowerCase();
    
    const options = filterSelect.querySelectorAll('option');
    
    options.forEach(option => {
        if (option.value === 'all') {
            option.style.display = ''; // Always show "All Equipment"
            return;
        }
        
        const searchableText = option.getAttribute('data-searchable') || option.textContent.toLowerCase();
        
        if (searchableText.includes(searchTerm)) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Auto-select first visible option if search is active
    if (searchTerm) {
        const firstVisible = Array.from(options).find(opt => opt.style.display !== 'none' && opt.value !== 'all');
        if (firstVisible) {
            filterSelect.value = firstVisible.value;
            filterEquipmentHistory();
        }
    }
}

    function filterEquipmentHistory() {
        const filterValue = document.getElementById('equipmentHistoryFilter').value;
        const container = document.getElementById('historyContainer');
	const progressBtn = document.getElementById('viewProgressReportBtn');

// Show/hide progress report button
        if (filterValue === 'all') {
            progressBtn.style.display = 'none';
        } else {
            progressBtn.style.display = 'block';
        }
        
        let filteredHistory = activityHistory;
        
        if (filterValue !== 'all') {
            const equipmentId = parseInt(filterValue);
            filteredHistory = activityHistory.filter(item => item.equipmentId === equipmentId);
            
            if (filteredHistory.length === 0) {
                container.innerHTML = '<div style="padding: 15px; text-align: center; color: #95a5a6; font-size: 11px;"><p>No history found for this equipment</p></div>';
                return;
            }
        }
        
        const recentItems = filteredHistory.slice(0, 6);
        
        container.innerHTML = recentItems.map(item => `
        <div class="timeline-item" style="border-left: 3px solid ${item.color}; padding-left: 8px; margin-bottom: 10px; position: relative;">
                <button onclick="deleteHistory('${item.firebaseKey}')" style="position: absolute; top: 25px; right: 5px; background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 2px 6px; font-size: 9px; cursor: pointer; font-weight: 600;" title="Delete">🗑</button>
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 3px;">
                <strong style="font-size: 10px; color: #2c3e50;">${new Date(item.timestamp).toLocaleString()}</strong>
                <span style="font-size: 8px; background: ${item.color}; color: white; padding: 1px 4px; border-radius: 8px;">${item.category}</span>
            </div>
            <div style="font-size: 11px; font-weight: 500; margin-bottom: 2px;">${item.title}</div>
            <div style="font-size: 10px; color: #666; margin-bottom: 3px;">${item.description}</div>
            <div style="font-size: 10px; color: #999; background: #f8f9fa; padding: 6px 8px; border-radius: 3px; word-wrap: break-word; white-space: pre-wrap; line-height: 1.5; overflow-wrap: break-word; max-width: 100%; word-break: break-word;">${item.icon} ${item.notes}</div>
            <div style="font-size: 8px; color: #95a5a6; margin-top: 3px;">by ${item.user}</div>
        </div>
    `).join('');
}

    // ===== MODAL FUNCTIONS =====
    function openAddModal() {
        currentEditId = null;
        document.getElementById('modalTitle').textContent = 'Add New Task';
        clearForm();
        document.getElementById('updateModal').style.display = 'block';
    }

    function openUpdateModal(firebaseKey) {
        const item = projectData.find(p => p.firebaseKey === firebaseKey);
        if (!item) return;

        currentEditId = firebaseKey;
        document.getElementById('modalTitle').textContent = 'Update Task';
        document.getElementById('modalEquipment').value = item.equipment;
document.getElementById('modalVendor').value = item.vendor;
document.getElementById('modalPriority').value = item.priority;
document.getElementById('modalDisc').value = item.disc || item.task || 'CI';
document.getElementById('modalTask').value = item.taskName || '';
document.getElementById('modalStatus').value = item.status;
        document.getElementById('modalContract').value = item.contract;
        document.getElementById('modalVisa').value = item.visa;
        document.getElementById('modalTargetDate').value = item.targetDate || '';
        document.getElementById('modalMobDate').value = formatDateForInput(item.mobDate);
document.getElementById('modalTargetCompDate').value = item.targetCompDate || '';
document.getElementById('modalPrognosaCompDate').value = item.prognosaCompDate || '';
document.getElementById('modalProgress').value = item.progress;
document.getElementById('modalHighlight').checked = item.highlighted || false;
document.getElementById('modalMitigationPlan').value = item.mitigationPlan || '';
document.getElementById('modalNotes').value = '';
        document.getElementById('updateModal').style.display = 'block';
    }

    function clearForm() {
       document.getElementById('modalEquipment').value = '';
document.getElementById('modalVendor').value = '';
document.getElementById('modalPriority').value = '2nd';
document.getElementById('modalDisc').value = 'CI';
document.getElementById('modalTask').value = '';
document.getElementById('modalStatus').value = 'Contract Issue';
        document.getElementById('modalContract').value = 'Quotation';
        document.getElementById('modalVisa').value = 'Not Applied';
        document.getElementById('modalTargetDate').value = '';
        document.getElementById('modalMobDate').value = '';
document.getElementById('modalTargetCompDate').value = '';
document.getElementById('modalPrognosaCompDate').value = '';
document.getElementById('modalProgress').value = '0';
document.getElementById('modalHighlight').checked = false;
document.getElementById('modalMitigationPlan').value = '';
document.getElementById('modalNotes').value = '';
    }

    function closeModal() {
        document.getElementById('updateModal').style.display = 'none';
        currentEditId = null;
    }

    // ===== CRUD OPERATIONS =====
    function saveUpdate() {
        const equipment = document.getElementById('modalEquipment').value.trim();
        const vendor = document.getElementById('modalVendor').value.trim();
        
        if (!equipment || !vendor) {
            showNotification('Please fill in Equipment and Vendor fields', 'error');
            return;
        }

        const mobDateValue = document.getElementById('modalMobDate').value;
        const mobDateFormatted = mobDateValue ? formatDateForDisplay(mobDateValue) : 'TBD';

        const taskData = {
    equipment: equipment,
    vendor: vendor,
    priority: document.getElementById('modalPriority').value,
    disc: document.getElementById('modalDisc').value,
    task: document.getElementById('modalDisc').value, // Keep for backward compatibility
    taskName: document.getElementById('modalTask').value,
    status: document.getElementById('modalStatus').value,
    contract: document.getElementById('modalContract').value,
    visa: document.getElementById('modalVisa').value,
    targetDate: document.getElementById('modalTargetDate').value,
    mobDate: mobDateFormatted,
    targetCompDate: document.getElementById('modalTargetCompDate').value,
    prognosaCompDate: document.getElementById('modalPrognosaCompDate').value,
    progress: parseInt(document.getElementById('modalProgress').value) || 0,
    highlighted: document.getElementById('modalHighlight').checked,
    mitigationPlan: document.getElementById('modalMitigationPlan').value
};

        if (currentEditId) {
            // Update existing item
            const item = projectData.find(p => p.firebaseKey === currentEditId);
            
            // Detect changes
            let changes = [];
            if (item.equipment !== taskData.equipment) changes.push(`Equipment: "${item.equipment}" → "${taskData.equipment}"`);
            if (item.vendor !== taskData.vendor) changes.push(`Vendor: "${item.vendor}" → "${taskData.vendor}"`);
           if (item.priority !== taskData.priority) changes.push(`Priority: ${item.priority} → ${taskData.priority}`);
if (item.disc !== taskData.disc) changes.push(`Discipline: ${item.disc || item.task} → ${taskData.disc}`);
if (item.taskName !== taskData.taskName) changes.push(`Task: ${item.taskName || 'N/A'} → ${taskData.taskName}`);
if (item.status !== taskData.status) changes.push(`Status: ${item.status} → ${taskData.status}`);
            if (item.contract !== taskData.contract) changes.push(`Contract: ${item.contract} → ${taskData.contract}`);
            if (item.visa !== taskData.visa) changes.push(`VISA: ${item.visa} → ${taskData.visa}`);
            if (item.targetDate !== taskData.targetDate) changes.push(`Target Date: ${item.targetDate || 'N/A'} → ${taskData.targetDate || 'N/A'}`);
            if (item.mobDate !== taskData.mobDate) changes.push(`MOB Date: ${item.mobDate} → ${taskData.mobDate}`);
            if (item.progress !== taskData.progress) changes.push(`Progress: ${item.progress}% → ${taskData.progress}%`);
if (item.targetCompDate !== taskData.targetCompDate) changes.push(`Target Comp Date: ${item.targetCompDate || 'N/A'} → ${taskData.targetCompDate || 'N/A'}`);
if (item.prognosaCompDate !== taskData.prognosaCompDate) changes.push(`Prognosa Comp Date: ${item.prognosaCompDate || 'N/A'} → ${taskData.prognosaCompDate || 'N/A'}`);
if (item.mitigationPlan !== taskData.mitigationPlan) changes.push(`Mitigation Plan updated`);
            
            const changeDescription = changes.length > 0 ? changes.join(', ') : 'No changes detected';
            const userNotes = document.getElementById('modalNotes').value;
            const detailedNotes = userNotes ? `${userNotes} | Changes: ${changeDescription}` : `Changes: ${changeDescription}`;
            
            projectDataRef.child(currentEditId).update(taskData).then(() => {
                // Add to history
                activityHistoryRef.push({
                    timestamp: new Date().toISOString(),
                    type: 'update',
                    category: 'UPDATE',
                    title: vendor + ' - ' + equipment.substring(0, 30),
                    equipmentId: item.id,
                    equipment: equipment,
                    vendor: vendor,
                    description: `${changes.length} field(s) updated`,
                    notes: detailedNotes,
                    user: prompt('Enter your name:') || 'Anonymous',
                    icon: '📝',
                    color: '#27ae60'
                });
                
                showNotification('Task updated successfully', 'success');
                closeModal();
            }).catch((error) => {
                showNotification('Error updating task: ' + error.message, 'error');
            });
        } else {
            // Add new item
            const newId = Date.now();
            const newItem = {
                id: newId,
                no: projectData.length + 1,
                ...taskData
            };
            
            projectDataRef.push(newItem).then(() => {
                // Add to history
                activityHistoryRef.push({
                    timestamp: new Date().toISOString(),
                    type: 'add',
                    category: 'ADD',
                    title: 'New Task Added',
                    equipmentId: newId,
                    equipment: equipment,
                    vendor: vendor,
                    description: equipment + ' - ' + vendor,
                    notes: 'Priority: ' + taskData.priority + ', Status: ' + taskData.status,
                    user:  prompt('Enter your name:') || 'Anonymous',
                    icon: '➕',
                    color: '#e74c3c'
                });
                
                showNotification('Task added successfully', 'success');
                closeModal();
            }).catch((error) => {
                showNotification('Error adding task: ' + error.message, 'error');
            });
        }
    }

    function deleteItem(firebaseKey) {
        const item = projectData.find(p => p.firebaseKey === firebaseKey);
        if (!item) return;

        if (confirm(`Are you sure you want to delete this item?\n\n${item.equipment} - ${item.vendor}`)) {
            projectDataRef.child(firebaseKey).remove().then(() => {
                // Add to history
                activityHistoryRef.push({
                    timestamp: new Date().toISOString(),
                    type: 'delete',
                    category: 'DELETE',
                    title: 'Task Deleted',
                    equipmentId: null,
                    equipment: item.equipment,
                    vendor: item.vendor,
                    description: item.equipment + ' - ' + item.vendor,
                    notes: 'Task removed from tracking',
                    user:  prompt('Enter your name:') || 'Anonymous',
                    icon: '🗑️',
                    color: '#e74c3c'
                });
                
                showNotification('Item deleted successfully', 'success');
            }).catch((error) => {
                showNotification('Error deleting item: ' + error.message, 'error');
            });
        }
    }

function deleteHistory(firebaseKey) {
        if (confirm('Are you sure you want to delete this history item?')) {
            activityHistoryRef.child(firebaseKey).remove().then(() => {
                showNotification('History deleted successfully', 'success');
            }).catch((error) => {
                showNotification('Error deleting history: ' + error.message, 'error');
            });
        }
    }

 let currentHistoryPage = 1;
    const itemsPerPage = 20;
    let filteredHistoryData = [];
    let selectedHistoryItems = new Set();

    function showFullHistory() {
        document.getElementById('historyModal').style.display = 'block';
        currentHistoryPage = 1;
        selectedHistoryItems.clear();
        filteredHistoryData = [...activityHistory];
        renderFullHistory();
    }

    function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
    }

    function renderFullHistory() {
        const searchTerm = document.getElementById('historySearch').value.toLowerCase();
        
        filteredHistoryData = activityHistory.filter(item => {
            return item.title.toLowerCase().includes(searchTerm) ||
                   item.equipment.toLowerCase().includes(searchTerm) ||
                   item.vendor.toLowerCase().includes(searchTerm) ||
                   item.description.toLowerCase().includes(searchTerm);
        });

        const totalPages = Math.ceil(filteredHistoryData.length / itemsPerPage);
        const startIndex = (currentHistoryPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageItems = filteredHistoryData.slice(startIndex, endIndex);

        const container = document.getElementById('fullHistoryContainer');
        
        if (pageItems.length === 0) {
            container.innerHTML = '<div style="padding: 40px; text-align: center; color: #95a5a6;">No history found</div>';
        } else {
            container.innerHTML = pageItems.map(item => `
                <div style="border: 1px solid #ecf0f1; border-radius: 4px; padding: 12px; margin-bottom: 10px; background: ${selectedHistoryItems.has(item.firebaseKey) ? '#e8f4f8' : 'white'};">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <input type="checkbox" ${selectedHistoryItems.has(item.firebaseKey) ? 'checked' : ''} onchange="toggleHistorySelection('${item.firebaseKey}')" style="margin-top: 3px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong style="font-size: 11px; color: #2c3e50;">${new Date(item.timestamp).toLocaleString()}</strong>
                                <span style="font-size: 9px; background: ${item.color}; color: white; padding: 2px 8px; border-radius: 10px;">${item.category}</span>
                            </div>
                            <div style="font-size: 12px; font-weight: 600; margin-bottom: 3px;">${item.title}</div>
                            <div style="font-size: 11px; color: #666; margin-bottom: 3px;">${item.description}</div>
                            <div style="font-size: 10px; color: #999; background: #f8f9fa; padding: 4px 8px; border-radius: 3px; word-wrap: break-word; white-space: pre-wrap; line-height: 1.4; overflow-wrap: break-word; max-width: 100%; word-break: break-word;">${item.icon} ${item.notes}</div>
                            <div style="font-size: 9px; color: #95a5a6; margin-top: 5px;">by ${item.user}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('historyPageInfo').textContent = `${startIndex + 1}-${Math.min(endIndex, filteredHistoryData.length)} of ${filteredHistoryData.length}`;
        
        document.getElementById('prevPageBtn').disabled = currentHistoryPage === 1;
        document.getElementById('nextPageBtn').disabled = currentHistoryPage === totalPages || totalPages === 0;

        renderPageNumbers(totalPages);
    }

    function renderPageNumbers(totalPages) {
        const pageNumbersDiv = document.getElementById('pageNumbers');
        let html = '';
        
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentHistoryPage - 2 && i <= currentHistoryPage + 2)) {
                html += `<button onclick="goToHistoryPage(${i})" style="padding: 6px 10px; background: ${i === currentHistoryPage ? '#3498db' : '#ecf0f1'}; color: ${i === currentHistoryPage ? 'white' : '#2c3e50'}; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; min-width: 30px;">${i}</button>`;
            } else if (i === currentHistoryPage - 3 || i === currentHistoryPage + 3) {
                html += '<span style="padding: 0 5px;">...</span>';
            }
        }
        
        pageNumbersDiv.innerHTML = html;
    }

    function changeHistoryPage(direction) {
        const totalPages = Math.ceil(filteredHistoryData.length / itemsPerPage);
        const newPage = currentHistoryPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentHistoryPage = newPage;
            renderFullHistory();
        }
    }

    function goToHistoryPage(page) {
        currentHistoryPage = page;
        renderFullHistory();
    }

    function toggleHistorySelection(firebaseKey) {
        if (selectedHistoryItems.has(firebaseKey)) {
            selectedHistoryItems.delete(firebaseKey);
        } else {
            selectedHistoryItems.add(firebaseKey);
        }
        renderFullHistory();
    }

    function selectAllHistory() {
        const pageItems = filteredHistoryData.slice((currentHistoryPage - 1) * itemsPerPage, currentHistoryPage * itemsPerPage);
        pageItems.forEach(item => selectedHistoryItems.add(item.firebaseKey));
        renderFullHistory();
    }

    function deleteSelectedHistory() {
        if (selectedHistoryItems.size === 0) {
            showNotification('No items selected', 'error');
            return;
        }

        if (confirm(`Delete ${selectedHistoryItems.size} selected history items?`)) {
            const promises = Array.from(selectedHistoryItems).map(key => 
                activityHistoryRef.child(key).remove()
            );

            Promise.all(promises).then(() => {
                showNotification(`${selectedHistoryItems.size} items deleted`, 'success');
                selectedHistoryItems.clear();
                renderFullHistory();
            }).catch((error) => {
                showNotification('Error deleting items: ' + error.message, 'error');
            });
        }
    }

    function exportHistoryPDF() {
        const printWindow = window.open('', '_blank');
        const currentDate = new Date().toLocaleString();
        
        const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Activity History Report</title>
        <style>
            body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                font-size: 11px; 
                background: white; 
                color: #333; 
            }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                    .header h1 { margin: 0; font-size: 20px; color: #333; }
                    .history-item { border: 1px solid #ddd; padding: 12px; margin-bottom: 10px; page-break-inside: avoid; }
                    .timestamp { font-weight: bold; color: #2c3e50; font-size: 10px; }
                    .category { background: #3498db; color: white; padding: 2px 8px; border-radius: 10px; font-size: 9px; display: inline-block; }
                    .title { font-weight: bold; margin: 5px 0; font-size: 12px; }
                    .description { color: #666; margin: 3px 0; }
                    .notes { background: #f8f9fa; padding: 6px 10px; margin: 5px 0; border-radius: 3px; font-size: 10px; word-wrap: break-word; white-space: pre-wrap; line-height: 1.6; overflow-wrap: break-word; word-break: break-word; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Activity History Report</h1>
                    <p>Generated on: ${currentDate}</p>
                    <p>Total Records: ${filteredHistoryData.length}</p>
                </div>
                ${filteredHistoryData.map(item => `
                    <div class="history-item">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span class="timestamp">${new Date(item.timestamp).toLocaleString()}</span>
                            <span class="category">${item.category}</span>
                        </div>
                        <div class="title">${item.title}</div>
                        <div class="description">${item.description}</div>
                        <div class="notes">${item.icon} ${item.notes}</div>
                        <div style="font-size: 9px; color: #999; margin-top: 5px;">by ${item.user}</div>
                    </div>
                `).join('')}
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #333; text-align: center;">
                    <p style="margin: 0; font-size: 10px; font-weight: bold;">Developed by TS-KPB</p>
                    <p style="margin: 5px 0 0 0; font-size: 8px; color: #999;">© 2025 All Rights Reserved</p>
                </div>
            </body>
            </html>
        `;
        
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.print();
        };
    }

    // Search history on input
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('historySearch');
        if (searchInput) {
            searchInput.addEventListener('keyup', renderFullHistory);
        }
});

// ===== PROGRESS REPORT =====
    let currentEquipmentReport = null;

    function showProgressReport() {
        const filterValue = document.getElementById('equipmentHistoryFilter').value;
        
        if (filterValue === 'all') {
            showNotification('Please select an equipment first', 'error');
            return;
        }

        const equipmentId = parseInt(filterValue);
        const equipmentHistory = activityHistory.filter(item => item.equipmentId === equipmentId);
        
        if (equipmentHistory.length === 0) {
            showNotification('No history found for this equipment', 'error');
            return;
        }

        // Get current equipment data
        const currentEquipment = projectData.find(item => item.id === equipmentId);
        
        if (!currentEquipment) {
            showNotification('Equipment not found', 'error');
            return;
        }

        currentEquipmentReport = {
            equipment: currentEquipment,
            history: equipmentHistory
        };

        renderProgressReport();
        document.getElementById('progressReportModal').style.display = 'block';
    }

// NEW FUNCTION: Show Progress Report by Firebase Key (from table button)
function showProgressReportById(firebaseKey) {
    console.log('showProgressReportById called with:', firebaseKey);
    
    const item = projectData.find(p => p.firebaseKey === firebaseKey);
    console.log('Found item:', item);
    
    if (!item) {
        showNotification('Equipment not found', 'error');
        return;
    }

    const equipmentId = item.id;
    const equipmentHistory = activityHistory.filter(h => h.equipmentId === equipmentId);
    
    console.log('Equipment history:', equipmentHistory);
    
    // Allow showing report even with no history
    currentEquipmentReport = {
        equipment: item,
        history: equipmentHistory
    };

    renderProgressReport();
    document.getElementById('progressReportModal').style.display = 'block';
    
    if (equipmentHistory.length === 0) {
        showNotification('No activity history yet for this equipment', 'success');
    }
}

    function closeProgressReport() {
        document.getElementById('progressReportModal').style.display = 'none';
    }

    function renderProgressReport() {
    if (!currentEquipmentReport) return;

    const { equipment, history } = currentEquipmentReport;
    const container = document.getElementById('progressReportContent');
    
    // Filter and sort history
    const validHistory = history.filter(item => item && item.timestamp);
    const sortedHistory = validHistory.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    
    // Handle empty history
    if (sortedHistory.length === 0) {
        container.innerHTML = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h2 style="margin: 0 0 10px 0; font-size: 18px;">${equipment.equipment}</h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 12px;">
                    <div><strong>Vendor:</strong> ${equipment.vendor}</div>
                    <div><strong>Priority:</strong> ${equipment.priority}</div>
                    <div><strong>Status:</strong> ${equipment.status}</div>
                    <div><strong>Progress:</strong> ${equipment.progress}%</div>
                </div>
            </div>
            <div style="padding: 40px; text-align: center; background: #f8f9fa; border-radius: 8px;">
                <p style="font-size: 16px; color: #95a5a6; margin-bottom: 10px;">📋 No activity history yet</p>
                <p style="font-size: 12px; color: #bdc3c7;">Updates will appear here as changes are made</p>
            </div>
        `;
        return;
    }
    
    const firstUpdate = sortedHistory[0];
    const lastUpdate = sortedHistory[sortedHistory.length - 1];
    const duration = sortedHistory.length > 1 
        ? Math.ceil((new Date(lastUpdate.timestamp) - new Date(firstUpdate.timestamp)) / (1000 * 60 * 60 * 24))
        : 0;

    const statusChanges = sortedHistory.filter(item => item.category === 'UPDATE');

    container.innerHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h2 style="margin: 0 0 10px 0; font-size: 18px;">${equipment.equipment}</h2>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; font-size: 12px;">
                <div><strong>Vendor:</strong> ${equipment.vendor}</div>
                <div><strong>Priority:</strong> ${equipment.priority}</div>
                <div><strong>Discipline:</strong> ${equipment.disc || equipment.task}</div>
                <div><strong>Task:</strong> ${equipment.taskName || '-'}</div>
                <div><strong>Status:</strong> ${equipment.status}</div>
                <div><strong>Progress:</strong> ${equipment.progress}%</div>
            </div>
        </div>

        ${equipment.mitigationPlan ? `
        <div style="background: #fff3cd; border-left: 4px solid #f39c12; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #f39c12;">⚠️ Work Mitigation Plan</h3>
            <div style="font-size: 12px; color: #856404; white-space: pre-wrap;">${equipment.mitigationPlan}</div>
        </div>
        ` : ''}

        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; font-size: 14px; color: #2c3e50;">Summary Statistics</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                <div style="background: white; padding: 15px; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">${sortedHistory.length}</div>
                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 5px;">Total Updates</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${duration || 'N/A'}</div>
                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 5px;">${duration > 0 ? 'Days' : 'New'}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 6px;">
                    <div style="font-size: 24px; font-weight: bold; color: #27ae60;">${statusChanges.length}</div>
                    <div style="font-size: 11px; color: #7f8c8d; margin-top: 5px;">Changes</div>
                </div>
            </div>
        </div>

        <div style="background: white; border: 1px solid #ecf0f1; border-radius: 8px; padding: 20px;">
            <h3 style="margin: 0 0 20px 0; font-size: 14px;">Timeline</h3>
            ${sortedHistory.map(item => `
                <div style="padding: 12px; margin-bottom: 10px; background: #f8f9fa; border-left: 3px solid ${item.color}; border-radius: 6px;">
                    <div style="font-size: 11px; color: #2c3e50; margin-bottom: 5px;">
                        <strong>${new Date(item.timestamp).toLocaleString()}</strong>
                        <span style="float: right; background: ${item.color}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 9px;">${item.category}</span>
                    </div>
                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 3px;">${item.title}</div>
                    <div style="font-size: 11px; color: #666; margin-bottom: 5px;">${item.description}</div>
                    <div style="font-size: 10px; color: #999; background: white; padding: 8px; border-radius: 4px;">${item.icon} ${item.notes}</div>
                    <div style="font-size: 9px; color: #95a5a6; margin-top: 5px;">by ${item.user}</div>
                </div>
            `).join('')}
        </div>
    `;
}

    function exportProgressReportPDF() {
        if (!currentEquipmentReport) return;

        const { equipment, history } = currentEquipmentReport;
        const sortedHistory = [...history].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        const printWindow = window.open('', '_blank');
        const currentDate = new Date().toLocaleString();
        
        const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Progress Report - ${equipment.equipment}</title>
        <style>
            body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                font-size: 11px; 
                background: white; 
                color: #333; 
            }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                    .header h1 { margin: 0; font-size: 18px; color: #333; }
                    .info-box { background: #f8f9fa; padding: 15px; margin-bottom: 20px; border-radius: 6px; }
                    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
                    .timeline-item { margin-bottom: 20px; padding: 12px; padding-left: 20px; border-left: 3px solid #3498db; page-break-inside: avoid; background: #f8f9fa; }
                    .timestamp { font-weight: bold; font-size: 10px; margin-bottom: 5px; }
                    .title { font-weight: bold; margin: 5px 0; font-size: 11px; }
                    .description { margin: 5px 0; font-size: 10px; color: #666; }
                    .notes { 
                        background: white; 
                        padding: 8px 10px; 
                        margin: 8px 0; 
                        border-radius: 4px; 
                        font-size: 10px; 
                        color: #666; 
                        white-space: pre-wrap;
                        word-wrap: break-word;
                        line-height: 1.6;
                        border: 1px solid #e0e0e0;
                    }
                    .user-info { font-size: 9px; color: #999; margin-top: 5px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Equipment Progress Report</h1>
                    <p>${equipment.equipment}</p>
                    <p style="font-size: 10px;">Generated on: ${currentDate}</p>
                </div>
                
                <div class="info-box">
    <div class="info-grid">
        <div><strong>Vendor:</strong> ${equipment.vendor}</div>
        <div><strong>Priority:</strong> ${equipment.priority}</div>
        <div><strong>Discipline:</strong> ${equipment.disc || equipment.task}</div>
        <div><strong>Task:</strong> ${equipment.taskName || '-'}</div>
        <div><strong>Status:</strong> ${equipment.status}</div>
        <div><strong>Progress:</strong> ${equipment.progress}%</div>
        <div><strong>Contract:</strong> ${equipment.contract}</div>
        <div><strong>VISA:</strong> ${equipment.visa}</div>
    </div>
</div>

${equipment.mitigationPlan ? `
<div style="background: #fff3cd; border-left: 4px solid #f39c12; padding: 15px; border-radius: 6px; margin: 20px 0;">
    <h3 style="margin: 0 0 10px 0; font-size: 13px; color: #f39c12;">⚠️ Work Mitigation Plan</h3>
    <div style="font-size: 11px; color: #856404; white-space: pre-wrap; line-height: 1.6;">${equipment.mitigationPlan}</div>
</div>
` : ''}

<h3 style="margin-top: 30px;">Activity Timeline:</h3>
                ${sortedHistory.map(item => `
                    <div class="timeline-item">
                        <div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>
                        <div class="title">${item.icon} ${item.title}</div>
                        <div class="description">${item.description}</div>
                        <div class="notes">${item.notes}</div>
                        <div class="user-info">by ${item.user}</div>
                    </div>
                `).join('')}

                <div style="margin-top: 30px; padding-top: 15px; border-top: 2px solid #333; text-align: center;">
                    <p style="margin: 0; font-size: 10px; font-weight: bold;">Developed by TS-KPB</p>
                    <p style="margin: 5px 0 0 0; font-size: 8px; color: #999;">© 2025 All Rights Reserved</p>
                </div>
            </body>
            </html>
        `;
        
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.print();
        };
    }
   

    // ===== EXPORT =====
    function exportToPDF() {
        const printWindow = window.open('', '_blank');
        const currentDate = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let filteredData = currentFilter === 'all' ? projectData : projectData.filter(item => item.priority === currentFilter);
        
       const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Vendor Mobilization Report</title>
        <style>
            body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                font-size: 12px; 
                background: white; 
                color: #333; 
            }
                    .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
                    .header h1 { margin: 0; font-size: 24px; color: #333; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #333; padding: 8px; text-align: left; font-size: 10px; }
                    th { background: #2c3e50; color: white; }
                    tr:nth-child(even) { background: #f9f9f9; }
                    .ontime { color: #27ae60; font-weight: bold; }
                    .delayed { color: #e74c3c; font-weight: bold; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Vendor Mobilization Report</h1>
                    <p>Generated on: ${currentDate}</p>
                    <p>Filter: ${currentFilter === 'all' ? 'All Tasks' : currentFilter + ' Priority'}</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Priority</th>
                            <th>Equipment</th>
                            <th>Vendor</th>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Target MOB Date</th>
                            <th>MOB Date</th>
                            <th>Date Status</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map(item => {
                            const dateStatus = getDateStatus(item.targetDate, item.mobDate);
                            return `
                            <tr>
                                <td>${item.no}</td>
                                <td>${item.priority}</td>
                                <td>${item.equipment}</td>
                                <td>${item.vendor}</td>
                                <td>${item.task}</td>
                                <td>${item.status}</td>

<td>${item.targetDate ? formatDateForDisplay(item.targetDate) : '-'}</td>
                                    <td>${item.mobDate}</td>
                                    <td class="${dateStatus.status === 'ON TIME' ? 'ontime' : 'delayed'}">${dateStatus.status}</td>
                                    <td>${item.progress}%</td>
                                </tr>
                            `}).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #666;">
    <p>Vendor Mobilization Tracking System</p>
    <p>Report contains ${filteredData.length} tasks</p>
</div>

<div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #333; text-align: center;">
    <p style="margin: 0; font-size: 11px; font-weight: bold;">Developed by TS-KPB</p>
    <p style="margin: 5px 0 0 0; font-size: 9px; color: #999;">© 2025 All Rights Reserved</p>
</div>

                </body>
                </html>
            `;
            
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }

        // ===== NOTIFICATION =====
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Make functions globally accessible
        window.openUpdateModal = openUpdateModal;
        window.deleteItem = deleteItem;
window.filterByStatus = filterByStatus;
window.openGanttModal = openGanttModal;
window.closeGanttModal = closeGanttModal;
window.changeGanttView = changeGanttView;
window.exportGanttPDF = exportGanttPDF;
window.applyGanttColors = applyGanttColors;
window.jumpToGanttDate = jumpToGanttDate;
window.filterGanttChart = filterGanttChart;
window.showMitigationTooltip = showMitigationTooltip; // Add this
window.attachGanttHoverEvents = attachGanttHoverEvents; // Add this
function exportGanttImage() {
    if (!ganttInstance) {
        showNotification('Please open Gantt chart first', 'error');
        return;
    }
    
    showNotification('Exporting Gantt chart as image...', 'success');
    
    // Use html2canvas or similar library
    // For now, just use print dialog
    exportGanttPDF();
}
window.clearAllFilters = clearAllFilters;
	window.deleteHistory = deleteHistory;
        window.closeHistoryModal = closeHistoryModal;
        window.toggleHistorySelection = toggleHistorySelection;
        window.selectAllHistory = selectAllHistory;
        window.deleteSelectedHistory = deleteSelectedHistory;
        window.exportHistoryPDF = exportHistoryPDF;
        window.changeHistoryPage = changeHistoryPage;
        window.goToHistoryPage = goToHistoryPage;
        window.showProgressReport = showProgressReport;
window.showProgressReportById = showProgressReportById;
        window.closeProgressReport = closeProgressReport;
        window.exportProgressReportPDF = exportProgressReportPDF;
        window.exportToPDF = exportToPDF;
        window.closeModal = closeModal;
        window.filterByIssueType = filterByIssueType;
        window.clearIssueFilter = clearIssueFilter;
        window.filterEquipmentHistory = filterEquipmentHistory;
        window.saveUpdate = saveUpdate;
	window.changeTablePage = changeTablePage;
        window.goToTablePage = goToTablePage;
    </script>

    <!-- Footer -->
    <div style="background: #2c3e50; color: white; text-align: center; padding: 20px; margin-top: 30px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
        <p style="margin: 0; font-size: 13px; font-weight: 600; letter-spacing: 0.5px;">Developed by TS-KPB</p>
        <p style="margin: 8px 0 0 0; font-size: 10px; opacity: 0.7;">© 2025 All Rights Reserved</p>
    </div>

</body>
</html>
